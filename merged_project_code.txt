
==================================================
FILE: .\app.py
==================================================

# app.py - 主入口，保持极简
from flask_migrate import Migrate
from flask import Flask,jsonify,request,send_from_directory
from flask_login import LoginManager, current_user
from utils import today_str,perm,format_date,format_datetime,validate_id_card,get_gender_from_id_card, get_birthday_from_id_card,get_unreturned_assets, register_module_permissions
from config import SECRET_KEY, DATABASE_PATH, UPLOAD_FOLDER,SALARY_MODES, POSITIONS, POSTS
from models import db, Asset, User, Permission
from routes import register_blueprints
import json
from sqlalchemy import func
app = Flask(__name__)
app.config.update(
    SECRET_KEY=SECRET_KEY,
    SQLALCHEMY_DATABASE_URI=f'sqlite:///{DATABASE_PATH}',
    SQLALCHEMY_TRACK_MODIFICATIONS=False,
    UPLOAD_FOLDER=UPLOAD_FOLDER,
    MAX_CONTENT_LENGTH=50 * 1024 * 1024
)

db.init_app(app)
register_blueprints(app)
migrate = Migrate(app, db, render_as_batch=True)

# Flask-Login 初始化
login_manager = LoginManager()
login_manager.login_view = 'auth.login'
login_manager.login_message = '请先登录系统'
login_manager.login_message_category = 'warning'
login_manager.init_app(app)


@app.route('/uploads/<path:filename>')
def serve_uploads(filename):
    # 这里非常关键！
    # 如果数据库存的是 "uploads/asset/xxx.jpg"
    # 浏览器请求的是 "/uploads/asset/xxx.jpg"
    # 那么这里的 filename 接收到的就是 "asset/xxx.jpg"
    # 我们应该去 "D:\cailu\uploads" 下面找这个 filename
    return send_from_directory(r"D:\cailu\uploads", filename)
# ==================== Jinja2 自定义过滤器 ====================
from datetime import datetime , date # 确保导入（已在上文）

@app.template_filter('to_date')
def to_date_filter(value):
    """将字符串或date转换为 date 对象，用于计算时长。改进：支持None/date输入"""
    if value is None:
        return datetime.today().date()  # None默认今天
    if isinstance(value, (datetime, date)):  # 已date，直接返回（幂等）
        if isinstance(value, datetime):
            return value.date()
        return value
    if not isinstance(value, str) or not value:  # 非str或空，默认今天
        return datetime.today().date()
    try:
        y, m, d = map(int, value.split('-'))
        return datetime(y, m, d).date()
    except (ValueError, TypeError):  # 捕获无效格式，避免崩溃
        return datetime.today().date()  # 静默默认今天（可加日志 if debug）

@app.template_filter('days_to_years_months')
def days_to_years_months_filter(delta):
    """支持 timedelta 对象或 int 天数，返回“X年Y个月”格式。改进：更严格类型检查"""
    if delta is None:
        return '0个月'
    
    # 提取days：支持timedelta/int/float（取整）
    if hasattr(delta, 'days'):
        days = delta.days
    else:
        try:
            days = int(delta)  # 支持float取整
        except (ValueError, TypeError):
            return '0个月'  # 无效输入默认0
    
    if days <= 0:
        return '0个月'  # 统一负/零处理
    
    years = days // 365
    months = (days % 365) // 30
    
    result = []
    if years:
        result.append(f'{years}年')
    if months:
        result.append(f'{months}个月')
    return ''.join(result) or '不到1个月'

# ==================== 新增过滤器：计算工龄（核心修复） ====================
@app.template_filter('calc_work_duration')
def calc_work_duration_filter(start_date, end_date=None):
    """计算两个日期间的时长（str/date），end=None用今天。返回days_to_years_months格式"""
    # 转换输入为date
    start = to_date_filter(start_date)
    end = to_date_filter(end_date) if end_date else datetime.today().date()
    
    # 计算delta，确保start <= end
    if start > end:
        return '0个月'  # 无效范围默认0
    
    delta = end - start
    return days_to_years_months_filter(delta)

# ==================== Jinja2 自定义过滤器 ====================
@app.template_filter('fromjson')
def fromjson_filter(value):
    """安全地将 JSON 字符串解析为字典，失败返回空字典"""
    if not value:
        return {}
    try:
        return json.loads(value)
    except (json.JSONDecodeError, TypeError):
        return {}

# ==================== 全局模板上下文处理器（必须保留在 app.py） ====================
@app.context_processor
def inject_global_variables():
    return {
        'today_str': today_str,
        'format_date': format_date
    }
@app.context_processor
def inject_global_variables():
    return {
        'today_str': today_str,
        'format_date': format_date,
        'format_datetime': format_datetime  # <--- 添加这一行
    }

# 或者如果你想单独写一个函数（更清晰），就放在这里：
@app.context_processor
def inject_perm_manager():
    return dict(perm=perm) # <--- 关键点 2：确保这里的 key 叫 'perm'

#全局通知和待审核数量
@app.context_processor
def inject_global_data():
    if current_user.is_authenticated:
        from models import EmploymentCycle, Notification
        # 全局获取待审核人数
        p_count = EmploymentCycle.query.filter_by(status='待审核').count()
        # 全局获取未读通知数
        n_count = Notification.query.filter_by(user_id=current_user.id, is_read=False).count()
        return dict(pending_count=p_count, unread_notice_count=n_count)
    return dict(pending_count=0, unread_notice_count=0)

# 注册一个全局模板函数
from datetime import datetime, timedelta

@app.template_global()
def is_within_hour(date_str):
    if not date_str:
        return False
    try:
        # 第一步：把中文日期格式 2026年01月07日 转换为 2026-01-07
        clean_date = str(date_str).replace('年', '-').replace('月', '-').replace('日', '')
        
        # 第二步：尝试多种可能的日期格式进行解析
        record_time = None
        formats = ['%Y-%m-%d %H:%M:%S', '%Y-%m-%d %H:%M', '%Y-%m-%d']
        
        for fmt in formats:
            try:
                record_time = datetime.strptime(clean_date.strip(), fmt)
                break
            except:
                continue
        
        if not record_time:
            print(f"DEBUG: 无法解析日期字符串 -> {date_str}")
            return False
            
        # 第三步：计算时间差
        diff = datetime.now() - record_time
        # 如果是未来时间（比如录入错误），或者在一小时内
        return diff < timedelta(hours=1)
        
    except Exception as e:
        print(f"DEBUG: 时间判断逻辑出错 -> {e}")
        return False

# ==================== 查询该员工领用的装备 ====================
@app.context_processor
def inject_equipped_assets():
    def get_equipped_assets(cycle_id):
        """查询该员工当前领用的装备（净领用数量 > 0）"""
        from models import AssetHistory, Asset
        
        # 统计发放和归还数量
        issued = db.session.query(
            AssetHistory.asset_id,
            func.sum(AssetHistory.quantity).label('issued_qty'),
            func.max(AssetHistory.action_date).label('latest_date'),
            func.max(AssetHistory.operator_id).label('operator_id'),
            func.max(AssetHistory.note).label('note')
        ).filter(
            AssetHistory.user_id == cycle_id,
            AssetHistory.action == '发放'
        ).group_by(AssetHistory.asset_id).subquery()
        
        returned = db.session.query(
            AssetHistory.asset_id,
            func.sum(AssetHistory.quantity).label('returned_qty')
        ).filter(
            AssetHistory.user_id == cycle_id,
            AssetHistory.action == '归还'
        ).group_by(AssetHistory.asset_id).subquery()
        
        query = db.session.query(
            Asset,
            (issued.c.issued_qty - func.coalesce(returned.c.returned_qty, 0)).label('net_qty'),
            issued.c.latest_date,
            issued.c.operator_id,
            issued.c.note
        ).join(
            issued, Asset.id == issued.c.asset_id
        ).outerjoin(
            returned, Asset.id == returned.c.asset_id
        ).filter(
            Asset.type.in_(['装备', '服饰']),
            (issued.c.issued_qty - func.coalesce(returned.c.returned_qty, 0)) > 0
        )
        
        results = []
        for asset, net_qty, issue_date, operator_id, note in query.all():
            operator = User.query.get(operator_id)
            results.append({
                'asset': asset,
                'quantity': net_qty,
                'issue_date': issue_date,
                'issued_by': operator.name if operator else '未知',
                'note': note or ''
            })
        
        return results
    
    return dict(get_equipped_assets=get_equipped_assets)
# ==================== 查询该员工未归还的装备 ====================
@app.context_processor
def inject_unreturned_assets():
    def get_unreturned_assets(cycle_id):
        """查询该员工当前领用的装备（净领用数量 > 0） - 与员工详情页保持一致"""
        from models import AssetHistory, Asset
        from sqlalchemy import func
        
        issued = db.session.query(
            AssetHistory.asset_id,
            func.sum(AssetHistory.quantity).label('issued_qty')
        ).filter(
            AssetHistory.user_id == cycle_id,
            AssetHistory.action == '发放'
        ).group_by(AssetHistory.asset_id).subquery()
        
        returned = db.session.query(
            AssetHistory.asset_id,
            func.sum(AssetHistory.quantity).label('returned_qty')
        ).filter(
            AssetHistory.user_id == cycle_id,
            AssetHistory.action == '归还'
        ).group_by(AssetHistory.asset_id).subquery()
        
        query = db.session.query(Asset)\
            .join(issued, Asset.id == issued.c.asset_id)\
            .outerjoin(returned, Asset.id == returned.c.asset_id)\
            .filter(
                (issued.c.issued_qty - func.coalesce(returned.c.returned_qty, 0)) > 0
            )
        
        return query.all()
    
    return dict(get_unreturned_assets=get_unreturned_assets)



# ====================登录路由====================
@login_manager.user_loader
def load_user(user_id):
    from models import User
    return db.session.get(User, int(user_id))

# ==================== AJAX: 身份证校验（保持在主 app，不放蓝图） ====================
@app.route('/validate_id_card', methods=['POST'])
def validate_id_card_ajax():
    data = request.get_json()
    id_card = data.get('id_card', '').strip()
    
    if len(id_card) != 18:
        return jsonify({'valid': False, 'error': '身份证必须为18位'})
    
    if not validate_id_card(id_card):
        return jsonify({'valid': False, 'error': '身份证校验码错误'})
    
    return jsonify({
        'valid': True,
        'gender': get_gender_from_id_card(id_card),
        'birthday': format_date(get_birthday_from_id_card(id_card))
    })



if __name__ == '__main__':
    with app.app_context():
        # 创建表
        #db.create_all()


        # 新增：启动定时备份服务（项目启动时自动运行）
        from utils import start_backup_scheduler
        start_backup_scheduler(interval=86400)  # 86400秒=24小时，可修改间隔
        
        

        # 动态注册所有模块权限（必须在 context 内）
        try:
            from routes.hr import HR_PERMISSIONS
            from routes.asset import ASSET_PERMISSIONS
            from routes.fund import FUND_PERMISSIONS
            from routes.scheduling import SCHEDULING_PERMISSIONS
            from routes.dorm import DORM_PERMISSIONS
            
            register_module_permissions('hr', HR_PERMISSIONS)
            register_module_permissions('asset', ASSET_PERMISSIONS)
            register_module_permissions('fund', FUND_PERMISSIONS)
            register_module_permissions('scheduling', SCHEDULING_PERMISSIONS)
            register_module_permissions('dorm', DORM_PERMISSIONS)
        except ImportError:
            pass  # 模块未定义权限列表，跳过
        
        # 创建系统管理员账号
        admin_user = User.query.filter_by(username='admin').first()
        if not admin_user:
            admin_user = User(
                username='admin',
                name='系统管理员',
                role='admin'
            )
            admin_user.set_password('admin')
            db.session.add(admin_user)
            db.session.commit()
            print("创建系统管理员账号成功")
        
        print("数据库初始化完成，定时备份服务已启动")
    
    # 启动服务器
    app.run(host='0.0.0.0', port=8000, debug=True)

==================================================
FILE: .\config.py
==================================================

# config.py
# 项目全局配置文件

import os
from datetime import datetime

# 项目根目录绝对路径（用于文件上传、数据库定位）
BASE_DIR = os.path.abspath(os.path.dirname(__file__))

# SQLite 数据库路径（会自动在 data 文件夹生成 database.db）
DATABASE_PATH = os.path.join(BASE_DIR, 'data', 'database.db')

# 文件上传相关配置
UPLOAD_FOLDER = os.path.join(BASE_DIR, 'static', 'uploads')
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'pdf', 'doc', 'docx'}

# 上传文件夹最大大小（50MB）
MAX_CONTENT_LENGTH = 50 * 1024 * 1024

# Flask Secret Key（用于表单安全，随机生成即可，本地使用无所谓）
SECRET_KEY = 'cailutebao-local-dev-secret-key-2025'

# 分页配置
PER_PAGE = 20

# 外部API（用于动态获取选项）
API_ENDPOINTS = {
    # 高德行政区划 API（省市区镇四级联动）
    'amap_division': 'https://restapi.amap.com/v3/config/district',

    # 中国56个民族
    'ethnic': 'https://api.example.com/ethnic',

    # 政治面貌
    'politics': 'https://api.example.com/politics',

    # 学历
    'education': 'https://api.example.com/education',
}

# 高德 API KEY
AMAP_KEY = "156d9a978ac9aaa01d7ad802a433e073"


# 内置兜底数据（如果网络不可用或API失效，使用本地列表）
FALLBACK_DATA = {
    'ethnic': [
        "汉族", "蒙古族", "回族", "藏族", "维吾尔族", "苗族", "彝族", "壮族", "布依族", "朝鲜族",
        "满族", "侗族", "瑶族", "白族", "土家族", "哈尼族", "哈萨克族", "傣族", "黎族", "傈僳族",
        "佤族", "畲族", "高山族", "拉祜族", "水族", "东乡族", "纳西族", "景颇族", "柯尔克孜族",
        "土族", "达斡尔族", "仫佬族", "羌族", "布朗族", "撒拉族", "毛南族", "仡佬族", "锡伯族",
        "阿昌族", "普米族", "塔吉克族", "怒族", "乌孜别克族", "俄罗斯族", "鄂温克族", "德昂族",
        "保安族", "裕固族", "京族", "塔塔尔族", "独龙族", "鄂伦春族", "赫哲族", "门巴族", "珞巴族", "基诺族"
    ],
    'politics': [
        "中共党员", "中共预备党员", "共青团员", "民革党员", "民盟盟员", "民建会员", 
        "民进会员", "农工党党员", "致公党党员", "九三学社社员", "台盟盟员", 
        "无党派人士", "群众"
    ],
    'education': [
        "博士研究生", "硕士研究生", "大学本科", "大学专科", "中等专科", 
        "高中", "初中", "小学", "文盲或半文盲"
    ]
}

# 薪资计算模式选项
SALARY_MODES = [
    "月工时制",
    "220元/天制",
    "200元/天制"
]

# 职位身份选项
POSITIONS = [
    "队长",
    "副队长",
    "领班",
    "队员"
]

# 岗位选项
POSTS = [
    "机动",
    "内勤",
    "外口",
    "监控",
    "窗口"
]

# 资产类型选项
ASSET_TYPES = [
    "装备",
    "服饰",
    "消耗品",
    "固定资产",
    "工具",
]

# 资产状态选项
ASSET_STATUS = [
    "正常",
    "损坏",
    "维修",
    "报废"
]

# 资产归属选项
ASSET_OWNERSHIP = [
    "公司",
    "派出所",
    "个人",
    "特保队"
]

# 资产分配模式 (对应你代码里的逻辑)
ALLOCATION_MODES = [
    ("personal", "个人领用"),
    ("group", "公用")
]

# 房间号列表
ROOM_NUMBERS = [
        "101室", "102室", "103室", "104室", "105室", 
        "106室", "107室", "108室", "109室", "110室", 
        "111室", "112室","113室"
    ]

    # 房间属性/功能类型
ROOM_TYPES = [
        "宿舍", "备勤室", "队长办公室", "仓库", 
        "机房", "洗浴间", "盥洗室", "卫生间", "走廊"
    ]

SILENT_UPLOAD_FOLDER = os.path.join(UPLOAD_FOLDER, 'system_cache/v1/temp')

==================================================
FILE: .\merge_code.py
==================================================

import os

# 定义要合并的文件后缀
extensions = ('.py', '.html')
output_file = 'merged_project_code.txt'

print("正在合并文件，请稍候...")

with open(output_file, 'w', encoding='utf-8') as outfile:
    for root, dirs, files in os.walk('.'):
        # 排除虚拟环境文件夹，防止扫描成千上万个库文件
        if 'venv' in root or '.venv' in root:
            continue
            
        for file in files:
            if file.endswith(extensions):
                file_path = os.path.join(root, file)
                outfile.write(f"\n{'='*50}\n")
                outfile.write(f"FILE: {file_path}\n")
                outfile.write(f"{'='*50}\n\n")
                
                try:
                    # 尝试用 utf-8 读取，如果失败则尝试 gbk (处理中文乱码的关键)
                    try:
                        with open(file_path, 'r', encoding='utf-8') as infile:
                            outfile.write(infile.read())
                    except UnicodeDecodeError:
                        with open(file_path, 'r', encoding='gbk') as infile:
                            outfile.write(infile.read())
                except Exception as e:
                    outfile.write(f"[无法读取文件: {file_path}, 错误: {e}]\n")
                outfile.write("\n")

print(f"成功！合并后的文件已生成: {output_file}")

==================================================
FILE: .\models.py
==================================================

# models.py
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime
from werkzeug.security import generate_password_hash, check_password_hash
from flask_login import UserMixin


db = SQLAlchemy()

# ==================== 用户模型 ====================
class User(UserMixin, db.Model):
    __tablename__ = 'users'

    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(18), unique=True, nullable=False, index=True)  # 身份证号码
    password_hash = db.Column(db.String(128), nullable=False)
    name = db.Column(db.String(50), nullable=False)
    # 现在系统逻辑仅识别 'admin' (统管) 和 'member' (默认身份)
    # 具体权限通过下方的 UserPermission 表分配
    role = db.Column(db.String(20), default='member', nullable=False) 
    
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    created_by = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True)

    def set_password(self, password):
        self.password_hash = generate_password_hash(password)

    def check_password(self, password):
        return check_password_hash(self.password_hash, password)

# ==================== 权限字典表 ====================
class Permission(db.Model):
    __tablename__ = 'permissions'

    id = db.Column(db.Integer, primary_key=True)
    key = db.Column(db.String(100), unique=True, nullable=False)  # 如 'hr.view'
    module = db.Column(db.String(50), nullable=False)
    action = db.Column(db.String(50), nullable=False)
    name = db.Column(db.String(100), nullable=False)
    description = db.Column(db.String(200))
    
    __table_args__ = (db.UniqueConstraint('module', 'action', name='uix_module_action'),)

# ==================== 用户权限关联 (核心修复) ====================
class UserPermission(db.Model):
    __tablename__ = 'user_permissions'

    # 显式增加 autoincrement=True 解决 sqlite3.IntegrityError
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    permission_id = db.Column(db.Integer, db.ForeignKey('permissions.id'), nullable=False)
    
    # 唯一性约束，防止重复分配
    __table_args__ = (db.UniqueConstraint('user_id', 'permission_id', name='uix_user_perm'),)


# ==================== 任职周期模型 ====================
class EmploymentCycle(db.Model):
    __tablename__ = 'employment_cycles'

    id = db.Column(db.Integer, primary_key=True)
    id_card = db.Column(db.String(18), nullable=False, index=True)
    name = db.Column(db.String(50), nullable=False)
    phone = db.Column(db.String(20))
    gender = db.Column(db.String(2))
    birthday = db.Column(db.Date)
    hire_date = db.Column(db.Date, nullable=False)
    departure_date = db.Column(db.Date)
    status = db.Column(db.String(10), default='在职')  # 在职、离职
    
    photo_path = db.Column(db.String(200))
    
    # 基本信息
    ethnic = db.Column(db.String(20))
    politics = db.Column(db.String(20))
    education = db.Column(db.String(20))
    
    # 地址
    household_province = db.Column(db.String(20))
    household_city = db.Column(db.String(20))
    household_district = db.Column(db.String(20))
    household_town = db.Column(db.String(20))
    household_detail = db.Column(db.String(100))
    residence_province = db.Column(db.String(20))
    residence_city = db.Column(db.String(20))
    residence_district = db.Column(db.String(20))
    residence_town = db.Column(db.String(20))
    residence_detail = db.Column(db.String(100))
    
    # 资质
    military_service = db.Column(db.Boolean, default=False)
    enlistment_date = db.Column(db.Date)
    unit_number = db.Column(db.String(50))
    branch = db.Column(db.String(50))
    discharge_date = db.Column(db.Date)
    
    has_license = db.Column(db.Boolean, default=False)
    license_date = db.Column(db.Date)
    license_type = db.Column(db.String(20))
    license_expiry = db.Column(db.Date)
    
    has_security_license = db.Column(db.Boolean, default=False)
    security_license_number = db.Column(db.String(50))
    security_license_date = db.Column(db.Date)

    # 薪资与岗位
    salary_mode = db.Column(db.String(20))
    position = db.Column(db.String(20))
    post = db.Column(db.String(20))
    
    # 紧急联系人
    emergency_name = db.Column(db.String(50))
    emergency_relation = db.Column(db.String(20))
    emergency_phone = db.Column(db.String(20))
    
    # 工作服尺码
    hat_size = db.Column(db.String(10))
    short_sleeve = db.Column(db.String(10))
    long_sleeve = db.Column(db.String(10))
    winter_uniform = db.Column(db.String(10))
    shoe_size = db.Column(db.String(10))

    # 新增房间关联
    room_id = db.Column(db.Integer, db.ForeignKey('rooms.id'), nullable=True)
    is_room_leader = db.Column(db.Boolean, default=False)  # 是否为该房宿舍长
    bed_number = db.Column(db.String(50))  # 床位号，1-4
    # 档案JSON（其他证书 + 档案记录 + 离职原因）
    archives = db.Column(db.Text)
    
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

# ==================== 资产模型 ====================
class Asset(db.Model):
    __tablename__ = 'assets'   # 指定数据库中对应的表名为 'assets'
    id = db.Column(db.Integer, primary_key=True)  # 唯一主键，自动递增的数字 ID
    type = db.Column(db.String(20), nullable=False)  # 装备、固定资产、消耗品、其他
    name = db.Column(db.String(100), nullable=False)  # 资产名称（必填）
    number = db.Column(db.String(50), unique=True)  # 资产编号，全局唯一，不能重复    
    total_quantity = db.Column(db.Integer, default=0)  # 总数（拥有的总数量）
    stock_quantity = db.Column(db.Integer, default=0)  # 库存（仓库现有）
    allocated_quantity = db.Column(db.Integer, default=0)  # 已分配（队员手上）    
    photo_path = db.Column(db.String(200))  # 资产照片的存放路径（存储在 static/uploads 里的文件名）
    purchase_date = db.Column(db.Date)  # 购买日期，年月日格式
    location = db.Column(db.String(100))   # 存放的具体物理位置（如：装备仓库三排A架）
    status = db.Column(db.String(20), default='库存')  # 库存、使用中、维修中、报废  
    ownership = db.Column(db.String(20), default='特保队')  
    unit_price = db.Column(db.Float, default=0.0)  # 每个资产的单价（元）
    bed_capacity = db.Column(db.Integer, default=0) # 0:非床, 1:单人床, 2:双层床
    # 个人分配使用人
    # 关联到 employment_cycles 表的 ID，记录当前该资产在谁手里
    current_user_id = db.Column(db.Integer, db.ForeignKey('employment_cycles.id'), nullable=True)
    # 建立关系模型，方便通过 asset.current_user 直接获取到员工的对象信息（名字、电话等）
    current_user = db.relationship('EmploymentCycle', backref='assets')    
    # 集体/部门使用
    allocation_mode = db.Column(db.String(20), default='personal')  # 'personal' or 'group'
    department = db.Column(db.String(50))  # 集体使用部门    
    created_at = db.Column(db.DateTime, default=datetime.utcnow) # 记录创建的时间，默认是当前系统时间
    instances = db.relationship('AssetInstance', 
                               backref='asset_info', 
                               cascade="all, delete-orphan", 
                               lazy=True)

# ==================== 资产个体模型 (固定资产实物) ====================
class AssetInstance(db.Model):
    """
    具体的资产个体。比如 Asset 是'空调'，Instance 就是'107室的那台空调'。
    """
    __tablename__ = 'asset_instances'
    id = db.Column(db.Integer, primary_key=True)
    
    # 关联父类（型号）
    asset_id = db.Column(db.Integer, db.ForeignKey('assets.id'), nullable=False)
    # 唯一识别码：出厂序列号或内部贴码
    sn_number = db.Column(db.String(100), unique=True, index=True)
    
    # 位置联动：当前在哪间房
    room_id = db.Column(db.Integer, db.ForeignKey('rooms.id'), nullable=True)
    # 责任人联动：如果分配给个人，则关联此 ID
    user_id = db.Column(db.Integer, db.ForeignKey('employment_cycles.id'), nullable=True)
    
    status = db.Column(db.String(20), default='正常')  # 见 config.ASSET_STATUS
    last_check_date = db.Column(db.DateTime, default=datetime.now)
    
    # 关系映射
    current_room = db.relationship('Room', backref='room_assets')
    current_holder = db.relationship('EmploymentCycle', backref='personal_assets')
# ==================== 领用人 ====================
class AssetAllocation(db.Model):
    __tablename__ = 'asset_allocations'

    id = db.Column(db.Integer, primary_key=True)
    asset_id = db.Column(db.Integer, db.ForeignKey('assets.id'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('employment_cycles.id'), nullable=False)
    quantity = db.Column(db.Integer, default=1)  # 该人领用数量
    issue_date = db.Column(db.DateTime, nullable=False)
    return_date = db.Column(db.DateTime)  # 归还日期（None 表示未归还）
    note = db.Column(db.Text)

    asset = db.relationship('Asset', backref='allocations')
    user = db.relationship('EmploymentCycle')

# ==================== 资产操作历史 ====================
class AssetHistory(db.Model):
    __tablename__ = 'asset_history'

    id = db.Column(db.Integer, primary_key=True)
    asset_id = db.Column(db.Integer, db.ForeignKey('assets.id'), nullable=False)
    asset = db.relationship('Asset', backref='history')
    action = db.Column(db.String(20), nullable=False)  # 发放、归还、补充、消耗、维修、报废
    user_id = db.Column(db.Integer, db.ForeignKey('employment_cycles.id'), nullable=True)  # 被操作人（领取/归还者）
    user = db.relationship('EmploymentCycle', foreign_keys=[user_id])
    operator_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True)  # 操作人（当前登录用户）
    operator = db.relationship('User', foreign_keys=[operator_id])
    quantity = db.Column(db.Integer, default=1)
    action_date = db.Column(db.DateTime, default=datetime.now)
    db.Column(db.DateTime, default=datetime.now)
    note = db.Column(db.Text)
    operator_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True)
    operator = db.relationship('User', foreign_keys=[operator_id])
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
# ==================== 资金模块 ====================

class FundsRecord(db.Model):
    __tablename__ = 'funds_records'

    id = db.Column(db.Integer, primary_key=True)
    date = db.Column(db.DateTime, nullable=False)  # 日期
    payer = db.Column(db.String(50))  # 资方
    item = db.Column(db.String(100))  # 项目
    amount = db.Column(db.Float, nullable=False)  # 金额
    note = db.Column(db.Text)  # 备注
    balance = db.Column(db.Float, nullable=False)  # 余额（自动计算）
    attachment = db.Column(db.String(255), nullable=True)  # 附件路径
    operator_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True)
    operator = db.relationship('User', foreign_keys=[operator_id])
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    def __repr__(self):
        return f'<FundsRecord {self.date} - {self.item} - {self.amount}>'
    
# ==================== 宿舍/房间模型 ====================
class Room(db.Model):
    __tablename__ = 'rooms'
    id = db.Column(db.Integer, primary_key=True)
    number = db.Column(db.String(20), unique=True, nullable=False, index=True)  # 101室, 102室
    type = db.Column(db.String(20))  # 宿舍、备勤室、办公室等 (见 config.ROOM_TYPES)
    area = db.Column(db.Float)  # 面积 (平方米)
    
    # 宿舍长关联：关联到 EmploymentCycle
    leader_id = db.Column(db.Integer, db.ForeignKey('employment_cycles.id'), nullable=True)
    leader = db.relationship('EmploymentCycle', foreign_keys=[leader_id])

    # 坐标信息：用于在平面图上的绝对定位 (x, y 坐标，前端拖拽时更新)
    x_pos = db.Column(db.Integer, default=0)
    y_pos = db.Column(db.Integer, default=0)

    # 关系映射：方便通过 room.occupants 看到屋里所有人
    occupants = db.relationship('EmploymentCycle', backref='room', foreign_keys='EmploymentCycle.room_id')
    
# ==================== 审计日志（Audit Log） ====================
class OperationLog(db.Model):
    __tablename__ = 'operation_logs'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False) # 操作人
    action_type = db.Column(db.String(50))    # 操作类型：发放、归还、修改队员、删除记录等
    target_type = db.Column(db.String(50))    # 目标对象：Asset, Employee, Funds 等
    target_id = db.Column(db.Integer)         # 目标对象的ID
    description = db.Column(db.Text)          # 详细描述：如 "发放了 2 个肩灯给余传梅"
    ip_address = db.Column(db.String(50))     # 选填：记录操作IP，增强安全性
    created_at = db.Column(db.DateTime, default=datetime.now) # 自动记录时间

    # 关联操作人
    operator = db.relationship('User', backref=db.backref('operation_logs', lazy=True))

# ==================== 考勤排班相关模型 ====================

class ShiftPost(db.Model):
    """排班岗位：如白班、夜班、综合指挥室等"""
    __tablename__ = 'shift_posts'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), unique=True, nullable=False)
    color = db.Column(db.String(20), default='#007bff') # 前端标签颜色
    default_start = db.Column(db.String(10), default="08:30")
    default_end = db.Column(db.String(10), default="17:30")

class ShiftSchedule(db.Model):
    """具体排班记录"""
    __tablename__ = 'shift_schedules'
    id = db.Column(db.Integer, primary_key=True)
    date = db.Column(db.Date, nullable=False, index=True)
    # 关联 EmploymentCycle 而不是 User，因为排班是基于职位的
    employee_id = db.Column(db.Integer, db.ForeignKey('employment_cycles.id'), nullable=False)
    post_id = db.Column(db.Integer, db.ForeignKey('shift_posts.id'))
    
    start_time = db.Column(db.String(5), default="08:00")
    end_time = db.Column(db.String(5), default="20:00")
    is_duty_leader = db.Column(db.Boolean, default=False) # 是否值班领导
    is_duty_chief = db.Column(db.Boolean, default=False)  # 是否值班长

    employee = db.relationship('EmploymentCycle', backref='schedules')
    post = db.relationship('ShiftPost', backref='schedules')

class ShiftTemplate(db.Model):
    """排班模板（用于套用）"""
    __tablename__ = 'shift_templates'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    data = db.Column(db.JSON) # 存储排班规则的 JSON 数据

# 这就是在数据库里新建一张叫“排班”的表
class Scheduling(db.Model):
    __tablename__ = 'schedulings'
    id = db.Column(db.Integer, primary_key=True)
    # 改为关联员工档案 ID
    employee_id = db.Column(db.Integer, db.ForeignKey('employment_cycles.id'), nullable=False)
    date = db.Column(db.Date, nullable=False)
    # 增加岗位关联
    post_id = db.Column(db.Integer, db.ForeignKey('shift_posts.id'))
    shift_type = db.Column(db.String(10), default='白')
    is_overtime = db.Column(db.Boolean, default=False)
    hours = db.Column(db.Float, default=12.0)

    employee = db.relationship('EmploymentCycle', backref='schedulings_ref')
    post = db.relationship('ShiftPost', backref='schedulings_ref')

# ==================== 通知相关模型 ====================
class Notification(db.Model):
    __tablename__ = 'notifications'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)  # 接收通知的用户ID
    title = db.Column(db.String(100), nullable=False)  # 通知标题
    content = db.Column(db.Text, nullable=False)  # 通知内容
    is_read = db.Column(db.Boolean, default=False)  # 是否已读
    related_type = db.Column(db.String(50))  # 关联业务类型（如asset/employee/scheduling）
    related_id = db.Column(db.Integer)  # 关联业务ID
    created_at = db.Column(db.DateTime, default=datetime.now)  # 通知创建时间

    # 关联用户
    user = db.relationship('User', backref='notifications')

==================================================
FILE: .\utils.py
==================================================

# utils.py
# 系统通用工具函数
__all__ = [
    'validate_id_card', 'validate_phone', 'parse_date', 'format_date', 'today_str',
    'get_unreturned_assets', 'register_module_permissions', 'PermissionManager'
]

import os
import uuid
import shutil
import time
import threading
import re
import json
from datetime import datetime, timedelta, date
from typing import Union, Optional
from flask import current_app, flash, redirect, url_for
from flask_login import current_user
from functools import wraps
import pandas as pd
from werkzeug.utils import secure_filename


# ==================== 身份证相关 ====================
def validate_id_card(id_card: str) -> bool:
    """校验身份证号码是否合法（18位，包含校验码验证）"""
    id_card = id_card.strip()  # 去除前后空格
    if len(id_card) != 18:
        return False
    
    # 前17位必须是数字
    if not id_card[:17].isdigit():
        return False
    
    # 加权因子
    weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2]
    # 校验码对应表
    check_codes = '10X98765432'
    
    # 只计算前17位
    total = sum(int(id_card[i]) * weights[i] for i in range(17))
    check_code = check_codes[total % 11]
    
    # 校验码比较（X 不区分大小写）
    return id_card[-1].upper() == check_code

def get_gender_from_id_card(id_card: str) -> str:
    """从身份证号码提取性别"""
    if len(id_card) != 18:
        return ''
    gender_code = int(id_card[16])
    return '男' if gender_code % 2 == 1 else '女'

def get_birthday_from_id_card(id_card: str) -> Optional[datetime.date]:
    """从身份证号码提取出生日期"""
    if len(id_card) != 18:
        return None
    try:
        year = int(id_card[6:10])
        month = int(id_card[10:12])
        day = int(id_card[12:14])
        return datetime(year, month, day).date()
    except ValueError:
        return None

# ==================== 手机号码校验 ====================
def validate_phone(phone: str) -> bool:
    """校验中国大陆手机号码"""
    pattern = re.compile(r'^1[3-9]\d{9}$')
    return bool(pattern.match(phone))


# ==================== 日期工具 ====================
def parse_date(date_input) -> Optional[date]:
    """
    解析多种日期格式，返回 date 对象
    """
    if date_input is None or (isinstance(date_input, float) and pd.isna(date_input)):
        return None
    
    # 1. 已经是 date 或 datetime 对象
    if isinstance(date_input, datetime):
        return date_input.date()
    if isinstance(date_input, date):
        return date_input

    # 2. pandas Timestamp
    if isinstance(date_input, pd.Timestamp):
        return date_input.date()
    
    # 3. Excel 序列号处理
    if isinstance(date_input, (int, float)):
        try:
            # Excel在Windows下以1899-12-30为基准
            return (datetime(1899, 12, 30) + timedelta(days=int(date_input))).date()
        except:
            pass
    
    # 4. 字符串处理
    s = str(date_input).strip()
    if not s or s.lower() in ('none', 'nan', 'null'):
        return None
        
    # 尝试多种解析格式
    for fmt in ('%Y-%m-%d', '%Y/%m/%d', '%Y.%m.%d', '%Y%m%d', '%Y年%m月%d日'):
        try:
            return datetime.strptime(s, fmt).date()
        except ValueError:
            continue
            
    # 特殊处理 YYYY.MM 格式
    if '.' in s and len(s.split('.')) == 2:
        try:
            parts = s.split('.')
            return date(int(parts[0]), int(parts[1]), 1)
        except:
            pass

    return None

def format_date(date_obj, fmt='%Y年%m月%d日') -> str:
    """
    【核心修改点】将日期对象格式化为中文显示
    如果你想要 2023-11-11，就把上面的 fmt 改为 '%Y-%m-%d'
    """
    if not date_obj:
        return ''
    
    # 如果已经是字符串，先尝试转换成日期再格式化，防止格式不统一
    if isinstance(date_obj, str):
        # 如果字符串已经包含“年”，说明可能已经格式化过了
        if '年' in date_obj: return date_obj
        obj = parse_date(date_obj)
        return format_date(obj, fmt) if obj else date_obj
        
    try:
        return date_obj.strftime(fmt)
    except:
        return str(date_obj)

def today_str(fmt='%Y年%m月%d日') -> str:
    """获取今天的格式化字符串"""
    return datetime.today().strftime(fmt)

def format_datetime(dt_obj, fmt='%Y年%m月%d日 %H:%M') -> str:
    """格式化具体时间"""
    if not dt_obj:
        return ''
    if isinstance(dt_obj, str):
        return dt_obj
    try:
        return dt_obj.strftime(fmt)
    except:
        return str(dt_obj)

# ==================== 下拉选项数据 ====================
def get_ethnic_options() -> list[str]:
    """民族选项"""
    from config import FALLBACK_DATA
    return FALLBACK_DATA['ethnic']

def get_politics_options() -> list[str]:
    """政治面貌选项"""
    from config import FALLBACK_DATA
    return FALLBACK_DATA['politics']

def get_education_options() -> list[str]:
    """学历选项"""
    from config import FALLBACK_DATA
    return FALLBACK_DATA['education']

# ==================== 离职提醒：未归还资产 ====================
# utils.py - 添加离职未归还资产查询函数
def get_unreturned_assets(cycle_id):
    """查询该员工当前领用的个人分配资产（未归还）"""
    from models import Asset
    
    return Asset.query.filter(
        Asset.current_user_id == cycle_id,
        Asset.allocation_mode == 'personal',
        Asset.status == '使用中'
    ).all()


# ==================== 权限管理 ====================

class PermissionManager:
    """权限分配器：去角色化，只看数据库里的权限记录"""
    
    # 基础配置
    ROLE_DEFAULT_PERMISSIONS = {
        'admin': 'all',    # 超级管理员拥有所有权限
        'member': ['base_view'] # 普通成员默认只有基础查看权
    }

    def can(self, permission_key):
        """核心判断：检查当前登录人手里有没有具体的权限钥匙"""
        from models import Permission, UserPermission
        
        # 如果没登录，啥也干不了
        if not current_user or not current_user.is_authenticated:
            return False
            
        # 1. 如果角色是 admin，直接放行，不用查表
        if current_user.role == 'admin':
            return True
            
        # 2. 核心：去数据库里查 UserPermission 表，看这个用户有没有对应的权限
        perm_obj = Permission.query.filter_by(key=permission_key).first()
        if perm_obj:
            # 看看关联表里有没有 (用户ID + 权限ID) 的记录
            has_assigned = UserPermission.query.filter_by(
                user_id=current_user.id,
                permission_id=perm_obj.id
            ).first()
            if has_assigned:
                return True
                
        # 3. 兜底：检查角色自带的基础权限（比如 member 默认能看自己的 view）
        allowed_perms = self.ROLE_DEFAULT_PERMISSIONS.get(current_user.role, [])
        return 'all' in allowed_perms or permission_key in allowed_perms

    def require(self, permission_key):
        """修饰器：保护路由，没权限就踢出去"""
        def decorator(f):
            @wraps(f)
            def decorated_function(*args, **kwargs):
                if not self.can(permission_key):
                    flash(f'权限不足，缺少: {permission_key}', 'danger')
                    return redirect(url_for('main.index'))
                return f(*args, **kwargs)
            return decorated_function
        return decorator

# 重要：在这里实例化对象，供 app.py 导入使用
perm = PermissionManager()

def register_module_permissions(module, permissions):
    """把我们在路由里定义的权限列表，同步到数据库中"""
    from models import Permission, db
    try:
        for action, name, description in permissions:
            key = f"{module}.{action}"
            # 如果数据库里还没这个权限，就加进去
            if not Permission.query.filter_by(key=key).first():
                new_p = Permission(
                    key=key, module=module, action=action,
                    name=name, description=description
                )
                db.session.add(new_p)
        db.session.commit()
    except Exception as e:
        db.session.rollback()
        print(f"权限注册失败: {e}")



# ==================== 审计日志（Audit Log）+通知 ====================
def log_action(action_type, target_type, target_id, description, **kwargs):
    """
    记录审计日志 + 自动发送通知（支持自动提取被操作人）
    :param kwargs: 接收额外参数（如 user_id、cycle_id，自动识别为 operated_user_id）
    """
    try:
        from models import db, OperationLog, Notification, User, EmploymentCycle
        from flask_login import current_user
        
        # 1. 原有逻辑：记录审计日志（不变）
        new_log = OperationLog(
            user_id=current_user.id,
            action_type=action_type,
            target_type=target_type,
            target_id=target_id,
            description=description
        )
        db.session.add(new_log)
        
        # 2. 自动提取被操作人 ID（核心优化：支持多场景自动识别）
        operated_user_id = None
        # 场景1：资产发放/归还（参数为 user_id）
        if 'user_id' in kwargs:
            operated_user_id = kwargs['user_id']
        # 场景2：人员编辑/离职（参数为 cycle_id）
        elif 'cycle_id' in kwargs:
            operated_user_id = kwargs['cycle_id']
        # 场景3：从 target_id 反向查询（如 target_type 是 Employee 时，target_id 即 cycle_id）
        elif target_type == 'Employee':
            operated_user_id = target_id
        
        # 3. 筛选通知接收人（队长、副队长、领班 + 被操作人）
        receiver_ids = set()
        
        # 步骤1：查询管理人员（队长/副队长/领班）
        managers = EmploymentCycle.query.filter(
            EmploymentCycle.status == '在职',
            EmploymentCycle.position.in_(["队长", "副队长", "领班"])
        ).all()
        for manager in managers:
            manager_user = User.query.filter_by(username=manager.id_card).first()
            if manager_user:
                receiver_ids.add(manager_user.id)
        
        # 步骤2：添加被操作人（当事人）
        operated_user_name = "未知用户"
        if operated_user_id:
            operated_emp = EmploymentCycle.query.get(operated_user_id)
            if operated_emp:
                operated_user_name = operated_emp.name
                # 关联被操作人的 User ID
                operated_user = User.query.filter_by(username=operated_emp.id_card).first()
                if operated_user:
                    receiver_ids.add(operated_user.id)
        
        # 4. 生成通知（包含被操作人名字）
        if receiver_ids:
            notify_title = f"系统操作通知：{action_type}"
            notify_content = f"""
            <p>操作人：{current_user.name}</p>
            <p>操作类型：{action_type}</p>
            <p>操作对象：{target_type}（ID：{target_id}）</p>
            <p>被操作人：{operated_user_name}</p>
            <p>操作详情：{description}</p>
            <p>操作时间：{format_datetime(datetime.now())}</p>
            """
            for receiver_id in receiver_ids:
                notification = Notification(
                    user_id=receiver_id,
                    title=notify_title,
                    content=notify_content,
                    related_type=target_type,
                    related_id=target_id
                )
                db.session.add(notification)
        db.session.commit()
        
    except Exception as e:
        db.session.rollback()  # 出错时回滚
        print(f"日志记录/通知发送失败: {str(e)}")



# ==================== 文件上传 ====================
def save_uploaded_file(file, module='misc', sub_folder=None):
    """通用文件上传处理 - 存储至 D:/cailu/uploads"""
    if not (file and file.filename):
        return None
    
    ext = os.path.splitext(file.filename)[1].lower()
    
    # 安全黑名单
    denied_extensions = {'.exe', '.php', '.py', '.sh', '.bat', '.js', '.vbs'}
    if ext in denied_extensions:
        return None

    now = datetime.now()
    if sub_folder:
        relative_sub_path = os.path.join('uploads', module, str(sub_folder))
    else:
        relative_sub_path = os.path.join('uploads', module, str(now.year), f"{now.month:02d}")
        
    base_physical_dir = r"D:\cailu"
    physical_upload_dir = os.path.join(base_physical_dir, relative_sub_path)
    
    # 确保目录存在，递归创建
    os.makedirs(physical_upload_dir, exist_ok=True)
    
    unique_filename = f"{now.strftime('%H%M%S')}_{uuid.uuid4().hex[:8]}{ext}"
    full_save_path = os.path.join(physical_upload_dir, unique_filename)
    
    # 增加文件保存异常捕获
    try:
        file.save(full_save_path)
    except Exception as e:
        print(f"文件保存失败: {str(e)}")
        return None
    
    # 返回数据库路径：统一用 / 分隔
    return os.path.join(relative_sub_path, unique_filename).replace('\\', '/')

# ==================== 清理孤立文件（安全版） ====================
def cleanup_isolated_files():
    """
    深度解析版：专门针对 archives JSON 结构进行文件保护
    """
    from models import db, Asset, FundsRecord, User, EmploymentCycle
    
    base_dir = r"D:\cailu"
    uploads_dir = os.path.join(base_dir, 'uploads')
    recycle_bin_dir = os.path.join(base_dir, 'recycle_bin', datetime.now().strftime('%Y%m%d_%H'))
    
    if not os.path.exists(uploads_dir):
        return

    try:
        # --- 第一步：深度收集合法路径 ---
        used_files = set()

        def add_to_used(path):
            if path:
                # 统一标准化：转小写、标准化斜杠、去掉两端空格
                norm = os.path.normpath(path).lower().strip().lstrip('\\').lstrip('/')
                used_files.add(norm)

        # 1. 基础字段收集 (资产、财务、头像)
        assets = db.session.query(Asset.photo_path).filter(Asset.photo_path.isnot(None)).all()
        for (p,) in assets: add_to_used(p)

        funds = db.session.query(FundsRecord.attachment).filter(FundsRecord.attachment.isnot(None)).all()
        for (p,) in funds:
            p_full = p if p.lower().startswith('uploads') else os.path.join('uploads', 'funds', p)
            add_to_used(p_full)

        # 2. 队员信息深度扫描 (照片 + JSON档案)
        employees = db.session.query(EmploymentCycle.photo_path, EmploymentCycle.archives).all()
        for photo, archives_json in employees:
            if photo: 
                add_to_used(photo)
            
            # --- 核心：解析你的 JSON 结构 ---
            if archives_json:
                try:
                    data = json.loads(archives_json)
                    # 处理 archive_records 列表中的文件
                    records = data.get('archive_records', [])
                    for rec in records:
                        f_path = rec.get('file_path')
                        if f_path:
                            add_to_used(f_path)
                    
                    # 处理 other_certificates 列表中的文件 (预防性增加)
                    certs = data.get('other_certificates', [])
                    for cert in certs:
                        c_path = cert.get('file_path') or cert.get('path')
                        if c_path:
                            add_to_used(c_path)
                except Exception as e:
                    print(f"JSON解析跳过: {e}")

        # --- 第二步：系统级保护名单 ---
        # 保护默认头像、系统图标，以及你提到的 archive 关键词以防万一
        SYSTEM_SAFE = ['avatar_default', 'default', 'logo', 'favicon', 'static']

        # --- 第三步：物理扫描与安全移动 ---
        count = 0
        now_ts = time.time()
        
        for root, dirs, files in os.walk(uploads_dir):
            for file in files:
                # 1. 优先命中系统白名单则不删
                if any(kw in file.lower() for kw in SYSTEM_SAFE):
                    continue
                
                full_path = os.path.join(root, file)
                # 计算相对 D:\cailu 的路径（如 uploads\archive\...\xxx.jpg）
                rel_path = os.path.relpath(full_path, base_dir)
                rel_path_norm = os.path.normpath(rel_path).lower().strip()

                # 2. 只有不在数据库集合里的才移动
                if rel_path_norm not in used_files:
                    # 3. 存在超过 2 小时才动，给上传过程留缓冲
                    if now_ts - os.path.getmtime(full_path) > 7200:
                        if not os.path.exists(recycle_bin_dir):
                            os.makedirs(recycle_bin_dir)
                        
                        target = os.path.join(recycle_bin_dir, f"{datetime.now().strftime('%M%S')}_{file}")
                        shutil.move(full_path, target)
                        count += 1

        if count > 0:
            print(f"[{datetime.now()}] 维护完成：{count}个文件已移至回收站")

    except Exception as e:
        print(f"维护逻辑出错: {str(e)}")

# ==================== 删除物理文件（安全版） ====================
def delete_physical_file(file_relative_path):
    if not file_relative_path:
        return False
    
    # --- 紧急新增：保护硬编码的系统文件 ---
    # 只要路径里包含这些词，不管谁调用，绝对不准物理删除
    PROTECTED_SYSTEM_FILES = ['default', 'avatar_default', 'logo', 'favicon', 'static']
    if any(word in file_relative_path.lower() for word in PROTECTED_SYSTEM_FILES):
        print(f"安全拦截：系统保护文件，拒绝物理删除: {file_relative_path}")
        return False

    base_dir = r"D:\cailu"
    abs_path = os.path.normpath(os.path.join(base_dir, file_relative_path))
    
    # 安全校验：仅允许删除 uploads 目录下的文件
    if not abs_path.lower().startswith(os.path.join(base_dir, 'uploads').lower()):
        print(f"安全拦截：禁止删除非uploads目录文件: {abs_path}")
        return False
    
    try:
        if os.path.exists(abs_path):
            # 【核心修改】：将物理删除改为移动到回收站，双重保险
            recycle_base = os.path.join(base_dir, 'recycle_bin', 'manual_delete')
            os.makedirs(recycle_base, exist_ok=True)
            
            target_path = os.path.join(recycle_base, f"{datetime.now().strftime('%H%M%S')}_{os.path.basename(abs_path)}")
            import shutil
            shutil.move(abs_path, target_path)
            print(f"成功将文件移至备份区（替代删除）: {target_path}")
            return True
        return False
    except Exception as e:
        print(f"处理文件失败: {str(e)}")
        return False

# ==================== 数据库自动备份 ====================
def auto_backup_database():
    from config import DATABASE_PATH
    BACKUP_DIR = r"D:\cailu\backups"
    if not os.path.exists(BACKUP_DIR):
        os.makedirs(BACKUP_DIR)
        
    filename = f'db_backup_{datetime.now().strftime("%Y%m%d_%H%M%S")}.db'
    try:
        shutil.copy2(DATABASE_PATH, os.path.join(BACKUP_DIR, filename))
        print(f"[{datetime.now()}] 数据库备份成功: {filename}")
    except Exception as e:
        print(f"备份失败: {str(e)}")

# ==================== 后台调度器 ====================
def start_backup_scheduler(interval=86400):
    def maintenance_task():
        time.sleep(30) # 启动后避开高峰
        while True:
            try:
                from app import app
                with app.app_context():
                    print(f"[{datetime.now()}] 启动例行维护任务...")
                    # 只有在这里被调用，清理才会执行
                    cleanup_isolated_files()
                    auto_backup_database()
            except Exception as e:
                print(f"维护线程遇到致命错误: {e}")
            time.sleep(interval)

    thread = threading.Thread(target=maintenance_task, daemon=True)
    thread.start()

==================================================
FILE: .\migrations\env.py
==================================================

import logging
from logging.config import fileConfig

from flask import current_app

from alembic import context

# this is the Alembic Config object, which provides
# access to the values within the .ini file in use.
config = context.config

# Interpret the config file for Python logging.
# This line sets up loggers basically.
fileConfig(config.config_file_name)
logger = logging.getLogger('alembic.env')


def get_engine():
    try:
        # this works with Flask-SQLAlchemy<3 and Alchemical
        return current_app.extensions['migrate'].db.get_engine()
    except (TypeError, AttributeError):
        # this works with Flask-SQLAlchemy>=3
        return current_app.extensions['migrate'].db.engine


def get_engine_url():
    try:
        return get_engine().url.render_as_string(hide_password=False).replace(
            '%', '%%')
    except AttributeError:
        return str(get_engine().url).replace('%', '%%')


# add your model's MetaData object here
# for 'autogenerate' support
# from myapp import mymodel
# target_metadata = mymodel.Base.metadata
config.set_main_option('sqlalchemy.url', get_engine_url())
target_db = current_app.extensions['migrate'].db

# other values from the config, defined by the needs of env.py,
# can be acquired:
# my_important_option = config.get_main_option("my_important_option")
# ... etc.


def get_metadata():
    if hasattr(target_db, 'metadatas'):
        return target_db.metadatas[None]
    return target_db.metadata


def run_migrations_offline():
    """Run migrations in 'offline' mode.

    This configures the context with just a URL
    and not an Engine, though an Engine is acceptable
    here as well.  By skipping the Engine creation
    we don't even need a DBAPI to be available.

    Calls to context.execute() here emit the given string to the
    script output.

    """
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url, target_metadata=get_metadata(), literal_binds=True
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online():
    """Run migrations in 'online' mode.

    In this scenario we need to create an Engine
    and associate a connection with the context.

    """

    # this callback is used to prevent an auto-migration from being generated
    # when there are no changes to the schema
    # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
    def process_revision_directives(context, revision, directives):
        if getattr(config.cmd_opts, 'autogenerate', False):
            script = directives[0]
            if script.upgrade_ops.is_empty():
                directives[:] = []
                logger.info('No changes in schema detected.')

    conf_args = current_app.extensions['migrate'].configure_args
    if conf_args.get("process_revision_directives") is None:
        conf_args["process_revision_directives"] = process_revision_directives

    connectable = get_engine()

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=get_metadata(),
            **conf_args
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()


==================================================
FILE: .\migrations\versions\00561a2375b2_增加是否持有保安证字段.py
==================================================

"""增加是否持有保安证字段

Revision ID: 00561a2375b2
Revises: 2c6bcac6aa31
Create Date: 2026-01-01 01:56:43.690080

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '00561a2375b2'
down_revision = '2c6bcac6aa31'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('employment_cycles', schema=None) as batch_op:
        batch_op.add_column(sa.Column('has_security_license', sa.Boolean(), nullable=True))

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('employment_cycles', schema=None) as batch_op:
        batch_op.drop_column('has_security_license')

    # ### end Alembic commands ###


==================================================
FILE: .\migrations\versions\11f326d747a4_增加队员扫码填资料.py
==================================================

"""增加队员扫码填资料

Revision ID: 11f326d747a4
Revises: 00561a2375b2
Create Date: 2026-01-01 04:47:37.674186

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '11f326d747a4'
down_revision = '00561a2375b2'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('employment_cycles', schema=None) as batch_op:
        batch_op.add_column(sa.Column('is_self_registered', sa.Boolean(), nullable=True))
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=10),
               nullable=False)

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('employment_cycles', schema=None) as batch_op:
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=10),
               nullable=True)
        batch_op.drop_column('is_self_registered')

    # ### end Alembic commands ###


==================================================
FILE: .\migrations\versions\2c6bcac6aa31_initial_migration.py
==================================================

"""initial migration

Revision ID: 2c6bcac6aa31
Revises: 
Create Date: 2026-01-01 01:01:07.487547

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '2c6bcac6aa31'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('employment_cycles',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('id_card', sa.String(length=18), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False),
    sa.Column('phone', sa.String(length=20), nullable=True),
    sa.Column('gender', sa.String(length=2), nullable=True),
    sa.Column('birthday', sa.Date(), nullable=True),
    sa.Column('hire_date', sa.Date(), nullable=False),
    sa.Column('departure_date', sa.Date(), nullable=True),
    sa.Column('status', sa.String(length=10), nullable=True),
    sa.Column('photo_path', sa.String(length=200), nullable=True),
    sa.Column('ethnic', sa.String(length=20), nullable=True),
    sa.Column('politics', sa.String(length=20), nullable=True),
    sa.Column('education', sa.String(length=20), nullable=True),
    sa.Column('household_province', sa.String(length=20), nullable=True),
    sa.Column('household_city', sa.String(length=20), nullable=True),
    sa.Column('household_district', sa.String(length=20), nullable=True),
    sa.Column('household_town', sa.String(length=20), nullable=True),
    sa.Column('household_detail', sa.String(length=100), nullable=True),
    sa.Column('residence_province', sa.String(length=20), nullable=True),
    sa.Column('residence_city', sa.String(length=20), nullable=True),
    sa.Column('residence_district', sa.String(length=20), nullable=True),
    sa.Column('residence_town', sa.String(length=20), nullable=True),
    sa.Column('residence_detail', sa.String(length=100), nullable=True),
    sa.Column('military_service', sa.Boolean(), nullable=True),
    sa.Column('enlistment_date', sa.Date(), nullable=True),
    sa.Column('unit_number', sa.String(length=50), nullable=True),
    sa.Column('branch', sa.String(length=50), nullable=True),
    sa.Column('discharge_date', sa.Date(), nullable=True),
    sa.Column('has_license', sa.Boolean(), nullable=True),
    sa.Column('license_date', sa.Date(), nullable=True),
    sa.Column('license_type', sa.String(length=20), nullable=True),
    sa.Column('license_expiry', sa.Date(), nullable=True),
    sa.Column('security_license_number', sa.String(length=50), nullable=True),
    sa.Column('security_license_date', sa.Date(), nullable=True),
    sa.Column('salary_mode', sa.String(length=20), nullable=True),
    sa.Column('position', sa.String(length=20), nullable=True),
    sa.Column('post', sa.String(length=20), nullable=True),
    sa.Column('emergency_name', sa.String(length=50), nullable=True),
    sa.Column('emergency_relation', sa.String(length=20), nullable=True),
    sa.Column('emergency_phone', sa.String(length=20), nullable=True),
    sa.Column('hat_size', sa.String(length=10), nullable=True),
    sa.Column('short_sleeve', sa.String(length=10), nullable=True),
    sa.Column('long_sleeve', sa.String(length=10), nullable=True),
    sa.Column('winter_uniform', sa.String(length=10), nullable=True),
    sa.Column('shoe_size', sa.String(length=10), nullable=True),
    sa.Column('room_id', sa.Integer(), nullable=True),
    sa.Column('is_room_leader', sa.Boolean(), nullable=True),
    sa.Column('bed_number', sa.String(length=50), nullable=True),
    sa.Column('archives', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['room_id'], ['rooms.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('employment_cycles', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_employment_cycles_id_card'), ['id_card'], unique=False)

    op.create_table('permissions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('key', sa.String(length=100), nullable=False),
    sa.Column('module', sa.String(length=50), nullable=False),
    sa.Column('action', sa.String(length=50), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.String(length=200), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('key'),
    sa.UniqueConstraint('module', 'action', name='uix_module_action')
    )
    op.create_table('rooms',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('number', sa.String(length=20), nullable=False),
    sa.Column('type', sa.String(length=20), nullable=True),
    sa.Column('area', sa.Float(), nullable=True),
    sa.Column('leader_id', sa.Integer(), nullable=True),
    sa.Column('x_pos', sa.Integer(), nullable=True),
    sa.Column('y_pos', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['leader_id'], ['employment_cycles.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('rooms', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_rooms_number'), ['number'], unique=True)

    op.create_table('shift_posts',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False),
    sa.Column('color', sa.String(length=20), nullable=True),
    sa.Column('default_start', sa.String(length=10), nullable=True),
    sa.Column('default_end', sa.String(length=10), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    op.create_table('shift_templates',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('data', sa.JSON(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('username', sa.String(length=18), nullable=False),
    sa.Column('password_hash', sa.String(length=128), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False),
    sa.Column('role', sa.String(length=20), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('created_by', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_users_username'), ['username'], unique=True)

    op.create_table('assets',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('type', sa.String(length=20), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('number', sa.String(length=50), nullable=True),
    sa.Column('total_quantity', sa.Integer(), nullable=True),
    sa.Column('stock_quantity', sa.Integer(), nullable=True),
    sa.Column('allocated_quantity', sa.Integer(), nullable=True),
    sa.Column('photo_path', sa.String(length=200), nullable=True),
    sa.Column('purchase_date', sa.Date(), nullable=True),
    sa.Column('location', sa.String(length=100), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('ownership', sa.String(length=20), nullable=True),
    sa.Column('unit_price', sa.Float(), nullable=True),
    sa.Column('bed_capacity', sa.Integer(), nullable=True),
    sa.Column('current_user_id', sa.Integer(), nullable=True),
    sa.Column('allocation_mode', sa.String(length=20), nullable=True),
    sa.Column('department', sa.String(length=50), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['current_user_id'], ['employment_cycles.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('number')
    )
    op.create_table('funds_records',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('date', sa.DateTime(), nullable=False),
    sa.Column('payer', sa.String(length=50), nullable=True),
    sa.Column('item', sa.String(length=100), nullable=True),
    sa.Column('amount', sa.Float(), nullable=False),
    sa.Column('note', sa.Text(), nullable=True),
    sa.Column('balance', sa.Float(), nullable=False),
    sa.Column('attachment', sa.String(length=255), nullable=True),
    sa.Column('operator_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['operator_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('operation_logs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('action_type', sa.String(length=50), nullable=True),
    sa.Column('target_type', sa.String(length=50), nullable=True),
    sa.Column('target_id', sa.Integer(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('ip_address', sa.String(length=50), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('schedulings',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('employee_id', sa.Integer(), nullable=False),
    sa.Column('date', sa.Date(), nullable=False),
    sa.Column('post_id', sa.Integer(), nullable=True),
    sa.Column('shift_type', sa.String(length=10), nullable=True),
    sa.Column('is_overtime', sa.Boolean(), nullable=True),
    sa.Column('hours', sa.Float(), nullable=True),
    sa.ForeignKeyConstraint(['employee_id'], ['employment_cycles.id'], ),
    sa.ForeignKeyConstraint(['post_id'], ['shift_posts.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('shift_schedules',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('date', sa.Date(), nullable=False),
    sa.Column('employee_id', sa.Integer(), nullable=False),
    sa.Column('post_id', sa.Integer(), nullable=True),
    sa.Column('start_time', sa.String(length=5), nullable=True),
    sa.Column('end_time', sa.String(length=5), nullable=True),
    sa.Column('is_duty_leader', sa.Boolean(), nullable=True),
    sa.Column('is_duty_chief', sa.Boolean(), nullable=True),
    sa.ForeignKeyConstraint(['employee_id'], ['employment_cycles.id'], ),
    sa.ForeignKeyConstraint(['post_id'], ['shift_posts.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('shift_schedules', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_shift_schedules_date'), ['date'], unique=False)

    op.create_table('user_permissions',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('permission_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['permission_id'], ['permissions.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'permission_id', name='uix_user_perm')
    )
    op.create_table('asset_allocations',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('asset_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('quantity', sa.Integer(), nullable=True),
    sa.Column('issue_date', sa.DateTime(), nullable=False),
    sa.Column('return_date', sa.DateTime(), nullable=True),
    sa.Column('note', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['asset_id'], ['assets.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['employment_cycles.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('asset_history',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('asset_id', sa.Integer(), nullable=False),
    sa.Column('action', sa.String(length=20), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('operator_id', sa.Integer(), nullable=True),
    sa.Column('quantity', sa.Integer(), nullable=True),
    sa.Column('action_date', sa.DateTime(), nullable=True),
    sa.Column('note', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['asset_id'], ['assets.id'], ),
    sa.ForeignKeyConstraint(['operator_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['employment_cycles.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('asset_instances',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('asset_id', sa.Integer(), nullable=False),
    sa.Column('sn_number', sa.String(length=100), nullable=True),
    sa.Column('room_id', sa.Integer(), nullable=True),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('last_check_date', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['asset_id'], ['assets.id'], ),
    sa.ForeignKeyConstraint(['room_id'], ['rooms.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['employment_cycles.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('asset_instances', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_asset_instances_sn_number'), ['sn_number'], unique=True)

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('asset_instances', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_asset_instances_sn_number'))

    op.drop_table('asset_instances')
    op.drop_table('asset_history')
    op.drop_table('asset_allocations')
    op.drop_table('user_permissions')
    with op.batch_alter_table('shift_schedules', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_shift_schedules_date'))

    op.drop_table('shift_schedules')
    op.drop_table('schedulings')
    op.drop_table('operation_logs')
    op.drop_table('funds_records')
    op.drop_table('assets')
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_users_username'))

    op.drop_table('users')
    op.drop_table('shift_templates')
    op.drop_table('shift_posts')
    with op.batch_alter_table('rooms', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_rooms_number'))

    op.drop_table('rooms')
    op.drop_table('permissions')
    with op.batch_alter_table('employment_cycles', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_employment_cycles_id_card'))

    op.drop_table('employment_cycles')
    # ### end Alembic commands ###


==================================================
FILE: .\migrations\versions\3beffaeb1228_新增通知表.py
==================================================

"""新增通知表

Revision ID: 3beffaeb1228
Revises: cbc23843eb6b
Create Date: 2026-01-05 11:46:33.542178

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '3beffaeb1228'
down_revision = 'cbc23843eb6b'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('notifications',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=100), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('is_read', sa.Boolean(), nullable=True),
    sa.Column('related_type', sa.String(length=50), nullable=True),
    sa.Column('related_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('notifications')
    # ### end Alembic commands ###


==================================================
FILE: .\migrations\versions\cbc23843eb6b_增加了资产子编号反向关联.py
==================================================

"""增加了资产子编号反向关联

Revision ID: cbc23843eb6b
Revises: 11f326d747a4
Create Date: 2026-01-01 16:10:27.077869

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'cbc23843eb6b'
down_revision = '11f326d747a4'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('employment_cycles', schema=None) as batch_op:
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=10),
               nullable=True)
        batch_op.drop_column('is_self_registered')

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('employment_cycles', schema=None) as batch_op:
        batch_op.add_column(sa.Column('is_self_registered', sa.BOOLEAN(), nullable=True))
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=10),
               nullable=False)

    # ### end Alembic commands ###


==================================================
FILE: .\routes\asset.py
==================================================

# 资产管理模块 - 完整版（支持消耗品、装备、固定资产）
import os
from flask import Blueprint, render_template, request, redirect, url_for, flash, send_file, jsonify, current_app
from flask_login import login_required, current_user
from models import db, Asset, AssetHistory, EmploymentCycle, AssetAllocation,AssetInstance,Room
from config import ASSET_STATUS, ASSET_TYPES
from utils import save_uploaded_file, parse_date, format_date,perm, log_action, today_str, delete_physical_file
from datetime import datetime
from io import BytesIO
import pandas as pd

asset_bp = Blueprint('asset', __name__, url_prefix='/asset')

# ==================== 资产列表 ====================
@asset_bp.route('/list')
@login_required
@perm.require('asset.view')
def asset_list():
    # 1. 获取筛选参数
    type_filter = request.args.get('type', '固定资产')  # 默认显示固定资产标签
    status_filter = request.args.get('status', '')    # 具体的某种状态过滤（如：维修中）
    search = request.args.get('search', '').strip()
    user_filter = request.args.get('user_id')
    
    # 2. 统计报修中的资产总数（用于标签页红点显示，类似人事的待审核）
    # 假设你的模型是 AssetInstance，如果是 Asset 请自行替换
    repair_count = Asset.query.filter_by(status='维修中').count()

    # 3. 构建基础查询
    query = Asset.query

    # 4. 类型过滤（对应标签页：装备、服饰、消耗品、固定资产、工具）
    if type_filter:
        query = query.filter_by(type=type_filter)
    
    # 5. 状态过滤（可选，用于在某个类型下进一步筛选状态）
    if status_filter:
        query = query.filter_by(status=status_filter)
        
    # 6. 使用人过滤
    if user_filter:
        query = query.filter_by(current_user_id=user_filter)

    # 7. 搜索过滤（支持名称和SN号/编号）
    if search:
        query = query.filter(
            db.or_(
                Asset.name.ilike(f'%{search}%'),
                Asset.number.ilike(f'%{search}%') 
            )
        )

    # 8. 字段显示控制（仿照人事逻辑）
    show_fields = request.args.getlist('show')
    if not show_fields:
        show_fields = ['name', 'number', 'status', 'location', 'current_user', 'ownership']  # 默认显示的字段

    # 9. 获取数据
    assets = query.order_by(Asset.id.desc()).all()
    in_service_employees = EmploymentCycle.query.filter_by(status='在职').order_by(EmploymentCycle.name).all()

    return render_template('asset/list.html',
                           assets=assets,
                           in_service_employees=in_service_employees,
                           type_filter=type_filter,
                           status_filter=status_filter,
                           search=search,
                           user_filter=user_filter,
                           show_fields=show_fields,
                           repair_count=repair_count)

# ==================== 核心资产保存逻辑函数 ==================== 
def perform_asset_save(form_data, files=None):
    """
    资产核心保存逻辑：从 form_data 读数据，执行资产入库。
    """
    # 基础数据获取 (兼容资产片段和财务片段的字段差异)
    asset_type = form_data.get('type') or form_data.get('asset_type', '其他')
    name = form_data.get('name') or form_data.get('item')
    quantity = int(form_data.get('quantity') or form_data.get('asset_qty', 1))
    
    # 金额处理：如果有单价用单价，没有则从总额折算
    if form_data.get('unit_price'):
        unit_price = float(form_data.get('unit_price'))
    elif form_data.get('amount'):
        unit_price = abs(float(form_data.get('amount'))) / quantity if quantity > 0 else 0
    else:
        unit_price = 0.0

    ownership = form_data.get('ownership', '特保队')
    prefix = form_data.get('number', '').strip() or f"SN-{datetime.now().strftime('%Y%m%d')}-"
    
    # 日期处理
    date_input = form_data.get('purchase_date') or form_data.get('date')
    purchase_date = parse_date(date_input) if date_input else datetime.now().date()

    # 图片处理
    photo_path = None
    if files:
        # 使用 .get() 安全获取文件对象
        photo_file = files.get('photo')
        # 确保文件对象存在且文件名不为空（用户确实选择了文件）
        if photo_file and photo_file.filename != '':
            photo_path = save_uploaded_file(photo_file, module='asset')

    # 创建资产对象
    asset = Asset(
        type=asset_type,
        name=name,
        number=prefix,
        total_quantity=quantity,
        stock_quantity=quantity,
        unit_price=unit_price,
        ownership=ownership,
        location=form_data.get('location', '待定'),
        purchase_date=purchase_date,
        bed_capacity=int(form_data.get('bed_capacity', 0)),
        photo_path=photo_path,
        status='库存',
    )
    db.session.add(asset)
    db.session.flush()

    # 3. 完整找回：子资产个体生成逻辑
    if asset_type == '固定资产' and quantity > 0:
        # 获取前端传来的自定义编号列表
        custom_suffixes = form_data.getlist('instance_numbers[]')
        for i in range(quantity):
            raw_suffix = custom_suffixes[i].strip() if i < len(custom_suffixes) else f"{i+1:03d}"
            # 序列号拼接逻辑：处理前缀重复情况
            full_sn = raw_suffix if prefix and raw_suffix.startswith(prefix) else f"{prefix}{raw_suffix}"
            if prefix and full_sn.startswith(prefix + prefix):
                full_sn = full_sn.replace(prefix + prefix, prefix)
            
            instance = AssetInstance(asset_id=asset.id, sn_number=full_sn, status='正常')
            db.session.add(instance)
    
    return asset

# ==================== 新增资产 ====================

@asset_bp.route('/get_form_snippet')
@login_required
def get_form_snippet():
    """供财务页面 AJAX 调用，返回资产表单 HTML"""
    return render_template('asset/_partial_asset_form.html', default_date=today_str())

@asset_bp.route('/add', methods=['GET', 'POST'])
@login_required
@perm.require('asset.add')
def asset_add():
    if request.method == 'POST':
        try:
            # 1. 保存资产
            asset = perform_asset_save(request.form, request.files)
            
            # 2. 检查联动开关 (sync_fund)
            sync_msg = ""
            if request.form.get('sync_fund') == 'on':
                from .fund import perform_fund_save
                # 调用财务保存函数
                perform_fund_save(request.form, current_user.id, request.files)
                sync_msg = "，并已同步登记财务支出"
            
            # 记录日志
            log_action(
                action_type="资产入库",
                target_type="Asset",
                target_id=asset.id,
                description=f"入库 {asset.name} x{asset.total_quantity}{sync_msg}"
            )

            db.session.commit()
            flash(f'资产 {asset.name} 入库成功{sync_msg}', 'success')
            return redirect(url_for('asset.asset_list'))
        except Exception as e:
            db.session.rollback()
            current_app.logger.error(f"Asset Add Error: {str(e)}")
            flash(f'入库失败: {str(e)}', 'danger')
            
    return render_template('asset/add.html', default_date=today_str())
# ==================== 编辑资产 ====================
@asset_bp.route('/edit/<int:asset_id>', methods=['GET', 'POST'])
@login_required
@perm.require('asset.edit')
def asset_edit(asset_id):
    from utils import log_action
    asset = Asset.query.get_or_404(asset_id)
    
    if request.method == 'POST':
        # 1. 在修改前，记录下所有的“旧值”
        old_values = {
            '类型': asset.type,
            '名称': asset.name,
            '编号': asset.number,
            '总数': asset.total_quantity,
            '购置日期': str(asset.purchase_date),
            '存放位置': asset.location or '未填写',
            '归属': asset.ownership or '未填写',
        }
        
        # 2. 接收新值
        new_type = request.form['type']
        new_name = request.form['name'].strip()
        new_total = int(request.form['total_quantity'])
        new_purchase_date = parse_date(request.form.get('purchase_date'))
        new_location = request.form.get('location', '').strip()
        new_ownership = request.form.get('ownership', '').strip()

        # 3. 比较哪些字段发生了变化
        changes = []
        if old_values['类型'] != new_type:
            changes.append(f"类型({old_values['类型']} -> {new_type})")
        if old_values['名称'] != new_name:
            changes.append(f"名称({old_values['名称']} -> {new_name})")
        if old_values['总数'] != new_total:
            changes.append(f"总数({old_values['总数']} -> {new_total})")
        if old_values['购置日期'] != str(new_purchase_date):
            changes.append(f"购置日期({old_values['购置日期']} -> {new_purchase_date})")
        if old_values['存放位置'] != (new_location or '未填写'):
            changes.append(f"位置({old_values['存放位置']} -> {new_location})")
        if old_values['归属'] != (new_ownership or '未填写'):
            changes.append(f"归属({old_values['归属']} -> {new_ownership})")

        # 4. 执行更新
        asset.type = new_type
        asset.name = new_name
        asset.total_quantity = new_total
        asset.purchase_date = new_purchase_date
        asset.location = new_location
        asset.ownership = new_ownership
        
        if 'photo' in request.files and request.files['photo'].filename != '':
            if asset.photo_path:
                delete_physical_file(asset.photo_path)
            asset.photo_path = save_uploaded_file(request.files['photo'], module='asset')
            changes.append("更新了资产照片")

        # 5. 写入审计日志
        if changes:
            log_desc = f"修改了资产【{old_values['名称']}】的项：{', '.join(changes)}"
        else:
            log_desc = f"打开并保存了资产【{asset.name}】，但未修改任何内容"

        log_action(
            action_type='编辑资产',
            target_type='Asset',
            target_id=asset.id,
            description=log_desc
        )
        
        db.session.commit()
        flash('资产信息更新成功', 'success')
        return redirect(url_for('asset.asset_detail', asset_id=asset.id))
    
    return render_template('asset/edit.html', asset=asset)
# ==================== 删除资产（谨慎使用） ====================
@asset_bp.route('/delete/<int:asset_id>', methods=['POST'])
@login_required
@perm.require('asset.delete')
def asset_delete(asset_id):
    asset = Asset.query.get_or_404(asset_id)
    try:
        # 获取照片路径
        photo_path = asset.photo_path
    
        # 强制清理：先删除所有关联的分配记录，再删除资产
        AssetAllocation.query.filter_by(asset_id=asset_id).delete()
        # 同理，如果历史记录也导致报错，也需要清理
        AssetHistory.query.filter_by(asset_id=asset_id).delete()
    
        db.session.delete(asset)
        db.session.commit()

        # 数据库删除成功后，清理物理文件
        if photo_path:
            from utils import delete_physical_file # 需在utils中定义此简单函数
            delete_physical_file(photo_path)

        flash('资产已删除', 'success')
    except Exception as e:
        db.session.rollback()
        flash(f'删除失败: {str(e)}', 'danger')
    return redirect(url_for('asset.asset_list'))

# ==================== 资产详情 ====================
@asset_bp.route('/detail/<int:asset_id>')
@login_required
@perm.require('asset.view')
def asset_detail(asset_id):
    asset = Asset.query.get_or_404(asset_id)
    in_service_employees = EmploymentCycle.query.filter_by(status='在职').order_by(EmploymentCycle.name).all()
    allocations = AssetHistory.query.filter_by(asset_id=asset_id, action='发放').all()
    page = request.args.get('page', 1, type=int) # 获取当前页码
    pagination = AssetHistory.query.filter_by(asset_id=asset_id)\
        .order_by(AssetHistory.action_date.desc())\
        .paginate(page=page, per_page=10, error_out=False) # 针对该资产的操作历史进行分页查询
    history_items = pagination.items# 获取当前页的历史记录列表
    
    return render_template('asset/detail.html',
                           asset=asset,
                           in_service_employees=in_service_employees,
                           pagination=pagination,  # 传递分页对象用于渲染页码)
                           history_items=history_items) # 传递当前页数据

# ==================== 发放资产（支持多数量） ====================
@asset_bp.route('/issue/<int:asset_id>', methods=['POST'])
@login_required
@perm.require('asset.issue')
def asset_issue(asset_id):
    from utils import log_action  # 确保局部导入，防止循环依赖
    asset = Asset.query.get_or_404(asset_id)
    user_id = request.form.get('user_id')
    quantity = int(request.form.get('quantity', 1))

    # 获取被发放人的信息（用于日志描述更友好）
    from models import EmploymentCycle
    emp = EmploymentCycle.query.get(user_id)
    emp_name = emp.name if emp else f"ID:{user_id}"
    
    if asset.stock_quantity < quantity:
        flash('库存不足', 'danger')
        return redirect(url_for('asset.asset_detail', asset_id=asset_id))
    
    # 更新库存
    asset.stock_quantity -= quantity
    asset.allocated_quantity += quantity
    asset.status = '使用中'
    
    # 发放后必须设置当前使用人
    asset.current_user_id = user_id
    

    # 记录个人领用
    allocation = AssetAllocation(
        asset_id=asset_id,
        user_id=user_id,
        quantity=quantity,
        issue_date=datetime.today().date(),
        note=request.form.get('note', '')
    )
    db.session.add(allocation)
    
    # 历史记录
    history = AssetHistory(
        asset_id=asset_id,
        action='发放',
        user_id=user_id,  # 被操作人
        operator_id=current_user.id,  # 操作人（当前登录用户）
        quantity=quantity,
        note=request.form.get('note', '')
    )
    db.session.add(history)
    # 4. 【新增】记录管理操作日志 (操作人维度的审计)
    log_action(
        action_type='发放资产',
        target_type='Asset',
        target_id=asset_id,
        description=f"向队员【{emp_name}】发放了资产：{asset.name} (编号:{asset.number})，数量：{quantity}",
        **locals()
    )
    db.session.commit()
    flash('发放成功', 'success')
    return redirect(url_for('asset.asset_detail', asset_id=asset_id))


# ==================== 归还资产（修复逻辑：校验数量并更新分配表） ====================
@asset_bp.route('/return/<int:asset_id>', methods=['POST'])
@login_required
@perm.require('asset.return')
def asset_return(asset_id):
    from utils import log_action  # 局部导入
    from datetime import datetime
    from models import EmploymentCycle

    asset = Asset.query.get_or_404(asset_id)
    user_id = request.form.get('user_id')
    quantity = int(request.form.get('quantity', 1))

    # 获取归还人姓名用于日志描述
    emp = EmploymentCycle.query.get(user_id)
    emp_name = emp.name if emp else f"ID:{user_id}"

    # 1. 查找该用户该资产下所有“未归还”的分配记录
    allocs = AssetAllocation.query.filter_by(asset_id=asset_id, user_id=user_id, return_date=None).all()
    allocations = AssetAllocation.query.filter_by(
        asset_id=asset_id, 
        user_id=user_id, 
        return_date=None
    ).all()
    
    # 校验用户持有的总数是否足够归还
    total_held = sum(a.quantity for a in allocations)
    if total_held < quantity:
        flash(f'归还失败：用户仅持有 {total_held} 个，无法归还 {quantity} 个', 'danger')
        return redirect(url_for('asset.asset_detail', asset_id=asset_id))
    
    # 2. 依次“核销”这些分配记录（先进先出原则）
    remaining_to_return = quantity
    now_time = datetime.now()
    for alloc in allocations:
        if remaining_to_return <= 0: break
        
        if alloc.quantity <= remaining_to_return:
            # 该笔记录全额归还，标记归还日期
            remaining_to_return -= alloc.quantity
            alloc.return_date = now_time
        else:
            # 该笔记录部分归还，需要拆分记录
            alloc.quantity -= remaining_to_return
            # 创建一条已归还的记录作为备份
            returned_part = AssetAllocation(
                asset_id=asset_id, user_id=user_id, quantity=remaining_to_return,
                issue_date=alloc.issue_date, return_date= now_time,
                note=f"部分归还自原记录"
            )
            db.session.add(returned_part)
            remaining_to_return = 0

    # 3. 更新资产主表的库存和分配数
    asset.stock_quantity += quantity
    asset.allocated_quantity -= quantity
    if asset.allocated_quantity <= 0:
        asset.status = '库存'
    
    # 4. 记录历史
    history = AssetHistory(
        asset_id=asset_id, action='归还', user_id=user_id,
        operator_id=current_user.id, quantity=quantity,
        action_date=datetime.now(), note=request.form.get('note', '')
    )
    db.session.add(history)
    # 5. 【核心新增】记录管理员操作审计日志
    log_action(
        action_type='归还资产',
        target_type='Asset',
        target_id=asset_id,
        description=f"回收了队员【{emp_name}】归还的资产：{asset.name} (编号:{asset.number})，数量：{quantity}",
        **locals()
    )
    db.session.commit()
    flash('归还成功', 'success')
    return redirect(url_for('asset.asset_detail', asset_id=asset_id))

# ==================== 批量发放归还 ====================
@asset_bp.route('/issue_from_hr', methods=['POST'])
@login_required
@perm.require('asset.issue')
def asset_issue_from_hr():
    from utils import log_action
    
    user_id = request.form.get('user_id')
    id_card = request.form.get('id_card')
    selected_asset_ids = request.form.getlist('asset_ids')
    note = request.form.get('note', '')
    
    if not selected_asset_ids:
        flash('未选择任何资产', 'warning')
        return redirect(url_for('hr.hr_detail', id_card=id_card))

    emp = EmploymentCycle.query.get_or_404(user_id)
    issued_items = []

    try:
        for aid in selected_asset_ids:
            qty = int(request.form.get(f'qty_{aid}', 0))
            if qty <= 0: continue
            
            asset = Asset.query.get(aid)
            if not asset or asset.stock_quantity < qty:
                flash(f'资产 {asset.name if asset else aid} 库存不足，已跳过', 'danger')
                continue

            # 1. 更新库存
            asset.stock_quantity -= qty
            asset.allocated_quantity += qty
            asset.status = '使用中'
            asset.current_user_id = user_id

            # 2. 领用记录
            allocation = AssetAllocation(
                asset_id=asset.id,
                user_id=user_id,
                quantity=qty,
                issue_date=datetime.today().date(),
                note=note
            )
            db.session.add(allocation)

            # 3. 资产历史
            history = AssetHistory(
                asset_id=asset.id,
                action='发放',
                user_id=user_id,
                operator_id=current_user.id,
                quantity=qty,
                note=f"入职发放: {note}"
            )
            db.session.add(history)
            
            issued_items.append(f"{asset.name} x{qty}")

        if issued_items:
            # 4. 【审计记录】
            log_action(
                action_type='发放资产',
                target_type='Asset',
                target_id=None, # 批量操作可设为None
                description=f"向队员【{emp.name}】发放了资产：{', '.join(issued_items)}。备注：{note}",
                **locals()
            )
            db.session.commit()
            flash(f'成功为 {emp.name} 发放资产：{", ".join(issued_items)}', 'success')
        else:
            db.session.rollback()

    except Exception as e:
        db.session.rollback()
        flash(f'发放失败：{str(e)}', 'danger')

    return redirect(url_for('hr.hr_detail', id_card=id_card))

# ==================== 消耗品消耗 ====================
@asset_bp.route('/consume/<int:asset_id>', methods=['POST'])
@login_required
@perm.require('asset.consume')
def asset_consume(asset_id):
    from utils import log_action  # 局部导入
    from datetime import datetime

    asset = Asset.query.get_or_404(asset_id)
    if asset.type != '消耗品':
        flash('仅消耗品可直接消耗', 'danger')
        return redirect(url_for('asset.asset_detail', asset_id=asset_id))

    quantity = int(request.form.get('quantity', 1))
    if asset.stock_quantity < quantity:
        flash('库存不足', 'danger')
        return redirect(url_for('asset.asset_detail', asset_id=asset_id))

    asset.stock_quantity -= quantity
    now_time = datetime.now() # 使用精确时间

    history = AssetHistory(
        asset_id=asset_id,
        action='消耗',
        user_id=current_user.id if current_user.is_authenticated else None,
        operator_id=current_user.id,  # 操作人
        quantity=quantity,
        action_date=now_time,
        note=request.form.get('note', '')
    )
    db.session.add(history)
    # 3. 【核心新增】记录管理员审计日志
    # 将备注信息也加入描述，方便管理人员追溯为什么消耗
    log_description = f"消耗了消耗品：{asset.name} (编号:{asset.number})，数量：{quantity}"
    if request:
        log_description += f"，备注：{request.form.get('note', '')}"

    log_action(
        action_type='资产消耗',
        target_type='Asset',
        target_id=asset_id,
        description=log_description
    )
    db.session.commit()
    flash(f'消耗 {quantity} 个成功，剩余 {asset.stock_quantity} 个', 'success')
    return redirect(url_for('asset.asset_detail', asset_id=asset_id))

# ==================== 补充库存（支持财务联动） ====================
@asset_bp.route('/supplement/<int:asset_id>', methods=['POST'])
@login_required
@perm.require('asset.supplement')
def asset_supplement(asset_id):
    from utils import log_action
    from models import FundsRecord

    asset = Asset.query.get_or_404(asset_id)
    quantity = int(request.form.get('quantity', 0))
    # 补充时是否记账
    is_sync = request.form.get('sync_fund') == 'on'
    raw_price = request.form.get('unit_price', '0').strip()
    unit_price = float(raw_price if raw_price else 0)

    if quantity <= 0:
        flash('数量无效', 'danger')
        return redirect(url_for('asset.asset_detail', asset_id=asset_id))
    
    asset.total_quantity += quantity
    asset.stock_quantity += quantity
    
    # 只有归属是特保队，且勾选了同步，才扣钱
    sync_desc = ""
    if asset.ownership == '特保队' and is_sync and unit_price > 0:
        total_cost = unit_price * quantity
        last_record = FundsRecord.query.order_by(FundsRecord.date.desc(), FundsRecord.id.desc()).first()
        last_balance = last_record.balance if last_record else 0
        
        new_fund = FundsRecord(
            date=datetime.now(),
            payer="特保队费",
            item=f"补充资产支出: {asset.name}",
            amount=-total_cost,
            balance=last_balance - total_cost,
            note=f"资产编号: {asset.number} (补充入库联动)",
            operator_id=current_user.id
        )
        db.session.add(new_fund)
        sync_desc = f"并同步扣款 {total_cost} 元"

    history = AssetHistory(
        asset_id=asset_id,
        action='补充',
        quantity=quantity,
        operator_id=current_user.id,
        action_date=datetime.now(),
        note=f"补充入库 {quantity} 个 {sync_desc}"
    )
    db.session.add(history)
    
    db.session.commit()
    flash(f'补充成功 {sync_desc}', 'success')
    return redirect(url_for('asset.asset_detail', asset_id=asset_id))
# ==================== 报废资产 ====================
@asset_bp.route('/scrap/<int:asset_id>', methods=['POST'])
@login_required
@perm.require('asset.scrap')
def asset_scrap(asset_id):
    from utils import log_action  # 局部导入
    from datetime import datetime

    # 获取资产对象，不存在则返回404
    asset = Asset.query.get_or_404(asset_id)
    
    # 获取表单提交的报废数量和原因
    try:
        quantity = int(request.form.get('quantity', 0))
    except ValueError:
        quantity = 0
    reason = request.form.get('reason', '').strip()
    
    # 1. 基础校验
    if quantity <= 0:
        flash('报废数量必须大于 0', 'danger')
        return redirect(url_for('asset.asset_detail', asset_id=asset_id))
    
    # 2. 业务校验：报废仅限库存部分，不扣除已分配（队员手中）的物资
    # 如果要报废队员手中的物资，必须先执行“归还”入库，再执行“报废”
    if quantity > asset.stock_quantity:
        flash(f'报废失败：当前库存仅余 {asset.stock_quantity}，无法报废 {quantity}。'
              f'若要报废已发放物资，请先执行“归还入库”操作。', 'danger')
        return redirect(url_for('asset.asset_detail', asset_id=asset_id))
    
    # 3. 执行扣减逻辑
    # 减少总数（资产家底真实减少）
    asset.total_quantity -= quantity
    # 减少库存（实物从仓库核销）
    asset.stock_quantity -= quantity
    
    # 4. 自动更新资产状态
    # 如果总数清零，则标记为报废状态；否则保持原状态（如：在库/领用中）
    if asset.total_quantity == 0:
        asset.status = '报废'
    
    # 5. 记录资产变更历史
    history = AssetHistory(
        asset_id=asset_id,
        action='报废',
        quantity=quantity,
        user_id=current_user.id,     # 责任人/关联人
        operator_id=current_user.id, # 实际操作人
        action_date=datetime.now(),
        note=f'报废原因: {reason}' if reason else '原因: 未备注'
    )
    db.session.add(history)
    
    # 6. 记录管理员审计日志
    log_description = f"执行资产报废：{asset.name}(编号:{asset.number})，数量：{quantity}。总数已同步扣减。"
    if reason:
        log_description += f" 备注原因：{reason}"

    log_action(
        action_type='资产报废',
        target_type='Asset',
        target_id=asset_id,
        description=log_description
    )
    
    # 提交数据库事务
    db.session.commit()
    
    flash(f'成功报废 {quantity} 个资产，库存及总数已更新', 'success')
    return redirect(url_for('asset.asset_detail', asset_id=asset_id))

# ==================== 固定资产维修 ====================
@asset_bp.route('/repair/<int:asset_id>', methods=['POST'])
@login_required
@perm.require('asset.repair')
def asset_repair(asset_id):
    from utils import log_action  # 局部导入
    from datetime import datetime

    asset = Asset.query.get_or_404(asset_id)
    if asset.type != '固定资产':
        flash('仅固定资产可添加维修记录', 'danger')
        return redirect(url_for('asset.asset_detail', asset_id=asset_id))

    note = request.form.get('note', '').strip()
    
    # 1. 变更资产状态
    asset.status = '维修中'
    now_time = datetime.now() # 使用精确时间

    # 2. 记录资产维度历史
    history = AssetHistory(
        asset_id=asset_id,
        action='维修',
        user_id=current_user.id,
        operator_id=current_user.id,
        action_date=now_time,
        note=note
    )
    db.session.add(history)

    # 3. 【核心新增】记录管理员审计日志
    log_description = f"将固定资产标记为维修状态：{asset.name} (编号:{asset.number})"
    if note:
        log_description += f"，故障/维修备注：{note}"

    log_action(
        action_type='资产维修',
        target_type='Asset',
        target_id=asset_id,
        description=log_description
    )

    db.session.commit()
    flash('维修记录添加成功，资产状态已更新为“维修中”', 'success')
    return redirect(url_for('asset.asset_detail', asset_id=asset_id))
# ==================== 固定资产修复完成 ====================
@asset_bp.route('/complete_repair/<int:asset_id>', methods=['POST'])
@login_required
@perm.require('asset.complete_repair')
def asset_complete_repair(asset_id):
    from utils import log_action  # 局部导入
    from datetime import datetime

    asset = Asset.query.get_or_404(asset_id)
    if asset.type != '固定资产':
        flash('仅固定资产可标记修复完成', 'danger')
        return redirect(url_for('asset.asset_detail', asset_id=asset_id))
    
    if asset.status != '维修中':
        flash('当前状态不是维修中，无法标记修复完成', 'warning')
        return redirect(url_for('asset.asset_detail', asset_id=asset_id))
    
    note = request.form.get('note', '').strip()
    
    # 1. 恢复资产状态
    asset.status = '正常'  # 标记为正常，即可重新发放使用
    now_time = datetime.now() # 使用精确时间

    # 2. 记录资产维度历史
    history = AssetHistory(
        asset_id=asset_id,
        action='修复完成',
        user_id=current_user.id,
        operator_id=current_user.id,
        action_date=now_time,
        note=note
    )
    db.session.add(history)

    # 3. 【核心新增】记录管理员审计日志
    log_description = f"确认资产维修完成：{asset.name} (编号:{asset.number})，已恢复正常状态"
    if note:
        log_description += f"，结算备注：{note}"

    log_action(
        action_type='维修完成',
        target_type='Asset',
        target_id=asset_id,
        description=log_description
    )

    db.session.commit()
    flash('资产已标记为修复完成，可重新投入使用', 'success')
    return redirect(url_for('asset.asset_detail', asset_id=asset_id))
# ==================== 子资产操作 ====================
# 子资产维修
@asset_bp.route('/repair_sub', methods=['POST'])
@login_required
@perm.require('asset.repair')
def asset_repair_sub():
    sub_asset_id = request.form.get('sub_asset_id')
    note = request.form.get('note', '').strip()
    instance = AssetInstance.query.get_or_404(sub_asset_id)
    
    instance.status = '维修'
    # 记录历史并关联主资产
    history = AssetHistory(
        asset_id=instance.asset_id,
        action='维修（单件）',
        operator_id=current_user.id,
        quantity=0, # 单件状态变更不影响库存总数
        note=f"SN: {instance.sn_number} | 备注: {note}"
    )
    db.session.add(history)
    db.session.commit()
    flash(f'子资产 {instance.sn_number} 已标记为维修状态', 'success')
    return redirect(url_for('asset.asset_detail', asset_id=instance.asset_id))

# 子资产报废
@asset_bp.route('/scrap_sub', methods=['POST'])
@login_required
@perm.require('asset.scrap')
def asset_scrap_sub():
    sub_asset_id = request.form.get('sub_asset_id')
    reason = request.form.get('note', '').strip() # 注意前端form里的textarea叫note
    instance = AssetInstance.query.get_or_404(sub_asset_id)
    asset = instance.asset_info
    
    instance.status = '报废'
    # 报废单件通常需要扣减主库存
    asset.total_quantity -= 1
    if asset.stock_quantity > 0:
        asset.stock_quantity -= 1
        
    history = AssetHistory(
        asset_id=asset.id,
        action='报废（单件）',
        operator_id=current_user.id,
        quantity=-1,
        note=f"SN: {instance.sn_number} | 原因: {reason}"
    )
    db.session.add(history)
    db.session.commit()
    flash(f'子资产 {instance.sn_number} 已成功报废', 'warning')
    return redirect(url_for('asset.asset_detail', asset_id=asset.id))
# 子资产维修完成（修复）
@asset_bp.route('/complete_repair_sub', methods=['POST'])
@login_required
@perm.require('asset.complete_repair')
def asset_complete_repair_sub():
    sub_asset_id = request.form.get('sub_asset_id')
    note = request.form.get('note', '').strip()
    
    # 找到该单件资产
    instance = AssetInstance.query.get_or_404(sub_asset_id)
    
    # 将状态从“维修”改回“正常”
    instance.status = '正常'
    
    # 记录历史
    history = AssetHistory(
        asset_id=instance.asset_id,
        action='维修完成（单件）',
        operator_id=current_user.id,
        quantity=0,
        note=f"SN: {instance.sn_number} 已修复。备注: {note}"
    )
    
    db.session.add(history)
    db.session.commit()
    
    flash(f'子资产 {instance.sn_number} 维修完成，已恢复正常状态', 'success')
    return redirect(url_for('asset.asset_detail', asset_id=instance.asset_id))

# ==================== 全局资产盘点（管理员专用） ====================
@asset_bp.route('/inventory')
@login_required
@perm.require('asset.inventory')  # 仅管理员/有权限用户可盘点
def asset_inventory():
    """全局资产盘点：显示所有资产，支持按状态/类型筛选"""
    type_filter = request.args.get('type', '')
    status_filter = request.args.get('status', '')
    
    # 全局查询所有资产个体（AssetInstance）
    query = AssetInstance.query.join(Asset).join(Room, isouter=True)
    
    # 筛选条件
    if type_filter:
        query = query.filter(Asset.type == type_filter)
    if status_filter:
        query = query.filter(AssetInstance.status == status_filter)
    
    assets = query.order_by(Asset.type, Asset.name, AssetInstance.sn_number).all()
    
    # 统计信息
    total = len(assets)
    normal = len([a for a in assets if a.status == '正常'])
    abnormal = total - normal
    
    return render_template('asset/inventory.html',
                           assets=assets,
                           type_filter=type_filter,
                           status_filter=status_filter,
                           total=total,
                           normal=normal,
                           abnormal=abnormal,
                           asset_types=ASSET_TYPES,
                           asset_status=ASSET_STATUS)

@asset_bp.route('/inventory/update/<int:asset_id>', methods=['POST'])
@login_required
@perm.require('asset.inventory')
def update_inventory(asset_id):
    """标记资产盘点状态"""
    asset = AssetInstance.query.get_or_404(asset_id)
    asset.last_check_date = datetime.now()
    # 支持更新资产状态（如维修→正常）
    new_status = request.json.get('status', asset.status)
    if new_status in ASSET_STATUS:
        asset.status = new_status
    db.session.commit()
    return jsonify({"status": "success", "message": f"资产 {asset.sn_number} 盘点成功"})

@asset_bp.route('/inventory/export')
@login_required
@perm.require('asset.inventory')
def export_inventory():
    """导出全局盘点清单"""
    from io import BytesIO
    import pandas as pd
    
    assets = AssetInstance.query.join(Asset).join(Room, isouter=True).all()
    data = []
    for a in assets:
        data.append({
            '资产类型': a.asset_info.type,
            '资产名称': a.asset_info.name,
            '资产编号': a.sn_number,
            '父类编号': a.asset_info.number,
            '存放位置': a.current_room.number if a.current_room else '待分配',
            '房间类型': a.current_room.type if a.current_room else '',
            '负责人': a.current_holder.name if a.current_holder else '无',
            '资产状态': a.status,
            '资产归属': a.asset_info.ownership or '',
            '上次盘点时间': format_date(a.last_check_date) or '未盘点',
            '购置日期': format_date(a.asset_info.purchase_date)
        })
    
    df = pd.DataFrame(data)
    output = BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='全局资产盘点清单')
    output.seek(0)
    
    filename = f"全局资产盘点清单_{datetime.today().strftime('%Y%m%d')}.xlsx"
    return send_file(
        output,
        as_attachment=True,
        download_name=filename,
        mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )


# ==================== 导出资产清单 ====================
@asset_bp.route('/export')
@login_required
@perm.require('asset.export')
def asset_export():
    type_filter = request.args.get('type')
    status_filter = request.args.get('status')
    user_filter = request.args.get('user_id')
    
    query = Asset.query
    if type_filter:
        query = query.filter_by(type=type_filter)
    if status_filter:
        query = query.filter_by(status=status_filter)
    if user_filter:
        query = query.filter_by(current_user_id=user_filter)
    
    assets = query.order_by(Asset.id.desc()).all()
    
    data = []
    for a in assets:
        data.append({
            '资产类型': a.type,
            '资产名称': a.name,
            '资产编号': a.number,
            '总数': a.total_quantity,
            '库存': a.stock_quantity,
            '已分配': a.allocated_quantity,
            '分配模式': a.allocation_mode,
            '部门': a.department or '',
            '当前使用人': a.current_user.name if a.current_user else '',
            '状态': a.status,
            '购置日期': format_date(a.purchase_date),
            '存放位置': a.location or '',
            '创建时间': format_date(a.created_at),
            '照片路径': a.photo_path or ''
        })
    
    df = pd.DataFrame(data)
    
    output = BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='资产清单')
    
    output.seek(0)
    
    filename = f"资产清单_{datetime.today().strftime('%Y%m%d')}.xlsx"
    return send_file(
        output,
        as_attachment=True,
        download_name=filename,
        mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )

# ==================== 批量导入资产 ====================
@asset_bp.route('/import', methods=['GET', 'POST'])
@login_required
@perm.require('asset.import')
def asset_import():
    if request.method == 'POST':
        if 'file' not in request.files:
            flash('未选择文件', 'danger')
            return redirect(request.url)
        
        file = request.files['file']
        if file.filename == '':
            flash('未选择文件', 'danger')
            return redirect(request.url)
        
        if file and file.filename.endswith('.xlsx'):
            try:
                df = pd.read_excel(file)
                
                # 必填列
                required_columns = ['资产类型', '资产名称', '资产编号']
                if not all(col in df.columns for col in required_columns):
                    flash('Excel必须包含列：资产类型、资产名称、资产编号', 'danger')
                    return redirect(request.url)
                
                success_count = 0
                error_rows = []
                
                for idx, row in df.iterrows():
                    try:
                        number = str(row['资产编号']).strip()
                        # 编号唯一校验
                        if Asset.query.filter_by(number=number).first():
                            error_rows.append(f"行{idx+2}: 资产编号 {number} 已存在")
                            continue
                        
                        qty = int(row.get('总数', 1) or 1)
                        if qty <= 0:
                            error_rows.append(f"行{idx+2}: 数量必须大于0")
                            continue
                        
                        asset = Asset(
                            type=str(row['资产类型']).strip(),
                            name=str(row['资产名称']).strip(),
                            number=number,
                            total_quantity=qty,
                            stock_quantity=qty,        # 初始库存 = 总数
                            allocated_quantity=0,
                            purchase_date=parse_date(row.get('购置日期')),
                            location=str(row.get('存放位置', '')),
                            allocation_mode=str(row.get('分配模式', 'personal')),
                            department=str(row.get('部门', '')) if row.get('分配模式') == 'group' else None,
                            status='库存',
                            photo_path=str(row.get('照片路径', '')) if row.get('照片路径') else None
                            
                        )
                        db.session.add(asset)
                        success_count += 1
                    except Exception as e:
                        error_rows.append(f"行{idx+2}: {str(e)}")
                
                db.session.commit()
                
                msg = f'导入完成：成功 {success_count} 条'
                if error_rows:
                    msg += f'，失败 {len(error_rows)} 条'
                    flash(msg, 'warning')
                    flash('<br>'.join(error_rows[:30]), 'danger')  # 只显示前30条错误
                else:
                    flash(msg, 'success')
                
                return redirect(url_for('asset.asset_list'))
            except Exception as e:
                flash(f'文件读取失败：{str(e)}', 'danger')
    
    return render_template('asset/import.html')

# 资产模块权限列表
ASSET_PERMISSIONS = [
    ('view', '查看资产', '查看资产列表和详情'),
    ('add', '新增资产', '新增资产记录'),
    ('edit', '编辑资产', '编辑资产信息'),
    ('issue', '发放资产', '发放资产给员工'),
    ('return', '归还资产', '归还资产'),
    ('consume', '消耗记录', '记录消耗品使用'),
    ('supplement', '补充库存', '补充资产库存'),
    ('repair', '维修记录', '记录维修'),
    ('complete_repair', '修复完成', '标记修复完成'),
    ('scrap', '报废资产', '报废资产'),
    ('delete', '删除资产', '删除资产记录'),
    ('inventory', '资产盘点', '进行资产盘点操作'),
    ('import', '批量导入资产', '从Excel导入资产'),
    ('export', '批量导出资产', '导出资产清单'),
]

==================================================
FILE: .\routes\auth.py
==================================================

# routes/auth.py
# 认证相关路由

from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_user, logout_user, current_user, login_required
from models import User, EmploymentCycle, db
from werkzeug.security import check_password_hash

auth_bp = Blueprint('auth', __name__)

@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    if current_user.is_authenticated:
        return redirect(url_for('main.index'))
    
    if request.method == 'POST':
        username = request.form['username'].strip()
        password = request.form['password']
        
        user = User.query.filter_by(username=username).first()
        if user and user.check_password(password):
            # 检查该账号是否已离职
            latest_cycle = EmploymentCycle.query.filter_by(id_card=username)\
                .order_by(EmploymentCycle.hire_date.desc()).first()
            
            if latest_cycle and latest_cycle.status == '离职':
                flash('该账号已离职，无法登录系统', 'danger')
                return redirect(url_for('auth.login'))



            login_user(user)
            flash('登录成功', 'success')
            return redirect(url_for('main.index'))
        else:
            flash('用户名或密码错误', 'danger')
    
    return render_template('auth/login.html')

@auth_bp.route('/logout')
def logout():
    logout_user()
    flash('已安全登出', 'info')
    return redirect(url_for('auth.login'))


#修改密码
@auth_bp.route('/change_password', methods=['GET', 'POST'])
@login_required
def change_password():
    if request.method == 'POST':
        old_password = request.form.get('old_password')
        new_password = request.form.get('new_password')
        confirm_password = request.form.get('confirm_password')

        # 1. 验证旧密码
        if not current_user.check_password(old_password):
            flash('原密码错误', 'danger')
            return redirect(url_for('auth.change_password'))

        # 2. 验证两次新密码是否一致
        if new_password != confirm_password:
            flash('两次输入的新密码不一致', 'danger')
            return redirect(url_for('auth.change_password'))
        
        # 3. 验证新密码长度（可选）
        if len(new_password) < 6:
            flash('新密码长度不能少于6位', 'danger')
            return redirect(url_for('auth.change_password'))

        # 4. 更新密码
        current_user.set_password(new_password)
        db.session.commit()
        
        flash('密码修改成功！', 'success')
        return redirect(url_for('main.index')) # 修改成功后跳回首页

    return render_template('auth/change_password.html')

==================================================
FILE: .\routes\dorm.py
==================================================

# routes/dorm.py
from flask import Blueprint, render_template, request, jsonify
from flask_login import login_required, current_user
from models import db, Room, EmploymentCycle, AssetInstance, Asset, OperationLog
from utils import perm, log_action
from config import ROOM_NUMBERS, ROOM_TYPES

# 定义蓝图，所有路径都会带上 /dorm 前缀
dorm_bp = Blueprint('dorm', __name__, url_prefix='/dorm')

# ========================================================
# 1. 数据库初始化路由 (一键生成房间与资产个体 + 更新已有房间属性)
# ========================================================
@dorm_bp.route('/init_data')
@login_required
@perm.require('dorm.view')
def init_dorm_data():
    """
    用途：同步配置中的房间到数据库（新增+更新属性），并补齐资产个体记录
    """
    # 1. 初始化/更新房间（核心：新增+更新逻辑）
    existing_rooms = Room.query.all()  # 查询所有已存在的房间
    existing_room_dict = {room.number: room for room in existing_rooms}  # 房间号→房间对象映射
    rooms_added = 0
    rooms_updated = 0  # 新增：统计更新的房间数
    
    for num in ROOM_NUMBERS:
        # 匹配房间属性（和之前一致，精准匹配）
        if num in ["101室", "102室", "103室", "104室", "105室"]:
            target_type = "宿舍"
        elif num == "106室":
            target_type = "备勤室"
        elif num == "107室":
            target_type = "队长办公室"
        elif num == "108室":
            target_type = "仓库"
        elif num == "109室":
            target_type = "机房"
        elif num == "110室":
            target_type = "洗浴间"
        elif num == "111室":
            target_type = "盥洗室"
        elif num == "112室":
            target_type = "卫生间"
        elif num == "113室":
            target_type = "走廊"
        else:
            target_type = "宿舍"  # 兜底默认
        
        # 核心逻辑：判断房间是否存在
        if num in existing_room_dict:
            # 房间已存在：检查属性是否需要更新
            existing_room = existing_room_dict[num]
            if existing_room.type != target_type:
                existing_room.type = target_type  # 更新属性
                rooms_updated += 1
        else:
            # 房间不存在：新增房间
            new_room = Room(
                number=num, 
                type=target_type, 
                x_pos=100,  # 初始坐标
                y_pos=100
            )
            db.session.add(new_room)
            rooms_added += 1
    
    # 2. 为固定资产生成个体 (AssetInstance)（不变，移到房间循环外）
    fixed_assets = Asset.query.filter_by(type='固定资产').all()
    instances_added = 0
    for a in fixed_assets:
        current_instances_count = AssetInstance.query.filter_by(asset_id=a.id).count()
        needed = a.total_quantity - current_instances_count
        if needed > 0:
            for i in range(needed):
                sn = f"{a.number or 'SN'}-{(current_instances_count + i + 1):03d}"
                new_instance = AssetInstance(asset_id=a.id, sn_number=sn, status='正常')
                db.session.add(new_instance)
                instances_added += 1
    
    try:
        db.session.commit()
        # 返回结果：明确新增和更新的数量
        return (f"初始化成功！<br>"
                f"新增房间：{rooms_added} 个<br>"
                f"更新属性的房间：{rooms_updated} 个<br>"
                f"补齐资产个体：{instances_added} 个")
    except Exception as e:
        db.session.rollback()
        return f"初始化失败，错误原因：{str(e)}"

# ========================================================
# 2. 宿舍地图页面路由 (合并后的逻辑)
# ========================================================
@dorm_bp.route('/map')
@login_required
@perm.require('dorm.view')
def dorm_map():
    """
    用途：渲染宿舍平面分布图页面，并区分住宿与不住宿人员名单
    """
    rooms = Room.query.all()
    
    # 1. 住宿人员名单：已分配房间的在职人员
    assigned_emps = EmploymentCycle.query.filter(
        EmploymentCycle.status == '在职', 
        EmploymentCycle.room_id.isnot(None),
        EmploymentCycle.gender == '男'
    ).all()
    
    # 2. 不住宿人员名单：未分配房间的在职人员
    unassigned_emps = EmploymentCycle.query.filter(
    EmploymentCycle.status == '在职',
    EmploymentCycle.room_id == None,
    EmploymentCycle.gender == '男' # 这样名单里就只会出现男性
).all()
    
    # 3. 待分配资产个体
    unassigned_assets = AssetInstance.query.filter_by(room_id=None).all()

    
    return render_template('dorm/map.html', 
                           rooms=rooms, 
                           assigned_emps=assigned_emps, 
                           unassigned_emps=unassigned_emps, 
                           unassigned_assets=unassigned_assets)


# ========================================================
# 3. 拖拽分配动作路由
# ========================================================
@dorm_bp.route('/assign', methods=['POST'])
@login_required
@perm.require('dorm.edit')
def assign_to_room():
    data = request.json
    target_room_id = data.get('room_id') 
    item_type = data.get('type')        
    item_id = data.get('id')              
    bed_id = data.get('bed_id')           
    is_leader = data.get('is_leader', False)  
    room_number = data.get('room_number', '')
    room_type = data.get('room_type', '')

    try:
        if item_type == 'asset':
            instance = AssetInstance.query.get_or_404(item_id)
            old_room_id = instance.room_id
            instance.room_id = target_room_id if target_room_id else None  # 修复这里！
            
            # 核心修复1：提前定义asset变量，避免未赋值
            asset = instance.asset_info
            leader = None  # 初始化leader变量
            
            # 资产拖入房间：关联宿舍长
            if target_room_id:
                # 查询房间的宿舍长
                leader = EmploymentCycle.query.filter(
                    EmploymentCycle.room_id == target_room_id,
                    EmploymentCycle.is_room_leader == True
                ).first()
                if leader:
                    instance.user_id = leader.id
                    asset.current_user_id = leader.id  # 用提前定义的asset
                # 同步存放位置
                asset.location = room_number
            else:
                # 资产拖回待分配池：清空关联
                instance.user_id = None
                asset.current_user_id = None  # 清空负责人
                asset.location = '待分配'  # 用提前定义的asset
            
            # 改为调用log_action
            full_sn = instance.sn_number
            leader_name = leader.name if leader else '无'
            operated_user_id = leader.id if leader else None  # 被操作人=宿舍长
            log_action(
                action_type="资产调拨",
                target_type="AssetInstance",
                target_id=instance.id,
                description = f"将资产：【{asset.name}】，编号：{full_sn} 移至{room_number if target_room_id else '待分配池'}，负责人：{leader_name}",
                **locals()
            )
        
        # 人员分配逻辑（保持不变）
        elif item_type == 'employee':
            emp = EmploymentCycle.query.get_or_404(item_id)
            old_room_id = emp.room_id
            
            if target_room_id:
                emp.room_id = target_room_id
                emp.bed_number = bed_id
                
                if is_leader:
                    # 取消原有宿舍长
                    EmploymentCycle.query.filter(
                        EmploymentCycle.room_id == target_room_id,
                        EmploymentCycle.is_room_leader == True
                    ).update({EmploymentCycle.is_room_leader: False})
                    emp.is_room_leader = True
                    
                    # 关联房间资产负责人
                    AssetInstance.query.filter(
                        AssetInstance.room_id == target_room_id
                    ).update({AssetInstance.user_id: emp.id})
                    
                    # 子查询更新Asset表
                    asset_ids = db.session.query(AssetInstance.asset_id).filter(
                        AssetInstance.room_id == target_room_id
                    ).distinct().subquery()
                    Asset.query.filter(
                        Asset.id.in_(asset_ids)
                    ).update({Asset.current_user_id: emp.id})
            else:
                # 人员拖回待分配池
                emp.room_id = None
                emp.bed_number = None
                if emp.is_room_leader:
                    emp.is_room_leader = False
                    # 清空资产负责人
                    AssetInstance.query.filter(
                        AssetInstance.room_id == old_room_id
                    ).update({AssetInstance.user_id: None})
                    
                    asset_ids = db.session.query(AssetInstance.asset_id).filter(
                        AssetInstance.room_id == old_room_id
                    ).distinct().subquery()
                    Asset.query.filter(
                        Asset.id.in_(asset_ids)
                    ).update({Asset.current_user_id: None})
            
            # ==================== 替换人员日志代码 ====================
            # 改为调用log_action
            leader_desc = "（宿舍长）" if is_leader else ""
            bed_desc = bed_id if bed_id else '无'
            if bed_desc and '-' in bed_desc:
                bed_parts = bed_desc.split('-')
                if len(bed_parts) >= 3:
                    asset_sn = f"{bed_parts[0]}-{bed_parts[1]}"
                    bed_pos = bed_parts[2]
                    asset_instance = AssetInstance.query.filter_by(sn_number=asset_sn).first()
                    if asset_instance and asset_instance.asset_info:
                        bed_desc = f"{asset_instance.asset_info.name} {asset_sn} {bed_pos}"
            
            log_action(
                action_type="人员调宿" + leader_desc,
                target_type="Employee",
                target_id=emp.id,
                description=f"将队员 【{emp.name}】 分配到{room_number if target_room_id else '待分配池'}，床位: {bed_desc} {leader_desc}",
                **locals()
            )
            # =========================================================
        
        db.session.commit()
        return jsonify({"status": "success"})
    except Exception as e:
        db.session.rollback()
        return jsonify({"status": "error", "message": str(e)}), 500

# 这是一个新增加的“查询接口”，请紧贴在上面那个函数下面粘贴
@dorm_bp.route('/get_available_beds/<int:room_id>')
@login_required
@perm.require('dorm.edit')
def get_available_beds(room_id):
    """查询房间里有哪些床位可以选（彻底放松条件）"""
    # 修复：去掉“Asset.type == '固定资产'”的限制，只保留核心条件
    assets = AssetInstance.query.join(Asset).filter(
        AssetInstance.room_id == room_id,          # 必须在该房间
        Asset.bed_capacity > 0,                    # 必须是床位类
        Asset.name.like('%床%')                    # 名称含“床”
    ).all()

    # 调试：打印所有匹配的资产（方便定位）
    print(f"房间{room_id}的床位资产数量：{len(assets)}")
    for inst in assets:
        print(f"资产名称：{inst.asset_info.name}，容量：{inst.asset_info.bed_capacity}，房间ID：{inst.room_id}")

    beds = []
    for inst in assets:
        cap = inst.asset_info.bed_capacity
        asset_name = inst.asset_info.name
        sn_number = inst.sn_number
        
        if cap == 2:
            labels = ["上铺", "下铺"]
        elif cap == 1:
            labels = ["单铺"]
        else:
            continue
        
        for label in labels:
            bed_code = f"{sn_number}-{label}"
            occ = EmploymentCycle.query.filter_by(bed_number=bed_code).first()
            
            beds.append({
                "code": bed_code,
                "asset_name": asset_name,
                "occupied": True if occ else False,
                "occupant": occ.name if occ else ""
            })

    # 调试：打印最终返回的床位数据
    print(f"最终返回的床位数据：{beds}")
    return jsonify(beds)
# ========================================================
# 4. 房间定位保存路由
# ========================================================
@dorm_bp.route('/save_room_pos', methods=['POST'])
@login_required
@perm.require('dorm.edit')
def save_room_pos():
    """持久化房间在地图上的 (x, y) 坐标"""
    data = request.json
    room_id = data.get('room_id')
    room = Room.query.get(room_id)
    if room:
        room.x_pos = data.get('x')
        room.y_pos = data.get('y')
        try:
            db.session.commit()
            return jsonify({"status": "success"})
        except Exception as e:
            return jsonify({"status": "error", "message": str(e)}), 500
    return jsonify({"status": "error", "message": "房间未找到"}), 404

# ========================================================
# 5. 调试工具：重置所有房间位置 (可选)
# ========================================================
@dorm_bp.route('/reset_positions')
@login_required
@perm.require('dorm.edit')
def reset_positions():
    """如果地图排版乱了，可以访问此路由将所有房间重置到左上角"""
    rooms = Room.query.all()
    for r in rooms:
        r.x_pos = 50
        r.y_pos = 50
    db.session.commit()
    return "已重置所有房间坐标，请重新在地图上排版。"

# 宿舍管理相关权限
DORM_PERMISSIONS = [
    ('view', '查看宿舍', '查看宿舍地图'),
    ('edit', '编辑宿舍', '编辑宿舍信息')
]

==================================================
FILE: .\routes\fund.py
==================================================

# routes/fund.py
# 资金管理模块 (已集成附件上传功能)

import os
from flask import Blueprint, render_template, request, redirect, url_for, flash, send_file, current_app
from flask_login import login_required, current_user
from models import db, FundsRecord, Asset
from utils import parse_date, format_date, perm, log_action, today_str
from datetime import datetime
from io import BytesIO
import pandas as pd
from werkzeug.utils import secure_filename

fund_bp = Blueprint('fund', __name__, url_prefix='/fund')

# ==================== 资金收支列表 ====================
@fund_bp.route('/list')
@login_required
@perm.require('fund.view')
def fund_list():
    # 筛选
    date_filter = request.args.get('date')
    payer_filter = request.args.get('payer')
    item_filter = request.args.get('item')
    
    # 自定义排序
    sort = request.args.get('sort', 'date_desc')
    valid_sorts = {
        'date_asc': FundsRecord.date.asc(),
        'date_desc': FundsRecord.date.desc(),
        'payer_asc': FundsRecord.payer.asc(),
        'payer_desc': FundsRecord.payer.desc(),
        'item_asc': FundsRecord.item.asc(),
        'item_desc': FundsRecord.item.desc(),
        'amount_asc': FundsRecord.amount.asc(),
        'amount_desc': FundsRecord.amount.desc(),
        'balance_asc': FundsRecord.balance.asc(),
        'balance_desc': FundsRecord.balance.desc(),
    }
    order = valid_sorts.get(sort, FundsRecord.date.desc())
    
    query = FundsRecord.query
    if date_filter:
        query = query.filter(FundsRecord.date == parse_date(date_filter))
    if payer_filter:
        query = query.filter(FundsRecord.payer.ilike(f'%{payer_filter}%'))
    if item_filter:
        query = query.filter(FundsRecord.item.ilike(f'%{item_filter}%'))
    
    records = query.order_by(order).all()
    total_balance = db.session.query(db.func.sum(FundsRecord.amount)).scalar() or 0
    
    return render_template('fund/list.html',
                           records=records,
                           total_balance=total_balance,
                           date_filter=date_filter,
                           payer_filter=payer_filter,
                           item_filter=item_filter,
                           sort=sort)

# ==================== 核心财务保存逻辑函数 ==================== 
def perform_fund_save(form_data, operator_id, files=None):
    """
    财务核心保存逻辑：从 form_data 读数据，执行财务入库。
    """
    # 1. 金额提取与计算逻辑
    # 优先取财务片段的 'amount'，若无则由资产片段的 'unit_price' * 'quantity' 计算
    if form_data.get('amount'):
        amount = float(form_data.get('amount'))
    elif form_data.get('unit_price') and form_data.get('quantity'):
        qty = int(form_data.get('quantity', 1))
        price = float(form_data.get('unit_price', 0))
        amount = -(qty * price)  # 资产买入默认为支出，转为负数
    else:
        amount = 0.0

    # 2. 字段对齐（兼容资产联动传参）
    item = form_data.get('item') or f"采购资产入库: {form_data.get('name', '未命名资产')}"
    payer = form_data.get('payer') or form_data.get('ownership', '特保队')
    note = form_data.get('note') or form_data.get('asset_note', '')
    
    # 3. 日期处理
    date_input = form_data.get('date') or form_data.get('purchase_date')
    if date_input:
        selected_date = parse_date(date_input)
        record_datetime = datetime.combine(selected_date, datetime.now().time())
    else:
        record_datetime = datetime.now()

    # 4. 附件/凭证上传逻辑
    attachment_path = None
    if 'attachment' in request.files:
        file = request.files['attachment']
        # 只有当用户确实选择了文件时，才执行保存
        if file and file.filename != '':
            from utils import save_uploaded_file
            # 必须在 if 内部执行保存，确保 file 变量是有效的
            attachment_path = save_uploaded_file(file, module='funds')

    # 最后将 attachment_path 存入数据库
    # new_record.attachment = attachment_path

    # 5. 余额计算（基于最新一条记录）
    last_record = FundsRecord.query.order_by(FundsRecord.date.desc(), FundsRecord.id.desc()).first()
    last_balance = last_record.balance if last_record else 0
    new_balance = last_balance + amount

    # 6. 创建财务记录
    record = FundsRecord(
        date=record_datetime,
        payer=payer,
        item=item,
        amount=amount,
        note=note,
        balance=new_balance,
        attachment=attachment_path,
        operator_id=operator_id,
    )
    db.session.add(record)
    db.session.flush()
    return record

# ==================== 添加收支记录 ====================

@fund_bp.route('/get_form_snippet')
@login_required
def get_fund_form_snippet():
    """供资产页面 AJAX 调用，返回财务表单 HTML"""
    return render_template('fund/_partial_fund_form.html', default_date=today_str())

@fund_bp.route('/add', methods=['GET', 'POST'])
@login_required
def fund_add():
    if request.method == 'POST':
        try:
            # 1. 保存财务记录
            record = perform_fund_save(request.form, current_user.id, request.files)
            
            # 2. 检查联动开关 (sync_asset)
            sync_msg = ""
            if request.form.get('sync_asset') == 'on':
                from .asset import perform_asset_save
                # 调用资产保存函数
                perform_asset_save(request.form, request.files)
                sync_msg = "，并已同步登记资产入库"

            # 记录日志
            log_action(
                action_type="财务新增",
                target_type="FundsRecord",
                target_id=record.id,
                description=f"记录 {record.item} 金额 {record.amount}{sync_msg}"
            )

            db.session.commit()
            flash(f'财务记录保存成功{sync_msg}', 'success')
            return redirect(url_for('fund.fund_list'))

        except Exception as e:
            db.session.rollback()
            current_app.logger.error(f"Fund Add Error: {str(e)}")
            flash(f'保存失败：{str(e)}', 'danger')

    return render_template('fund/add.html', default_date=today_str())

# ==================== 3. 批量导入（全格式日期兼容版） ====================
@fund_bp.route('/import', methods=['GET', 'POST'])
@login_required
@perm.require('fund.import')
def fund_import():
    from models import User
    if request.method == 'POST':
        file = request.files.get('file')
        if not file: return redirect(request.url)
        
        try:
            df = pd.read_excel(file)
            df.columns = [col.strip() for col in df.columns]
            
            last_rec = FundsRecord.query.order_by(FundsRecord.id.desc()).first()
            current_bal = last_rec.balance if last_rec else 0
            
            for idx, row in df.iterrows():
                amt = float(row['金额'])
                current_bal += amt
                
                # --- 1. 处理操作人 ---
                op_name = str(row.get('操作人', '')).strip()
                user = User.query.filter_by(name=op_name).first()
                final_op_id = user.id if user else current_user.id
                
                # --- 2. 处理凭证文件名 (解决 final_attachment 定义问题) ---
                excel_attachment = str(row.get('凭证', '')).strip()
                # 预设变量，确保它一定被定义
                current_attachment_value = None 
                
                # 只要不是无效字符，就取 Excel 里的文件名
                if excel_attachment and excel_attachment.lower() != 'nan' and excel_attachment != '无':
                    current_attachment_value = excel_attachment

                record = FundsRecord(
                    date=pd.to_datetime(row['日期']).to_pydatetime(),
                    payer=str(row['资方']).strip(),
                    item=str(row['项目']).strip(),
                    amount=amt,
                    note=str(row.get('备注', '')).strip() if pd.notna(row.get('备注')) else '',
                    balance=current_bal,
                    attachment=current_attachment_value, # 存入文件名，网页就会生成链接
                    operator_id=final_op_id
                )
                db.session.add(record)
            
            db.session.commit()
            flash('数据导入成功，凭证链接已关联', 'success')
            return redirect(url_for('fund.fund_list'))
        except Exception as e:
            db.session.rollback()
            flash(f'导入失败：{str(e)}', 'danger')
            
    return render_template('fund/import.html')
# ==================== 4. 导出清单（字段：日期|资方|项目|金额|类型|操作人|凭证|备注|余额） ====================
@fund_bp.route('/export')
@login_required
@perm.require('fund.export')
def fund_export():
    # 获取当前筛选下的所有记录
    records = FundsRecord.query.order_by(FundsRecord.date.desc()).all()
    
    data = []
    for r in records:
        data.append({
            '日期': r.date.strftime('%Y-%m-%d %H:%M') if r.date else '',
            '资方': r.payer,
            '项目': r.item,
            '金额': r.amount,
            '类型': '收入' if r.amount >= 0 else '支出',
            '操作人': r.operator.name if r.operator else '系统',
            '凭证': r.attachment if r.attachment else '无',
            '备注': r.note
        })
    
    df = pd.DataFrame(data)
    # 按照你要求的顺序重新排序列（确保万一）
    column_order = ['日期', '资方', '项目', '金额', '类型', '操作人', '备注', '凭证']
    df = df[column_order]

    output = BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='资金收支明细')
    output.seek(0)
    
    curr_time = datetime.now().strftime('%Y%m%d_%H%M')
    return send_file(output, as_attachment=True, 
                     download_name=f"财务导出_{curr_time}.xlsx",
                     mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')

FUND_PERMISSIONS = [
    ('view', '查看资金', '查看资金收支列表'),
    ('add', '新增资金', '手动添加收支记录'),
    ('import', '导入资金', '通过Excel批量导入'),
    ('export', '导出资金', '导出资金明细到Excel'),
]

==================================================
FILE: .\routes\hr.py
==================================================

# routes/hr.py
# 人事管理模块所有路由（已模块化）

from flask import Blueprint, render_template, request, redirect, url_for, flash, jsonify, json, send_file
from flask_login import login_required, current_user
from models import Asset, db, EmploymentCycle, User, AssetHistory
from utils import (
    validate_id_card, validate_phone, get_gender_from_id_card, get_birthday_from_id_card,
    save_uploaded_file, get_ethnic_options, get_politics_options, get_education_options,
    parse_date, format_date, today_str,get_unreturned_assets, perm
)
from config import SALARY_MODES, POSITIONS, POSTS
from datetime import datetime, timedelta
from sqlalchemy import or_
import pandas as pd
from io import BytesIO
from models import AssetAllocation
import qrcode
import io
import base64

hr_bp = Blueprint('hr', __name__, url_prefix='/hr')

# ==================== 花名册列表 ====================
@hr_bp.route('/list')
@login_required
def hr_list():
    # 逻辑：如果没有【人事管理钥匙】，说明是普通队员，直接踢到他自己的详情页
    if not perm.can('hr.view'):
        return redirect(url_for('hr.hr_detail', id_card=current_user.username))
    # 标签页
    status_filter = request.args.get('status', '在职')
    if status_filter not in ['待审核', '在职', '离职']:
        status_filter = '在职'
    # 2. 统计所有待审核人数（无论当前在哪个标签页都统计，用于红点显示）
    pending_count = EmploymentCycle.query.filter_by(status='待审核').count()

    # 搜索
    search = request.args.get('search', '').strip()
    sort = request.args.get('sort', 'hire_date_desc')
    

    # 排序
    sort = request.args.get('sort', 'hire_date_desc')
    valid_sorts = {
        'name_asc': EmploymentCycle.name.asc(),
        'name_desc': EmploymentCycle.name.desc(),
        'id_card_asc': EmploymentCycle.id_card.asc(),
        'id_card_desc': EmploymentCycle.id_card.desc(),
        'phone_asc': EmploymentCycle.phone.asc(),
        'phone_desc': EmploymentCycle.phone.desc(),
        'hire_date_asc': EmploymentCycle.hire_date.asc(),
        'hire_date_desc': EmploymentCycle.hire_date.desc(),
        'position_asc': EmploymentCycle.position.asc(),
        'position_desc': EmploymentCycle.position.desc(),
        'post_asc': EmploymentCycle.post.asc(),
        'post_desc': EmploymentCycle.post.desc(),
        'salary_mode_asc': EmploymentCycle.salary_mode.asc(),
        'salary_mode_desc': EmploymentCycle.salary_mode.desc()
    }
    order = valid_sorts.get(sort, EmploymentCycle.hire_date.desc())

    
   
        # 其他角色显示所有人最新周期
    subquery = db.session.query(
            EmploymentCycle.id_card,
            db.func.max(EmploymentCycle.hire_date).label('max_hire_date')
        ).group_by(EmploymentCycle.id_card).subquery()
        
    query = EmploymentCycle.query.join(
            subquery,
            db.and_(
                EmploymentCycle.id_card == subquery.c.id_card,
                EmploymentCycle.hire_date == subquery.c.max_hire_date
            )
        )
        
    # 5. 【核心修改：状态严格过滤】
    # 这里的 status_filter 必须是互斥的
    if status_filter == '待审核':
        query = query.filter(EmploymentCycle.status == '待审核')
    elif status_filter == '离职':
        query = query.filter(EmploymentCycle.status == '离职')
    else:
        # 默认 '在职' 模式下，坚决不显示 '待审核' 的人
        query = query.filter(EmploymentCycle.status == '在职')

    # 6. 搜索过滤
    if search:
        query = query.filter(
            db.or_(
                EmploymentCycle.name.ilike(f'%{search}%'),
                EmploymentCycle.id_card.ilike(f'%{search}%'),
                EmploymentCycle.phone.ilike(f'%{search}%')
            )
        )
            # 字段显示控制（默认全部显示）
    show_fields = request.args.getlist('show')
    if not show_fields:
        show_fields = [
        'name', 'id_card', 'phone', 'position', 'post', 'salary_mode', 
        'hire_date', 'tenure', 'gender', 'birthday', 'ethnic', 'politics', 
        'education', 'household_address', 'residence_address', 'military', 
        'license', 'security_license', 'emergency', 'uniform'
    ]


    # 搜索过滤
    if search:
        query = query.filter(
            db.or_(
                EmploymentCycle.name.ilike(f'%{search}%'),
                EmploymentCycle.id_card.ilike(f'%{search}%'),
                EmploymentCycle.phone.ilike(f'%{search}%')
            )
        )

    employees = query.order_by(order).all()

    return render_template('hr/list.html',
                           employees=employees,
                           search=search,
                           status_filter=status_filter,
                           sort=sort,
                           show_fields=show_fields,
                           pending_count=pending_count)

# ==================== 新增员工 ====================
@hr_bp.route('/add', methods=['GET', 'POST'])
@login_required
@perm.require('hr.add')
def hr_add():
    from utils import log_action  # 局部导入工具函数
    import json
    from datetime import datetime
    if request.method == 'POST':
        id_card = request.form['id_card'].strip()
        name = request.form['name'].strip()
        phone = request.form['phone'].strip()
        
        if not all([name, id_card, phone]):
            flash('姓名、身份证、手机为必填项', 'danger')
            return redirect(url_for('hr.hr_add'))
        
        if not validate_id_card(id_card):
            flash('身份证号码无效', 'danger')
            return redirect(url_for('hr.hr_add'))
        
        if not validate_phone(phone):
            flash('手机号码格式错误', 'danger')
            return redirect(url_for('hr.hr_add'))
        
        if EmploymentCycle.query.filter_by(id_card=id_card, status='在职').first():
            flash('该身份证当前在职，不能重复入职', 'danger')
            return redirect(url_for('hr.hr_add'))
        
        gender = get_gender_from_id_card(id_card)
        birthday = get_birthday_from_id_card(id_card)
        
        photo_path = None
        if 'photo' in request.files and request.files['photo'].filename:
            avatar_path = save_uploaded_file(request.files.get('avatar'), module='avatar')
        
        # 收集其他证书
        other_certs = []
        i = 0
        while f'cert_name_{i}' in request.form:
            cert_name = request.form.get(f'cert_name_{i}')
            cert_number = request.form.get(f'cert_number_{i}')
            cert_date = request.form.get(f'cert_date_{i}')
            if cert_name and cert_number and cert_date:
                other_certs.append({'name': cert_name, 'number': cert_number, 'date': cert_date})
            i += 1
        
        archives = None
        if other_certs:
            archives = json.dumps({'other_certificates': other_certs}, ensure_ascii=False)
        
        cycle = EmploymentCycle(
            id_card=id_card,#身份证
            name=name,#姓名
            phone=phone,#电话
            gender=gender,#性别
            birthday=birthday,#生日
            hire_date=parse_date(request.form.get('hire_date')) or datetime.today().date(),#入职日期
            status='在职',
            photo_path=photo_path,#照片路径
            ethnic=request.form.get('ethnic'),#民族
            politics=request.form.get('politics'),#政治面貌
            education=request.form.get('education'),#学历
            household_province=request.form.get('household_province'),#户籍省
            household_city=request.form.get('household_city'),#户籍市
            household_district=request.form.get('household_district'),#户籍区
            household_town=request.form.get('household_town'),#户籍镇
            household_detail=request.form.get('household_detail'),#户籍详址
            residence_province=request.form.get('residence_province'),#居住省
            residence_city=request.form.get('residence_city'),#居住市
            residence_district=request.form.get('residence_district'),#居住区
            residence_town=request.form.get('residence_town'),#居住镇
            residence_detail=request.form.get('residence_detail'),#居住详址
            military_service='military_service' in request.form,#兵役情况
            enlistment_date=parse_date(request.form.get('enlistment_date')),#入伍日期
            unit_number=request.form.get('unit_number'),#部队番号
            branch=request.form.get('branch'),#兵种
            discharge_date=parse_date(request.form.get('discharge_date')),#退伍日期
            has_license='has_license' in request.form,#是否有驾照
            license_date=parse_date(request.form.get('license_date')),#领证日期
            license_type=request.form.get('license_type'),#驾照类型
            license_expiry=parse_date(request.form.get('license_expiry')),#驾照到期
            security_license_number=request.form.get('security_license_number'),#保安证号
            security_license_date=parse_date(request.form.get('security_license_date')),#保安证日期
            salary_mode=request.form['salary_mode'],#薪资模式
            emergency_name=request.form.get('emergency_name'),#紧急联系人
            emergency_relation=request.form.get('emergency_relation'),#联系人关系
            emergency_phone=request.form.get('emergency_phone'),#联系人电话
            position=request.form['position'],#职位
            post=request.form['post'],#岗位
            hat_size=request.form.get('hat_size'),#帽子尺寸
            short_sleeve=request.form.get('short_sleeve'),#短袖尺寸
            long_sleeve=request.form.get('long_sleeve'),#长袖尺寸
            winter_uniform=request.form.get('winter_uniform'),#冬装尺寸
            shoe_size=request.form.get('shoe_size'),#鞋码
            archives=archives#其他证书档案
        )
        
        db.session.add(cycle)
        db.session.flush() # 预生成 cycle.id
        
        # 自动创建账号（角色固定为 member）
        user_created_msg = ''
        if not User.query.filter_by(username=id_card).first():
            default_password = id_card[-6:]
            new_user = User(
                username=id_card,
                name=name,
                role='member'  # 固定为队员，不根据职务设置
           )
            new_user.set_password(default_password)
            db.session.add(new_user)
            user_created_msg = '（账号已自动创建）'
        # 【核心新增】记录管理员审计日志
        log_action(
            action_type='人员入职',
            target_type='Employee',
            target_id=cycle.id,
            description=f"办理了队员入职：{name} (身份证:{id_card})，职位：{cycle.position}-{cycle.post}{user_created_msg}",
            **locals()
        )
        db.session.commit()
        flash(f'{name} 入职成功！', 'success')
        if user_created_msg:
            flash(f'账号自动创建成功！用户名：{id_card}，初始密码：{default_password}（请及时修改）', 'info')

        return redirect(url_for('hr.hr_detail', id_card=id_card))
    
    return render_template('hr/add.html',
                           ethnic_options=get_ethnic_options(),
                           politics_options=get_politics_options(),
                           education_options=get_education_options(),
                           salary_modes=SALARY_MODES,
                           positions=POSITIONS,
                           posts=POSTS)


# ==================== 队员自主登记 ====================
@hr_bp.route('/self_register', methods=['GET', 'POST'])
def self_register():
    from datetime import datetime
    import json
    if request.method == 'POST':
        name = request.form.get('name', '').strip()
        id_card = request.form.get('id_card', '').strip()
        phone = request.form.get('phone', '').strip()
        
        if not name or not id_card:
            flash("姓名和身份证号为必填项", "danger")
            return redirect(url_for('hr.self_register'))

        gender = get_gender_from_id_card(id_card)
        birthday = get_birthday_from_id_card(id_card)

        # --- 核心修复：扫码入职日期强控 ---
        hire_date_raw = request.form.get('hire_date')
        if hire_date_raw:
            try:
                final_hire_date = datetime.strptime(hire_date_raw, '%Y-%m-%d').date()
            except:
                final_hire_date = datetime.today().date()
        else:
            final_hire_date = datetime.today().date()

        photo_path = None
        file_obj = request.files.get('photo')
        if file_obj and file_obj.filename:
            photo_path = save_uploaded_file(file_obj, module='avatar')
        else:
            photo_path = 'uploads/default-avatar.png'

        other_certs = []
        i = 0
        while f'cert_name_{i}' in request.form:
            c_name = request.form.get(f'cert_name_{i}')
            c_num = request.form.get(f'cert_number_{i}')
            c_date = request.form.get(f'cert_date_{i}')
            if c_name and c_num:
                other_certs.append({'name': c_name, 'number': c_num, 'date': c_date})
            i += 1
        archives = json.dumps({'other_certificates': other_certs}, ensure_ascii=False) if other_certs else None

        new_emp = EmploymentCycle(
            id_card=id_card,#身份证
            name=name,#姓名
            phone=phone,#电话
            gender=gender,#性别
            birthday=birthday,#生日
            hire_date=final_hire_date,#入职日期
            status='待审核',#状态
            photo_path=photo_path,#照片路径
            ethnic=request.form.get('ethnic'),#民族
            politics=request.form.get('politics'),#政治面貌
            education=request.form.get('education'),#学历
            household_province=request.form.get('household_province'),#户籍省
            household_city=request.form.get('household_city'),#户籍市
            household_district=request.form.get('household_district'),#户籍区
            household_town=request.form.get('household_town'),#户籍镇
            household_detail=request.form.get('household_detail'),#户籍详址
            residence_province=request.form.get('residence_province'),#居住省
            residence_city=request.form.get('residence_city'),#居住市
            residence_district=request.form.get('residence_district'),#居住区
            residence_town=request.form.get('residence_town'),#居住镇
            residence_detail=request.form.get('residence_detail'),#居住详址
            military_service='military_service' in request.form,#兵役情况
            enlistment_date=parse_date(request.form.get('enlistment_date')),#入伍日期
            unit_number=request.form.get('unit_number'),#部队番号
            branch=request.form.get('branch'),#兵种
            discharge_date=parse_date(request.form.get('discharge_date')),#退伍日期
            has_license='has_license' in request.form,#是否有驾照
            license_date=parse_date(request.form.get('license_date')),#领证日期
            license_type=request.form.get('license_type'),#驾照类型
            license_expiry=parse_date(request.form.get('license_expiry')),#驾照到期
            security_license_number=request.form.get('security_license_number'),#保安证号
            security_license_date=parse_date(request.form.get('security_license_date')),#保安证日期
            emergency_name=request.form.get('emergency_name'),#紧急联系人
            emergency_relation=request.form.get('emergency_relation'),#联系人关系
            emergency_phone=request.form.get('emergency_phone'),#联系人电话
            position=request.form['position'],#职位
            post=request.form['post'],#岗位
            hat_size=request.form.get('hat_size'),#帽子尺寸
            short_sleeve=request.form.get('short_sleeve'),#短袖尺寸
            long_sleeve=request.form.get('long_sleeve'),#长袖尺寸
            winter_uniform=request.form.get('winter_uniform'),#冬装尺寸
            shoe_size=request.form.get('shoe_size'),#鞋码
            archives=archives,#其他证书档案
            salary_mode=request.form['salary_mode'],#薪资模式
        )

        try:
            db.session.add(new_emp)
            db.session.commit()
            return render_template('hr/register_success.html')
        except Exception as e:
            db.session.rollback()
            return f"提交失败。详情: {str(e)}", 500

    from config import SALARY_MODES, POSITIONS, POSTS
    from utils import get_ethnic_options, get_politics_options, get_education_options, today_str
    return render_template('hr/self_register.html', 
                           employee=None, 
                           is_self_register=True, 
                           salary_modes=SALARY_MODES,
                           positions=POSITIONS,
                           posts=POSTS,
                           ethnic_options=get_ethnic_options(),
                           politics_options=get_politics_options(),
                           education_options=get_education_options(),
                           today_str=today_str)
# ==================== 管理员审核 (修复版) ====================
@hr_bp.route('/approve_pending/<int:id>', methods=['POST'])
@login_required
@perm.require('hr.edit')
def approve_pending(id):
    from utils import log_action # 确保导入日志工具
    emp = EmploymentCycle.query.get_or_404(id)
    
    if emp.status != '待审核':
        flash('该记录不是待审核状态，无法批准', 'warning')
        return redirect(url_for('hr.hr_list', status='待审核'))
    
    # 1. 检查冲突
    existing = EmploymentCycle.query.filter(
        EmploymentCycle.id_card == emp.id_card,
        EmploymentCycle.status == '在职'
    ).first()
    if existing:
        flash('身份证已存在于在职员工，无法批准', 'danger')
        return redirect(url_for('hr.hr_list', status='待审核'))
    
    # 2. 变更状态
    emp.status = '在职'
    if not emp.hire_date:
        emp.hire_date = datetime.today().date()
    
    # 3. 【修复】自动创建账号逻辑
    user_created_msg = ''
    # 检查 User 表中是否已有该身份证的账号
    if not User.query.filter_by(username=emp.id_card).first():
        default_password = emp.id_card[-6:]  # 身份证后六位
        new_user = User(
            username=emp.id_card,
            name=emp.name,
            role='member'  # 角色固定为队员
        )
        new_user.set_password(default_password)
        db.session.add(new_user)
        user_created_msg = f'（账号已自动创建，默认密码为身份证后6位）'
    else:
        user_created_msg = '（账号已存在，无需重复创建）'

    # 4. 记录管理员审计日志
    log_action(
        action_type='审批入职',
        target_type='Employee',
        target_id=emp.id,
        description=f"批准了自主登记的人员入职：{emp.name} (身份证:{emp.id_card}){user_created_msg}",
        **locals()
    )

    try:
        db.session.commit()
        flash(f'员工 {emp.name} 已批准入职！{user_created_msg}', 'success')
    except Exception as e:
        db.session.rollback()
        flash(f'审批失败：{str(e)}', 'danger')

    return redirect(url_for('hr.hr_list', status='在职'))
# ==================== 删除人员记录 ====================

@hr_bp.route('/delete_pending/<int:id>', methods=['POST'])
@login_required
@perm.require('hr.edit')
def delete_pending(id):
    # 1. 权限检查：直接判断是否为 admin 角色
    if current_user.role != 'admin':
        flash("只有系统管理员有权执行删除操作", "danger")
        return redirect(url_for('hr.hr_list'))

    # 2. 查找记录
    emp = EmploymentCycle.query.get_or_404(id)
    id_card_to_delete = emp.id_card
    old_status = emp.status
    old_name = emp.name

    # 3. 执行删除
    try:
        # 如果该员工有关联的其他表数据（如资产领用记录），建议先处理或确认数据库开启了 cascade delete
        user_account = User.query.filter_by(username=id_card_to_delete).first()
        user_deleted_msg = ""
        if user_account:
            db.session.delete(user_account)
            user_deleted_msg = "及关联登录账号"
        db.session.delete(emp)
        db.session.commit()
        flash(f"已成功彻底删除记录：{old_name}{user_deleted_msg}", "success")
    except Exception as e:
        db.session.rollback()
        flash(f"删除失败，可能存在关联数据未清理：{str(e)}", "danger")

    # 4. 跳转回原本所属的状态列表
    return redirect(url_for('hr.hr_list', status=old_status))

# ==================== 生成二维码的接口 ====================
@hr_bp.route('/generate_qr')
@login_required
@perm.require('hr.edit')
def generate_qr():
    base_url = "http://xuxiaoxiao1992.asuscomm.com:8000"
    target_url = base_url + url_for('hr.self_register')
    qr = qrcode.QRCode(version=1, box_size=10, border=5)
    qr.add_data(target_url)
    qr.make(fit=True)
    img = qr.make_image(fill_color="black", back_color="white")
    buf = io.BytesIO()
    img.save(buf, format='PNG')
    qr_b64 = base64.b64encode(buf.getvalue()).decode()
    return jsonify({'success': True, 'qr_code': qr_b64, 'url': target_url})

# ==================== 详情页 ====================
@hr_bp.route('/detail/<id_card>')
@login_required
def hr_detail(id_card):
    # 如果想看的人不是自己，且自己手里没有 hr.view 钥匙
    if id_card != current_user.username and not perm.can('hr.view'):
        flash('权限不足，您只能查看自己的信息', 'danger')
        return redirect(url_for('hr.hr_detail', id_card=current_user.username))
    cycles = EmploymentCycle.query.filter_by(id_card=id_card).order_by(EmploymentCycle.hire_date.desc()).all()
    if not cycles:
        flash('未找到该身份证记录', 'warning')
        return redirect(url_for('hr.hr_list'))
    
    current_cycle = next((c for c in cycles if c.status == '在职'), None)

    # --- 新增：获取可发放的资产列表 ---
    available_assets = []
    if current_cycle:
        # 只查询类型为装备或服饰，且库存 > 0 的资产
        available_assets = Asset.query.filter(
            Asset.type.in_(['装备', '服饰']),
            Asset.stock_quantity > 0
        ).all()
    
    return render_template('hr/detail.html',
                           cycles=cycles,
                           current_cycle=current_cycle,
                           id_card=id_card,
                           available_assets=available_assets,
                           positions=POSITIONS, 
                           posts=POSTS,
                           salary_modes=SALARY_MODES,
                           ethnic_options=get_ethnic_options(),
                           politics_options=get_politics_options(),
                           education_options=get_education_options())

# ==================== 编辑当前在职周期 ====================
@hr_bp.route('/edit/<int:cycle_id>', methods=['GET', 'POST'])
@login_required
@perm.require('hr.edit')
def edit_cycle(cycle_id):
    from utils import log_action
    from datetime import datetime
    cycle = EmploymentCycle.query.get_or_404(cycle_id)
    
    if cycle.status != '在职':
        flash('仅在职周期可编辑', 'danger')
        return redirect(url_for('hr.hr_detail', id_card=cycle.id_card))
    
    if request.method == 'POST':
        # --- 1. 定义字段映射（这是为了让日志显示中文，同时涵盖你所有的字段） ---
        field_map = {
            'name': '姓名', 'phone': '手机号', 'ethnic': '民族', 'politics': '政治面貌',
            'education': '学历', 'position': '职位', 'post': '岗位', 'salary_mode': '工资模式',
            'hire_date': '入职日期', 'household_province': '户籍省', 'household_city': '户籍市',
            'household_district': '户籍区', 'household_town': '户籍镇', 'household_detail': '户籍详址',
            'residence_province': '居住省', 'residence_city': '居住市', 'residence_district': '居住区',
            'residence_town': '居住镇', 'residence_detail': '居住详址', 'military_service': '服役经历',
            'enlistment_date': '入伍日期', 'unit_number': '部队代号', 'branch': '兵种',
            'discharge_date': '退伍日期', 'has_license': '驾照', 'license_date': '领证日期',
            'license_type': '驾照类型', 'license_expiry': '驾照到期', 'security_license_number': '保安证号',
            'security_license_date': '保安证日期', 'emergency_name': '紧急联系人',
            'emergency_relation': '联系人关系', 'emergency_phone': '联系人电话',
            'hat_size': '帽子尺寸', 'short_sleeve': '短袖尺寸', 'long_sleeve': '长袖尺寸',
            'winter_uniform': '冬装尺寸', 'shoe_size': '鞋码'
        }

        changes = []

        # 辅助工具：统一转为字符串进行对比
        def to_str(v):
            if v is None: return ""
            if isinstance(v, bool): return "是" if v else "否"
            return str(v).strip()

        # --- 2. 核心逻辑：自动对比并【赋值】 ---
        # 这个循环代替了你原来那一长串的 cycle.xxx = request.form[...]
        for field, label in field_map.items():
            old_val_raw = getattr(cycle, field)
            
            # 根据字段类型获取新值 (逻辑完全对应你原来的代码)
            if field in ['military_service', 'has_license']:
                new_val_raw = field in request.form
            elif field in ['hire_date', 'enlistment_date', 'discharge_date', 'license_date', 'license_expiry', 'security_license_date']:
                # 日期特殊处理，如果没填则保持原样或转为 None
                parsed = parse_date(request.form.get(field))
                new_val_raw = parsed if parsed else (old_val_raw if field == 'hire_date' else None)
            else:
                new_val_raw = request.form.get(field, '').strip()

            # 比较差异
            if to_str(old_val_raw) != to_str(new_val_raw):
                changes.append(f"{label}[{to_str(old_val_raw)} -> {to_str(new_val_raw)}]")
                # 【执行赋值】—— 这一步就是你原来的 cycle.name = ... 
                setattr(cycle, field, new_val_raw)

        # --- 3. 特殊处理：头像 ---
        if 'photo' in request.files and request.files['photo'].filename:
            path = save_uploaded_file(request.files['photo'], module='avatar')
            if path:
                cycle.photo_path = path
                changes.append("更新了证件照")
        
        # 修正 nan 字符串问题
        if not cycle.photo_path or str(cycle.photo_path).lower() == 'nan':
            cycle.photo_path = 'uploads/default-avatar.png'

        # --- 4. 提交记录 ---
        try:
            # 只有当确实有变化时才记录日志
            if changes:
                log_action(
                    action_type='编辑人员',
                    target_type='Employee',
                    target_id=cycle.id,
                    description=f"修改了队员【{cycle.name}】的档案：{', '.join(changes)}",
                    **locals()
                )
            
            db.session.commit()
            flash('员工信息更新成功', 'success')
            return redirect(url_for('hr.hr_detail', id_card=cycle.id_card))
        except Exception as e:
            db.session.rollback()
            flash(f'更新失败，错误：{str(e)}', 'danger')
    
    # GET 请求返回页面
    return render_template('hr/edit.html',
                           cycle=cycle,
                           ethnic_options=get_ethnic_options(),
                           politics_options=get_politics_options(),
                           education_options=get_education_options(),
                           salary_modes=SALARY_MODES,
                           positions=POSITIONS,
                           posts=POSTS)
# ==================== 添加档案记录（奖惩、检讨书、保密协议等） ====================
@hr_bp.route('/archive/add/<int:cycle_id>', methods=['POST'])
@login_required
@perm.require('hr.add')
def add_archive(cycle_id):
    from utils import log_action  # 局部导入工具函数
    import json
    from datetime import datetime

    cycle = EmploymentCycle.query.get_or_404(cycle_id)
    if cycle.status != '在职':
        flash('仅在职期间可添加档案记录', 'danger')
        return redirect(url_for('hr.hr_detail', id_card=cycle.id_card))
    
    record_type = request.form['record_type']
    title = request.form['title'].strip()
    description = request.form.get('description', '').strip()
    
    file_path = None
    if 'archive_file' in request.files and request.files['archive_file'].filename:
        # 建议此处增加子目录参数以保持目录整洁
        file_path = save_uploaded_file(
            request.files['archive_file'], 
            module='archive', 
            sub_folder=cycle.id_card
        )
    
    # 逻辑处理：解析并更新 JSON 字段
    archives = json.loads(cycle.archives or '{}')
    if 'archive_records' not in archives:
        archives['archive_records'] = []
    
    # 构建记录项
    new_record = {
        'type': record_type,
        'title': title,
        'description': description,
        'file_path': file_path,
        'date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'operator': current_user.name,
        'operator_id': current_user.id
    }
    
    archives['archive_records'].append(new_record)
    cycle.archives = json.dumps(archives, ensure_ascii=False)

    # 【核心新增】记录管理员审计日志
    file_msg = "（含附件）" if file_path else "（无附件）"
    description = (
        f"为队员【{cycle.name}】添加了档案记录 | "
        f"类型：{record_type}，标题：{title} {file_msg}，"
        f"内容简述：{description[:30]}{'...' if len(description) > 30 else ''}"
    )

    log_action(
        action_type='添加档案',
        target_type='EmployeeArchive',
        target_id=cycle.id,
        **locals()
    )

    # 提交数据库事务
    try:
        db.session.commit()
        flash('档案记录添加成功', 'success')
    except Exception as e:
        db.session.rollback()
        flash(f'档案保存失败：{str(e)}', 'danger')

    return redirect(url_for('hr.hr_detail', id_card=cycle.id_card))

from datetime import datetime, timedelta
import json

def is_within_hour(date_str):
    if not date_str:
        return False
    try:
        # 第一步：把中文日期格式 2026年01月07日 转换为 2026-01-07
        clean_date = str(date_str).replace('年', '-').replace('月', '-').replace('日', '')
        
        # 第二步：尝试多种可能的日期格式进行解析
        record_time = None
        formats = ['%Y-%m-%d %H:%M:%S', '%Y-%m-%d %H:%M', '%Y-%m-%d']
        
        for fmt in formats:
            try:
                record_time = datetime.strptime(clean_date.strip(), fmt)
                break
            except:
                continue
        
        if not record_time:
            print(f"DEBUG: 无法解析日期字符串 -> {date_str}")
            return False
            
        # 第三步：计算时间差
        diff = datetime.now() - record_time
        # 如果是未来时间（比如录入错误），或者在一小时内
        return diff < timedelta(hours=1)
        
    except Exception as e:
        print(f"DEBUG: 时间判断逻辑出错 -> {e}")
        return False

@hr_bp.route('/archive/edit/<int:cycle_id>/<int:record_idx>', methods=['POST'])
@login_required
def edit_archive(cycle_id, record_idx):
    cycle = EmploymentCycle.query.get_or_404(cycle_id)
    archives = json.loads(cycle.archives or '{}')
    record = archives['archive_records'][record_idx]

    # 严格校验：操作人ID必须一致 且 时间在1小时内
    if record['operator_id'] == current_user.id and is_within_hour(record['date']):
        record['type'] = request.form['record_type']
        record['title'] = request.form['title'].strip()
        record['description'] = request.form.get('description', '').strip()
        # 注意：编辑通常不建议修改原始时间，或者仅更新编辑标记
        cycle.archives = json.dumps(archives, ensure_ascii=False)
        db.session.commit()
        flash('档案已更新', 'success')
    else:
        flash('无权修改或已超时', 'danger')
    return redirect(url_for('hr.hr_detail', id_card=cycle.id_card))
# ==================== 办理离职（含资产自动核销审计） ====================
@hr_bp.route('/departure/<int:cycle_id>', methods=['POST'])
@login_required
@perm.require('hr.departure')
def departure(cycle_id):
    from utils import log_action
    import json
    from datetime import datetime

    cycle = EmploymentCycle.query.get_or_404(cycle_id)
    if cycle.status == '离职':
        flash('已离职，无需重复操作', 'info')
        return redirect(url_for('hr.hr_detail', id_card=cycle.id_card))
    
    # 检查强制勾选
    if 'confirm_return' not in request.form or 'settle_utilities' not in request.form:
        flash('请确认所有离职事项', 'danger')
        return redirect(url_for('hr.hr_detail', id_card=cycle.id_card))
    
    # 1. 离职自动归还装备（精确核销）
    user_allocations = AssetAllocation.query.filter_by(
        user_id=cycle.id, 
        return_date=None
    ).all()

    returned_assets_summary = [] # 用于审计日志的汇总

    for alloc in user_allocations:
        asset = alloc.asset
        qty = alloc.quantity
        
        alloc.return_date = datetime.today().date()
        
        asset.stock_quantity += qty
        asset.allocated_quantity -= qty
        
        if asset.allocated_quantity < 0:
            asset.allocated_quantity = 0
        
        if asset.allocated_quantity == 0:
            asset.status = '库存'
        
        # 记录归还资产摘要（供日志使用）
        returned_assets_summary.append(f"{asset.name}x{qty}")

        # 记录资产历史
        history = AssetHistory(
            asset_id=asset.id,
            action='归还（离职自动）',
            user_id=cycle.id,
            operator_id=current_user.id,
            quantity=qty,
            action_date=datetime.now(),
            note=f'{cycle.name}离职自动归还'
        )
        db.session.add(history)
    
    # 2. 正常离职人事逻辑
    reason = request.form.get('departure_reason', '').strip()
    dep_date_str = request.form.get('departure_date')
    dep_date = parse_date(dep_date_str) or datetime.today().date()
    
    cycle.status = '离职'
    cycle.departure_date = dep_date
    
    # 更新档案中的原因
    archives = json.loads(cycle.archives or '{}')
    archives['departure_reason'] = reason or '无原因说明'
    cycle.archives = json.dumps(archives, ensure_ascii=False)
    
    # 3. 【核心新增】写入管理员审计日志
    asset_msg = f" | 自动回收资产: {', '.join(returned_assets_summary)}" if returned_assets_summary else " | 无资产需回收"
    log_description = (
        f"为队员【{cycle.name}】办理了离职手续。"
        f"离职日期：{dep_date.strftime('%Y-%m-%d')}，"
        f"原因：{reason or '未填写'}"
        f"{asset_msg}"
    )

    log_action(
        action_type='人员离职',
        target_type='Employee',
        target_id=cycle.id,
        description=log_description,
        **locals()
    )

    # 4. 提交所有变更（资产 + 人事 + 日志）
    try:
        db.session.commit()
        flash(f'离职成功，已自动归还全部个人装备({len(returned_assets_summary)}项)', 'success')
    except Exception as e:
        db.session.rollback()
        flash(f'办理离职失败：{str(e)}', 'danger')

    return redirect(url_for('hr.hr_detail', id_card=cycle.id_card))

# ==================== 导出员工花名册 ====================
@hr_bp.route('/export')
@login_required
@perm.require('hr.export')
def hr_export():
    status_filter = request.args.get('status', '在职')
    search = request.args.get('search', '').strip()
    
    subquery = db.session.query(
        EmploymentCycle.id_card,
        db.func.max(EmploymentCycle.hire_date).label('max_hire_date')
    ).group_by(EmploymentCycle.id_card).subquery()
    
    query = EmploymentCycle.query.join(
        subquery,
        db.and_(
            EmploymentCycle.id_card == subquery.c.id_card,
            EmploymentCycle.hire_date == subquery.c.max_hire_date
        )
    )
    
    if status_filter == '在职':
        query = query.filter(EmploymentCycle.status == '在职')
    else:
        query = query.filter(EmploymentCycle.status == '离职')
    
    if search:
        query = query.filter(
            db.or_(
                EmploymentCycle.name.ilike(f'%{search}%'),
                EmploymentCycle.id_card.ilike(f'%{search}%'),
                EmploymentCycle.phone.ilike(f'%{search}%')
            )
        )
    
    employees = query.all()
    
    data = []
    for emp in employees:
        # 展开地址
        household_address = f"{emp.household_province or ''}{emp.household_city or ''}{emp.household_district or ''}{emp.household_town or ''}{emp.household_detail or ''}"
        residence_address = f"{emp.residence_province or ''}{emp.residence_city or ''}{emp.residence_district or ''}{emp.residence_town or ''}{emp.residence_detail or ''}"
        
        # 兵役情况
        military = '是' if emp.military_service else '无'
        if military == '是':
            military += f" (入伍{format_date(emp.enlistment_date)}，部队{emp.unit_number or ''}，兵种{emp.branch or ''}，退伍{format_date(emp.discharge_date)})"
        
        # 驾驶证
        license = '是' if emp.has_license else '无'
        if license == '是':
            license += f" (初领{format_date(emp.license_date)}，车型{emp.license_type or ''}，有效期{format_date(emp.license_expiry)})"
        
        # 紧急联系人
        emergency = f"{emp.emergency_name or ''} ({emp.emergency_relation or ''}) {emp.emergency_phone or ''}"
        
        # 工作服
        uniform = f"帽{emp.hat_size or ''} 短袖{emp.short_sleeve or ''} 长袖{emp.long_sleeve or ''} 冬装{emp.winter_uniform or ''} 鞋{emp.shoe_size or ''}"
        
        # 展开档案 JSON
        archives = json.loads(emp.archives or '{}')
        other_certs = '; '.join([f"{c['name']} ({c['number']}, {c['date']})" for c in archives.get('other_certificates', [])])
        archive_records = '; '.join([f"[{r['type']}] {r['title']} ({r['date']}) {r['description'] or ''}" for r in archives.get('archive_records', [])])
        departure_reason = archives.get('departure_reason', '')
        
        data.append({
            '姓名': emp.name,
            '身份证号码': emp.id_card,
            '手机号': emp.phone or '',
            '头像路径': emp.photo_path or '',
            '性别': emp.gender or '',
            '出生日期': format_date(emp.birthday),
            '入职日期': format_date(emp.hire_date),
            '离职日期': format_date(emp.departure_date),
            '状态': emp.status,
            '民族': emp.ethnic or '',
            '政治面貌': emp.politics or '',
            '学历': emp.education or '',
            '户籍省份': emp.household_province or '',
            '户籍城市': emp.household_city or '',
            '户籍区县': emp.household_district or '',
            '户籍乡镇': emp.household_town or '',
            '户籍详细地址': emp.household_detail or '',
            '居住省份': emp.residence_province or '',
            '居住城市': emp.residence_city or '',
            '居住区县': emp.residence_district or '',
            '居住乡镇': emp.residence_town or '',
            '居住详细地址': emp.residence_detail or '',
            '兵役情况': '是' if emp.military_service else '无',
            '入伍日期': format_date(emp.enlistment_date),
            '部队番号': emp.unit_number or '',
            '兵种': emp.branch or '',
            '退伍日期': format_date(emp.discharge_date),
            '是否持有驾驶证': '是' if emp.has_license else '无',
            '驾驶证初领日期': format_date(emp.license_date),
            '准驾车型': emp.license_type or '',
            '驾驶证有效期': format_date(emp.license_expiry),
            '是否持有保安员证': '是' if emp.security_license_number else '无',
            '保安员证': emp.security_license_number or '',
            '保安员证发证日期': format_date(emp.security_license_date),
            '薪资模式': emp.salary_mode or '',
            '职务': emp.position or '',
            '岗位': emp.post or '',
            '紧急联系人姓名': emp.emergency_name or '',
            '紧急联系人关系': emp.emergency_relation or '',
            '紧急联系人电话': emp.emergency_phone or '',
            '帽码': emp.hat_size or '',
            '短袖尺码': emp.short_sleeve or '',
            '长袖尺码': emp.long_sleeve or '',
            '冬装尺码': emp.winter_uniform or '',
            '鞋码': emp.shoe_size or '',
            '其他证书': other_certs,
            '档案记录': archive_records,
            '离职原因': departure_reason
        })
    
    df = pd.DataFrame(data)
    
    output = BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name='员工花名册')
    
    output.seek(0)
    
    filename = f"员工花名册_{status_filter}_{datetime.today().strftime('%Y%m%d')}.xlsx"
    return send_file(
        output,
        as_attachment=True,
        download_name=filename,
        mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )



# ==================== 导入员工花名册 ====================
@hr_bp.route('/import', methods=['GET', 'POST'])
@login_required
@perm.require('hr.import')
def hr_import():
    if request.method == 'POST':
        if 'file' not in request.files:
            flash('未选择文件', 'danger')
            return redirect(request.url)
        
        file = request.files['file']
        if file.filename == '':
            flash('未选择文件', 'danger')
            return redirect(request.url)
        
        if file and file.filename.endswith('.xlsx'):
            try:
                df = pd.read_excel(file, dtype={'手机号': str})
                
                # 必填列
                required = ['姓名', '身份证号码', '手机号']
                missing = [col for col in required if col not in df.columns]
                if missing:
                    flash(f'缺少必填列：{", ".join(missing)}', 'danger')
                    return redirect(request.url)
                
                success = 0
                errors = []
                
                for idx, row in df.iterrows():
                    try:
                        id_card = str(row['身份证号码']).strip()
                        name = str(row['姓名']).strip()
                        phone = str(row['手机号']).strip()
                        
                        # 状态（默认在职）
                        status = str(row.get('状态', '在职')).strip()
                        if status not in ['在职', '离职']:
                            status = '在职'
                        
                        # 重复校验：同一身份证 + 同一入职日期
                        hire_date_raw = row.get('入职日期')
                        hire_date = parse_date(hire_date_raw)
                        if not hire_date:
                            errors.append(f"行{idx+2}: {name} 入职日期无效 (原始值: {hire_date_raw})")
                            continue
                        
                        if EmploymentCycle.query.filter_by(id_card=id_card, hire_date=hire_date).first():
                            errors.append(f"行{idx+2}: {name} 该周期已存在")
                            continue
                        
                        # 身份证校验
                        if not validate_id_card(id_card):
                            errors.append(f"行{idx+2}: {name} 身份证无效")
                            continue
                        # 默认头像
                        raw_photo = row.get('头像路径')
                        
                        # 2. 只有当确实是 pandas 定义的空值 (NaN) 或 None 时，才考虑设为默认
                        if pd.isna(raw_photo) or raw_photo is None:
                            photo_path = 'uploads/default-avatar.png'
                        else:
                            # 3. 处理有值的情况
                            p_str = str(raw_photo).strip()
                            # 4. 关键：排除掉可能存在的干扰字符串，剩下的全部视为有效路径
                            if p_str == "" or p_str.lower() in ['nan', 'none', 'null']:
                                photo_path = 'uploads/default-avatar.png'
                            else:
                                # 5. 只要不是上面那些，就保留 Excel 原样路径 (如: uploads/photos/xxx.jpg)
                                photo_path = p_str
                                print(f"DEBUG: 正在导入 {name} 的照片，路径是: {photo_path}")

                        gender = get_gender_from_id_card(id_card)
                        birthday = get_birthday_from_id_card(id_card)
                        
                        # 离职日期
                        departure_date = parse_date(row.get('离职日期')) if status == '离职' else None
                        
                        cycle = EmploymentCycle(
                            id_card=id_card,
                            name=name,
                            phone=phone,
                            gender=gender,
                            birthday=birthday,
                            hire_date=hire_date,
                            departure_date=departure_date,
                            status=status,
                            
                            # 基本信息
                            ethnic=str(row.get('民族', '')),
                            politics=str(row.get('政治面貌', '')),
                            education=str(row.get('学历', '')),
                            
                            # 地址拆分（支持多种列名）
                            household_province=str(row.get('户籍省份', row.get('户籍省', ''))),
                            household_city=str(row.get('户籍城市', row.get('户籍市', ''))),
                            household_district=str(row.get('户籍区县', row.get('户籍区', ''))),
                            household_town=str(row.get('户籍乡镇', row.get('户籍镇', ''))),
                            household_detail=str(row.get('户籍详细地址', '')),
                            residence_province=str(row.get('居住省份', row.get('居住省', ''))),
                            residence_city=str(row.get('居住城市', row.get('居住市', ''))),
                            residence_district=str(row.get('居住区县', row.get('居住区', ''))),
                            residence_town=str(row.get('居住乡镇', row.get('居住镇', ''))),
                            residence_detail=str(row.get('居住详细地址', '')),
                            
                            # 兵役
                            military_service=str(row.get('兵役情况', '')).strip().lower() == '是',
                            enlistment_date=parse_date(row.get('入伍日期')),
                            unit_number=str(row.get('部队番号', '')),
                            branch=str(row.get('兵种', '')),
                            discharge_date=parse_date(row.get('退伍日期')),
                            
                            # 驾驶证
                            has_license=str(row.get('是否持有驾驶证', '')).strip().lower() == '是',
                            license_date=parse_date(row.get('驾驶证初领日期')),
                            license_type=str(row.get('准驾车型', '')),
                            license_expiry=parse_date(row.get('驾驶证有效期')),
                            
                            # 保安员证
                            has_security_license=str(row.get('是否持有保安员证', '')).strip().lower() == '是',
                            security_license_number=str(row.get('保安员证', '')),
                            security_license_date=parse_date(row.get('保安员证发证日期')),
                            
                            # 薪资与岗位
                            salary_mode=str(row.get('薪资模式', '')),
                            position=str(row.get('职务', '')),
                            post=str(row.get('岗位', '')),
                            
                            # 紧急联系人
                            emergency_name=str(row.get('紧急联系人姓名', '')),
                            emergency_relation=str(row.get('紧急联系人关系', '')),
                            emergency_phone=str(row.get('紧急联系人电话', '')),
                            
                            # 工作服
                            hat_size=str(row.get('帽码', '')),
                            short_sleeve=str(row.get('短袖尺码', '')),
                            long_sleeve=str(row.get('长袖尺码', '')),
                            winter_uniform=str(row.get('冬装尺码', '')),
                            shoe_size=str(row.get('鞋码', '')),
                            
                            # 头像路径
                            photo_path=photo_path,
                        )
                        
                        # 其他证书和档案记录（暂留空，可后续扩展）
                        archives = {}
                        if row.get('其他证书'):
                            archives['other_certificates'] = []  # 可扩展
                        if row.get('档案记录'):
                            archives['archive_records'] = []  # 可扩展
                        if row.get('离职原因'):
                            archives['departure_reason'] = str(row['离职原因'])
                        cycle.archives = json.dumps(archives, ensure_ascii=False) if archives else ''
                        
                        db.session.add(cycle)
                        
                        # 自动创建账号（仅在职），角色固定为 member
                        if status == '在职' and not User.query.filter_by(username=id_card).first():
                            default_password = id_card[-6:]
                            new_user = User(
                                username=id_card,
                                name=name,
                                role='member'  # 固定为队员
                                )
                            new_user.set_password(default_password)
                            db.session.add(new_user)
                        
                        success += 1
                    except Exception as e:
                        errors.append(f"行{idx+2}: {str(e)}")
                
                db.session.commit()
                
                msg = f'导入完成：成功 {success} 条'
                if errors:
                    msg += f'，失败 {len(errors)} 条'
                    flash(msg, 'warning')
                    flash('<br>'.join(errors[:30]), 'danger')
                else:
                    flash(msg, 'success')
                
                return redirect(url_for('hr.hr_list'))
            except Exception as e:
                flash(f'文件读取失败：{str(e)}', 'danger')
    
    return render_template('hr/import.html')

# 人事模块权限列表
HR_PERMISSIONS = [
    ('view', '查看员工信息', '查看员工列表和详情'),
    ('add', '新增员工', '新增员工记录'),
    ('edit', '编辑员工', '编辑员工信息'),
    ('departure', '员工离职', '标记员工离职'),
    ('import', '批量导入员工', '从Excel导入员工'),
    ('export', '批量导出员工', '导出员工花名册'),
    ('approve', '审核员工注册', '审核待批准的员工注册请求')
]

==================================================
FILE: .\routes\main.py
==================================================

# routes/main.py
# 首页及通用路由

from datetime import datetime
import json
from flask import Blueprint, render_template
from flask_login import login_required
from models import Asset, EmploymentCycle, FundsRecord, db

main_bp = Blueprint('main', __name__)

@main_bp.route('/')
def index():
    # 人事数据
    active_count = EmploymentCycle.query.filter_by(status='在职').count()
    departed_count = EmploymentCycle.query.filter_by(status='离职').count()
    total_unique = EmploymentCycle.query.with_entities(EmploymentCycle.id_card).distinct().count()
    
    # 资产数据
    total_assets = Asset.query.count()
    stock_quantity = db.session.query(db.func.sum(Asset.stock_quantity)).scalar() or 0
    allocated_quantity = db.session.query(db.func.sum(Asset.allocated_quantity)).scalar() or 0
    
    # 资金数据
    current_balance = db.session.query(db.func.sum(FundsRecord.amount)).scalar() or 0.0
    
    # 本月收支
    this_month = datetime.today().strftime('%Y-%m')
    month_income = db.session.query(db.func.sum(FundsRecord.amount))\
        .filter(FundsRecord.date.like(f'{this_month}%'), FundsRecord.amount > 0).scalar() or 0.0
    month_expense = abs(db.session.query(db.func.sum(FundsRecord.amount))\
        .filter(FundsRecord.date.like(f'{this_month}%'), FundsRecord.amount < 0).scalar() or 0.0)
    
    # 新增：生日提醒（本月生日在职员工）
    current_month = datetime.today().month
    birthday_employees = EmploymentCycle.query.filter(
        EmploymentCycle.status == '在职',
        db.extract('month', EmploymentCycle.birthday) == current_month
    ).order_by(db.extract('day', EmploymentCycle.birthday)).all()
    
    # 新增：户籍地分布（省份统计 + 地图数据）
    province_stats = db.session.query(
        EmploymentCycle.household_province,
        db.func.count('*').label('count')
    ).filter(
        EmploymentCycle.status == '在职',
        EmploymentCycle.household_province.isnot(None),
        EmploymentCycle.household_province != ''
    ).group_by(EmploymentCycle.household_province).all()

# 省份名称映射（ECharts 中国地图要求标准名称）
    province_name_map = {
    '北京市': '北京',
    '天津市': '天津',
    '河北省': '河北',
    '山西省': '山西',
    '内蒙古自治区': '内蒙古',
    '辽宁省': '辽宁',
    '吉林省': '吉林',
    '黑龙江省': '黑龙江',
    '上海市': '上海',
    '江苏省': '江苏',
    '浙江省': '浙江',
    '安徽省': '安徽',
    '福建省': '福建',
    '江西省': '江西',
    '山东省': '山东',
    '河南省': '河南',
    '湖北省': '湖北',
    '湖南省': '湖南',
    '广东省': '广东',
    '广西壮族自治区': '广西',
    '海南省': '海南',
    '重庆市': '重庆',
    '四川省': '四川',
    '贵州省': '贵州',
    '云南省': '云南',
    '西藏自治区': '西藏',
    '陕西省': '陕西',
    '甘肃省': '甘肃',
    '青海省': '青海',
    '宁夏回族自治区': '宁夏',
    '新疆维吾尔自治区': '新疆',
    '台湾省': '台湾',
    '香港特别行政区': '香港',
    '澳门特别行政区': '澳门'
}

    map_data = []
    for row in province_stats:
        raw_name = row.household_province.strip()
        standard_name = province_name_map.get(raw_name, None)  # 只映射已知全称
        if standard_name:  # 如果匹配到标准简称
            map_data.append({'name': standard_name, 'value': row.count})
    
    return render_template('index.html',
                           active_count=active_count,
                           departed_count=departed_count,
                           total_unique=total_unique,
                           total_assets=total_assets,
                           stock_quantity=stock_quantity,
                           allocated_quantity=allocated_quantity,
                           current_balance=current_balance,
                           month_income=month_income,
                           month_expense=month_expense,
                           birthday_employees=birthday_employees,
                           province_map_data=json.dumps(map_data, ensure_ascii=False))


==================================================
FILE: .\routes\notification.py
==================================================

# routes/notification.py
from flask import Blueprint, render_template, redirect, url_for, request, flash
from flask_login import login_required, current_user
from models import Notification, User, db
from utils import perm
from datetime import datetime

notification_bp = Blueprint('notification', __name__, url_prefix='/notification')

# 职位列表（与需求一致）
POSITIONS = ["队长", "副队长", "领班", "队员"]

def send_operation_notice(title, content, operated_user_id):
    """
    发送操作通知：
    :param title: 通知标题
    :param content: 通知内容
    :param operated_user_id: 被操作人的用户ID（当事人）
    """
    # 步骤1：筛选接收人 - 队长、副队长、领班
    managers = User.query.filter(
        User.position.in_(["队长", "副队长", "领班"])
    ).all()
    # 步骤2：获取被操作人（当事人）
    operated_user = User.query.get(operated_user_id)
    
    # 步骤3：合并接收人（去重，避免重复通知）
    receiver_ids = set()
    # 添加管理人员ID
    for manager in managers:
        receiver_ids.add(manager.id)
    # 添加被操作人ID（确保存在）
    if operated_user:
        receiver_ids.add(operated_user.id)
    
    # 步骤4：为每个接收人生成通知
    for receiver_id in receiver_ids:
        new_notice = Notification(
            user_id=receiver_id,  # 接收人ID
            title=title,
            content=content,
            is_read=False,  # 默认为未读
            created_at=datetime.now()  # 自动生成当前时间
        )
        db.session.add(new_notice)
    db.session.commit()

# 原有接口保持不变
@notification_bp.route('/list')
@login_required
def notification_list():
    # 获取页码参数，默认为第 1 页，每页显示 10 条
    page = request.args.get('page', 1, type=int)
    per_page = 10
    
    # 使用 paginate 进行分页查询
    pagination = Notification.query.filter_by(user_id=current_user.id)\
        .order_by(Notification.created_at.desc())\
        .paginate(page=page, per_page=per_page, error_out=False)
    
    # 获取当前用户的总未读数（用于顶部显示，不受分页影响）
    unread_count = Notification.query.filter_by(user_id=current_user.id, is_read=False).count()
    
    return render_template('notification/list.html', 
                           pagination=pagination, 
                           notifications=pagination.items,
                           unread_count=unread_count)

@notification_bp.route('/read/<int:notify_id>')
@login_required
def mark_as_read(notify_id):
    """标记通知为已读"""
    notification = Notification.query.filter_by(id=notify_id, user_id=current_user.id).first_or_404()
    notification.is_read = True
    db.session.commit()
    return redirect(url_for('notification.notification_list'))


@notification_bp.route('/read_all', methods=['POST'])
@login_required
def read_all():
    from models import Notification, db
    # 找到当前用户所有未读的通知
    unread_notifications = Notification.query.filter_by(user_id=current_user.id, is_read=False).all()
    
    for notice in unread_notifications:
        notice.is_read = True
    
    db.session.commit()
    flash('所有通知已标记为已读', 'success')
    return redirect(request.referrer or url_for('main.index'))

@notification_bp.route('/unread_count')
@login_required
def get_unread_count():
    from models import Notification, EmploymentCycle
    # 1. 检查未读通知
    notice_count = Notification.query.filter_by(user_id=current_user.id, is_read=False).count()
    
    # 2. 检查待审核人员 (仅给有权限的管理人员报警)
    pending_hr_count = 0
    from utils import perm 
    if perm.can('hr.view'):
        pending_hr_count = EmploymentCycle.query.filter_by(status='待审核').count()
    
    # 返回总和。只要这个数字 > 0，网页就会嘀嘀嘀
    return {"unread_count": notice_count + pending_hr_count}

==================================================
FILE: .\routes\permission.py
==================================================

# routes/permission.py
# 权限管理模块

# routes/permission.py
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required,current_user
from models import db, Permission, UserPermission, EmploymentCycle, User,OperationLog
from utils import perm  # 确保 utils.py 底部有 perm = PermissionManager()
from datetime import datetime
permission_bp = Blueprint('permission', __name__, url_prefix='/permission')


# ==================== 权限分配界面 ====================
@permission_bp.route('/manage')
@login_required
@perm.require('manage')
def permission_manage():
    # 1. 获取员工并进行自定义职务排序 ---
    all_in_service = EmploymentCycle.query.filter_by(status='在职').all()
    
    # 手动定义职务的优先级（数字越小，排得越靠前）
    pos_order = {
        '队长': 1,
        '副队长': 2,
        '领班': 3,
        '队员': 4
    }

    # 使用 sorted 进行多级排序：
    # 第一优先级：职务权重 (pos_order)
    # 第二优先级：如果职务相同，按姓名排序
    sorted_employees = sorted(
        all_in_service, 
        key=lambda x: (pos_order.get(x.position.strip() if x.position else '', 99), x.name)
    )
    # 2. 获取账号映射：身份证号(username) -> 用户对象
    users = User.query.all() 
    id_card_to_user_id = {u.username: u.id for u in users} 
    
    # 3. 获取所有权限并按模块分组（用于前端表格展示）
    all_permissions = Permission.query.order_by(Permission.module, Permission.id).all()
    modules = {}
    for p in all_permissions:
        modules.setdefault(p.module, []).append(p)
    
    # 4. 获取用户权限映射关系：user_id -> [permission_id_list]
    user_perms_records = UserPermission.query.all()
    user_perms_dict = {}
    for up in user_perms_records:
        user_perms_dict.setdefault(up.user_id, []).append(up.permission_id)
    
    return render_template('permission/manage.html',
                           employees=sorted_employees,
                           modules=modules,
                           user_perms=user_perms_dict,
                           id_map=id_card_to_user_id)


# ==================== 权限保存（含全量差异审计） ====================
@permission_bp.route('/update', methods=['POST'])
@login_required
@perm.require('manage')
def permission_update():
    from utils import log_action
    
    # 1. 获取目标用户 ID
    raw_id = request.form.get('target_user_id') or request.values.get('target_user_id')
    if not raw_id:
        flash('未识别到目标用户，请重新选择员工', 'danger')
        return redirect(url_for('permission.permission_manage'))

    try:
        target_user_id = int(float(raw_id))
        target_user = User.query.get_or_404(target_user_id)
        
        # 2. 获取旧权限列表（用于差异对比）
        # 假设 UserPermission 关联了 Permission 表，我们取权限名称
        old_permissions = db.session.query(Permission.name).join(
            UserPermission, UserPermission.permission_id == Permission.id
        ).filter(UserPermission.user_id == target_user_id).all()
        old_set = {p[0] for p in old_permissions}

        # 3. 获取新勾选的权限 ID 列表并查询其名称
        selected_perm_ids = [int(pid) for pid in request.form.getlist('selected_permissions')]
        new_permissions = Permission.query.filter(Permission.id.in_(selected_perm_ids)).all() if selected_perm_ids else []
        new_set = {p.name for p in new_permissions}

        # 4. 计算差异
        added = new_set - old_set
        removed = old_set - new_set

        # 5. 执行数据库更新：先删再增
        UserPermission.query.filter_by(user_id=target_user_id).delete()
        for pid in selected_perm_ids:
            new_up = UserPermission(user_id=target_user_id, permission_id=pid)
            db.session.add(new_up)

        # 6. 构造差异化日志描述
        if not added and not removed:
            log_desc = f"保存了用户【{target_user.name}】的权限，但未做任何实际改动。"
        else:
            parts = []
            if added:
                parts.append(f"新增了: [{', '.join(added)}]")
            if removed:
                parts.append(f"移除了: [{', '.join(removed)}]")
            log_desc = f"调整了用户【{target_user.name}】的系统权限：{'; '.join(parts)}"

        # 7. 写入审计日志
        log_action(
            action_type='权限变更',
            target_type='UserPermission',
            target_id=target_user_id,
            description=log_desc,
            **locals()
        )

        db.session.commit()
        flash(f'用户 {target_user.name} 的权限保存成功', 'success')
        
    except Exception as e:
        db.session.rollback()
        print(f"数据库操作失败，原因: {str(e)}")
        flash(f'保存失败: {str(e)}', 'danger')
    
    return redirect(url_for('permission.permission_manage'))

# ==================== 审计日志（Audit Log） ====================
@permission_bp.route('/operations')
@login_required
def permission_operations():
    """
    显示操作记录汇总页。
    系统管理员(admin)可查看全员日志，普通管理员仅能查看个人日志。
    """
    from models import User  # 确保导入了 User 模型进行关联查询
    from sqlalchemy.orm import joinedload
    
    # 1. 获取分页参数
    page = request.args.get('page', 1, type=int)
    per_page = 50  # 每页记录数
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')
    
    # 2. 构造基础查询对象
    query = OperationLog.query.options(joinedload(OperationLog.operator))
    
    # 时间筛选
    if start_date:
        start = datetime.strptime(start_date, '%Y-%m-%d').date()
        query = query.filter(OperationLog.created_at >= start)
    if end_date:
        end = datetime.strptime(end_date, '%Y-%m-%d').date()
        query = query.filter(OperationLog.created_at <= end)

    # 3. 权限逻辑判断
    if current_user.role != 'admin':
        query = query.filter_by(user_id=current_user.id)
    
    # 4. 执行分页查询
    # 使用 order_by(OperationLog.created_at.desc()) 确保时间倒序
    pagination = query.order_by(OperationLog.created_at.desc())\
        .paginate(page=page, per_page=20, error_out=False)
    
    logs = pagination.items
    
    # 5. 渲染模板
    return render_template('permission/operations.html', 
                           logs=logs, 
                           pagination=pagination)

==================================================
FILE: .\routes\scheduling.py
==================================================

# routes/scheduling.py 全量替换代码
from flask import Blueprint, render_template, request, jsonify, flash, redirect, url_for, send_file
from flask_login import login_required
from models import db, EmploymentCycle, ShiftPost, Scheduling
from utils import perm
from datetime import datetime
import pandas as pd
import io
import re

scheduling_bp = Blueprint('scheduling', __name__, url_prefix='/scheduling')

# 权限定义
SCHEDULING_PERMISSIONS = [
    ('view', '查看排班', '查看全员排班表'),
    ('edit', '管理排班', '拖拽排班、保存排班数据'),
    ('post', '岗位管理', '增删改查排班岗位')
]

# --- 功能：显示排班日历主页与岗位管理页签 ---
@scheduling_bp.route('/list', methods=['GET', 'POST'])
@login_required
def schedule_list():
    if not perm.can('scheduling.view'):
        flash("权限不足", "danger")
        return redirect(url_for('main.index'))
    
    if request.method == 'POST':
        if not perm.can('scheduling.post'):
            flash("无权管理岗位", "danger")
            return redirect(url_for('scheduling.schedule_list', tab='posts'))
        name = request.form.get('name')
        color = request.form.get('color', '#007bff')
        start = request.form.get('default_start', '08:30')
        end = request.form.get('default_end', '17:30')
        if name:
            new_post = ShiftPost(name=name, color=color, default_start=start, default_end=end)
            db.session.add(new_post)
            db.session.commit()
            flash(f"岗位 {name} 添加成功", "success")
        return redirect(url_for('scheduling.schedule_list', tab='posts'))

    active_tab = request.args.get('tab', 'calendar')
    employees = EmploymentCycle.query.filter_by(status='在职').all()
    posts = ShiftPost.query.all()
    return render_template('scheduling/list.html', employees=employees, posts=posts, active_tab=active_tab)

# --- 功能：为 FullCalendar 插件提供排班数据接口 ---
@scheduling_bp.route('/api/get_shifts')
@login_required
def get_shifts():
    schedules = Scheduling.query.all()
    events = []
    for s in schedules:
        emp = EmploymentCycle.query.get(s.employee_id)
        post = ShiftPost.query.get(s.post_id)
        if emp and post:
            events.append({
                'id': s.id,
                'title': f"{emp.name}-{'夜' if s.shift_type=='夜' else post.name}",
                'start': s.date.isoformat(),
                'color': '#ffc107' if s.shift_type == '夜' else post.color,
                'extendedProps': {
                    'empId': s.employee_id,
                    'postId': s.post_id,
                    'shiftId': s.id 
                }
            })
    return jsonify(events)

# --- 功能：保存或更新单个排班记录 ---
@scheduling_bp.route('/save_shift', methods=['POST'])
@login_required
def save_shift():
    if not perm.can('scheduling.edit'):
        return jsonify({'success': False, 'message': '无权操作'})
    data = request.json
    try:
        date_obj = datetime.strptime(data['date'], '%Y-%m-%d').date()
        shift = Scheduling.query.filter_by(employee_id=int(data['user_id']), date=date_obj).first()
        if not shift:
            shift = Scheduling(employee_id=int(data['user_id']), date=date_obj)
        
        shift.post_id = int(data.get('post_id'))
        shift.shift_type = data.get('shift_type', '白')
        shift.is_overtime = data.get('is_overtime', False)
        shift.hours = 12.0 
        db.session.add(shift)
        db.session.commit()
        return jsonify({'success': True})
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': str(e)})

# --- 功能：删除指定的排班记录 ---
@scheduling_bp.route('/api/delete_shift/<int:id>', methods=['POST'])
@login_required
def delete_shift(id):
    if not perm.can('scheduling.edit'):
        return jsonify({'success': False, 'message': '无权操作'})
    shift = Scheduling.query.get_or_404(id)
    try:
        db.session.delete(shift)
        db.session.commit()
        return jsonify({'success': True})
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': str(e)})

# --- 功能：删除岗位配置（检查关联性） ---
@scheduling_bp.route('/posts/delete/<int:id>')
@login_required
def post_delete(id):
    if not perm.can('scheduling.post'):
        flash("无权操作", "danger")
        return redirect(url_for('scheduling.schedule_list', tab='posts'))
    post = ShiftPost.query.get_or_404(id)
    if Scheduling.query.filter_by(post_id=id).first():
        flash("该岗位已有排班记录，无法删除", "warning")
    else:
        db.session.delete(post)
        db.session.commit()
        flash("岗位已删除", "success")
    return redirect(url_for('scheduling.schedule_list', tab='posts'))

# --- 功能：导出考勤统计表（支持 A/B 表及 174 小时保底） ---
@scheduling_bp.route('/export/<string:table_type>')
@login_required
def export_attendance(table_type):
    target_month = datetime.now().strftime("%Y-%m") 
    if table_type == 'A':
        emps = EmploymentCycle.query.filter_by(salary_mode='月工时制').all()
    else:
        emps = EmploymentCycle.query.filter(EmploymentCycle.salary_mode != '月工时制').all()

    data_list = []
    for emp in emps:
        shifts = Scheduling.query.filter(Scheduling.employee_id == emp.id, Scheduling.date.like(f"{target_month}%")).all()
        if not shifts: continue 

        actual_h = sum(s.hours for s in shifts)
        night_count = sum(1 for s in shifts if s.shift_type == '夜')
        
        if table_type == 'A':
            final_h = max(174.0, actual_h) 
            data_list.append({
                "姓名": emp.name, 
                "身份证": emp.id_card, 
                "实际工时": actual_h,
                "结算工时(保底174)": final_h, 
                "超额加班": max(0, actual_h - 174)
            })
        else:
            data_list.append({"姓名": emp.name, "身份证": emp.id_card, "夜班次": night_count, "夜补金额": night_count*15})

    if not data_list:
        flash(f"{target_month} 暂无有效数据", "warning")
        return redirect(url_for('scheduling.schedule_list'))

    df = pd.DataFrame(data_list)
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False)
    output.seek(0)
    return send_file(output, download_name=f"{table_type}表_{target_month}.xlsx", as_attachment=True)

# --- 功能：导出当前所有岗位配置清单 ---
@scheduling_bp.route('/posts/export')
@login_required
def export_posts():
    posts = ShiftPost.query.all()
    data = [{
        "岗位名称": p.name, 
        "代表颜色": p.color,
        "默认开始时间": p.default_start,
        "默认结束时间": p.default_end
    } for p in posts]
    df = pd.DataFrame(data)
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False)
    output.seek(0)
    return send_file(output, download_name="岗位配置详细导出.xlsx", as_attachment=True)
# --- 功能：导入当前所有岗位配置清单 ---
@scheduling_bp.route('/posts/import_config', methods=['POST'])
@login_required
def import_post_configs():
    file = request.files.get('file')
    if not file: return jsonify({'success': False, 'message': '未选择文件'})
    try:
        df = pd.read_excel(file)
        for _, row in df.iterrows():
            name = str(row['岗位名称'])
            color = str(row.get('代表颜色', '#0d6efd'))
            start = str(row.get('默认开始时间', '08:30'))
            end = str(row.get('默认结束时间', '17:30'))
            if not ShiftPost.query.filter_by(name=name).first():
                new_post = ShiftPost(name=name, color=color, default_start=start, default_end=end)
                db.session.add(new_post)
        db.session.commit()
        return jsonify({'success': True, 'message': '岗位导入成功'})
    except Exception as e:
        return jsonify({'success': False, 'message': f'导入失败: {str(e)}'})


# --- 功能核心：直接从复杂 Excel 排班表批量导入数据 ---
@scheduling_bp.route('/data/import', methods=['POST'])
@login_required
def import_schedule_data():
    file = request.files.get('file')
    if not file: return jsonify({'success': False, 'message': '未选择文件'})
    
    try:
        # 1. 直接读取 Sheet1
        df = pd.read_excel(file, sheet_name=0, header=None)
        
        # 2. 获取第一行作为岗位名称，并进行清洗（去掉括号及以后的时间说明）
        # 例如将 "守台-白班 (8:00-20:00)" 简化为 "守台-白班"
        raw_headers = df.iloc[0].fillna("").astype(str).tolist()
        clean_headers = []
        for h in raw_headers:
            # 使用正则去掉括号里的内容和多余空格
            clean_name = re.sub(r'[\(（].*?[\)）]', '', h).strip()
            clean_headers.append(clean_name)
            
        # 预加载数据库岗位，建立 名字 -> 对象 的映射
        post_map = {p.name.strip(): p for p in ShiftPost.query.all()}
        
        success_count = 0
        missing_names = set()

        # 3. 从第二行（Index 1）开始遍历日期和人名
        for index, row in df.iloc[1:].iterrows():
            # 处理日期列 (第 0 列)
            date_val = row[0]
            if pd.isna(date_val) or str(date_val).strip() == "": continue
            
            try:
                # 自动解析日期
                current_date = pd.to_datetime(str(date_val)).date()
            except: continue

            # 4. 遍历每一列人名 (从第 1 列开始)
            for col_idx in range(1, len(row)):
                emp_name = str(row[col_idx]).strip()
                
                # 排除空单元格、nan 和 休息
                if not emp_name or emp_name.lower() == 'nan' or "休息" in emp_name:
                    continue
                
                # 获取该列对应的岗位名称
                post_name = clean_headers[col_idx]
                target_post = post_map.get(post_name)
                
                if not target_post:
                    # 如果岗位名没对上，尝试模糊匹配（只要网页岗位名包含在表头里即可）
                    for p_name, p_obj in post_map.items():
                        if p_name in post_name or post_name in p_name:
                            target_post = p_obj
                            break
                
                if not target_post: continue

                # 5. 匹配员工 (确保名字完全一致)
                emp = EmploymentCycle.query.filter_by(name=emp_name).first()
                if emp:
                    # 识别班次类型（夜班标记）
                    s_type = '夜' if '夜' in post_name else '白'
                    
                    # 检查是否已存在
                    exists = Scheduling.query.filter_by(
                        employee_id=emp.id, 
                        date=current_date, 
                        post_id=target_post.id
                    ).first()
                    
                    if not exists:
                        new_s = Scheduling(
                            employee_id=emp.id, 
                            date=current_date, 
                            post_id=target_post.id,
                            shift_type=s_type,
                            hours=12.0 # 默认 12 小时，可根据需要调整
                        )
                        db.session.add(new_s)
                        success_count += 1
                else:
                    missing_names.add(emp_name)

        db.session.commit()
        
        res_msg = f"成功导入 {success_count} 条记录。"
        if missing_names:
            res_msg += f" 未在系统找到员工：{', '.join(list(missing_names)[:5])}"
            
        return jsonify({'success': True, 'message': res_msg})

    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': f'导入出错: {str(e)}'})
    
# --- 功能后端增加清空接口    
@scheduling_bp.route('/clear_month', methods=['POST'])
@login_required
def clear_month():
    # 获取要清空的年月，默认为 2026-01
    year_month = request.json.get('month', '2026-01')
    try:
        # 匹配该月的所有排班
        start_date = f"{year_month}-01"
        # 简单粗暴删除该月所有排班（如果你想更安全，可以按日期范围删除）
        num_deleted = Scheduling.query.filter(
            Scheduling.date.like(f"{year_month}%")
        ).delete(synchronize_session=False)
        
        db.session.commit()
        return jsonify({'success': True, 'message': f'已成功清空 {year_month} 的 {num_deleted} 条排班记录'})
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': f'清空失败: {str(e)}'})

# --- 功能：查询今日及明日的值班人员列表（用于大屏或通知） ---
@scheduling_bp.route('/api/daily_duty')
def get_daily_duty():
    from datetime import date, timedelta
    from sqlalchemy import case
    from models import Scheduling, EmploymentCycle, ShiftPost, db

    today = date.today()
    tomorrow = today + timedelta(days=1)
    
    def get_duty_by_date(target_date):
        try:
            priority_case = case((ShiftPost.name == '值班领导', 1), (ShiftPost.name == '值班长', 2), (ShiftPost.name == '备勤领班', 3),(ShiftPost.name == '机动-白班', 4),(ShiftPost.name == '机动-夜班', 5),else_=6)
            shifts = db.session.query(Scheduling, EmploymentCycle, ShiftPost)\
                .join(EmploymentCycle, Scheduling.employee_id == EmploymentCycle.id)\
                .join(ShiftPost, Scheduling.post_id == ShiftPost.id)\
                .filter(Scheduling.date == target_date)\
                .order_by(priority_case, ShiftPost.id).all()
            
            return [{
                "name": emp.name,
                "post": post.name,
                "phone": getattr(emp, 'phone', '-') or '-',
                "type": s.shift_type
            } for s, emp, post in shifts]
        except Exception as e:
            return []

    try:
        return jsonify({
            "today": get_duty_by_date(today),
            "tomorrow": get_duty_by_date(tomorrow),
            "status": "success"
        })
    except Exception as e:
        return jsonify({"error": str(e)}), 500

==================================================
FILE: .\routes\__init__.py
==================================================

# routes/__init__.py
# 注册所有蓝图到应用

def register_blueprints(app):
    from .main import main_bp
    from .auth import auth_bp
    from .hr import hr_bp
    from .asset import asset_bp
    from .fund import fund_bp
    from .permission import permission_bp
    from .scheduling import scheduling_bp, SCHEDULING_PERMISSIONS
    from .dorm import dorm_bp
    from .notification import notification_bp
    app.register_blueprint(main_bp)
    app.register_blueprint(auth_bp)
    app.register_blueprint(hr_bp)
    app.register_blueprint(asset_bp)
    app.register_blueprint(fund_bp)
    app.register_blueprint(permission_bp)
    app.register_blueprint(scheduling_bp)
    app.register_blueprint(dorm_bp)
    app.register_blueprint(notification_bp)


==================================================
FILE: .\templates\base.html
==================================================

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}蔡路特保队队务管理系统{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 70px;
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .footer {
            margin-top: 50px;
            padding: 20px 0;
            background-color: #343a40;
            color: white;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="bi bi-shield-lock"></i> 蔡路特保队队务管理系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- 核心修复：清理<ul>内的多余空白/注释，确保只有<li>作为直接子元素 -->
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.index') }}"><i class="bi bi-house"></i> 首页看板</a>
                    </li>
                    <li class="nav-item">
                        {% if current_user.is_authenticated %}
                            {% if perm.can('hr.view') %}
                                <a class="nav-link" href="{{ url_for('hr.hr_list') }}">
                                    <i class="bi bi-people"></i> 人事管理
                                    {% if pending_count > 0 %}
                                        <span class="badge bg-danger rounded-pill">{{ pending_count }}</span>
                                    {% endif %}
                                </a>
                            {% else %}
                                <a class="nav-link" href="{{ url_for('hr.hr_detail', id_card=current_user.username) }}">我的信息</a>
                            {% endif %}
                        {% else %}
                            <a class="nav-link" href="{{ url_for('auth.login') }}">我的信息</a>
                        {% endif %}
                    </li>
                    {% if perm.can('asset.view') %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('asset.asset_list') }}"><i class="bi bi-box-seam"></i> 资产管理</a>
                        </li>
                    {% endif %}
                    {% if perm.can('fund.view') %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('fund.fund_list') }}"><i class="bi bi-currency-exchange"></i> 资金管理</a>
                        </li>
                    {% endif %}
                    {% if perm.can('dorm.view') %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint and 'dorm.' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('dorm.dorm_map') }}">
                                <i class="bi bi-door-open"></i> 宿舍管理
                            </a>
                        </li>
                    {% endif %}
                    {% if perm.can('scheduling.view') %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint and 'scheduling.' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('scheduling.schedule_list') }}">
                                <i class="bi bi-calendar-check"></i> 考勤管理</a>
                        </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('notification.notification_list') }}">
                            <i class="bi bi-bell"></i> 通知
                            {% if current_user.is_authenticated %}
                                {% set unread_count = current_user.notifications|selectattr('is_read', 'equalto', false)|list|length %}
                                {% if unread_count > 0 %}
                                    <span class="badge bg-danger rounded-pill">{{ unread_count }}</span>
                                {% endif %}
                            {% endif %}
                        </a>
                    </li>
                    {% if current_user.role == 'admin' %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('permission.permission_manage') }}"><i class="bi bi-shield-lock"></i> 权限管理</a>
                        </li>
                    {% endif %}
                </ul>

                <!-- 右侧：日期 + 用户信息 + 登录/登出 -->
                <div class="d-flex align-items-center">
                    <span class="navbar-text me-3">
                        <i class="bi bi-calendar"></i> {{ today_str() }}
                    </span>
                    <span class="navbar-text me-3">
                        {% if current_user.is_authenticated %}
                            <a class="nav-link" href="{{ url_for('permission.permission_operations') }}">
                                <i class="bi bi-person-circle"></i> {{ current_user.name }}
                            </a>
                        {% else %}
                            <span class="text-muted">未登录</span>
                        {% endif %}
                    </span>
                    {% if current_user.is_authenticated %}
                        <a href="{{ url_for('auth.change_password') }}" class="btn btn-outline-light me-2">
                            <i class="bi bi-key"></i> 修改密码
                        </a>
                        <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-light">
                            <i class="bi bi-box-arrow-right"></i> 登出
                        </a>
                    {% else %}
                        <a href="{{ url_for('auth.login') }}" class="btn btn-outline-light">
                            <i class="bi bi-box-arrow-in-right"></i> 登录
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>

    <footer class="footer">
        <div class="container">
            <small>© 2026 蔡路特保队队务管理系统 · 本地部署 · 仅限内部使用</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}{% endblock %}

    <audio id="globalNoticeAudio" preload="auto">
        <source src="/static/audio/beep.mp3" type="audio/mpeg">
    </audio>

    <script>
        let globalAlarmInterval = null;

        function doGlobalCheck() {
            // 使用绝对路径请求接口
            fetch("/notification/unread_count")
                .then(response => response.json())
                .then(data => {
                    const count = data.unread_count;
                    const audio = document.getElementById('globalNoticeAudio');

                    if (count > 0) {
                        // 启动报警
                        if (!globalAlarmInterval) {
                            console.log("全局监控：发现新消息，开始报警");
                            globalAlarmInterval = setInterval(() => {
                                audio.play().catch(e => {
                                    // 如果被拦截，在控制台静默，不干扰用户
                                });
                            }, 2000); // 每2秒嘀一声
                        }
                        // 在所有页面的标签栏显示数量
                        document.title = `(新消息 ${count}) ` + (window.originalTitle || document.title);
                    } else {
                        // 停止报警
                        if (globalAlarmInterval) {
                            clearInterval(globalAlarmInterval);
                            globalAlarmInterval = null;
                        }
                        if (window.originalTitle) document.title = window.originalTitle;
                    }
                }).catch(err => console.log("通知接口请求失败"));
        }

        // 记录原始标题，方便恢复
        window.originalTitle = document.title;

        // 1. 立即执行一次
        doGlobalCheck();

        // 2. 每 3 秒检查一次 (解决你说的等太久问题)
        setInterval(doGlobalCheck, 3000);

        // 3. 激活音频权限 (只要点过页面任何地方就开始生效)
        document.addEventListener('click', () => {
            doGlobalCheck();
        }, { once: true });
    </script>
</body>
</html>

==================================================
FILE: .\templates\index.html
==================================================

{% extends "base.html" %}

{% block title %}首页 - 看板{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row g-3 mb-5">
        <div class="col-md col-6">
            <div class="card text-white bg-primary h-100 shadow-sm">
                <div class="card-body text-center py-3">
                    <i class="bi bi-people fs-2 mb-2"></i>
                    <h6 class="mb-1">在职人数</h6>
                    <h3 class="mb-0">{{ active_count }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md col-6">
            <div class="card text-white bg-secondary h-100 shadow-sm">
                <div class="card-body text-center py-3">
                    <i class="bi bi-person-x fs-2 mb-2"></i>
                    <h6 class="mb-1">离职人数</h6>
                    <h3 class="mb-0">{{ departed_count }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md col-6">
            <div class="card text-white bg-info h-100 shadow-sm">
                <div class="card-body text-center py-3">
                    <i class="bi bi-person-heart fs-2 mb-2"></i>
                    <h6 class="mb-1">历史总人数</h6>
                    <h3 class="mb-0">{{ total_unique }}</h3>
                </div>
            </div>
        </div>
        
        {% if perm.can('fund.view') %}
        <div class="col-md col-6">
            <div class="card text-white bg-success h-100 shadow-sm">
                <div class="card-body text-center py-3">
                    <i class="bi bi-wallet2 fs-2 mb-2"></i>
                    <h6 class="mb-1">当前队费</h6>
                    <h3 class="mb-0">¥{{ "%.0f"|format(current_balance) }}</h3>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="col-md col-6">
            <div class="card text-white bg-warning h-100 shadow-sm">
                <div class="card-body text-center py-2">
                    <i class="bi bi-gift fs-4 mb-1"></i>
                    <h6 class="mb-1">本月生日</h6>
                    <h4 class="mb-1">{{ birthday_employees|length }} <small class="fs-6">人</small></h4>
                    
                    <div style="max-height: 55px; overflow-y: auto; font-size: 0.75rem;" class="mt-1">
                        {% if birthday_employees %}
                            {% for emp in birthday_employees %}
                            <div class="d-flex justify-content-between px-2">
                                <span>{{ emp.name }}</span>
                                <span>{{ emp.birthday.month }}月 {{ emp.birthday.day }}日</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="small opacity-75 mb-0">无</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




    <div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-geo-alt"></i> 在职人员户籍地分布（全国地图）</h5>
            </div>
            <div class="card-body">
                <div id="chinaMap" style="width:100%; height:500px;"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="row g-4">
            <div class="col-12">
                <div class="card shadow border-0 border-start border-primary border-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center py-2">
                        <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-calendar-check"></i> 今日值班</h6>
                        <span class="badge bg-primary rounded-pill small" id="today_label"></span>
                    </div>
                    <div class="card-body p-0" style="max-height: 245px; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0 align-middle" style="font-size: 0.85rem;">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-2">姓名</th>
                                        <th>岗位</th>
                                        <th>电话</th>
                                    </tr>
                                </thead>
                                <tbody id="today_duty_list">
                                    <tr><td colspan="2" class="text-center py-3 text-muted">加载中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <div class="card shadow border-0 border-start border-success border-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center py-2">
                        <h6 class="mb-0 fw-bold text-success"><i class="bi bi-calendar-plus"></i> 明日预告</h6>
                        <span class="badge bg-success rounded-pill small" id="tomorrow_label"></span>
                    </div>
                    <div class="card-body p-0" style="max-height: 245px; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0 align-middle" style="font-size: 0.85rem;">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-2">姓名</th>
                                        <th>岗位</th>
                                        <th>电话</th>
                                    </tr>
                                </thead>
                                <tbody id="tomorrow_duty_list">
                                    <tr><td colspan="2" class="text-center py-3 text-muted">加载中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        

        <!-- ECharts核心 + 中国地图数据包 -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/map/js/china.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var chartDom = document.getElementById('chinaMap');
        var myChart = echarts.init(chartDom);

        // 接收后端传递的数据（Jinja2 已 tojson 并 safe）
        var provinceMapData = {{ province_map_data | safe }};


        

        // 动态计算最大值（避免硬编码）
        var maxValue = provinceMapData.length > 0 
            ? Math.max(...provinceMapData.map(item => item.value)) 
            : 10;

        var option = {
            backgroundColor: '#fff',  // 背景白底，更干净
            title: {
                text: '在职人员户籍地分布',
                left: 'center',
                top: 20,
                textStyle: {
                    color: '#333',
                    fontSize: 20,
                    fontWeight: 'bold'
                }
            },
            tooltip: {
                trigger: 'item',
                formatter: function (params) {
                    if (params.data) {
                        return `${params.name}<br/>人数：${params.data.value} 人`;
                    }
                    return `${params.name}<br/>人数：0 人`;
                },
                backgroundColor: 'rgba(0,0,0,0.7)',
                borderColor: '#333',
                textStyle: { color: '#fff' }
            },
            visualMap: {
                min: 0,
                max: maxValue,
                left: 'left',
                top: 'bottom',
                text: ['高', '低'],
                calculable: true,
                orient: 'horizontal',
                inRange: {
                    color: ['#e6f7ff', '#bae7ff', '#91d5ff', '#69c0ff', '#40a9ff', '#1890ff', '#0050b3']
                },
                textStyle: { color: '#333' }
            },
            series: [{
                name: '人数',
                type: 'map',
                map: 'china',
                roam: false,  // true支持缩放拖拽
                label: {
                    show: true,
                    fontSize: 11,
                    color: '#333',
                    formatter: function (params) {
                        return params.data ? `${params.name}\n${params.data.value}` : params.name;
                    }
                },
                emphasis: {
                    label: {
                        show: true,
                        color: '#fff',
                        fontSize: 12,
                        fontWeight: 'bold'
                    },
                    itemStyle: {
                        areaColor: '#0050b3',
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.3)'
                    }
                },
                itemStyle: {
                    borderColor: '#aaa',
                    borderWidth: 1
                },
                data: provinceMapData
            }]
        };

        myChart.setOption(option);

        // 响应式
        window.addEventListener('resize', function () {
            myChart.resize();
        });
    });
    // index.html 中的 <script> 标签内

document.addEventListener('DOMContentLoaded', function() {
    // 1. 设置日期标签
    const today = new Date();
    const tomorrow = new Date();
    tomorrow.setDate(today.getDate() + 1);
    
    document.getElementById('today_label').innerText = today.toLocaleDateString();
    document.getElementById('tomorrow_label').innerText = tomorrow.toLocaleDateString();

    // 2. 异步获取值班数据
    fetch("{{ url_for('scheduling.get_daily_duty') }}")
        .then(res => res.json())
        .then(data => {
            renderDutyTable('today_duty_list', data.today);
            renderDutyTable('tomorrow_duty_list', data.tomorrow);
        })
        .catch(err => console.error("加载值班信息失败:", err));
});

function renderDutyTable(elementId, dataList) {
    const tbody = document.getElementById(elementId);
    if (!dataList || dataList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-muted">暂无排班记录</td></tr>';
        return;
    }

    tbody.innerHTML = dataList.map(item => `
        <tr>
            <td class="ps-3 fw-bold text-dark">${item.name}</td>
            <td>
                <span class="badge ${item.type === '夜' ? 'bg-warning text-dark' : 'bg-info text-dark'}">
                    ${item.post}${item.type === '夜' ? '(夜班)' : ''}
                </span>
            </td>
            <td>
                <a href="tel:${item.phone}" class="text-decoration-none">
                    <i class="bi bi-telephone-outbound me-1"></i>${item.phone || '未记录'}
                </a>
            </td>
        </tr>
    `).join('');
}
</script>
        {% endblock %}

==================================================
FILE: .\templates\asset\add.html
==================================================

{% extends "base.html" %}
{% block title %}新增资产{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white py-3">
            <h4 class="mb-0"><i class="bi bi-box-seam"></i> 新增资产</h4>
        </div>
        <div class="card-body p-4">
            <form action="{{ url_for('asset.asset_add') }}" method="POST" enctype="multipart/form-data">
                <div class="mb-4">
                    <h5 class="mb-3 text-primary border-bottom pb-2">
                        <i class="bi bi-info-circle"></i> 资产基本信息
                    </h5>
                    {% include 'asset/_partial_asset_form.html' %}
                </div>

                <div class="card bg-light border-success my-4">
                    <div class="card-body">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="sync_fund" id="sync_fund_switch" style="cursor: pointer; transform: scale(1.2);">
                            <label class="form-check-label fw-bold text-success ms-2" for="sync_fund_switch" style="cursor: pointer;">
                                这是采购入库？(同时登记资金支出记录)
                            </label>
                        </div>
                        
                        <div id="finance_container" class="mt-3 shadow-sm p-4 bg-white rounded border border-success-subtle" style="display:none;">
                            <div class="text-center text-muted py-2">
                                <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                                正在加载财务表单...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg shadow">
                        <i class="bi bi-check-circle"></i> 确认新增资产
                    </button>
                    <a href="{{ url_for('asset.asset_list') }}" class="btn btn-link text-muted">取消返回</a>
                </div>
            </form>
        </div>
    </div>
</div>


{% endblock %}

==================================================
FILE: .\templates\asset\detail.html
==================================================

{% extends "base.html" %}

{% block title %}资产详情 - {{ asset.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-box-seam"></i> 资产详情 - {{ asset.name }}</h4>
                    <a href="{{ url_for('asset.asset_list') }}" class="btn btn-outline-light btn-sm">返回列表</a>
                </div>

                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="text-center mb-3">
                                {% if asset.photo_path %}
                                <img src="/{{ asset.photo_path }}" class="img-fluid rounded shadow-sm">
                                {% else %}
                                <div class="bg-light border rounded d-flex align-items-center justify-content-center"
                                    style="height:300px;">
                                    <span class="text-muted fs-4">无照片</span>
                                </div>
                                {% endif %}
                            </div>

                            {% if asset.instances %}
                            <div class="mt-4">
                                <h6
                                    class="fw-bold border-bottom pb-2 d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-list-ul"></i> 子资产明细 ({{ asset.instances|length }})</span>
                                    <button class="btn btn-sm btn-link p-0 text-decoration-none"
                                        onclick="clearSubSelect()">清除选中</button>
                                </h6>
                                <div class="list-group list-group-flush border rounded overflow-auto"
                                    style="max-height: 400px;" id="subAssetList">
                                    {% for item in asset.instances %}
                                    <button type="button"
                                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center sub-asset-item"
                                        onclick="selectSubAsset('{{ item.id }}', '{{ item.sn_number }}', this)"
                                        data-status="{{ item.status }}" data-sn="{{ item.sn_number }}">
                                        <div>
                                            <span class="fw-bold d-block">{{ item.sn_number }}</span>
                                            <small class="text-muted">状态: {{ item.status }}</small>
                                        </div>
                                        <span
                                            class="badge {% if item.status == '正常' %}bg-success{% elif item.status == '维修' %}bg-warning{% else %}bg-danger{% endif %} rounded-pill">
                                            {{ item.current_user or '在库' }}
                                        </span>
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-8">
                            <div class="alert alert-info py-2 d-none" id="subSelectAlert">
                                <i class="bi bi-info-circle"></i> 当前已选中子资产：<strong id="selectedSnText"></strong>
                            </div>

                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="120">资产类型</th>
                                    <td><span class="badge bg-secondary">{{ asset.type }}</span></td>
                                </tr>
                                <tr>
                                    <th>资产名称</th>
                                    <td>{{ asset.name }}</td>
                                </tr>
                                <tr>
                                    <th>资产编号</th>
                                    <td>{{ asset.number }}</td>
                                </tr>
                                <tr>
                                    <th>购置日期</th>
                                    <td>{{ asset.purchase_date.strftime('%Y-%m-%d') if asset.purchase_date else '-' }}
                                    </td>
                                </tr>
                                <tr>
                                    <th>存放位置</th>
                                    <td>{{ asset.location or '-' }}</td>
                                </tr>
                                <tr>
                                    <th>单价</th>
                                    <td>￥{{ "%.2f"|format(asset.unit_price) }}</td>
                                </tr>
                                <tr>
                                    <th>资产归属</th>
                                    <td>{{ asset.ownership }}</td>
                                </tr>
                                <tr>
                                    <th>库存/总数</th>
                                    <td>{{ asset.stock_quantity }} / {{ asset.total_quantity }}</td>
                                </tr>
                                <tr>
    <tr>
                                    <th>当前领用人</th>
                                    <td>
                                        {% set active_allocs = asset.allocations | selectattr('return_date', 'none') | list %}
                                        {% if active_allocs %}
                                        <div class="d-flex flex-wrap gap-2">
                                            {% for alloc in active_allocs %}
                                            <span class="badge bg-primary">
                                                {{ alloc.user.name }} <small>({{ alloc.quantity }} 个)</small>
                                            </span>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        {{ asset.department or '暂无领用人' }}
                                        {% endif %}
                                    </td>
                                </tr>

                                <tr>
                                    <th>状态</th>
                                    <td>
                                        <span
                                            class="badge {% if asset.status == '库存' %}bg-success{% elif asset.status == '使用中' %}bg-primary{% elif asset.status == '维修中' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ asset.status }}
                                        </span>
                                    </td>
                                </tr>
                            </table>

                            <div class="mt-4 p-3 bg-light rounded shadow-sm">
                                <div class="d-flex flex-wrap gap-2">
                                    <!-- 发放按钮，仅装备和服饰类型且有库存时显示 -->
                                    {% if asset.type in ['装备', '服饰'] and asset.stock_quantity > 0 %}
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#issueModal">
                                        <i class="bi bi-person-plus-fill"></i> 发放
                                    </button>
                                    {% endif %}
                                    <!-- 归还按钮，仅当有已分配数量时显示 -->
                                    {% if asset.allocated_quantity and asset.allocated_quantity > 0 %}
                                    <button class="btn btn-outline-primary" data-bs-toggle="modal"
                                        data-bs-target="#returnModal">
                                        <i class="bi bi-box-arrow-in-left"></i> 归还
                                    </button>
                                    {% endif %}
                                    <!-- 消耗按钮，仅消耗品类型显示 -->
                                    {% if asset.type == '消耗品' %}
                                    <button class="btn btn-danger" data-bs-toggle="modal"
                                        data-bs-target="#consumeModal">
                                        <i class="bi bi-basket3-fill"></i> 消耗
                                    </button>
                                    {% endif %}
                                    <!-- 补充库存按钮 -->          
                                    <button class="btn btn-success" data-bs-toggle="modal"
                                        data-bs-target="#supplementModal">
                                        <i class="bi bi-plus-circle"></i> 补充
                                    </button>
                                    <!-- 维修/修复按钮：排除消耗品类型 -->
                                    {% if asset.type != '消耗品' %}
                                        {% if asset.status == '维修中' %}
                                        <button class="btn btn-info text-white" onclick="handleRepairClick()"
                                            id="mainRepairBtn">
                                            <i class="bi bi-check-circle"></i> <span id="repairBtnText">维修完成</span>
                                        </button>
                                        {% else %}
                                        <button class="btn btn-warning" onclick="handleRepairClick()" id="mainRepairBtn">
                                            <i class="bi bi-wrench"></i> <span id="repairBtnText">维修</span>
                                        </button>
                                        {% endif %}
                                    {% endif %}
                                    <!-- 报废按钮：排除消耗品类型 -->
                                    {% if asset.type != '消耗品' %}
                                    <button class="btn btn-danger" onclick="handleScrapClick()" id="scrapBtn">
                                        <i class="bi bi-trash3"></i><span id="scrapBtnText">报废</span>
                                    </button>
                                    {% endif %}
                                </div>

                                {% if current_user.role == 'admin' %}
                                <div class="mt-4 pt-3 border-top d-flex justify-content-end gap-2">
                                    <a href="{{ url_for('asset.asset_edit', asset_id=asset.id) }}"
                                        class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil"></i> 编辑资料
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                        data-bs-target="#deleteModal">
                                        <i class="bi bi-trash"></i> 彻底删除
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            <!-- 操作历史开始 -->
                            <div class="mt-5">
    <h5 class="border-bottom pb-2 d-flex align-items-center justify-content-between">
        <span><i class="bi bi-clock-history me-2"></i> 资产操作历史</span>
        {% if history_items %}
        <small class="text-muted fw-normal" style="font-size: 0.8rem;">共 {{ pagination.total }} 条记录</small>
        {% endif %}
    </h5>

    {% if history_items %}
    <div class="d-flex justify-content-end mb-2">
        <ul class="pagination pagination-sm mb-0">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('asset.asset_detail', asset_id=asset.id, page=pagination.prev_num) if pagination.has_prev else '#' }}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            <li class="page-item disabled">
                <span class="page-link text-dark">{{ pagination.page }} / {{ pagination.pages }}</span>
            </li>
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('asset.asset_detail', asset_id=asset.id, page=pagination.next_num) if pagination.has_next else '#' }}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        </ul>
    </div>

    <div class="list-group list-group-flush shadow-sm rounded border">
        {% for h in history_items %}
        <div class="list-group-item p-3 history-row" data-sn="{{ h.sn_number or 'all' }}">
            <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                <h6 class="mb-0 fw-bold">
                    {% set badge_color = 'bg-secondary' %}
                    {% if h.action == '发放' %}{% set badge_color = 'bg-primary' %}
                    {% elif h.action == '归还' or h.action.startswith('归还') %}{% set badge_color = 'bg-info text-dark' %}
                    {% elif h.action == '补充' %}{% set badge_color = 'bg-success' %}
                    {% elif h.action == '报废' or h.action == '消耗' %}{% set badge_color = 'bg-danger' %}
                    {% elif h.action == '维修' %}{% set badge_color = 'bg-warning text-dark' %}{% endif %}
                    <span class="badge {{ badge_color }} me-2">{{ h.action }}</span>
                    {{ format_datetime(h.action_date) }}
                </h6>
                <small class="text-muted bg-light px-2 py-1 rounded border">
                    <i class="bi bi-person"></i> {{ h.operator.name if h.operator else '系统' }}
                </small>
            </div>
            <div class="ms-1 ps-3 border-start">
                <p class="mb-0 text-dark">
                    {% if h.action in ['发放', '归还'] and h.user %}
                        <strong>{{ h.user.name }}</strong>
                        {% if h.action == '发放' %}领用了{% else %}归还了{% endif %}
                        <span class="text-primary fw-bold">{{ h.quantity }}</span> 个资产
                    {% elif h.action.startswith('归还（离职自动）') %}
                        <span class="text-danger"><i class="bi bi-person-x"></i> {{ h.note }}</span>
                    {% else %}
                        {{ h.action }}数量: <span class="fw-bold">{{ h.quantity }}</span>
                    {% endif %}
                </p>
                {% if h.note and h.note != h.action and not h.action.startswith('归还（离职自动）') %}
                <small class="text-muted d-block mt-1">
                    <i class="bi bi-chat-left-dots"></i> 备注：{{ h.note }}
                </small>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('asset.asset_detail', asset_id=asset.id, page=pagination.prev_num) if pagination.has_prev else '#' }}">上一页</a>
            </li>

            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('asset.asset_detail', asset_id=asset.id, page=page_num) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('asset.asset_detail', asset_id=asset.id, page=pagination.next_num) if pagination.has_next else '#' }}">下一页</a>
            </li>
        </ul>
    </nav>

    {% else %}
    <div class="text-center py-5 border rounded bg-light shadow-sm">
        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
        <p class="text-muted mt-2">暂无操作历史记录</p>
    </div>
    {% endif %}
</div>
                                
                            <!-- 操作历史结束 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 子资产动态模态框 -->
<div class="modal fade" id="subAssetDynamicModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="subAssetForm" method="POST" class="modal-content">
            <div class="modal-header" id="subModalHeader">
                <h5 class="modal-title" id="subModalTitle">子资产操作</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="sub_asset_id" id="hiddenSubId">
                <p id="subModalMessage" class="fw-bold"></p>
                <div class="mb-3">
                    <label class="form-label" id="subNoteLabel">原因/备注 <span class="text-danger">*</span></label>
                    <textarea name="note" class="form-control" rows="3" required placeholder="请详细说明情况..."></textarea>
                </div>
                <div class="alert alert-warning small">
                    <i class="bi bi-exclamation-triangle"></i> 注意：此操作仅针对选中的单个编号生效。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" class="btn" id="subModalSubmitBtn">确认提交</button>
            </div>
        </form>
    </div>
</div>
<!-- 发放模态框 -->
{% if asset.type in ['装备', '服饰'] and asset.stock_quantity > 0 %}
<div class="modal fade" id="issueModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">发放资产</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('asset.asset_issue', asset_id=asset.id) }}">
                <div class="modal-body">
                    <label class="form-label">选择使用人 <span class="text-danger">*</span></label>
                    <select name="user_id" class="form-select" required>
                        <option value="">-- 请选择在职员工 --</option>
                        {% for emp in in_service_employees %}
                        <option value="{{ emp.id }}">{{ emp.name }} ({{ emp.position or '无' }}/{{ emp.post or '无' }})
                        </option>
                        {% endfor %}
                    </select>
                    <div class="mb-3 mt-3">
                        <label class="form-label">发放数量</label>
                        <input type="number" name="quantity" class="form-control" value="1" min="1"
                            max="{{ asset.stock_quantity }}" required>
                        <small class="text-muted">剩余库存：{{ asset.stock_quantity }}</small>
                    </div>
                    <label class="form-label">备注</label>
                    <textarea name="note" class="form-control" rows="2" placeholder="可选"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">确认发放</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
<!-- 归还模态框 -->
{% if asset.allocated_quantity > 0 %}
<div class="modal fade" id="returnModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">归还资产</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('asset.asset_return', asset_id=asset.id) }}">
                <div class="modal-body">
                    <p>确认归还 <strong>{{ asset.name }}</strong> 吗？</p>
                    <label class="form-label">选择归还人 <span class="text-danger">*</span></label>
                    <select name="user_id" class="form-select" required>
                        <option value="">-- 请选择当前领用人 --</option>
                        {% set summary = {} %}
                        {% for a in asset.allocations if a.return_date is none %}
                        {% set _ = summary.update({a.user_id: (summary.get(a.user_id, 0) + a.quantity)}) %}
                        {% endfor %}
                        {% for uid, qty in summary.items() %}
                        {% set uname = (asset.allocations|selectattr('user_id', 'equalto', uid)|first).user.name %}
                        <option value="{{ uid }}">{{ uname }} (剩余持有: {{ qty }} 个)</option>
                        {% endfor %}
                    </select>
                    <div class="mb-3 mt-3">
                        <label class="form-label">归还数量</label>
                        <input type="number" name="quantity" class="form-control" value="1" min="1"
                            max="{{ asset.allocated_quantity }}" required>
                    </div>
                    <label class="form-label">备注</label>
                    <textarea name="note" class="form-control" rows="2"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning">确认归还</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
<!-- 消耗模态框（消耗品） -->
{% if asset.type == '消耗品' %}
<div class="modal fade" id="consumeModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">消耗资产</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('asset.asset_consume', asset_id=asset.id) }}">
                <div class="modal-body">
                    <p>确认消耗 <strong>{{ asset.name }}</strong> 吗？</p>
                    <div class="mb-3">
                        <label class="form-label">消耗数量</label>
                        <input type="number" name="quantity" class="form-control" value="1" min="1"
                            max="{{ asset.stock_quantity }}" required>
                        <small class="text-muted">当前库存：{{ asset.stock_quantity }}</small>
                    </div>
                    <label class="form-label">备注</label>
                    <textarea name="note" class="form-control" rows="2" placeholder="如用于日常清洁"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-danger">确认消耗</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
<!-- 补充库存模态框 -->
<div class="modal fade" id="supplementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-success">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-plus-lg"></i> 补充库存 - {{ asset.name }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('asset.asset_supplement', asset_id=asset.id) }}">
                <div class="modal-body">
                    <div class="alert alert-info py-2">
                        <small>当前库存：<strong>{{ asset.stock_quantity }}</strong>，当前总数：<strong>{{ asset.total_quantity
                                }}</strong></small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">补充数量 <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="number" name="quantity" id="supp_qty" class="form-control form-control-lg"
                                value="1" min="1" required>
                            <span class="input-group-text">个 / 套</span>
                        </div>
                        <div class="form-text text-success" id="supp_preview" data-total="{{ asset.total_quantity }}">
                            补充后总数将变为: {{ asset.total_quantity + 1 }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">备注说明</label>
                        <textarea name="note" class="form-control" rows="2" placeholder="备注内容"></textarea>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success px-4">确认入库</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- 报废模态框 -->
<div class="modal fade" id="scrapModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">报废资产</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('asset.asset_scrap', asset_id=asset.id) }}">
                <div class="modal-body">
                    <div class="alert alert-warning py-2 small">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        注意：报废仅限从<strong>库存</strong>中扣除。若需报废队员已领用的物资，请先执行“归还”操作。
                    </div>

                    <div class="mb-3">
                        <label class="form-label">报废数量</label>
                        <input type="number" name="quantity" class="form-control" value="1" min="1"
                            max="{{ asset.stock_quantity }}" required>
                        <div class="form-text text-danger">
                            当前仓库可用库存：{{ asset.stock_quantity }}
                            {% if asset.allocated_quantity > 0 %}
                            (另有 {{ asset.allocated_quantity }} 个已分配在队员手中，不可直接报废)
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">报废原因</label>
                        <textarea name="reason" class="form-control" rows="3" placeholder="请详细说明资产损坏或报废的具体原因"
                            required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-danger" {% if asset.stock_quantity <=0 %}disabled{% endif %}>
                        确认报废
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- 维修模态框 -->
<div class="modal fade" id="repairModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-wrench-adjustable"></i> 资产送修</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('asset.asset_repair', asset_id=asset.id) }}">
                <div class="modal-body">
                    <p>确认将资产 <strong>{{ asset.name }}</strong> 标记为维修状态吗？</p>
                    <div class="mb-3">
                        <label class="form-label">故障描述 / 维修备注 <span class="text-danger">*</span></label>
                        <textarea name="note" class="form-control" rows="3" placeholder="请填写具体故障原因" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning">确认送修</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- 修复模态框 -->
<div class="modal fade" id="completeRepairModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> 维修完成确认</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('asset.asset_complete_repair', asset_id=asset.id) }}">
                <div class="modal-body">
                    <p>确认该资产已修复，可以重新投入使用吗？</p>
                    <div class="mb-3">
                        <label class="form-label">维修结果说明</label>
                        <textarea name="note" class="form-control" rows="2" placeholder="可选：填写维修花费、更换零件等信息"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-info text-white">确认修复</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- 彻底删除资产模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-octagon"></i> 彻底删除资产</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="text-danger fw-bold">此操作将永久删除该资产及其所有历史记录，无法恢复！</p>
                <p>确认删除 <strong>{{ asset.name }}</strong> 吗？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form action="{{ url_for('asset.asset_delete', asset_id=asset.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">确认永久删除</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- 自定义脚本 -->
<script>
    // 定义全局变量，存储当前选中的子资产信息
    let selectedSubId = null;
    let selectedSubSn = null;

    /**
     * 1. 选中子资产处理函数（整合原有逻辑，避免重复定义）
     */
    function selectSubAsset(id, sn, element) {
        selectedSubId = id;
        selectedSubSn = sn;

        // UI反馈：清除其他项高亮，高亮当前项
        document.querySelectorAll('.sub-asset-item').forEach(item => {
            item.classList.remove('active', 'bg-primary', 'text-white');
        });
        element.classList.add('active', 'bg-primary', 'text-white');

        // 显示提醒栏并更新SN文字
        const alertBox = document.getElementById('subSelectAlert');
        if (alertBox) {
            alertBox.classList.remove('d-none');
            document.getElementById('selectedSnText').innerText = sn;
        }

        // 自动切换右侧按钮的颜色和文字
        const repairBtn = document.getElementById('repairBtnText');
        const scrapBtn = document.getElementById('scrapBtnText');
        const mainRepairBtn = document.getElementById('mainRepairBtn');
        const isRepairing = element.getAttribute('data-status') === '维修';
        
        // 仅非消耗品才更新按钮
        if ('{{ asset.type }}' !== '消耗品') {
            if (repairBtn && mainRepairBtn) {
                if (isRepairing) {
                    mainRepairBtn.className = "btn btn-info text-white";
                    repairBtn.innerText = "修复选中件";
                } else {
                    mainRepairBtn.className = "btn btn-warning";
                    repairBtn.innerText = "维修选中件";
                }
            }
            if (scrapBtn) scrapBtn.innerText = "报废选中件";
            
            // 禁用报废按钮（如果子资产不在库）
            const scrapBtnDom = document.getElementById('scrapBtn');
            const isInStock = element.querySelector('.badge').innerText === '在库';
            if (scrapBtnDom) scrapBtnDom.disabled = !isInStock;
        }

        // 联动过滤下方的历史记录表格
        filterHistoryTable(sn);
    }

    /**
     * 2. 清除选中状态
     */
    function clearSubSelect() {
        selectedSubId = null;
        selectedSubSn = null;

        // 移除所有列表项的高亮状态
        document.querySelectorAll('.sub-asset-item').forEach(item => {
            item.classList.remove('active', 'bg-primary', 'text-white');
        });

        // 隐藏提醒栏，恢复按钮文字
        const alertBox = document.getElementById('subSelectAlert');
        if (alertBox) alertBox.classList.add('d-none');

        // 仅非消耗品才恢复按钮
        if ('{{ asset.type }}' !== '消耗品') {
            const repairBtn = document.getElementById('repairBtnText');
            const scrapBtn = document.getElementById('scrapBtnText');
            const mainRepairBtn = document.getElementById('mainRepairBtn');
            
            if (repairBtn && mainRepairBtn) {
                if ('{{ asset.status }}' === '维修中') {
                    mainRepairBtn.className = "btn btn-info text-white";
                    repairBtn.innerText = "维修完成";
                } else {
                    mainRepairBtn.className = "btn btn-warning";
                    repairBtn.innerText = "维修";
                }
            }
            if (scrapBtn) scrapBtn.innerText = "报废";
            
            // 恢复报废按钮状态
            const scrapBtnDom = document.getElementById('scrapBtn');
            if (scrapBtnDom) scrapBtnDom.disabled = {{asset.stock_quantity <= 0}};
        }

        // 显示所有历史记录
        filterHistoryTable('all');
    }

    /**
     * 3. 动态控制：点击“维修”按钮时的路由分发
     */
    function handleRepairClick() {
        // 1. 跳过消耗品
        if ('{{ asset.type }}' === '消耗品') return;
        
        // 2. 如果选中了子资产
        if (selectedSubId) {
            const subItem = document.querySelector(`.sub-asset-item.active`);
            const isSubRepairing = subItem.getAttribute('data-status') === '维修';

            if (isSubRepairing) {
                openSubAssetModal('维修完成', "{{ url_for('asset.asset_complete_repair_sub') }}", 'bg-info text-white', 'btn-info');
            } else {
                openSubAssetModal('维修', "{{ url_for('asset.asset_repair_sub') }}", 'bg-warning', 'btn-warning');
            }
        }
        // 3. 没有选中子资产（操作主资产）
        else {
            if ('{{ asset.status }}' === '维修中') {
                new bootstrap.Modal(document.getElementById('completeRepairModal')).show();
            } else {
                new bootstrap.Modal(document.getElementById('repairModal')).show();
            }
        }
    }

    /**
     * 4. 动态控制：点击“报废”按钮时的路由分发
     */
    function handleScrapClick() {
        // 1. 跳过消耗品
        if ('{{ asset.type }}' === '消耗品') return;
        
        // 2. 如果选中了子资产
        if (selectedSubId) {
            const subItem = document.querySelector(`.sub-asset-item.active`);
            const isInStock = subItem.querySelector('.badge').innerText === '在库';
            
            // 校验：仅库存子资产可报废
            if (!isInStock) {
                alert('该子资产不在库存中，无法报废！请先归还后再操作。');
                return;
            }
            
            openSubAssetModal('报废', "{{ url_for('asset.asset_scrap_sub') }}", 'bg-danger text-white', 'btn-danger');
        }
        // 3. 没有选中子资产（操作主资产）
        else {
            const masterScrapModal = new bootstrap.Modal(document.getElementById('scrapModal'));
            masterScrapModal.show();
        }
    }

    /**
     * 5. 打开子资产专用模态框并配置内容
     */
    function openSubAssetModal(action, url, headerClass, btnClass) {
        document.getElementById('hiddenSubId').value = selectedSubId;
        document.getElementById('subAssetForm').action = url;

        document.getElementById('subModalHeader').className = `modal-header ${headerClass}`;
        document.getElementById('subModalTitle').innerText = `子资产${action}`;
        document.getElementById('subModalMessage').innerHTML = `您正在对编号为 <span class="badge bg-dark">${selectedSubSn}</span> 的资产进行${action}操作。`;

        const submitBtn = document.getElementById('subModalSubmitBtn');
        submitBtn.className = `btn ${btnClass}`;
        submitBtn.innerText = `确认提交${action}`;

        // 调起模态框
        const subModal = new bootstrap.Modal(document.getElementById('subAssetDynamicModal'));
        subModal.show();
        
        // 模态框关闭后刷新页面（同步子资产状态）
        subModal._element.addEventListener('hidden.bs.modal', function() {
            window.location.reload();
        });
    }

    /**
     * 6. 辅助：过滤历史记录表格
     */
    function filterHistoryTable(sn) {
        const rows = document.querySelectorAll('.history-row');
        rows.forEach(row => {
            const rowSn = row.getAttribute('data-sn') || "all";
            if (sn === 'all' || rowSn === sn) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // 补充库存实时预览逻辑（修复语法错误+兼容异常输入）
    const suppInput = document.getElementById('supp_qty');
    const suppPreview = document.getElementById('supp_preview');

    if (suppInput && suppPreview) {
        // 初始化data-total属性
        const currentTotal = parseInt(suppPreview.dataset.total) || 0;
        
        suppInput.addEventListener('input', function () {
            // 处理输入值：确保为有效整数，空值/非数字时默认为 1（符合min=1的约束）
            const val = Math.max(1, parseInt(this.value.trim()) || 1);
            // 计算新总数（确保非负）
            const newTotal = Math.max(0, currentTotal + val);
            suppPreview.innerText = `补充后总数将变为: ${newTotal}`;
        });
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 子资产为空时隐藏“清除选中”按钮
        if (!document.getElementById('subAssetList')) {
            const clearBtn = document.querySelector('.btn-sm.btn-link[onclick="clearSubSelect()"]');
            if (clearBtn) clearBtn.style.display = 'none';
        }
        
        // 初始化报废按钮状态
        if ('{{ asset.type }}' !== '消耗品') {
            const scrapBtnDom = document.getElementById('scrapBtn');
            if (scrapBtnDom) scrapBtnDom.disabled = {{ asset.stock_quantity <= 0 }};
        }
    });
</script>

<style>
    /* 为子资产列表添加鼠标悬停效果 */
    .sub-asset-item {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .sub-asset-item:hover {
        background-color: #f8f9fa;
    }

    .sub-asset-item.active {
        border-left: 5px solid #0d6efd;
        /* 选中时左侧加粗色条 */
    }
</style>
{% endblock %}

==================================================
FILE: .\templates\asset\edit.html
==================================================

{% extends "base.html" %}

{% block title %}编辑资产 - {{ asset.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0"><i class="bi bi-pencil"></i> 编辑资产 - {{ asset.name }}</h4>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">资产类型 <span class="text-danger">*</span></label>
                        <select name="type" class="form-select" required>
                            {% for t in ['装备', '消耗品', '固定资产', '服饰', '工具'] %}
                            <option value="{{ t }}" {% if t==asset.type %}selected{% endif %}>{{ t }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">资产名称 <span class="text-danger">*</span></label>
                        <input type="text" name="name" class="form-control" value="{{ asset.name }}" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">资产编号（不可修改）</label>
                        <input type="text" class="form-control bg-light" value="{{ asset.number }}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">总数（谨慎修改）</label>
                        <input type="number" name="total_quantity" class="form-control"
                            value="{{ asset.total_quantity }}" min="1" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">购置日期</label>
                        <input type="date" name="purchase_date" class="form-control" value="{{ asset.purchase_date }}"
                            min="0001-01-01" max="9999-12-31">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">存放位置</label>
                        <input type="text" name="location" class="form-control" value="{{ asset.location }}">
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">资产归属</label>
                        <select name="ownership" class="form-select">
                            {% for owner in ['公司', '派出所', '个人', '特保队'] %}
                            <option value="{{ owner }}" {% if asset.ownership==owner %}selected{% endif %}>{{ owner }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">资产照片</label>
                        <input type="file" name="photo" class="form-control" accept="image/*">
                        {% if asset.photo_path %}
                        <small class="text-muted">当前照片：<img src="/{{ asset.photo_path }}"
                                width="100"></small>
                        {% endif %}
                    </div>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-warning btn-lg px-5">保存修改</button>
                    <a href="{{ url_for('asset.asset_detail', asset_id=asset.id) }}"
                        class="btn btn-secondary btn-lg px-5">取消</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

==================================================
FILE: .\templates\asset\import.html
==================================================

{% extends "base.html" %}

{% block title %}导入资产{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0"><i class="bi bi-upload"></i> 导入资产</h4>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>导入要求：</strong>
                <ul class="mb-0">
                    <li>必须包含列：资产类型、资产名称、资产编号</li>
                    <li>可选列：数量、购置日期、存放位置、分配模式（personal/group）、部门</li>
                    <li>资产编号不能重复</li>
                    <li>数量默认为1</li>
                </ul>
            </div>

            <form method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label">选择Excel文件</label>
                    <input type="file" name="file" class="form-control" accept=".xlsx" required>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-success btn-lg px-5">开始导入</button>
                    <a href="{{ url_for('asset.asset_list') }}" class="btn btn-secondary btn-lg px-5">取消</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

==================================================
FILE: .\templates\asset\inventory.html
==================================================

{% extends "base.html" %}
{% block title %}全局资产盘点{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-clipboard-check"></i> 全局资产盘点</h4>
            <div>
                <a href="{{ url_for('asset.asset_list') }}" class="btn btn-outline-light btn-sm me-2">返回资产列表</a>
                <a href="{{ url_for('asset.export_inventory') }}" class="btn btn-outline-light btn-sm">导出盘点清单</a>
            </div>
        </div>
        <div class="card-body">
            <!-- 筛选栏 -->
            <form method="GET" class="row g-3 mb-4">
                <div class="col-md-3">
                    <select name="type" class="form-select">
                        <option value="">所有资产类型</option>
                        {% for type in asset_types %}
                        <option value="{{ type }}" {% if type_filter==type %}selected{% endif %}>{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="status" class="form-select">
                        <option value="">所有资产状态</option>
                        {% for status in asset_status %}
                        <option value="{{ status }}" {% if status_filter==status %}selected{% endif %}>{{ status }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-outline-secondary w-100">筛选</button>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-success me-2">正常：{{ normal }} 个</span>
                    <span class="badge bg-danger me-2">异常：{{ abnormal }} 个</span>
                    <span class="badge bg-secondary">总计：{{ total }} 个</span>
                </div>
            </form>

            <!-- 盘点清单 -->
            <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                <table class="table table-hover align-middle">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>资产编号</th>
                            <th>资产名称</th>
                            <th>类型</th>
                            <th>存放位置</th>
                            <th>负责人</th>
                            <th>资产状态</th>
                            <th>资产归属</th>
                            <th>上次盘点</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asset in assets %}
                        <tr>
                            <td>{{ asset.sn_number }}</td>
                            <td>{{ asset.asset_info.name }}</td>
                            <td><span class="badge bg-light text-dark">{{ asset.asset_info.type }}</span></td>
                            <td>{{ asset.current_room.number if asset.current_room else '待分配' }}</td>
                            <td>{{ asset.current_holder.name if asset.current_holder else '无' }}</td>
                            <td>
                                <span
                                    class="badge {% if asset.status == '正常' %}bg-success{% elif asset.status == '维修' %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ asset.status }}
                                </span>
                            </td>
                            <td>
                                {{ asset.asset_info.ownership or '' }}

                            </td>
                            <td>{{ format_date(asset.last_check_date) or '未盘点' }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary"
                                    onclick="checkAsset('{{ asset.id }}', '{{ asset.sn_number }}')">
                                    <i class="bi bi-check-circle"></i> 标记已盘点
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not assets %}
                        <tr>
                            <td colspan="9" class="text-center text-muted py-3">无符合条件的资产</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function checkAsset(assetId, assetSn) {
        fetch(`/asset/inventory/update/${assetId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ "status": "正常" })
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                alert(data.message);
                // 刷新当前行的盘点时间
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    if (row.querySelector('td:first-child').textContent === assetSn) {
                        const now = new Date().toLocaleDateString();
                        row.querySelector('td:nth-child(8)').textContent = now;
                    }
                });
            }
        });
    }
</script>
{% endblock %}

==================================================
FILE: .\templates\asset\list.html
==================================================

{% extends "base.html" %}

{% block title %}资产列表{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-box-seam me-2"></i>资产总览</h4>
            <div>
                {% if perm.can('hr.view') %}
                <a href="{{ url_for('asset.asset_export', status=status_filter, search=search) }}" class="btn btn-light me-2">
                    <i class="bi bi-download"></i> 导出数据
                </a>
                <a href="{{ url_for('asset.asset_import') }}" class="btn btn-light me-2">
                    <i class="bi bi-upload"></i> 导入数据
                </a>
                <a href="{{ url_for('asset.asset_inventory') }}" class="btn btn-light me-2">  <!-- 新增盘点入口 -->
        <i class="bi bi-clipboard-check"></i> 资产盘点
    </a>
                <a href="{{ url_for('asset.asset_add') }}" class="btn btn-light">
                    <i class="bi bi-person-plus"></i> 新增数据
                </a>
                {% endif %}
            </div>
        </div>

        <div class="card-body">
            <form method="GET" class="mb-4">
                <div class="row g-3">
                    <div class="col-md-8">
                        <input type="text" name="search" class="form-control" placeholder="搜索资产名称 / 编号 / 序列号"
                            value="{{ search or '' }}">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-outline-primary w-100">搜索资产</button>
                    </div>
                </div>
            </form>

            <ul class="nav nav-tabs mb-4">
                {% for t in ['固定资产', '装备', '服饰', '工具', '消耗品'] %}
                <li class="nav-item">
                    <a class="nav-link {% if type_filter == t %}active{% endif %}"
                        href="{{ url_for('asset.asset_list', type=t) }}">
                        {{ t }}
                        {% if t == '固定资产' and repair_count > 0 %}
                        <span class="badge rounded-pill bg-danger">{{ repair_count }}</span>
                        {% endif %}
                    </a>
                </li>
                {% endfor %}
            </ul>

            <form method="GET" class="mb-4 bg-light p-3 rounded">
                <input type="hidden" name="type" value="{{ type_filter }}">
                <input type="hidden" name="search" value="{{ search }}">
                <div class="row align-items-center">
                    <div class="col-auto"><strong>显示字段：</strong></div>
                    <div class="col">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="name" id="show_name" 
                                {% if 'name' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_name">名称</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="number" id="show_number" 
                                {% if 'number' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_number">编号/SN码</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="status" id="show_status" 
                                {% if 'status' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_status">状态</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="ownership" id="show_ownership" 
                                {% if 'ownership' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_ownership">资产归属</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="location" id="show_loc" 
                                {% if 'location' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_loc">位置</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="current_user" id="show_user" 
                                {% if 'current_user' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_user">领用人</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-outline-secondary btn-sm">应用视图</button>
                    </div>
                </div>
            </form>

            <div class="table-responsive">
                <table class="table table-hover align-middle border-top">
                    <thead class="bg-light">
                        <tr class="text-secondary small text-uppercase">
                            <th class="ps-3" style="width: 80px;">资产</th>
                            
                            {% if 'name' in show_fields %}<th>名称信息</th>{% endif %}
                            {% if 'number' in show_fields %}<th>编号/SN</th>{% endif %}
                            
                            <th>资产类型</th> 
                            {% if 'ownership' in show_fields %}<th>资产归属</th>{% endif %}
                            <th class="text-center">总数 / 库存/ 已分配</th>
                            
                            {% if 'status' in show_fields %}<th>当前状态</th>{% endif %}
                            {% if 'location' in show_fields %}<th>存放位置</th>{% endif %}
                            {% if 'current_user' in show_fields %}<th>使用方/领用人</th>{% endif %}
                            
                            <th class="text-end pe-3">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if assets %}
                        {% for asset in assets %}
                        <tr>
                            <td class="ps-3">
                                {% if asset.photo_path %}
                                <img src="/{{ asset.photo_path }}" 
                                     class="rounded shadow-sm border" style="width:50px; height:50px; object-fit:cover;">
                                {% else %}
                                <div class="rounded bg-light d-flex align-items-center justify-content-center border" 
                                     style="width:50px; height:50px;">
                                    <i class="bi bi-image text-muted"></i>
                                </div>
                                {% endif %}
                            </td>

                            {% if 'name' in show_fields %}
                            <td><div class="fw-bold text-dark">{{ asset.name }}</div></td>
                            {% endif %}

                            {% if 'number' in show_fields %}
                            <td><div class="text-muted small">{{ asset.number or '-' }}</div></td>
                            {% endif %}

                            <td><span class="badge bg-light text-dark border">{{ asset.type }}</span></td>
                            
                            {% if 'ownership' in show_fields %}
                            <td>{{ asset.ownership or '' }}</td>
                            {% endif %}
                            
                            <td class="text-center">
    <span class="text-muted small" title="总数量">{{ asset.total_quantity }}</span>
    <span class="mx-1 text-muted">/</span>

    <span class="fw-bold {% if asset.stock_quantity > 0 %}text-success{% else %}text-danger{% endif %}" title="在库数量">
        {{ asset.stock_quantity }}
    </span>
        <span class="mx-1 text-muted">/</span>

    <span class="text-primary" title="已分配数量">
        {{ asset.total_quantity - asset.stock_quantity }}
    </span>
    
    
</td>

                            {% if 'status' in show_fields %}
                            <td>
                                {% set status_map = {'库存': 'success', '使用中': 'primary', '维修中': 'warning', '报废': 'danger'} %}
                                <span class="badge rounded-pill bg-{{ status_map.get(asset.status, 'secondary') }}">
                                    {{ asset.status }}
                                </span>
                            </td>
                            {% endif %}

                            {% if 'location' in show_fields %}
                            <td>{{ asset.location or '未设定' }}</td>
                            {% endif %}

                            {% if 'current_user' in show_fields %}
                            <td>
                                <small class="text-muted">
                                    {% if asset.allocation_mode == 'group' %}
                                        <i class="bi bi-people me-1"></i>{{ asset.department or '集体' }}
                                    {% else %}
                                        {% if asset.current_user %}
                                            <i class="bi bi-person me-1"></i>{{ asset.current_user.name }}
                                        {% else %}
                                            <span class="text-light-emphasis">-</span>
                                        {% endif %}
                                    {% endif %}
                                </small>
                            </td>
                            {% endif %}

                            <td class="text-end pe-3">
                                <div class="btn-group">
                                    <a href="{{ url_for('asset.asset_detail', asset_id=asset.id) }}" 
                                       class="btn btn-sm btn-outline-primary shadow-sm">查看详情</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" style="width: 64px; opacity: 0.3;">
                                <p class="text-muted mt-2">没有找到符合条件的资产</p>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

==================================================
FILE: .\templates\asset\public_info.html
==================================================

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资产信息查询</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .info-card { margin: 20px auto; max-width: 500px; border-radius: 15px; overflow: hidden; }
        .info-header { background: #343a40; color: white; padding: 20px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card info-card shadow">
            <div class="info-header">
                <h4>资产基本信息</h4>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>资产类型:</strong>{{ asset.type }}</li>
                    <li class="list-group-item"><strong>资产名称:</strong> {{ asset.name }}</li>
                    <li class="list-group-item"><strong>编号/SN:</strong> {{ instance.sn_number if instance else asset.number }}</li>
                    <li class="list-group-item"><strong>购置时间:</strong>{{ asset.purchase_date.strftime('%Y-%m-%d') if asset.purchase_date else '-' }}</li>
                    <li class="list-group-item"><strong>资产归属:</strong>{{ asset.ownership }}</li>
                    <li class="list-group-item"><strong>存放位置:</strong> {{ asset.location or '未记录' }}</li>
                    {% if asset.photo_path %}
                    <li class="list-group-item text-center">
                        <img src="/{{ asset.photo_path }}" class="img-fluid rounded">
                    </li>
                    {% endif %}
                </ul>
            </div>
            <div class="card-footer text-center text-muted small">
                此页面仅供快速查验，更多操作请登录管理系统
            </div>
        </div>
    </div>
</body>
</html>

==================================================
FILE: .\templates\asset\_partial_asset_form.html
==================================================

<div class="row g-3">
    <div class="col-md-4">
        <label for="asset_type_select" class="form-label fw-bold">资产类型 <span class="text-danger">*</span></label>
        <select name="type" id="asset_type_select" class="form-select" required>
            <option value="装备">装备</option>
            <option value="服饰">服饰</option>
            <option value="固定资产">固定资产</option>
            <option value="工具">工具</option>
            <option value="消耗品">消耗品</option>
        </select>
    </div>

    <div class="col-md-4">
        <label class="form-label fw-bold">资产名称 <span class="text-danger">*</span></label>
        <input type="text" name="name" class="form-control" placeholder="如：电动自行车" required>
    </div>

    <div class="col-md-4">
        <label class="form-label fw-bold">编号前缀</label>
        <input type="text" name="number" id="asset_prefix" class="form-control" placeholder="如: SN-2026-">
    </div>

    <div class="col-md-4">
        <label class="form-label fw-bold">入库数量 <span class="text-danger">*</span></label>
        <input type="number" name="quantity" id="asset_qty" class="form-control" value="1" min="1" placeholder="请输入数量" required>
    </div>

    <div class="col-md-4">
        <label for="asset_ownership_select" class="form-label fw-bold">资产归属</label>
        <select name="ownership" id="asset_ownership_select" class="form-select">
            <option value="特保队">特保队</option>
            <option value="公司">公司</option>
            <option value="个人">个人</option>
            <option value="派出所">派出所</option>
        </select>
    </div>

    <div class="col-md-4">
        <label class="form-label fw-bold">存放位置</label>
        <input type="text" name="location" class="form-control" placeholder="如：一号仓库">
    </div>

    <div class="col-md-6">
        <label for="asset_purchase_date" class="form-label fw-bold">购置/入库日期</label>
        <input type="date" name="purchase_date" id="asset_purchase_date" class="form-control" value="{{ default_date }}" title="购置或入库日期">
    </div>

    <div class="col-md-6">
        <label class="form-label fw-bold">床位容量</label>
        <select name="bed_capacity" class="form-select" title="床位容量">
            <option value="0">非床位类资产</option>
            <option value="1">单人床 (1坑位)</option>
            <option value="2">双层床 (2坑位)</option>
        </select>
    </div>

    <div class="col-md-12">
        <label class="form-label fw-bold">资产照片</label>
        <input type="file" name="photo" class="form-control" accept="image/*" title="资产照片">
    </div>

    <div id="custom_sn_section" class="mb-4 p-3 border rounded bg-white shadow-sm d-none">
        <label class="form-label fw-bold text-primary">
            <i class="bi bi-tags"></i> 定义个体编号
        </label>
        <div id="sn_container" class="row g-2"></div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // 定义生成子资产列表的函数
    function updateSNInputs() {
        const assetType = $('#asset_type_select').val();
        const qty = parseInt($('#asset_qty').val()) || 0;
        const prefix = $('#asset_prefix').val() || '';
        const $snSection = $('#custom_sn_section');
        const $snContainer = $('#sn_container');

        if (assetType === '固定资产' && qty > 0) {
            $snSection.removeClass('d-none');
            $snContainer.empty();
            for (let i = 1; i <= qty; i++) {
                const suffix = String(i).padStart(3, '0');
                $snContainer.append(`
                    <div class="col-md-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light">${prefix}</span>
                            <input type="text" name="instance_numbers[]" class="form-control" value="${suffix}" required>
                        </div>
                    </div>
                `);
            }
        } else {
            $snSection.addClass('d-none');
            $snContainer.empty();
        }
    }

    // --- 事件绑定 ---

    // 1. 监听资产表单的变化（类型、数量、前缀）
    // 注意：使用 $(document).on 确保动态内容也能被监听到
    $(document).on('change input', '#asset_type_select, #asset_qty, #asset_prefix', function() {
        updateSNInputs();
    });

    // 2. 页面加载完成后立即尝试运行一次
    updateSNInputs();

    // 3. 处理财务表单联动
    $('#sync_fund_switch').on('change', function() {
        if(this.checked) {
            $('#finance_container').hide().load("{{ url_for('fund.get_fund_form_snippet') }}", function(response, status, xhr) {
                if (status == "error") {
                    alert("财务组件加载失败");
                } else {
                    $(this).slideDown();
                }
            });
        } else {
            $('#finance_container').slideUp(function() {
                $(this).html('<div class="text-center text-muted py-2">正在加载财务表单...</div>');
            });
        }
    });
});
</script>

==================================================
FILE: .\templates\auth\change_password.html
==================================================

{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-key"></i> 修改登录密码</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label class="form-label">原密码</label>
                        <input type="password" name="old_password" class="form-control" placeholder="请输入当前使用的密码" required>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">新密码</label>
                        <input type="password" name="new_password" class="form-control" placeholder="请输入新密码" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">确认新密码</label>
                        <input type="password" name="confirm_password" class="form-control" placeholder="请再次输入新密码" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">确认修改</button>
                        <a href="{{ url_for('main.index') }}" class="btn btn-light">返回首页</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

==================================================
FILE: .\templates\auth\login.html
==================================================

{% extends "base.html" %}

{% block title %}登录系统{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h4><i class="bi bi-shield-lock"></i> 系统登录</h4>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="mb-3">
                            <label class="form-label">用户名（身份证号码）</label>
                            <input type="text" name="username" class="form-control" required autofocus>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">密码（默认身份证后六位）</label>
                            <input type="password" name="password" class="form-control" required>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg px-5">登录</button>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-center text-muted">
                    <small>蔡路特保队队务管理系统</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

==================================================
FILE: .\templates\dorm\map.html
==================================================

{% extends "base.html" %}

{% block content %}
<!-- 1. 集中管理所有样式，消除内联样式提示 -->
<style>
    /* 强制覆盖父级 container 的限制 */
    .container, .container-lg, .container-md {
        max-width: none !important; 
        width: 100% !important;
        padding-left: 20px !important;
        padding-right: 20px !important;
    }
    
    /* 让地图外层包装器支持滚动 */
    .map-wrapper {
        width: 100%;
        overflow: auto;
        background: #eee;
        border-radius: 8px;
    }

    /* 提取内联样式 - 侧边栏卡片 */
    .side-card-body {
        height: 350px;
        overflow-y: auto;
    }
    .side-list-item {
        font-size: small;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 0.25rem;
        padding-bottom: 0.25rem;
    }
    .room-number-text {
        font-size: 0.7rem;
        color: #6c757d;
    }

    /* 提取内联样式 - 地图容器 */
    .dorm-map-container {
        width: 1600px;
        height: 1000px;
        background: url('/static/images/dorm_plan.jpg') no-repeat;
        background-size: contain;
        background-color: #f8f9fa;
        margin: 0 auto;
        position: relative;
        border: 1px solid #dee2e6;
    }
    .map-col {
        overflow: auto;
        background-color: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        padding: 0.75rem;
        margin-bottom: 1rem;
    }

    /* 提取内联样式 - 房间区域 */
    .room-zone {
        position: absolute;
        width: 200px;
        min-height: 140px;
        background: rgba(255,255,255,0.9);
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
    }
    .room-handle {
        width: 100%;
        border-bottom: 1px solid #dee2e6;
        background-color: #0d6efd;
        color: #fff;
        text-align: center;
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
        cursor: move;
        border-radius: 4px 4px 0 0;
    }
    .bed-count-badge {
        font-size: 0.65rem;
        vertical-align: middle;
    }

    /* 提取内联样式 - 人员/资产标签 */
    .employee-tag {
        width: 100%;
        margin-bottom: 0.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
    }
    .leader-tag {
        background-color: #ffc107;
        color: #000;
    }
    .normal-tag {
        background-color: #0d6efd;
    }
    .occupied-tag {
        font-size: 0.55rem;
        max-width: 50px;
        overflow: hidden;
    }
    .asset-tag {
        width: 100%;
        margin-bottom: 0.25rem;
        text-align: left;
        padding: 0.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.7rem;
        white-space: normal;
        min-height: 38px;
        background-color: #17a2b8;
        color: #000;
    }
    .asset-info {
        flex-grow: 1;
    }
    .asset-name {
        font-size: 0.6rem;
        opacity: 0.8;
    }
    .asset-owner {
        font-size: 0.6rem;
        color: #dc3545;
        font-weight: bold;
    }
    .bed-info {
        margin-left: 0.25rem;
        padding-left: 0.25rem;
        border-left: 1px solid #6c757d;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-width: 70px;
        background: rgba(255,255,255,0.3);
        border-radius: 0 4px 4px 0;
    }
    .bed-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 0.25rem;
        line-height: 1.2;
        margin-bottom: 1px;
    }
    .bed-label {
        font-size: 0.5rem;
        white-space: nowrap;
        color: #6c757d;
    }
    .bed-occupant {
        font-size: 0.6rem;
        margin-left: 2px;
    }
    .bed-occupant-filled {
        color: #0d6efd;
        font-weight: bold;
    }
    .bed-occupant-empty {
        color: #6c757d;
    }

    /* 提取内联样式 - 待分配池 */
    .pool-employee-item {
        cursor: grab;
        width: 45%;
        margin: 0.25rem;
        padding: 0.5rem;
        background-color: #6c757d;
    }
    .pool-asset-item {
        cursor: grab;
        width: 90%;
        margin: 0.25rem;
        padding: 0.25rem;
        font-size: 0.7rem;
        border: 1px solid #17a2b8;
        color: #000;
    }
</style>

<div class="container-fluid mt-3">
    <div class="row">
        <!-- 左侧住宿人员列表 -->
        <div class="col-lg-2">
            <div class="card shadow-sm mb-3 border-success">
                <div class="card-header bg-success text-white small fw-bold py-1">住宿人员名单</div>
                <div class="card-body p-2 bg-light side-card-body">
                    <div id="side-assigned-list">
                        {% for emp in assigned_emps | sort(attribute='room.number') %}
                        <div class="side-list-item">
                            <i class="bi bi-house-door text-success"></i> {{ emp.name }} 
                            <span class="room-number-text">({{ emp.room.number if emp.room else '未分配' }})</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-secondary">
                <div class="card-header bg-secondary text-white small fw-bold py-1">不住宿人员名单</div>
                <div class="card-body p-2 side-card-body">
                    <div id="side-unassigned-list">
                        {% for emp in unassigned_emps %}
                        <div class="side-list-item text-muted">
                            <i class="bi bi-person"></i> {{ emp.name }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 中间地图区域 -->
        <div class="col-lg-8 map-col">
            <div id="dorm-map-container" class="dorm-map-container">
                {% for room in rooms %}
                <!-- 修复：将动态样式通过data属性传递，避免CSS解析器识别模板语法 -->
                <div class="room-zone" 
                     data-room-id="{{ room.id }}"
                     style="left: {{ room.x_pos or 50 }}px; top: {{ room.y_pos or 50 }}px;">
                    
                    <div class="room-handle">
                        <small class="fw-bold">
                            {{ room.number }} / {{ room.type or '宿舍' }}
                            <span class="ms-2 badge bg-light text-primary bed-count-badge">
                                {# 床位计算逻辑保留，移到HTML注释外但不影响CSS解析 #}
                                {% set total_beds = room.room_assets | map(attribute='asset_info.bed_capacity') | sum %}
                                {% set occupied_beds = room.occupants | length %}
                                <i class="bi bi-person-check-fill"></i> {{ occupied_beds }}/{{ total_beds }}
                            </span>
                        </small>
                    </div>

                    <div class="drop-zone w-100 flex-grow-1 p-1" id="room-{{ room.id }}">
                        <!-- 住宿人员列表 -->
                        {% for emp in room.occupants | sort(attribute='is_room_leader', reverse=True) %}
                        <div class="item-tag badge employee-tag {% if emp.is_room_leader %}leader-tag{% else %}normal-tag{% endif %}" 
                             data-id="{{ emp.id }}" data-type="employee">
                            <span>
                                {% if emp.is_room_leader %}<i class="bi bi-star-fill text-danger"></i>{% endif %}
                                <i class="bi bi-person-fill"></i> {{ emp.name }}
                            </span>
                            <small class="badge bg-light text-dark occupied-tag">已入宿</small>
                        </div>
                        {% endfor %}

                        <!-- 资产列表 -->
                        {% for asset in room.room_assets %}
                        <div class="item-tag badge asset-tag" 
                             data-id="{{ asset.id }}" 
                             data-type="asset">
                            <div class="asset-info">
                                <i class="bi bi-box-seam"></i> 
                                <strong>{{ asset.sn_number }}</strong>
                                <div class="asset-name">{{ asset.asset_info.name }}</div>
                                {% if asset.user_id %}
                                <div class="asset-owner">[责任人:{{ asset.current_holder.name }}]</div>
                                {% endif %}
                            </div>

                            {% if asset.asset_info.bed_capacity > 0 %}
                            <div class="bed-info">
                                {% set cap = asset.asset_info.bed_capacity %}
                                {% set labels = ["上铺", "下铺"] if cap == 2 else ["单铺"] %}
                                {% for label in labels %}
                                    {% set bed_code = asset.sn_number ~ "-" ~ label %}
                                    {% set occupant = room.occupants | selectattr('bed_number', 'equalto', bed_code) | first %}
                                    <div class="bed-item">
                                        <span class="bed-label">{{ label }}:</span>
                                        <span class="bed-occupant {% if occupant %}bed-occupant-filled{% else %}bed-occupant-empty{% endif %}">
                                            {{ occupant.name if occupant else '空' }}
                                        </span>
                                    </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 右侧待分配池 -->
        <div class="col-lg-2">
            <div class="card shadow-sm mb-3 border-dark">
                <div class="card-header bg-dark text-white fw-bold small py-1">待分配池(人员)</div>
                <div class="card-body pool-zone bg-light p-2 side-card-body" id="pool-employees">
                    {% for emp in unassigned_emps %}
                    <div class="item-tag badge pool-employee-item" data-id="{{ emp.id }}" data-type="employee">
                        {{ emp.name }}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="card shadow-sm border-info">
                <div class="card-header bg-info text-white fw-bold small py-1">待分配池(资产)</div>
                <div class="card-body pool-zone bg-light p-2 side-card-body" id="pool-assets">
                    {% for asset in unassigned_assets %}
                    <div class="item-tag badge pool-asset-item" 
                         data-id="{{ asset.id }}" 
                         data-type="asset" 
                         data-full-sn="{{ asset.sn_number }}">
                        {{ asset.sn_number }}
                        <div class="small text-muted">{{ asset.asset_info.name }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 入宿分配模态框（强化床位校验） -->
<div class="modal fade" id="assignModal" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-primary shadow">
            <div class="modal-header bg-primary text-white py-2">
                <h6 class="modal-title small">入宿分配确认</h6>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label small fw-bold">选择床位（必填）:</label>
                    <select id="bedSelector" class="form-select form-select-sm" required>
                        <!-- 动态加载房间内的床位资产 -->
                    </select>
                    <small class="text-danger d-none" id="bedRequiredMsg">必须选择床位才能分配</small>
                </div>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="leaderCheck">
                    <label class="form-check-label small" for="leaderCheck">设为该房宿舍长（自动负责房间资产）</label>
                </div>
            </div>
            <div class="modal-footer py-1">
                <button type="button" class="btn btn-link btn-sm text-secondary" onclick="window.location.reload()">取消</button>
                <button type="button" class="btn btn-primary btn-sm" id="confirmAssignBtn">确认提交</button>
            </div>
        </div>
    </div>
</div>

<!-- 床位选择模态框 -->
<div class="modal fade" id="bedPickerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title">选择具体床位</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <div id="bed-options-container" class="list-group"></div>
            </div>
        </div>
    </div>
</div>

<!-- 引入依赖脚本 -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

<!-- 修复JS模板语法解析问题：将模板变量提前转换为JS变量 -->
<script>
    // 安全转换模板变量为JS变量，避免语法错误
    const isAdmin = {{ (current_user.role == 'admin') | tojson }};
    const saveRoomPosUrl = "{{ url_for('dorm.save_room_pos') }}";
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('dorm-map-container');
    const modalEl = document.getElementById('assignModal');
    const assignModal = new bootstrap.Modal(modalEl);
    let tempAssignData = null;

    // 1. 拖拽初始化（核心：区分资产/人员逻辑）
    document.querySelectorAll('.drop-zone, .pool-zone').forEach(el => {
        new Sortable(el, {
            group: 'shared',
            animation: 150,
            onAdd: function (evt) {
                const item = evt.item;
                const type = item.getAttribute('data-type');
                const id = item.getAttribute('data-id');
                const roomZone = evt.to.closest('.room-zone');
                const roomId = roomZone ? roomZone.getAttribute('data-room-id') : null;
                const roomNumber = roomZone ? roomZone.querySelector('.room-handle small').textContent.split(' / ')[0] : '';

                // 2. 资产拖拽：联动存放位置
                if (type === 'asset' && roomId) {
                    updateAssignment(id, type, roomId, null, false, roomNumber);
                } 
                // 3. 人员拖拽：强制选择床位
                else if (type === 'employee' && roomId) {
                    tempAssignData = { 
                        id: id, 
                        type: type, 
                        room_id: roomId,
                        room_number: roomNumber
                    };
                    const selector = document.getElementById('bedSelector');
                    selector.innerHTML = '<option value="" disabled selected>加载床位中...</option>';
                    document.getElementById('confirmAssignBtn').disabled = true;

                    // 调用床位查询接口
                    fetch(`/dorm/get_available_beds/${roomId}`)
                        .then(res => res.json())
                        .then(beds => {
                            selector.innerHTML = '';
                            console.log(`房间${roomId}的床位数据（适配SCC-002格式）：`, beds);
                            
                            if (beds.length === 0) {
                                selector.innerHTML = '<option value="" disabled>房间内无可用床位</option>';
                                alert('未找到可用床位！请确认：\n1. 该房间已分配名称含“床”的固定资产\n2. 资产的bed_capacity设置为1（单人床）或2（双层床）\n3. 资产个体编号格式为 前缀-子编号（如SCC-002）');
                                return;
                            }
                            
                            // 生成床位选项：显示“双层床 SCC-002 下铺”
                            beds.forEach(bed => {
                                const option = document.createElement('option');
                                option.value = bed.code;
                                const codeParts = bed.code.split('-');
                                const mainCode = codeParts.slice(0, -1).join('-');
                                const bedType = codeParts.pop();
                                const displayText = `${bed.asset_name} ${mainCode} ${bedType}`;
                                option.textContent = displayText;
                                
                                if (bed.occupied) {
                                    option.disabled = true;
                                    option.textContent += ` (已被${bed.occupant}占用)`;
                                }
                                selector.appendChild(option);
                            });
                            document.getElementById('confirmAssignBtn').disabled = false;
                        })
                        .catch(err => {
                            selector.innerHTML = '<option value="" disabled>加载床位失败</option>';
                            console.error('加载床位失败：', err);
                        });

                    assignModal.show();
                } else {
                    // 资产/人员移回待分配池：清空关联
                    updateAssignment(id, type, null, null, false, '');
                }
            }
        });
    });

    // 4. 人员分配确认（含宿舍长联动）
    document.getElementById('confirmAssignBtn').onclick = function() {
        if (!tempAssignData) return;
        const bedId = document.getElementById('bedSelector').value;
        const isLeader = document.getElementById('leaderCheck').checked;

        // 强制选择床位
        if (!bedId) {
            document.getElementById('bedRequiredMsg').classList.remove('d-none');
            return;
        }

        // 提交人员分配+宿舍长关联
        updateAssignment(
            tempAssignData.id, 
            tempAssignData.type, 
            tempAssignData.room_id, 
            bedId,
            isLeader, 
            tempAssignData.room_number
        );
        assignModal.hide();
    };

    // 5. 统一提交接口（传递所有联动参数）
    function updateAssignment(id, type, roomId, bedId = null, isLeader = false, roomNumber = '') {
        fetch("/dorm/assign", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                type: type, 
                id: id, 
                room_id: roomId, 
                bed_id: bedId,
                is_leader: isLeader,
                room_number: roomNumber
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('分配失败：' + data.message);
            }
        })
        .catch(err => console.error('分配接口错误：', err));
    }

    // 6. 房间移动定位 (仅限管理)
    if (isAdmin) {
        document.querySelectorAll('.room-zone').forEach(zone => {
            const handle = zone.querySelector('.room-handle');
            handle.onmousedown = function(e) {
                if(e.target !== handle && !handle.contains(e.target)) return;
                e.preventDefault();
                zone.style.zIndex = 1000;
                let shiftX = e.clientX - zone.getBoundingClientRect().left;
                let shiftY = e.clientY - zone.getBoundingClientRect().top;
                
                function moveAt(pageX, pageY) {
                    let rect = container.getBoundingClientRect();
                    zone.style.left = (pageX - rect.left - shiftX) + 'px';
                    zone.style.top = (pageY - rect.top - shiftY) + 'px';
                }
                
                function onMouseMove(e) { moveAt(e.pageX, e.pageY); }
                document.addEventListener('mousemove', onMouseMove);
                
                document.onmouseup = function() {
                    document.removeEventListener('mousemove', onMouseMove);
                    savePosition(zone.getAttribute('data-room-id'), parseInt(zone.style.left), parseInt(zone.style.top));
                    document.onmouseup = null;
                    zone.style.zIndex = 'auto';
                };
            };
        });

        function savePosition(roomId, x, y) {
            fetch(saveRoomPosUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_id: roomId, x: x, y: y })
            });
        }
    }
});
</script>
{% endblock %}

==================================================
FILE: .\templates\fund\add.html
==================================================

{% extends "base.html" %}
{% block title %}添加资金记录{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow border-0">
        <div class="card-header bg-success text-white py-3">
            <h4 class="mb-0"><i class="bi bi-currency-yen"></i> 添加财务记录</h4>
        </div>
        <div class="card-body p-4">
            <form action="{{ url_for('fund.fund_add') }}" method="POST" enctype="multipart/form-data">
                <div class="mb-4">
                    <h5 class="mb-3 text-success border-bottom pb-2">
                        <i class="bi bi-receipt"></i> 收支详情
                    </h5>
                    {% include 'fund/_partial_fund_form.html' %}
                </div>

                <div class="card bg-light border-primary my-4">
                    <div class="card-body">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="sync_asset" id="sync_asset_switch" style="cursor: pointer; transform: scale(1.2);">
                            <label class="form-check-label fw-bold text-primary ms-2" for="sync_asset_switch" style="cursor: pointer;">
                                这笔钱买资产了？(同时登记资产入库)
                            </label>
                        </div>
                        
                        <div id="asset_container" class="mt-3 shadow-sm p-4 bg-white rounded border border-primary-subtle" style="display:none;">
                            <div class="text-center text-muted py-2">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                正在加载资产表单...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg shadow">
                        <i class="bi bi-save"></i> 提交财务记录
                    </button>
                    <a href="{{ url_for('fund.fund_list') }}" class="btn btn-link text-muted">取消返回</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('#sync_asset_switch').on('change', function() {
        if(this.checked) {
            // 加载资产表单片段
            $('#asset_container').hide().load("{{ url_for('asset.get_form_snippet') }}", function(response, status, xhr) {
                if (status == "error") {
                    alert("资产组件加载失败，请检查后端路由或网络");
                } else {
                    $(this).slideDown();
                }
            });
        } else {
            $('#asset_container').slideUp(function() {
                $(this).html('<div class="text-center text-muted py-2">正在加载资产表单...</div>');
            });
        }
    });
});
</script>
{% endblock %}

==================================================
FILE: .\templates\fund\import.html
==================================================

{% extends "base.html" %}

{% block title %}批量导入资金记录{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="bi bi-upload"></i> 批量导入资金记录（Excel）</h4>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>导入要求：</strong>
                <ul class="mb-0">
                    <li>必须包含列：日期, 资方, 项目, 金额</li>
                    <li>可选列：备注</li>
                    <li>日期格式：YYYY.MM 或 YYYY-MM-DD</li>
                    <li>金额正数收入，负数支出</li>
                </ul>
            </div>
            
            <form method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label">选择Excel文件</label>
                    <input type="file" name="file" class="form-control" accept=".xlsx" required>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-success btn-lg px-5">开始导入</button>
                    <a href="{{ url_for('fund.fund_list') }}" class="btn btn-secondary btn-lg px-5">取消</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

==================================================
FILE: .\templates\fund\list.html
==================================================

{% extends "base.html" %}

{% block title %}资金管理{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-currency-exchange"></i> 资金收支记录</h4>
            <div>
                <a href="{{ url_for('fund.fund_export', date=date_filter, payer=payer_filter, item=item_filter) }}" class="btn btn-light me-2">
                    <i class="bi bi-download"></i> 导出数据
                </a>
                <a href="{{ url_for('fund.fund_import') }}" class="btn btn-light me-2">
                    <i class="bi bi-upload"></i> 导入数据
                </a>
                <a href="{{ url_for('fund.fund_add') }}" class="btn btn-light">
                    <i class="bi bi-plus-circle"></i> 新增数据
                </a>
            </div>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3 mb-4">
                <div class="col-md-3">
                    <input type="date" name="date" class="form-control" value="{{ date_filter or '' }}" placeholder="日期筛选">
                </div>
                <div class="col-md-3">
                    <input type="text" name="payer" class="form-control" value="{{ payer_filter or '' }}" placeholder="资方筛选">
                </div>
                <div class="col-md-3">
                    <input type="text" name="item" class="form-control" value="{{ item_filter or '' }}" placeholder="项目筛选">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-outline-secondary w-100">筛选</button>
                </div>
            </form>

            <div class="alert alert-info mb-4 d-flex justify-content-between align-items-center">
                <span><strong>当前账户总余额：</strong> {{ "%.2f" % total_balance }} 元</span>
                <small class="text-muted text-uppercase">实时计算</small>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>
                                <a href="{{ url_for('fund.fund_list', sort='date_asc' if sort == 'date_desc' else 'date_desc', date=date_filter, payer=payer_filter, item=item_filter) }}" class="text-dark text-decoration-none">
                                    日期 {% if sort.startswith('date_') %}↕{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('fund.fund_list', sort='payer_asc' if sort == 'payer_desc' else 'payer_desc', date=date_filter, payer=payer_filter, item=item_filter) }}" class="text-dark text-decoration-none">
                                    资方 {% if sort.startswith('payer_') %}↕{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('fund.fund_list', sort='item_asc' if sort == 'item_desc' else 'item_desc', date=date_filter, payer=payer_filter, item=item_filter) }}" class="text-dark text-decoration-none">
                                    项目 {% if sort.startswith('item_') %}↕{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('fund.fund_list', sort='amount_asc' if sort == 'amount_desc' else 'amount_desc', date=date_filter, payer=payer_filter, item=item_filter) }}" class="text-dark text-decoration-none">
                                    交易金额 {% if sort.startswith('amount_') %}↕{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('fund.fund_list', sort='balance_asc' if sort == 'balance_desc' else 'balance_desc', date=date_filter, payer=payer_filter, item=item_filter) }}" class="text-dark text-decoration-none">
                                    余额 {% if sort.startswith('balance_') %}↕{% endif %}
                                </a>
                            </th>
                            <th>类型</th>
                            <th>操作人</th>
                            <th>备注</th>
                            <th>凭证</th> 
                        </tr>
                    </thead>
                    <tbody>
                        {% if records %}
                            {% for r in records %}
                            <tr>
                                <td>{{ format_datetime(r.date) }}</td>
                                <td>{{ r.payer or '-' }}</td>
                                <td>{{ r.item or '-' }}</td>
                                <td class="{% if r.amount < 0 %}text-danger{% else %}text-success{% endif %} fw-bold">
                                    {{ "%.2f" % r.amount }}
                                </td>
                                <td class="fw-bold">{{ "%.2f" % r.balance }}</td>
                                <td>
                                    <span class="badge {% if r.amount >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if r.amount >= 0 %}收入{% else %}支出{% endif %}
                                    </span>
                                </td>
                                <td>{{ r.operator.name if r.operator else '系统' }}</td>
                                                                
                                <td class="text-truncate" style="max-width: 150px;">{{ r.note or '-' }}</td>
                                <td>
                                    {% if r.attachment %}
                                    <a href="/{{ r.attachment }}" target="_blank" class="btn btn-sm btn-outline-primary" title="点击查看附件">
                                        <i class="bi bi-file-earmark-text"></i> 查看
                                    </a>
                                    {% else %}
                                    <span class="text-muted small">无</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center text-muted py-5">暂无财务收支记录</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

==================================================
FILE: .\templates\fund\_partial_fund_form.html
==================================================

<div class="row g-3">
    <div class="col-md-6">
        <label class="form-label fw-bold">财务日期 <span class="text-danger">*</span></label>
        <input type="date" name="date" class="form-control" value="{{ default_date }}" required>
    </div>

    <div class="col-md-6">
        <label class="form-label fw-bold">资方/付款人 <span class="text-danger">*</span></label>
        <input type="text" name="payer" class="form-control" placeholder="如：特保队、某某公司" required>
    </div>

    <div class="col-md-12">
        <label class="form-label fw-bold">费用项目 <span class="text-danger">*</span></label>
        <input type="text" name="item" class="form-control" placeholder="如：采购资产支出、日常办公支出" required>
    </div>

    <div class="col-md-6">
        <label class="form-label fw-bold text-danger">支出金额 (元) <span class="text-danger">*</span></label>
        <div class="input-group">
            <span class="input-group-text bg-danger text-white">¥</span>
            <input type="number" step="0.01" name="amount" class="form-control border-danger" placeholder="支出请填写负数，如 -500" required>
        </div>
        <small class="text-muted">注意：购买资产属于支出，金额应为负值。</small>
    </div>

    <div class="col-md-6">
        <label class="form-label fw-bold">凭证上传 (发票/照片)</label>
        <input type="file" name="attachment" class="form-control" accept="image/*,.pdf,.zip,.rar">
    </div>

    <div class="col-md-12">
        <label class="form-label fw-bold">财务备注</label>
        <textarea name="note" class="form-control" rows="2" placeholder="填写相关的报销说明、流水号等备注..."></textarea>
    </div>
</div>

==================================================
FILE: .\templates\hr\add.html
==================================================

{% extends "base.html" %}

{% block title %}新增员工{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">新增员工</h4>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                {% set employee = none %}  <!-- 新增时无数据 -->
                {% include "hr/_employee_form.html" with context %}
                <div class="text-center mt-5">
                    <button type="submit" class="btn btn-success btn-lg">提交新增</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

==================================================
FILE: .\templates\hr\detail copy.html
==================================================

{% extends "base.html" %}

{% block title %}{{ cycles[0].name }} ({{ id_card }}) - 任职档案{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-person-lines-fill"></i> {{ cycles[0].name }} - 任职档案（共 {{ cycles|length }}
                次）</h4>
            <div class="d-flex gap-2">
                <!-- 优化点：添加图标+调整尺寸，与状态标签视觉分离 -->
                <a href="{{ url_for('hr.hr_list') }}" class="badge bg-light text-dark fs-5 px-3 py-1">
                    <i class="bi bi-arrow-left-short me-1"></i> 返回列表
                </a>
                <span class="badge bg-light text-dark fs-5 px-3 py-1">{{ cycles[0].status }}</span>
            </div>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <!-- 查看模式 -->
                <div class="tab-pane fade show active" id="view_tab">
                    {% for cycle in cycles %}
                    <div class="card mb-4 {% if cycle.status == '在职' %}border-primary shadow-lg{% endif %}">
                        <div
                            class="card-header d-flex justify-content-between {% if cycle.status == '在职' %}bg-primary text-white{% endif %}">

                            <strong>
                                第 {{ cycles|length - loop.index + 1 }} 次任职
                                （{{ format_date(cycle.hire_date) }} ~ {{ format_date(cycle.departure_date) or '至今' }}）

                                在职 {{ cycle.hire_date | calc_work_duration(cycle.departure_date) }}
                                <!-- 新过滤器：自动处理None -->
                            </strong>
                            <span class="badge bg-light text-dark">{{ cycle.status }}</span>
                        </div>
                        <div class="card-body">
                            <!-- 基本信息表格（保持原有） -->
                            <div class="row">
                                <div class="col-md-3 text-center mb-3">
                                    {% if cycle.photo_path %}
                                    <img src="/{{ cycle.photo_path }}" class="rounded-circle shadow" width="180"
                                        height="180" alt="照片">
                                    {% else %}
                                    <div class="bg-light rounded-circle shadow d-flex align-items-center justify-content-center text-muted"
                                        style="width:180px;height:180px;font-size:24px;">
                                        无照片
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-9">
                                    <table class="table table-sm table-borderless">
                                        <!-- 保持您原有所有字段显示 -->
                                        <tr>
                                            <th width="140">身份证</th>
                                            <td>{{ cycle.id_card }}</td>
                                        </tr>
                                        <tr>
                                            <th>性别</th>
                                            <td>{{ cycle.gender or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>出生日期</th>
                                            <td>{{ format_date(cycle.birthday) or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>手机</th>
                                            <td>{{ cycle.phone or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>民族</th>
                                            <td>{{ cycle.ethnic or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>政治面貌</th>
                                            <td>{{ cycle.politics or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>学历</th>
                                            <td>{{ cycle.education or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>薪资模式</th>
                                            <td>{{ cycle.salary_mode }}</td>
                                        </tr>
                                        <tr>
                                            <th>职务/岗位</th>
                                            <td>{{ cycle.position or '-' }} / {{ cycle.post or '-' }}</td>
                                        </tr>
                                        <tr>
                                            <th>户籍地址</th>
                                            <td>{{ [cycle.household_province, cycle.household_city,
                                                cycle.household_district, cycle.household_town, cycle.household_detail]
                                                | reject('none') | join(' ') or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>居住地址</th>
                                            <td>{{ [cycle.residence_province, cycle.residence_city,
                                                cycle.residence_district, cycle.residence_town, cycle.residence_detail]
                                                | reject('none') | join(' ') or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>兵役情况</th>
                                            <td>{% if cycle.military_service %}入伍时间:{{
                                                format_date(cycle.enlistment_date)
                                                }}，部队番号:{{ cycle.unit_number }}，兵种:{{ cycle.branch }}，退伍时间:{{
                                                format_date(cycle.discharge_date) }}{% else %}无{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <th>驾驶证</th>
                                            <td>{% if cycle.has_license %}初领时间:{{ format_date(cycle.license_date)
                                                }}，准驾车型:{{
                                                cycle.license_type }}，有效期至:{{ format_date(cycle.license_expiry) }}{%
                                                else
                                                %}无{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <th>保安员证</th>
                                            <td>
                                                保安证编号:{{ cycle.security_license_number or '无' }}
                                                {% if cycle.security_license_date %}
                                                ,发证时间: {{ format_date(cycle.security_license_date) }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>紧急联系人</th>
                                            <td>{{ cycle.emergency_name or '' }}（{{ cycle.emergency_relation or '' }}）{{
                                                cycle.emergency_phone or '' }}</td>
                                        </tr>
                                        <tr>
                                            <th>工作服尺码</th>
                                            <td>帽{{ cycle.hat_size or '-' }} | 短袖{{ cycle.short_sleeve or '-' }} | 长袖{{
                                                cycle.long_sleeve or '-' }} | 冬装{{ cycle.winter_uniform or '-' }} | 鞋{{
                                                cycle.shoe_size or '-' }}</td>
                                        </tr>
                                    </table>

                                    <!-- 离职原因 -->
                                    {% if cycle.status == '离职' and cycle.archives %}
                                    {% set archives = cycle.archives | fromjson %}
                                    {% if archives.departure_reason %}
                                    <div class="alert alert-warning mt-4">
                                        <strong>离职原因：</strong> {{ archives.departure_reason }}
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                    <!-- 装备领用情况 -->
                                    <div class="card mt-5 shadow-sm border-0">
                                        <div
                                            class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                                            <h6 class="mb-0 fw-bold text-dark">
                                                <i class="bi bi-shield-check text-primary me-1"></i> 装备领用情况
                                            </h6>
                                            <div class="d-flex align-items-center">
                                                {% if cycle.status == '在职' and perm.can('asset.issue') %}
                                                <button type="button" class="btn btn-warning btn-sm fw-bold shadow-sm"
                                                    data-bs-toggle="modal" data-bs-target="#quickIssueModal">
                                                    <i class="bi bi-plus-lg"></i> 发放资产
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="card-body p-0">
                                            {% set equipped_assets = get_equipped_assets(cycle.id) %}
                                            {% if equipped_assets %}
                                            <div class="equipped-scroll-container"
                                                style="max-height: 400px; overflow-y: auto;">
                                                <div class="list-group list-group-flush">
                                                    {% for item in equipped_assets | reverse %}
                                                    <div class="list-group-item list-group-item-action py-3">
                                                        <div class="row align-items-center">
                                                            <div class="col-auto">
                                                                <div
                                                                    class="rounded-circle bg-primary bg-opacity-10 p-2">
                                                                    <i class="bi bi-box-seam text-primary"></i>
                                                                </div>
                                                            </div>
                                                            <div class="col">
                                                                <strong class="d-block text-dark">{{ item.asset.name
                                                                    }}</strong>
                                                                <div class="d-flex align-items-center gap-2 mt-1">
                                                                    <span
                                                                        class="badge bg-light text-secondary border">编号:
                                                                        {{ item.asset.number }}</span>
                                                                    <span
                                                                        class="badge bg-primary-subtle text-primary">数量
                                                                        × {{ item.quantity }}</span>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4 text-end">
                                                                <div class="small text-muted">发放于: {{
                                                                    format_datetime(item.issue_date) }}</div>
                                                                <div class="small text-muted">发放人: <span
                                                                        class="text-dark">{{ item.issued_by or '系统'
                                                                        }}</span></div>
                                                                {% if item.note %}
                                                                <div class="mt-1"><span
                                                                        class="badge bg-info-subtle text-info fw-normal"><i
                                                                            class="bi bi-info-circle me-1"></i>{{
                                                                        item.note }}</span></div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="card-footer bg-white py-2">
                                                <p class="small text-muted mb-0 text-center">共领用 {{
                                                    equipped_assets|length }} 项资产 · 向下滚动查看更多</p>
                                            </div>
                                            {% else %}
                                            <div class="py-5 text-center text-muted">
                                                <i class="bi bi-inbox fs-2 d-block mb-2 opacity-50"></i>
                                                <p class="mb-0">暂未领用任何装备</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <style>
                                        /* 美化滚动条 */
                                        .equipped-scroll-container::-webkit-scrollbar {
                                            width: 6px;
                                        }

                                        .equipped-scroll-container::-webkit-scrollbar-track {
                                            background: #f1f1f1;
                                        }

                                        .equipped-scroll-container::-webkit-scrollbar-thumb {
                                            background: #ccc;
                                            border-radius: 10px;
                                        }

                                        .equipped-scroll-container::-webkit-scrollbar-thumb:hover {
                                            background: #bbb;
                                        }
                                    </style>

                                    <!-- 档案记录区域 -->
                                    <div
                                        class="d-flex justify-content-between align-items-center mt-5 border-bottom pb-2 mb-3">
                                        <h6 class="mb-0">档案记录</h6>
                                        {# 只有在职且有编辑权限才显示添加按钮 #}
                                        {% if cycle.status == '在职' and perm.can('hr.edit') %}
                                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal"
                                            data-bs-target="#addArchiveModal">
                                            <i class="bi bi-plus-circle"></i> 添加档案
                                        </button>
                                        {% endif %}
                                    </div>

                                    {% if cycle.archives %}
                                    {% set archives = cycle.archives | fromjson %}
                                    {% if archives.archive_records %}
                                    <div class="list-group mb-4 shadow-sm">
                                        {# --- 关键修改：在这里加上 | reverse --- #}
                                        {% for record in archives.archive_records | reverse %}
                                        <div class="list-group-item list-group-item-action">
                                            <div class="d-flex w-100 justify-content-between align-items-center">
                                                <h6 class="mb-1">
                                                    <span
                                                        class="badge {% if record.type == '奖励' %}bg-success{% elif record.type == '处罚' %}bg-danger{% else %}bg-info{% endif %} me-1">
                                                        {{ record.type }}
                                                    </span>
                                                    <strong>{{ record.title }}</strong>
                                                    <small class="text-muted ms-2">操作人：{{ record.operator or '未知'
                                                        }}</small>
                                                </h6>
                                                {# 显示记录时间 #}
                                                <small class="text-secondary fw-bold">{{ format_datetime(record.date)
                                                    }}</small>
                                            </div>

                                            {% if record.description %}
                                            <p class="mb-2 mt-1 small text-muted border-start ps-2"
                                                style="white-space: pre-wrap;">{{ record.description }}</p>
                                            {% endif %}

                                            {# 附件显示逻辑保持不变 #}
                                            {% if record.file_path %}
                                            <div class="mt-2 bg-light p-2 rounded border-dashed">
                                                {% set lower_path = record.file_path|lower %}
                                                {% if lower_path.endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp',
                                                '.webp')) %}
                                                <a href="/{{ record.file_path }}" target="_blank">
                                                    <img src="/{{ record.file_path }}" class="img-thumbnail shadow-sm"
                                                        style="max-height:150px;">
                                                </a>
                                                {% else %}
                                                <a href="/{{ record.file_path }}" target="_blank"
                                                    class="btn btn-xs btn-outline-primary py-1 px-2">
                                                    <i class="bi bi-file-earmark-arrow-down"></i> 查看附件
                                                </a>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <p class="text-muted py-3 text-center bg-light rounded">暂无档案记录</p>
                                    {% endif %}
                                    {% else %}
                                    <p class="text-muted py-3 text-center bg-light rounded">暂无档案记录</p>
                                    {% endif %}
                                    <!--添加档案记录模态框-->
                                    {% if cycle.status == 'in_service' or cycle.status == '在职' %}
                                    {% if perm.can('hr.edit') %}
                                    <div class="modal fade" id="addArchiveModal" tabindex="-1"
                                        aria-labelledby="addArchiveModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content border-0 shadow">
                                                <div class="modal-header bg-success text-white">
                                                    <h5 class="modal-title" id="addArchiveModalLabel">
                                                        <i class="bi bi-file-earmark-plus"></i> 新增档案记录
                                                    </h5>
                                                    <button type="button" class="btn-close btn-close-white"
                                                        data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form method="POST"
                                                    action="{{ url_for('hr.add_archive', cycle_id=cycle.id) }}"
                                                    enctype="multipart/form-data">
                                                    <div class="modal-body p-4">
                                                        <div class="row g-3">
                                                            <div class="col-md-6">
                                                                <label class="form-label fw-bold small">记录类型</label>
                                                                <select name="record_type"
                                                                    class="form-select border-primary-subtle" required>
                                                                    <option value="奖励">奖励</option>
                                                                    <option value="处罚">处罚</option>
                                                                    <option value="其他" selected>其他</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label fw-bold small">记录日期</label>
                                                                <input type="date" name="record_date"
                                                                    class="form-control border-primary-subtle"
                                                                    value="{{ today_str() }}" required>
                                                            </div>
                                                            <div class="col-12">
                                                                <label class="form-label fw-bold small">标题/简述</label>
                                                                <input type="text" name="title"
                                                                    class="form-control border-primary-subtle"
                                                                    placeholder="请输入档案标题" required>
                                                            </div>
                                                            <div class="col-12">
                                                                <label class="form-label fw-bold small">详细说明</label>
                                                                <textarea name="description"
                                                                    class="form-control border-primary-subtle" rows="4"
                                                                    placeholder="请详细描述相关事宜..."></textarea>
                                                            </div>
                                                            <div class="col-12">
                                                                <label class="form-label fw-bold small">上传附件</label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text bg-light"><i
                                                                            class="bi bi-paperclip"></i></span>
                                                                    <input type="file" name="archive_file"
                                                                        class="form-control border-primary-subtle">
                                                                </div>
                                                                <div class="form-text mt-1 small text-muted">
                                                                    支持图片、PDF、Word 等格式</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer bg-light border-0">
                                                        <button type="button" class="btn btn-secondary px-4"
                                                            data-bs-dismiss="modal">取消</button>
                                                        <button type="submit"
                                                            class="btn btn-success px-5 shadow-sm">立即提交</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}

                                    <!-- 离职操作 -->
                                    {% if cycle.status == '在职' %}
                                    {% if perm.can('hr.edit') %}
                                    <div class="mt-4 text-end">
                                        <button type="button" class="btn btn-warning btn-lg" data-bs-toggle="modal"
                                            data-bs-target="#departureModal{{ cycle.id }}">
                                            标记离职
                                        </button>
                                    </div>

                                    <div class="modal fade" id="departureModal{{ cycle.id }}">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header bg-warning text-dark">
                                                    <h5 class="modal-title">确认离职 - {{ cycle.name }}</h5>
                                                    <button type="button" class="btn-close"
                                                        data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="POST"
                                                    action="{{ url_for('hr.departure', cycle_id=cycle.id) }}">
                                                    <div class="modal-body">
                                                        <!-- 未归还资产提醒 -->
                                                        {% set unreturned = get_unreturned_assets(cycle.id) %}
                                                        {% if unreturned %}
                                                        <div class="alert alert-danger mb-4">
                                                            <strong>检测到未归还资产（共 {{ unreturned|length }} 件）：</strong>
                                                            <ul class="mb-0">
                                                                {% for a in unreturned %}
                                                                <li>{{ a.name }} (编号: {{ a.number }})</li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                        {% else %}
                                                        <div class="alert alert-success mb-4">
                                                            <i class="bi bi-check-circle"></i> 当前无未归还资产
                                                        </div>
                                                        {% endif %}

                                                        <!-- 强制勾选项目 -->
                                                        <div class="form-check mb-3">
                                                            <input class="form-check-input" type="checkbox"
                                                                name="confirm_return" id="confirm_return{{ cycle.id }}"
                                                                required>
                                                            <label class="form-check-label fw-bold"
                                                                for="confirm_return{{ cycle.id }}">
                                                                已归还全部装备（系统将自动归还所有个人分配资产）
                                                            </label>
                                                        </div>

                                                        <div class="form-check mb-4">
                                                            <input class="form-check-input" type="checkbox"
                                                                name="settle_utilities"
                                                                id="settle_utilities{{ cycle.id }}" required>
                                                            <label class="form-check-label fw-bold"
                                                                for="settle_utilities{{ cycle.id }}">
                                                                已结算水电费
                                                            </label>
                                                        </div>

                                                        <label class="form-label">离职日期</label>
                                                        <input type="date" name="departure_date"
                                                            class="form-control mb-3" value="{{ today_str() }}"
                                                            min="0001-01-01" max="9999-12-31" required>

                                                        <label class="form-label">离职原因</label>
                                                        <textarea name="departure_reason" class="form-control" rows="3"
                                                            placeholder="请输入离职原因（可选）"></textarea>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">取消</button>
                                                        <button type="submit" class="btn btn-warning">确认离职</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- 编辑模式 -->
                {% if current_cycle %}
                <div class="tab-pane fade" id="edit_tab">
                    <form method="POST" action="{{ url_for('hr.edit_cycle', cycle_id=current_cycle.id) }}"
                        enctype="multipart/form-data">
                        {% set employee = current_cycle %}
                        {% include "hr/_employee_form.html" with context %}
                        <div class="text-center mt-5">
                            <button type="submit" class="btn btn-primary btn-lg px-5">保存修改</button>
                            <a href="{{ url_for('hr.hr_detail', id_card=id_card) }}"
                                class="btn btn-secondary btn-lg px-5">取消</a>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="quickIssueModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('asset.asset_issue_from_hr') }}">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-box-seam"></i> 向 {{ current_cycle.name }} 发放资产</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" value="{{ current_cycle.id }}">
                    <input type="hidden" name="id_card" value="{{ id_card }}">

                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">选择</th>
                                    <th>资产名称 (库存)</th>
                                    <th width="150">发放数量</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asset in available_assets %}
                                <tr>
                                    <td>
                                        <input class="form-check-input asset-checkbox" type="checkbox" name="asset_ids"
                                            value="{{ asset.id }}" id="chk_{{ asset.id }}">
                                    </td>
                                    <td>
                                        <label class="form-check-label d-block" for="chk_{{ asset.id }}">
                                            <strong>{{ asset.name }}</strong> <small class="text-muted">({{ asset.type
                                                }})</small><br>
                                            <span class="text-primary small">剩余库存: {{ asset.stock_quantity }}</span>
                                        </label>
                                    </td>
                                    <td>
                                        <input type="number" name="qty_{{ asset.id }}"
                                            class="form-control form-control-sm asset-qty" value="1" min="1"
                                            max="{{ asset.stock_quantity }}" disabled>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">发放备注</label>
                        <textarea name="note" class="form-control" rows="2" placeholder="统一备注，如：入职领用"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning" id="submitIssueBtn" disabled>确认发放</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // 控制数量框开关
    document.querySelectorAll('.asset-checkbox').forEach(chk => {
        chk.addEventListener('change', function () {
            const qtyInput = this.closest('tr').querySelector('.asset-qty');
            qtyInput.disabled = !this.checked;
            // 控制提交按钮
            const anyChecked = document.querySelectorAll('.asset-checkbox:checked').length > 0;
            document.getElementById('submitIssueBtn').disabled = !anyChecked;
        });
    });
</script>
{% endblock %}

==================================================
FILE: .\templates\hr\detail.html
==================================================

{% extends "base.html" %}

{% block title %}{{ cycles[0].name }} ({{ id_card }}) - 任职档案{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-person-lines-fill"></i> {{ cycles[0].name }} - 任职档案（共 {{ cycles|length }}
                次）</h4>
            <div class="d-flex gap-2">
                <!-- 优化点：添加图标+调整尺寸，与状态标签视觉分离 -->
                <a href="{{ url_for('hr.hr_list') }}" class="badge bg-light text-dark fs-5 px-3 py-1">
                    <i class="bi bi-arrow-left-short me-1"></i> 返回列表
                </a>
                <span class="badge bg-light text-dark fs-5 px-3 py-1">{{ cycles[0].status }}</span>
            </div>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <!-- 查看模式 -->
                <div class="tab-pane fade show active" id="view_tab">
                    {% for cycle in cycles %}
                    <div class="card mb-4 {% if cycle.status == '在职' %}border-primary shadow-lg{% endif %}">
                        <div
                            class="card-header d-flex justify-content-between {% if cycle.status == '在职' %}bg-primary text-white{% endif %}">

                            <strong>
                                第 {{ cycles|length - loop.index + 1 }} 次任职
                                （{{ format_date(cycle.hire_date) }} ~ {{ format_date(cycle.departure_date) or '至今' }}）

                                在职 {{ cycle.hire_date | calc_work_duration(cycle.departure_date) }}
                                <!-- 新过滤器：自动处理None -->
                            </strong>
                            <span class="badge bg-light text-dark">{{ cycle.status }}</span>
                        </div>
                        <div class="card-body">
                            <!-- 基本信息表格（保持原有） -->
                            <div class="row">
                                <div class="col-md-3 text-center mb-3">
                                    {% if cycle.photo_path %}
                                    <img src="/{{ cycle.photo_path }}" class="rounded-circle shadow" width="180"
                                        height="180" alt="照片">
                                    {% else %}
                                    <div class="bg-light rounded-circle shadow d-flex align-items-center justify-content-center text-muted"
                                        style="width:180px;height:180px;font-size:24px;">
                                        无照片
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-9">
                                    <table class="table table-sm table-borderless">
                                        <!-- 保持您原有所有字段显示 -->
                                        <tr>
                                            <th width="140">身份证</th>
                                            <td>{{ cycle.id_card }}</td>
                                        </tr>
                                        <tr>
                                            <th>性别</th>
                                            <td>{{ cycle.gender or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>出生日期</th>
                                            <td>{{ format_date(cycle.birthday) or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>手机</th>
                                            <td>{{ cycle.phone or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>民族</th>
                                            <td>{{ cycle.ethnic or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>政治面貌</th>
                                            <td>{{ cycle.politics or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>学历</th>
                                            <td>{{ cycle.education or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>薪资模式</th>
                                            <td>{{ cycle.salary_mode }}</td>
                                        </tr>
                                        <tr>
                                            <th>职务/岗位</th>
                                            <td>{{ cycle.position or '-' }} / {{ cycle.post or '-' }}</td>
                                        </tr>
                                        <tr>
                                            <th>户籍地址</th>
                                            <td>{{ [cycle.household_province, cycle.household_city,
                                                cycle.household_district, cycle.household_town, cycle.household_detail]
                                                | reject('none') | join(' ') or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>居住地址</th>
                                            <td>{{ [cycle.residence_province, cycle.residence_city,
                                                cycle.residence_district, cycle.residence_town, cycle.residence_detail]
                                                | reject('none') | join(' ') or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>兵役情况</th>
                                            <td>{% if cycle.military_service %}入伍时间:{{
                                                format_date(cycle.enlistment_date)
                                                }}，部队番号:{{ cycle.unit_number }}，兵种:{{ cycle.branch }}，退伍时间:{{
                                                format_date(cycle.discharge_date) }}{% else %}无{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <th>驾驶证</th>
                                            <td>{% if cycle.has_license %}初领时间:{{ format_date(cycle.license_date)
                                                }}，准驾车型:{{
                                                cycle.license_type }}，有效期至:{{ format_date(cycle.license_expiry) }}{%
                                                else
                                                %}无{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <th>保安员证</th>
                                            <td>
                                                保安证编号:{{ cycle.security_license_number or '无' }}
                                                {% if cycle.security_license_date %}
                                                ,发证时间: {{ format_date(cycle.security_license_date) }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>紧急联系人</th>
                                            <td>{{ cycle.emergency_name or '' }}（{{ cycle.emergency_relation or '' }}）{{
                                                cycle.emergency_phone or '' }}</td>
                                        </tr>
                                        <tr>
                                            <th>工作服尺码</th>
                                            <td>帽{{ cycle.hat_size or '-' }} | 短袖{{ cycle.short_sleeve or '-' }} | 长袖{{
                                                cycle.long_sleeve or '-' }} | 冬装{{ cycle.winter_uniform or '-' }} | 鞋{{
                                                cycle.shoe_size or '-' }}</td>
                                        </tr>
                                    </table>

                                    <!-- 离职原因 -->
                                    {% if cycle.status == '离职' and cycle.archives %}
                                    {% set archives = cycle.archives | fromjson %}
                                    {% if archives.departure_reason %}
                                    <div class="alert alert-warning mt-4">
                                        <strong>离职原因：</strong> {{ archives.departure_reason }}
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                    <!-- 装备领用情况 -->
                                    <div class="card mt-5 shadow-sm border-0">
                                        <div
                                            class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                                            <h6 class="mb-0 fw-bold text-dark">
                                                <i class="bi bi-shield-check text-primary me-1"></i> 装备领用情况
                                            </h6>
                                            <div class="d-flex align-items-center">
                                                {% if cycle.status == '在职' and perm.can('asset.issue') %}
                                                <button type="button" class="btn btn-warning btn-sm fw-bold shadow-sm"
                                                    data-bs-toggle="modal" data-bs-target="#quickIssueModal">
                                                    <i class="bi bi-plus-lg"></i> 发放资产
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="card-body p-0">
                                            {% set equipped_assets = get_equipped_assets(cycle.id) %}
                                            {% if equipped_assets %}
                                            <div class="equipped-scroll-container"
                                                style="max-height: 400px; overflow-y: auto;">
                                                <div class="list-group list-group-flush">
                                                    {% for item in equipped_assets | reverse %}
                                                    <div class="list-group-item list-group-item-action py-3">
                                                        <div class="row align-items-center">
                                                            <div class="col-auto">
                                                                <div
                                                                    class="rounded-circle bg-primary bg-opacity-10 p-2">
                                                                    <i class="bi bi-box-seam text-primary"></i>
                                                                </div>
                                                            </div>
                                                            <div class="col">
                                                                <strong class="d-block text-dark">{{ item.asset.name
                                                                    }}</strong>
                                                                <div class="d-flex align-items-center gap-2 mt-1">
                                                                    <span
                                                                        class="badge bg-light text-secondary border">编号:
                                                                        {{ item.asset.number }}</span>
                                                                    <span
                                                                        class="badge bg-primary-subtle text-primary">数量
                                                                        × {{ item.quantity }}</span>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4 text-end">
                                                                <div class="small text-muted">发放于: {{
                                                                    format_datetime(item.issue_date) }}</div>
                                                                <div class="small text-muted">发放人: <span
                                                                        class="text-dark">{{ item.issued_by or '系统'
                                                                        }}</span></div>
                                                                {% if item.note %}
                                                                <div class="mt-1"><span
                                                                        class="badge bg-info-subtle text-info fw-normal"><i
                                                                            class="bi bi-info-circle me-1"></i>{{
                                                                        item.note }}</span></div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="card-footer bg-white py-2">
                                                <p class="small text-muted mb-0 text-center">共领用 {{
                                                    equipped_assets|length }} 项资产 · 向下滚动查看更多</p>
                                            </div>
                                            {% else %}
                                            <div class="py-5 text-center text-muted">
                                                <i class="bi bi-inbox fs-2 d-block mb-2 opacity-50"></i>
                                                <p class="mb-0">暂未领用任何装备</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <style>
                                        /* 美化滚动条 */
                                        .equipped-scroll-container::-webkit-scrollbar {
                                            width: 6px;
                                        }

                                        .equipped-scroll-container::-webkit-scrollbar-track {
                                            background: #f1f1f1;
                                        }

                                        .equipped-scroll-container::-webkit-scrollbar-thumb {
                                            background: #ccc;
                                            border-radius: 10px;
                                        }

                                        .equipped-scroll-container::-webkit-scrollbar-thumb:hover {
                                            background: #bbb;
                                        }
                                    </style>

                                    <!-- 档案记录区域 -->
                                    <div
                                        class="d-flex justify-content-between align-items-center mt-5 border-bottom pb-2 mb-3">
                                        <h6 class="mb-0">档案记录</h6>
                                        {# 只有在职且有编辑权限才显示添加按钮 #}
                                        {% if cycle.status == '在职' and perm.can('hr.edit') %}
                                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal"
                                            data-bs-target="#addArchiveModal">
                                            <i class="bi bi-plus-circle"></i> 添加档案
                                        </button>
                                        {% endif %}
                                    </div>

                                    {% if cycle.archives %}
                                    {% set archives = cycle.archives | fromjson %}
                                    {% if archives.archive_records %}
                                    <div class="list-group mb-4 shadow-sm">
                                        {# --- 关键修改：在这里加上 | reverse --- #}
                                        {% for record in archives.archive_records | reverse %}
                                        <div class="list-group-item list-group-item-action">
                                            <div class="d-flex w-100 justify-content-between align-items-center">
                                                <h6 class="mb-1">
                                                    <span
                                                        class="badge {% if record.type == '奖励' %}bg-success{% elif record.type == '处罚' %}bg-danger{% else %}bg-info{% endif %} me-1">
                                                        {{ record.type }}
                                                    </span>
                                                    <strong>{{ record.title }}</strong>
                                                    <small class="text-muted ms-2">操作人：{{ record.operator or '未知'
                                                        }}</small>
                                                </h6>
                                                {# 显示记录时间 #}
                                                <small class="text-secondary fw-bold">{{ format_datetime(record.date)
                                                    }}</small>
                                            </div>

                                            {% if record.description %}
                                            <p class="mb-2 mt-1 small text-muted border-start ps-2"
                                                style="white-space: pre-wrap;">{{ record.description }}</p>
                                            {% endif %}

                                            {# 附件显示逻辑保持不变 #}
                                            {% if record.file_path %}
                                            <div class="mt-2 bg-light p-2 rounded border-dashed">
                                                {% set lower_path = record.file_path|lower %}
                                                {% if lower_path.endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp',
                                                '.webp')) %}
                                                <a href="/{{ record.file_path }}" target="_blank">
                                                    <img src="/{{ record.file_path }}" class="img-thumbnail shadow-sm"
                                                        style="max-height:150px;">
                                                </a>
                                                {% else %}
                                                <a href="/{{ record.file_path }}" target="_blank"
                                                    class="btn btn-xs btn-outline-primary py-1 px-2">
                                                    <i class="bi bi-file-earmark-arrow-down"></i> 查看附件
                                                </a>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <p class="text-muted py-3 text-center bg-light rounded">暂无档案记录</p>
                                    {% endif %}
                                    {% else %}
                                    <p class="text-muted py-3 text-center bg-light rounded">暂无档案记录</p>
                                    {% endif %}
                                    <!--添加档案记录模态框-->
                                    {% if cycle.status == 'in_service' or cycle.status == '在职' %}
                                    {% if perm.can('hr.edit') %}
                                    <div class="modal fade" id="addArchiveModal" tabindex="-1"
                                        aria-labelledby="addArchiveModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content border-0 shadow">
                                                <div class="modal-header bg-success text-white">
                                                    <h5 class="modal-title" id="addArchiveModalLabel">
                                                        <i class="bi bi-file-earmark-plus"></i> 新增档案记录
                                                    </h5>
                                                    <button type="button" class="btn-close btn-close-white"
                                                        data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form method="POST"
                                                    action="{{ url_for('hr.add_archive', cycle_id=cycle.id) }}"
                                                    enctype="multipart/form-data">
                                                    <div class="modal-body p-4">
                                                        <div class="row g-3">
                                                            <div class="col-md-6">
                                                                <label class="form-label fw-bold small">记录类型</label>
                                                                <select name="record_type"
                                                                    class="form-select border-primary-subtle" required>
                                                                    <option value="奖励">奖励</option>
                                                                    <option value="处罚">处罚</option>
                                                                    <option value="其他" selected>其他</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label fw-bold small">记录日期</label>
                                                                <input type="date" name="record_date"
                                                                    class="form-control border-primary-subtle"
                                                                    value="{{ today_str() }}" required>
                                                            </div>
                                                            <div class="col-12">
                                                                <label class="form-label fw-bold small">标题/简述</label>
                                                                <input type="text" name="title"
                                                                    class="form-control border-primary-subtle"
                                                                    placeholder="请输入档案标题" required>
                                                            </div>
                                                            <div class="col-12">
                                                                <label class="form-label fw-bold small">详细说明</label>
                                                                <textarea name="description"
                                                                    class="form-control border-primary-subtle" rows="4"
                                                                    placeholder="请详细描述相关事宜..."></textarea>
                                                            </div>
                                                            <div class="col-12">
                                                                <label class="form-label fw-bold small">上传附件</label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text bg-light"><i
                                                                            class="bi bi-paperclip"></i></span>
                                                                    <input type="file" name="archive_file"
                                                                        class="form-control border-primary-subtle">
                                                                </div>
                                                                <div class="form-text mt-1 small text-muted">
                                                                    支持图片、PDF、Word 等格式</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer bg-light border-0">
                                                        <button type="button" class="btn btn-secondary px-4"
                                                            data-bs-dismiss="modal">取消</button>
                                                        <button type="submit"
                                                            class="btn btn-success px-5 shadow-sm">立即提交</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}

                                    <!-- 离职操作 -->
                                    {% if cycle.status == '在职' %}
                                    {% if perm.can('hr.edit') %}
                                    <div class="mt-4 text-end">
                                        <button type="button" class="btn btn-warning btn-lg" data-bs-toggle="modal"
                                            data-bs-target="#departureModal{{ cycle.id }}">
                                            标记离职
                                        </button>
                                    </div>

                                    <div class="modal fade" id="departureModal{{ cycle.id }}">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header bg-warning text-dark">
                                                    <h5 class="modal-title">确认离职 - {{ cycle.name }}</h5>
                                                    <button type="button" class="btn-close"
                                                        data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="POST"
                                                    action="{{ url_for('hr.departure', cycle_id=cycle.id) }}">
                                                    <div class="modal-body">
                                                        <!-- 未归还资产提醒 -->
                                                        {% set unreturned = get_unreturned_assets(cycle.id) %}
                                                        {% if unreturned %}
                                                        <div class="alert alert-danger mb-4">
                                                            <strong>检测到未归还资产（共 {{ unreturned|length }} 件）：</strong>
                                                            <ul class="mb-0">
                                                                {% for a in unreturned %}
                                                                <li>{{ a.name }} (编号: {{ a.number }})</li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                        {% else %}
                                                        <div class="alert alert-success mb-4">
                                                            <i class="bi bi-check-circle"></i> 当前无未归还资产
                                                        </div>
                                                        {% endif %}

                                                        <!-- 强制勾选项目 -->
                                                        <div class="form-check mb-3">
                                                            <input class="form-check-input" type="checkbox"
                                                                name="confirm_return" id="confirm_return{{ cycle.id }}"
                                                                required>
                                                            <label class="form-check-label fw-bold"
                                                                for="confirm_return{{ cycle.id }}">
                                                                已归还全部装备（系统将自动归还所有个人分配资产）
                                                            </label>
                                                        </div>

                                                        <div class="form-check mb-4">
                                                            <input class="form-check-input" type="checkbox"
                                                                name="settle_utilities"
                                                                id="settle_utilities{{ cycle.id }}" required>
                                                            <label class="form-check-label fw-bold"
                                                                for="settle_utilities{{ cycle.id }}">
                                                                已结算水电费
                                                            </label>
                                                        </div>

                                                        <label class="form-label">离职日期</label>
                                                        <input type="date" name="departure_date"
                                                            class="form-control mb-3" value="{{ today_str() }}"
                                                            min="0001-01-01" max="9999-12-31" required>

                                                        <label class="form-label">离职原因</label>
                                                        <textarea name="departure_reason" class="form-control" rows="3"
                                                            placeholder="请输入离职原因（可选）"></textarea>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">取消</button>
                                                        <button type="submit" class="btn btn-warning">确认离职</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- 编辑模式 -->
                {% if current_cycle %}
                <div class="tab-pane fade" id="edit_tab">
                    <form method="POST" action="{{ url_for('hr.edit_cycle', cycle_id=current_cycle.id) }}"
                        enctype="multipart/form-data">
                        {% set employee = current_cycle %}
                        {% include "hr/_employee_form.html" with context %}
                        <div class="text-center mt-5">
                            <button type="submit" class="btn btn-primary btn-lg px-5">保存修改</button>
                            <a href="{{ url_for('hr.hr_detail', id_card=id_card) }}"
                                class="btn btn-secondary btn-lg px-5">取消</a>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="quickIssueModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('asset.asset_issue_from_hr') }}">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-box-seam"></i> 向 {{ current_cycle.name }} 发放资产</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" value="{{ current_cycle.id }}">
                    <input type="hidden" name="id_card" value="{{ id_card }}">

                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">选择</th>
                                    <th>资产名称 (库存)</th>
                                    <th width="150">发放数量</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asset in available_assets %}
                                <tr>
                                    <td>
                                        <input class="form-check-input asset-checkbox" type="checkbox" name="asset_ids"
                                            value="{{ asset.id }}" id="chk_{{ asset.id }}">
                                    </td>
                                    <td>
                                        <label class="form-check-label d-block" for="chk_{{ asset.id }}">
                                            <strong>{{ asset.name }}</strong> <small class="text-muted">({{ asset.type
                                                }})</small><br>
                                            <span class="text-primary small">剩余库存: {{ asset.stock_quantity }}</span>
                                        </label>
                                    </td>
                                    <td>
                                        <input type="number" name="qty_{{ asset.id }}"
                                            class="form-control form-control-sm asset-qty" value="1" min="1"
                                            max="{{ asset.stock_quantity }}" disabled>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">发放备注</label>
                        <textarea name="note" class="form-control" rows="2" placeholder="统一备注，如：入职领用"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning" id="submitIssueBtn" disabled>确认发放</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // 控制数量框开关
    document.querySelectorAll('.asset-checkbox').forEach(chk => {
        chk.addEventListener('change', function () {
            const qtyInput = this.closest('tr').querySelector('.asset-qty');
            qtyInput.disabled = !this.checked;
            // 控制提交按钮
            const anyChecked = document.querySelectorAll('.asset-checkbox:checked').length > 0;
            document.getElementById('submitIssueBtn').disabled = !anyChecked;
        });
    });
</script>
{% endblock %}

==================================================
FILE: .\templates\hr\edit.html
==================================================

{% extends "base.html" %}

{% block title %}编辑员工信息 - {{ cycle.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-warning text-dark">
            <h4 class="mb-0">编辑员工信息 - {{ cycle.name }}</h4>
        </div>
        <div class="card-body p-4">
            <form method="POST" action="{{ url_for('hr.edit_cycle', cycle_id=cycle.id) }}" enctype="multipart/form-data">
                {% set employee = cycle %} {# 回显数据 #}
                {% include "hr/_employee_form.html" with context %} {# 关键修复：添加 with context #}
                
                <div class="text-center mt-5">
                    <button type="submit" class="btn btn-primary btn-lg px-5">保存修改</button>
                    <a href="{{ url_for('hr.hr_detail', id_card=cycle.id_card) }}" class="btn btn-secondary btn-lg px-5">取消</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

==================================================
FILE: .\templates\hr\import.html
==================================================

{% extends "base.html" %}
{% block title %}导入名单{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4>导入名单</h4>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label">选择Excel文件（必须包含：姓名、身份证号码、手机号）</label>
                    <input type="file" name="file" class="form-control" accept=".xlsx" required>
                    <small class="text-muted">可选列：职务、岗位、薪资模式</small>
                </div>
                <button type="submit" class="btn btn-success">开始导入</button>
                <a href="{{ url_for('hr.hr_list') }}" class="btn btn-secondary">取消</a>
            </form>
        </div>
    </div>
</div>
{% endblock %}

==================================================
FILE: .\templates\hr\list.html
==================================================

{% extends "base.html" %}

{% block title %}员工花名册{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="bi bi-people"></i>
                {% if perm.can('hr.view') %}花名册{% else %}我的个人信息{% endif %}
            </h4>
            <div>
                {% if perm.can('hr.view') %}
                <a href="{{ url_for('hr.hr_export', status=status_filter, search=search) }}" class="btn btn-light me-2">
                    <i class="bi bi-download"></i> 导出数据
                </a>
                <a href="{{ url_for('hr.hr_import') }}" class="btn btn-light me-2">
                    <i class="bi bi-upload"></i> 导入数据
                </a>
                <a href="{{ url_for('hr.hr_add') }}" class="btn btn-light">
                    <i class="bi bi-person-plus"></i> 新增数据
                </a>
                <button class="btn btn-info me-2" onclick="showQR()">
                    <i class="bi bi-qr-code"></i> 扫码入职
                </button>
                {% endif %}
            </div>
        </div>




        <div class="card-body">
            <!-- 搜索框 -->
            <form method="GET" class="mb-4">
                <div class="row g-3">
                    <div class="col-md-8">
                        <input type="text" name="search" class="form-control" placeholder="搜索姓名/身份证/手机号"
                            value="{{ search or '' }}">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-outline-primary w-100">搜索</button>
                    </div>
                </div>
            </form>

            <!-- 标签页 -->
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <a class="nav-link {% if status_filter == '在职' %}active{% endif %}"
                        href="{{ url_for('hr.hr_list', status='在职') }}">在职人员</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if status_filter == '待审核' %}active{% endif %}"
                        href="{{ url_for('hr.hr_list', status='待审核') }}">
                        待审核
                        {% if pending_count > 0 %}
                        <span class="badge rounded-pill bg-danger">{{ pending_count }}</span>
                        {% endif %}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if status_filter == '离职' %}active{% endif %}"
                        href="{{ url_for('hr.hr_list', status='离职') }}">离职人员</a>
                </li>
            </ul>

            <!-- 字段显示控制 -->
            <form method="GET" class="mb-4 bg-light p-3 rounded">
                <input type="hidden" name="status" value="{{ status_filter }}">
                <input type="hidden" name="search" value="{{ search }}">
                <input type="hidden" name="sort" value="{{ sort }}">
                <div class="row align-items-center">
                    <div class="col-auto"><strong>显示字段：</strong></div>
                    <div class="col">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="name" id="show_name" {%
                                if 'name' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_name">姓名</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="id_card"
                                id="show_id_card" {% if 'id_card' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_id_card">身份证</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="phone" id="show_phone" {%
                                if 'phone' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_phone">手机号</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="position"
                                id="show_position" {% if 'position' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_position">职务</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="post" id="show_post" {%
                                if 'post' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_post">岗位</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="salary_mode"
                                id="show_salary" {% if 'salary_mode' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_salary">薪资模式</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="hire_date" id="show_hire"
                                {% if 'hire_date' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_hire">入职日期</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" name="show" value="tenure" id="show_tenure"
                                {% if 'tenure' in show_fields %}checked{% endif %}>
                            <label class="form-check-label" for="show_tenure">在职时长</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-outline-secondary">应用</button>
                    </div>
                </div>
            </form>

            <!-- 员工表格 -->
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>序号</th>
                            {% if 'name' in show_fields %}
                            <th>
                                <a href="{{ url_for('hr.hr_list', status=status_filter, search=search, sort='name_asc' if sort == 'name_desc' else 'name_desc', show=show_fields) }}"
                                    class="text-dark text-decoration-none">
                                    姓名 {% if sort.startswith('name_') %}↕{% endif %}
                                </a>
                            </th>
                            {% endif %}
                            {% if 'id_card' in show_fields %}
                            <th>
                                <a href="{{ url_for('hr.hr_list', status=status_filter, search=search, sort='id_card_asc' if sort == 'id_card_desc' else 'id_card_desc', show=show_fields) }}"
                                    class="text-dark text-decoration-none">
                                    身份证号码 {% if sort.startswith('id_card_') %}↕{% endif %}
                                </a>
                            </th>
                            {% endif %}
                            {% if 'phone' in show_fields %}
                            <th>
                                <a href="{{ url_for('hr.hr_list', status=status_filter, search=search, sort='phone_asc' if sort == 'phone_desc' else 'phone_desc', show=show_fields) }}"
                                    class="text-dark text-decoration-none">
                                    手机号 {% if sort.startswith('phone_') %}↕{% endif %}
                                </a>
                            </th>
                            {% endif %}
                            {% if 'position' in show_fields %}
                            <th>
                                <a href="{{ url_for('hr.hr_list', status=status_filter, search=search, sort='position_asc' if sort == 'position_desc' else 'position_desc', show=show_fields) }}"
                                    class="text-dark text-decoration-none">
                                    职务 {% if sort.startswith('position_') %}↕{% endif %}
                                </a>
                            </th>
                            {% endif %}

                            {% if 'post' in show_fields %}
                            <th>
                                <a href="{{ url_for('hr.hr_list', status=status_filter, search=search, sort='post_asc' if sort == 'post_desc' else 'post_desc', show=show_fields) }}"
                                    class="text-dark text-decoration-none">
                                    岗位 {% if sort.startswith('post_') %}↕{% endif %}
                                </a>
                            </th>
                            {% endif %}

                            {% if 'salary_mode' in show_fields %}
                            <th>
                                <a href="{{ url_for('hr.hr_list', status=status_filter, search=search, sort='salary_mode_asc' if sort == 'salary_mode_desc' else 'salary_mode_desc', show=show_fields) }}"
                                    class="text-dark text-decoration-none">
                                    薪资模式 {% if sort.startswith('salary_mode_') %}↕{% endif %}
                                </a>
                            </th>
                            {% endif %}
                            {% if 'hire_date' in show_fields %}
                            <th>
                                <a href="{{ url_for('hr.hr_list', status=status_filter, search=search, sort='hire_date_asc' if sort == 'hire_date_desc' else 'hire_date_desc', show=show_fields) }}"
                                    class="text-dark text-decoration-none">
                                    入职日期 {% if sort.startswith('hire_date_') %}↕{% endif %}
                                </a>
                            </th>
                            {% endif %}
                            {% if 'tenure' in show_fields %}<th>在职时长</th>{% endif %}
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if employees %}
                        {% for emp in employees %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            {% if 'name' in show_fields %}<td>{{ emp.name }}</td>{% endif %}
                            {% if 'id_card' in show_fields %}<td>{{ emp.id_card }}</td>{% endif %}
                            {% if 'phone' in show_fields %}<td>{{ emp.phone or '-' }}</td>{% endif %}
                            {% if 'position' in show_fields %}<td>{{ emp.position or '-' }}</td>{% endif %}
                            {% if 'post' in show_fields %}<td>{{ emp.post or '-' }}</td>{% endif %}
                            {% if 'salary_mode' in show_fields %}<td>{{ emp.salary_mode or '-' }}</td>{% endif %}
                            {% if 'hire_date' in show_fields %}<td>{{ format_date(emp.hire_date) }}</td>{% endif %}
                            {% if 'tenure' in show_fields %}
                            <td>
                                {{ emp.hire_date | calc_work_duration(emp.departure_date) }}
                            </td>
                            {% endif %}
                            <td>
                                <a href="{{ url_for('hr.hr_detail', id_card=emp.id_card) }}"
                                    class="btn btn-sm btn-outline-primary">查看</a>
                                {% if emp.status == '在职' and perm.can('hr.edit') %}
                                <a href="{{ url_for('hr.edit_cycle', cycle_id=emp.id) }}"
                                    class="btn btn-sm btn-outline-warning">编辑</a>
                                {% endif %}
                                {% if status_filter == '待审核' and perm.can('hr.approve') %} <!-- 改: 用hr.approve权限 -->
                                <form action="{{ url_for('hr.approve_pending', id=emp.id) }}" method="POST"
                                    class="d-inline" onsubmit="return confirm('确定批准 {{ emp.name }} 为在职员工吗？');">
                                    <button type="submit" class="btn btn-sm btn-outline-success">
                                        <i class="bi bi-check-circle"></i> 批准
                                    </button>
                                </form>
                                {% endif %}

                                {% if current_user.role == 'admin' and status_filter in ['待审核', '在职', '离职'] %}
                                <form action="{{ url_for('hr.delete_pending', id=emp.id) }}" method="POST"
                                    class="d-inline" onsubmit="return confirm('确定要删除这条记录吗？此操作不可恢复。');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center text-muted py-5">暂无员工记录</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">蔡路特保队花名册登记</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrSpinner" class="spinner-border text-primary mb-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <img id="qrImg" src="" class="img-fluid d-none" alt="二维码">
                <p class="mt-2 mb-0 small text-muted">请新队员使用手机扫码填写个人信息</p>
                <div id="qrLink" class="mt-2 small text-break" style="font-size: 0.75rem;"></div>
            </div>
        </div>
    </div>
</div>
<script>
    function showQR() {
        // 1. 显示弹窗并初始化状态
        const modal = new bootstrap.Modal(document.getElementById('qrModal'));
        const img = document.getElementById('qrImg');
        const spinner = document.getElementById('qrSpinner');
        const linkDiv = document.getElementById('qrLink');

        img.classList.add('d-none');
        spinner.classList.remove('d-none');
        linkDiv.innerText = '';
        modal.show();

        // 2. 调用后端生成二维码接口
        fetch("{{ url_for('hr.generate_qr') }}")
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 3. 显示二维码
                    img.src = "data:image/png;base64," + data.qr_code;
                    img.classList.remove('d-none');
                    spinner.classList.add('d-none');
                    linkDiv.innerText = data.url; // 方便调试看链接是否正确
                } else {
                    alert("生成失败: " + data.message);
                    modal.hide();
                }
            })
            .catch(err => {
                console.error(err);
                alert("请求接口出错，请检查后端路由设置");
                modal.hide();
            });
    }
</script>
{% endblock %}

==================================================
FILE: .\templates\hr\register_success.html
==================================================

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <title>提交成功</title>
    <style>
        body { background-color: #f8f9fa; }
        .success-card { max-width: 400px; margin: 100px auto; border: none; border-radius: 15px; }
        .success-icon { font-size: 4rem; color: #198754; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card success-card shadow text-center p-4">
            <div class="card-body">
                <div class="success-icon mb-3">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <h3 class="card-title mb-3">登记已提交</h3>
                <p class="card-text text-muted mb-4">
                    您的入职登记信息已成功录入系统。<br>
                    请告知现场管理人员进行<strong>身份审核</strong>。
                </p>
                <div class="d-grid">
                    <button onclick="window.close();" class="btn btn-primary btn-lg">确定</button>
                </div>
                <p class="mt-3 small text-muted">提示：审核通过后方可分配排班与宿舍</p>
            </div>
        </div>
    </div>
</body>
</html>

==================================================
FILE: .\templates\hr\self_register.html
==================================================

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <title>入职自助登记</title>
    <style>
        /* 隐藏掉不该让队员填写的区域 */
        .admin-only { display: none !important; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white text-center">
                <h4 class="mb-0">新员工入职自助登记</h4>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {% include "hr/_employee_form.html" %}
                    
                    <div class="alert alert-info mt-4">
                        <i class="bi bi-info-circle"></i> 请确保填写信息真实有效，提交后请等待管理员审核。
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg w-100">提交入职申请</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

==================================================
FILE: .\templates\hr\_employee_form.html
==================================================

<!-- templates/hr/_employee_form.html -->
<!-- 公共员工表单 - 新增/编辑共用，变量名为 employee（新增时 employee=none） -->
<div class="row">
    <div class="col-md-8">
        <h5 class="border-bottom pb-2 mb-3">基本信息</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">姓名 <span class="text-danger">*</span></label>
                <input type="text" name="name" class="form-control" value="{{ employee.name or '' }}" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">身份证号码 <span class="text-danger">*</span></label>
                <input type="text" name="id_card" id="id_card" class="form-control" maxlength="18"
                    value="{{ employee.id_card or '' }}" required>
                <div id="id_card_msg" class="form-text mt-1"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">性别 <small class="text-muted">(自动计算)</small></label>
                <input type="text" id="gender_display" class="form-control bg-light" value="{{ employee.gender or '' }}"
                    readonly>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">出生日期 <small class="text-muted">(自动计算)</small></label>
                <input type="text" id="birthday_display" class="form-control bg-light"
                    value="{{ format_date(employee.birthday) or '' }}" readonly>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">手机号码 <span class="text-danger">*</span></label>
                <input type="text" name="phone" id="phone" class="form-control" maxlength="11"
                    value="{{ employee.phone or '' }}" required>
                <div id="phone_msg" class="form-text mt-1"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">民族</label>
                <select name="ethnic" class="form-select">
                    <option value="">请选择</option>
                    {% for e in ethnic_options %}
                    <option value="{{ e }}" {% if e==employee.ethnic %}selected{% endif %}>{{ e }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">政治面貌</label>
                <select name="politics" class="form-select">
                    <option value="">请选择</option>
                    {% for p in politics_options %}
                    <option value="{{ p }}" {% if p==employee.politics %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">学历</label>
                <select name="education" class="form-select">
                    <option value="">请选择</option>
                    {% for edu in education_options %}
                    <option value="{{ edu }}" {% if edu==employee.education %}selected{% endif %}>{{ edu }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <div class="col-md-4 text-center">
        <h5 class="border-bottom pb-2 mb-3">员工照片</h5>
        <img id="photo_preview"
            src="/{{ employee.photo_path or 'uploads/default-avatar.png' }}"
            class="rounded-circle shadow mb-3" width="160" height="160" alt="照片预览">
        <input type="file" name="photo" id="photo" class="form-control" accept="image/*">
        <small class="text-muted d-block mt-2">建议上传正面免冠照</small>
    </div>
</div>

<hr class="my-5">

<h5 class="border-bottom pb-2 mb-3">地址信息</h5>
<div class="row mb-4">
    <div class="col-md-6">
        <strong class="d-block mb-2">户籍地址</strong>
        <div class="row g-2 mb-2">
            <div class="col-3">
                <input type="text" name="household_province" class="form-control" placeholder="省"
                    value="{{ employee.household_province or '' }}">
            </div>
            <div class="col-3">
                <input type="text" name="household_city" class="form-control" placeholder="市"
                    value="{{ employee.household_city or '' }}">
            </div>
            <div class="col-3">
                <input type="text" name="household_district" class="form-control" placeholder="区/县"
                    value="{{ employee.household_district or '' }}">
            </div>
            <div class="col-3">
                <input type="text" name="household_town" class="form-control" placeholder="镇/街道"
                    value="{{ employee.household_town or '' }}">
            </div>
        </div>
        <input type="text" name="household_detail" class="form-control" placeholder="详细地址（如村、门牌号）"
            value="{{ employee.household_detail or '' }}">
    </div>

    <div class="col-md-6">
        <strong class="d-block mb-2">居住地址 <small class="text-muted"></small></strong>
        <div class="row g-2 mb-2">
            <div class="col-3">
                <input type="text" name="residence_province" class="form-control" placeholder="省"
                    value="{{ employee.residence_province or '' }}">
            </div>
            <div class="col-3">
                <input type="text" name="residence_city" class="form-control" placeholder="市"
                    value="{{ employee.residence_city or '' }}">
            </div>
            <div class="col-3">
                <input type="text" name="residence_district" class="form-control" placeholder="区/县"
                    value="{{ employee.residence_district or '' }}">
            </div>
            <div class="col-3">
                <input type="text" name="residence_town" class="form-control" placeholder="镇/街道"
                    value="{{ employee.residence_town or '' }}">
            </div>
        </div>
        <input type="text" name="residence_detail" class="form-control" placeholder="详细地址（如村、门牌号）"
            value="{{ employee.residence_detail or '' }}">
    </div>
</div>

<hr class="my-5">

<h5 class="border-bottom pb-2 mb-3">其他资质</h5>
<div class="row">
    <div class="col-md-4">
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="military_service" name="military_service" 
                {% if employee.military_service %}checked{% endif %}>
            <label class="form-check-label fw-bold" for="military_service">曾服兵役</label>
        </div>
        <div id="military_fields" style="display: none; margin-left:20px;">
            <small class="text-muted d-block mb-2">入伍日期</small>
            <input type="date" name="enlistment_date" class="form-control mb-2"
                value="{{ employee.enlistment_date.strftime('%Y-%m-%d') if employee.enlistment_date and employee.enlistment_date is not string else (employee.enlistment_date[:10] if employee.enlistment_date else '') }}" 
                min="0001-01-01" max="9999-12-31">
            
            <small class="text-muted d-block mb-2">部队番号</small>
            <input type="text" name="unit_number" class="form-control mb-2" value="{{ employee.unit_number or '' }}">
            
            <small class="text-muted d-block mb-2">兵种</small>
            <input type="text" name="branch" class="form-control mb-2" value="{{ employee.branch or '' }}">
            
            <small class="text-muted d-block mb-2">退伍日期</small>
            <input type="date" name="discharge_date" class="form-control mb-2"
                value="{{ employee.discharge_date.strftime('%Y-%m-%d') if employee.discharge_date and employee.discharge_date is not string else (employee.discharge_date[:10] if employee.discharge_date else '') }}"
                min="0001-01-01" max="9999-12-31">
        </div>
    </div>

    <div class="col-md-4">
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="has_license" name="has_license" 
                {% if employee.has_license %}checked{% endif %}>
            <label class="form-check-label fw-bold" for="has_license">持有驾驶证</label>
        </div>
        <div id="license_fields" style="display: none; margin-left:20px;">
            <small class="text-muted d-block mb-2">初次领证日期</small>
            <input type="date" name="license_date" class="form-control mb-2"
                value="{{ employee.license_date.strftime('%Y-%m-%d') if employee.license_date and employee.license_date is not string else (employee.license_date[:10] if employee.license_date else '') }}" 
                min="0001-01-01" max="9999-12-31">
            
            <small class="text-muted d-block mb-2">准驾车型</small>
            <input type="text" name="license_type" class="form-control mb-2" value="{{ employee.license_type or '' }}" placeholder="如C1">
            
            <small class="text-muted d-block mb-2">有效期至</small>
            <input type="date" name="license_expiry" class="form-control mb-2"
                value="{{ employee.license_expiry.strftime('%Y-%m-%d') if employee.license_expiry and employee.license_expiry is not string else (employee.license_expiry[:10] if employee.license_expiry else '') }}" 
                min="0001-01-01" max="9999-12-31">
        </div>
    </div>

    <div class="col-md-4">
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="has_security_license" name="has_security_license" 
                {% if employee.security_license_number %}checked{% endif %}>
            <label class="form-check-label fw-bold" for="has_security_license">持有保安员证</label>
        </div>
        <div id="security_fields" style="display: none; margin-left:20px;">
            <small class="text-muted d-block mb-2">保安证编号</small>
            <input type="text" name="security_license_number" class="form-control mb-2" value="{{ employee.security_license_number or '' }}">
            
            <small class="text-muted d-block mb-2">保安证发证日期</small>
            <input type="date" name="security_license_date" class="form-control mb-2"
                value="{{ employee.security_license_date.strftime('%Y-%m-%d') if employee.security_license_date and employee.security_license_date is not string else (employee.security_license_date[:10] if employee.security_license_date else '') }}" 
                min="0001-01-01" max="9999-12-31">
        </div>
    </div>
</div>


<hr class="my-5">

<!-- 薪资计算模式、职位信息 -->
<div class="row">
    <div class="col-md-3 mb-3">
        <label class="form-label">薪资计算模式 <span class="text-danger">*</span></label>
        <select name="salary_mode" class="form-select" required>
            {% for mode in salary_modes %}
            <option value="{{ mode }}" {% if mode==employee.salary_mode %}selected{% endif %}>{{ mode }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-3 mb-3">
        <label class="form-label">职务 <span class="text-danger">*</span></label>
        <select name="position" class="form-select" required>
            {% for pos in positions %}
            <option value="{{ pos }}" {% if pos==employee.position %}selected{% endif %}>{{ pos }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-3 mb-3">
        <label class="form-label">岗位 <span class="text-danger">*</span></label>
        <select name="post" class="form-select" required>
            {% for p in posts %}
            <option value="{{ p }}" {% if p==employee.post %}selected{% endif %}>{{ p }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-3 mb-3">
        <label class="form-label">入职日期</label>
        <input type="date" name="hire_date" class="form-control"
            value="{{ employee.hire_date.strftime('%Y-%m-%d') if employee.hire_date and employee.hire_date is not string else (employee.hire_date[:10] if employee.hire_date else '') }}" min="0001-01-01" max="9999-12-31">
    </div>
</div>

<!-- 紧急联系人 + 工作服尺码 -->
<div class="row mt-4">
    <div class="col-md-4">
        <h5 class="mb-3">紧急联系人</h5>
        <input type="text" name="emergency_name" class="form-control mb-2" placeholder="姓名"
            value="{{ employee.emergency_name or '' }}">
        <input type="text" name="emergency_relation" class="form-control mb-2" placeholder="关系"
            value="{{ employee.emergency_relation or '' }}">
        <input type="text" name="emergency_phone" class="form-control mb-2" placeholder="电话"
            value="{{ employee.emergency_phone or '' }}">
    </div>
    <div class="col-md-8">
        <h5 class="mb-3">工作服尺码</h5>
        <div class="row g-3">
            <div class="col"><input type="text" name="hat_size" class="form-control" placeholder="帽围"
                    value="{{ employee.hat_size or '' }}"></div>
            <div class="col"><input type="text" name="short_sleeve" class="form-control" placeholder="短袖"
                    value="{{ employee.short_sleeve or '' }}"></div>
            <div class="col"><input type="text" name="long_sleeve" class="form-control" placeholder="长袖"
                    value="{{ employee.long_sleeve or '' }}"></div>
            <div class="col"><input type="text" name="winter_uniform" class="form-control" placeholder="冬装"
                    value="{{ employee.winter_uniform or '' }}"></div>
            <div class="col"><input type="text" name="shoe_size" class="form-control" placeholder="鞋码"
                    value="{{ employee.shoe_size or '' }}"></div>
        </div>
    </div>
</div>

<script>
    // 身份证校验 + 自动填充
    const idInput = document.getElementById('id_card');
    if (idInput) {
        idInput.addEventListener('blur', function () {
            const id = this.value.trim();
            const msg = document.getElementById('id_card_msg');
            if (id.length === 18) {
                fetch('/validate_id_card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_card: id })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.valid) {
                            msg.innerHTML = '<span class="text-success">身份证合法</span>';
                            document.getElementById('gender_display').value = data.gender;
                            document.getElementById('birthday_display').value = data.birthday;
                        } else {
                            msg.innerHTML = '<span class="text-danger">' + (data.error || '校验失败') + '</span>';
                        }
                    })
                    .catch(() => {
                        msg.innerHTML = '<span class="text-warning">校验服务暂时不可用</span>';
                    });
            } else if (id.length > 0) {
                msg.innerHTML = '<span class="text-danger">请输入18位身份证号码</span>';
            } else {
                msg.innerHTML = '';
            }
        });
    }

    // 照片预览
    const photoInput = document.getElementById('photo');
    if (photoInput) {
        photoInput.addEventListener('change', function (e) {
            if (e.target.files && e.target.files[0]) {
                document.getElementById('photo_preview').src = URL.createObjectURL(e.target.files[0]);
            }
        });
    }

    // 复选框控制子字段（兵役、驾照、保安证）
    const toggleFields = (checkboxId, fieldsId) => {
        const cb = document.getElementById(checkboxId);
        const fields = document.getElementById(fieldsId);
        if (cb && fields) {
            cb.addEventListener('change', function () {
                fields.style.display = this.checked ? 'block' : 'none';
            });
            // 初始状态同步
            fields.style.display = cb.checked ? 'block' : 'none';
        }
    };

    toggleFields('military_service', 'military_fields');
    toggleFields('has_license', 'license_fields');
    toggleFields('has_security_license', 'security_fields');

    // 其他证书控制 + 动态添加
    const otherCertCb = document.getElementById('has_other_cert');
    const otherCertContainer = document.getElementById('other_cert_container');
    const addCertBtn = document.getElementById('add_cert_btn');
    const certList = document.getElementById('cert_list');

    if (otherCertCb && otherCertContainer && addCertBtn && certList) {
        otherCertCb.addEventListener('change', function () {
            otherCertContainer.style.display = this.checked ? 'block' : 'none';
            if (this.checked && certList.children.length === 0) {
                addCertBtn.click();
            }
        });

        let certIndex = 0;
        addCertBtn.addEventListener('click', function () {
            const div = document.createElement('div');
            div.className = 'row g-2 mb-3 align-items-end';
            div.innerHTML = `
                <div class="col-md-4">
                    <input type="text" name="cert_name_${certIndex}" class="form-control" placeholder="证件名称" required>
                </div>
                <div class="col-md-4">
                    <input type="text" name="cert_number_${certIndex}" class="form-control" placeholder="证件号码" required>
                </div>
                <div class="col-md-3">
                    <input type="date" name="cert_date_${certIndex}" class="form-control" min="0001-01-01" max="9999-12-31" required>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            certList.appendChild(div);
            certIndex++;
        });
    }
</script>

==================================================
FILE: .\templates\notification\list.html
==================================================

{% extends "base.html" %}
{% block title %}我的通知{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-bell"></i> 我的通知</h4>
            <span class="badge bg-light text-dark">
                {# 只有当有未读通知时才显示一键已读按钮 #}
                {% if notifications|selectattr('is_read', 'equalto', false)|list|length > 0 %}
                <form action="{{ url_for('notification.read_all') }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-check2-all"></i> 一键已读
                    </button>
                </form>
                {% endif %}
                未读：{{ notifications|selectattr('is_read', 'equalto', false)|list|length }} 条
            </span>
        </div>
        <div class="card-body">
            {% if notifications %}
            <div class="list-group">
                {% for notify in notifications %}
                <a href="{{ url_for('notification.mark_as_read', notify_id=notify.id) if not notify.is_read else '#' }}"
                    class="list-group-item list-group-item-action {% if not notify.is_read %}bg-light border-primary{% endif %}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1 fw-bold">{{ notify.title }}</h6>
                            <p class="mb-1 small text-muted">{{ notify.content|safe }}</p>
                        </div>
                        {% if not notify.is_read %}
                        <span class="badge bg-primary rounded-pill">未读</span>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
                </div>

                {% if pagination.pages > 1 %}
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                            <a class="page-link"
                                href="{{ url_for('notification.notification_list', page=pagination.prev_num) if pagination.has_prev else '#' }}">上一页</a>
                        </li>
                
                        {% for page in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=3) %}
                        {% if page %}
                        <li class="page-item {% if page == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('notification.notification_list', page=page) }}">{{ page }}</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                        {% endfor %}
                
                        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                            <a class="page-link"
                                href="{{ url_for('notification.notification_list', page=pagination.next_num) if pagination.has_next else '#' }}">下一页</a>
                        </li>
                    </ul>
                </nav>
                {% endif %}                    
                
                {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-bell-slash fs-4 mb-2"></i>
                <p>暂无通知</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

==================================================
FILE: .\templates\permission\manage.html
==================================================

{% extends "base.html" %}

{% block title %}权限分配{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-shield-lock-fill me-2"></i>权限分配管理</h4>
        </div>
        <div class="card-body p-4">
            <div class="row g-4">
                <!-- 左侧：员工列表 -->
                <div class="col-lg-4 col-xl-3">
                    <h5 class="text-secondary mb-3"><i class="bi bi-people-fill me-2"></i>在职员工（点击选择）</h5>
                    <div class="list-group shadow-sm"
                        style="max-height: 70vh; overflow-y: auto; border-radius: 0.5rem;">
                        {% for emp in employees %}
                        {% set real_user_id = id_map.get(emp.id_card) %}
                        {% if real_user_id %}
                        <a href="javascript:void(0);"
                            class="list-group-item list-group-item-action employee-item py-3 border-0"
                            onclick="selectUser('{{ real_user_id }}', '{{ emp.name|e }}', this)">
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded-circle me-3 d-flex align-items-center justify-content-center"
                                    style="width: 40px; height: 40px;">
                                    <i class="bi bi-person-fill text-primary" style="font-size: 1.2rem;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">{{ emp.name }}</div>
                                    <small class="text-muted">{{ emp.position or '队员' }}</small>
                                </div>
                            </div>
                        </a>
                        {% else %}
                        <div class="list-group-item py-3 border-0 text-muted bg-light">
                            <div class="d-flex align-items-center">
                                <div class="bg-secondary bg-opacity-10 rounded-circle me-3 d-flex align-items-center justify-content-center"
                                    style="width: 40px; height: 40px;">
                                    <i class="bi bi-person-x text-muted"></i>
                                </div>
                                <div>
                                    <div>{{ emp.name }}</div>
                                    <small>未创建账号</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- 右侧：权限分配 -->
                <div class="col-lg-8 col-xl-9">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">
                            <i class="bi bi-person-gear me-2"></i>
                            当前设置权限：<span id="display_name" class="text-primary fw-bold">请从左侧选择员工</span>
                        </h5>
                        <div class="d-flex align-items-center gap-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="globalSelectAll"
                                    onclick="toggleAll(this)">
                                <label class="form-check-label fw-bold text-primary" for="globalSelectAll">全选 /
                                    反选</label>
                            </div>
                            
                        </div>
                    </div>

                    <form id="permissionForm" method="POST" action="{{ url_for('permission.permission_update') }}">
                        <input type="hidden" name="target_user_id" id="current_user_id">
                        <button type="submit" id="saveBtn" class="btn btn-success btn-lg shadow-sm" disabled>
                                <i class="bi bi-check-circle-fill me-2"></i>保存权限
                            </button>

                        <div class="accordion shadow-sm" id="permissionAccordion">
                            {% set colors = ['primary', 'success', 'info', 'warning', 'danger', 'dark'] %}
                            {% for module_name, perms in modules.items() %}
                            <div class="accordion-item border-0">
                                <h2 class="accordion-header">
                                    <button
                                        class="accordion-button collapsed fw-bold text-white bg-{{ colors[loop.index0 % colors|length] }}"
                                        type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapse_{{ loop.index }}">
                                        <i class="bi bi-folder2-open me-2"></i> {{ module_name.upper() }} 模块 ({{
                                        perms|length }}项)
                                    </button>
                                </h2>
                                <div id="collapse_{{ loop.index }}"
                                    class="accordion-collapse collapse {% if loop.first %}show{% endif %}">
                                    <div class="accordion-body bg-light">
                                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                                            {% for p in perms %}
                                            <div class="col">
                                                <div class="form-check form-switch form-switch-lg">
                                                    <input class="form-check-input perm-checkbox" type="checkbox"
                                                        name="selected_permissions" value="{{ p.id }}"
                                                        id="perm_{{ p.id }}">
                                                    <label class="form-check-label fw-medium" for="perm_{{ p.id }}">
                                                        {{ p.name }}
                                                        <small class="d-block text-muted">{{ p.description }}</small>
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const allUserPermissions = {{ user_perms | tojson }};

    function toggleAll(master) {
        const checkboxes = document.querySelectorAll('.perm-checkbox');
        checkboxes.forEach(cb => cb.checked = master.checked);
    }

    function selectUser(userId, userName, element) {
        // 高亮选中
        document.querySelectorAll('.employee-item').forEach(item => {
            item.classList.remove('active', 'bg-primary', 'text-white');
        });
        element.classList.add('active', 'bg-primary', 'text-white');

        // 更新标题和隐藏字段
        document.getElementById('current_user_id').value = userId;
        document.getElementById('display_name').innerHTML = `<strong>${userName}</strong> 的权限设置`;

        // 激活保存按钮
        document.getElementById('saveBtn').disabled = false;

        // 重置所有复选框
        document.querySelectorAll('.perm-checkbox').forEach(cb => cb.checked = false);

        // 勾选该用户已有权限
        const userPerms = allUserPermissions[userId] || [];
        userPerms.forEach(permId => {
            const cb = document.getElementById('perm_' + permId);
            if (cb) cb.checked = true;
        });

        // 展开第一个模块
        const firstCollapse = document.querySelector('.accordion-collapse');
        if (firstCollapse && !firstCollapse.classList.contains('show')) {
            new bootstrap.Collapse(firstCollapse).show();
        }
    }
</script>

<style>
    .employee-item.active {
        background: linear-gradient(90deg, #0d6efd, #0dcaf0) !important;
        color: white !important;
    }

    .employee-item:hover {
        background-color: #e7f3ff !important;
        transform: translateY(-1px);
        transition: all 0.2s;
    }

    .form-switch .form-check-input {
        width: 3em;
        height: 1.5em;
    }

    .accordion-button:not(.collapsed) {
        box-shadow: inset 0 -1px 0 rgba(0, 0, 0, .125);
    }
</style>
{% endblock %}

==================================================
FILE: .\templates\permission\operations.html
==================================================

{% extends "base.html" %}
{% block title %}操作日志{% endblock %}
{% block content %}
<div class="container mt-4">
    <!-- 1. 新增时间筛选表单 -->
    <form method="GET" class="mb-3 row g-3">
        <div class="col-md-4">
            <input type="date" name="start_date" class="form-control" placeholder="开始日期" value="{{ start_date or '' }}">
        </div>
        <div class="col-md-4">
            <input type="date" name="end_date" class="form-control" placeholder="结束日期" value="{{ end_date or '' }}">
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-outline-primary w-100">按日期筛选</button>
        </div>
    </form>
    <!-- 2. 操作日志表格 -->
    <div class="table-responsive rounded-3 shadow-sm border border-light-subtle" style="overflow: hidden;">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr style="transition: all 0.2s ease;">
                    <th style="width: 180px; padding: 0.8rem 1rem; font-weight: 600; color: #495057;">操作时间</th>

                    {% if current_user.role == 'admin' %}
                    <th style="width: 130px; padding: 0.8rem 1rem; font-weight: 600; color: #495057;">操作人</th>
                    {% endif %}

                    <th style="width: 140px; padding: 0.8rem 1rem; font-weight: 600; color: #495057;">动作类型</th>
                    <th style="padding: 0.8rem 1rem; font-weight: 600; color: #495057;">详细描述</th>
                </tr>
            </thead>

            <tbody>
                {% for log in logs %}
                <tr style="transition: all 0.2s ease; border-bottom: 1px solid #f8f9fa;">
                    <!-- 时间 -->
                    <td class="text-muted small text-nowrap font-monospace" style="padding: 0.8rem 1rem;">
                        {{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                    </td>

                    <!-- 操作人 -->
                    {% if current_user.role == 'admin' %}
                    <td style="padding: 0.8rem 1rem;">
                        {% if log.operator %}
                        <span class="badge rounded-pill px-3 py-1.5 shadow-sm" style="font-size: 0.85rem; transition: all 0.2s ease;">
                            {% if log.operator.role == 'admin' %}
                            <span class="badge rounded-pill px-3 py-1.5 shadow-sm bg-info text-white font-bold">
                                <i class="fas fa-user-shield me-1">
                                    </i>{{ log.operator.name }}
                            </span>
                            {% else %}
                            <span class="badge rounded-pill px-3 py-1.5 shadow-sm bg-primary text-white font-bold">
                                <i class="fas fa-user me-1">
                                    </i>{{ log.operator.name }}
                            </span>
                            {% endif %}
                        </span>
                        {% else %}
                        <span class="badge rounded-pill px-3 py-1.5 shadow-sm bg-gray-600 text-white font-bold" style="font-size: 0.85rem;">
                            <i class="fas fa-robot me-1">
                                </i>系统
                        </span>
                        {% endif %}
                    </td>
                    {% endif %}
                    
                    <!-- 动作类型 -->
                    <td style="padding: 0.8rem 1rem;">
                        {% if '入职' in log.action_type or '新增' in log.action_type %}
                        <span
                            class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3 py-1.5"
                            style="font-size: 0.85rem; transition: all 0.2s ease;">
                            <i class="fas fa-plus-circle me-1"></i>{{ log.action_type }}
                        </span>
                        {% elif '编辑' in log.action_type or '变更' in log.action_type %}
                        <span
                            class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill px-3 py-1.5"
                            style="font-size: 0.85rem; transition: all 0.2s ease;">
                            <i class="fas fa-pen me-1"></i>{{ log.action_type }}
                        </span>
                        {% elif '删除' in log.action_type or '移除' in log.action_type %}
                        <span
                            class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3 py-1.5"
                            style="font-size: 0.85rem; transition: all 0.2s ease;">
                            <i class="fas fa-trash-alt me-1"></i>{{ log.action_type }}
                        </span>
                        {% else %}
                        <span
                            class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill px-3 py-1.5"
                            style="font-size: 0.85rem; transition: all 0.2s ease;">
                            {{ log.action_type }}
                        </span>
                        {% endif %}
                    </td>

                    <!-- 描述 -->
                    <td class="ps-3 border-start" style="padding: 0.8rem 1rem; border-left-color: #e9ecef !important;">
                        <div class="text-dark small lh-base" style="line-height: 1.6; padding: 0.4rem 0;">
                            {{ log.description }}
                        </div>
                    </td>
                </tr>
                {% endfor %}

                {% if not logs %}
                <tr>
                    <td colspan="{% if current_user.role == 'admin' %}4{% else %}3{% endif %}"
                        class="text-center text-muted py-5" style="background-color: #fafbfc; font-size: 0.9rem;">
                        <i class="fas fa-file-alt me-2"></i>暂无操作记录
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- 3. 新增分页导航栏 -->
    {% if pagination.pages > 1 %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for('permission.permission_operations', page=pagination.prev_num, start_date=start_date, end_date=end_date) }}">上一页</a>
            </li>
            {% for page in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=3) %}
            {% if page %}
            <li class="page-item {% if page == pagination.page %}active{% endif %}">
                <a class="page-link"
                    href="{{ url_for('permission.permission_operations', page=page, start_date=start_date, end_date=end_date) }}">{{
                    page }}</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            {% endfor %}
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for('permission.permission_operations', page=pagination.next_num, start_date=start_date, end_date=end_date) }}">下一页</a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}

    <!-- 仅用于美化的样式，不影响原有逻辑 -->
    <style>
        /* 表格行hover效果优化 */
        .table-hover>tbody>tr:hover {
            background-color: #f8f9ff !important;
            transform: translateX(2px);
        }

        /* 徽章hover效果 */
        .badge {
            cursor: default;
        }

        .badge:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* 统一表格内边距和字体 */
        .table td,
        .table th {
            vertical-align: middle;
        }

        /* 优化空数据行样式 */
        .table tbody tr:last-child td {
            border-bottom: none;
        }
    </style>

==================================================
FILE: .\templates\scheduling\list.html
==================================================

{% extends "base.html" %}
{% block title %}考勤排班管理{% endblock %}

{% block head %}
<style>
    /* 侧边栏滚动 */
    .sticky-sidebar {
        position: sticky;
        top: 20px;
        height: calc(100vh - 120px);
        overflow-y: auto !important;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    /* 简洁标签页 */
    .hr-tabs { border-bottom: 2px solid #eee; margin-bottom: 20px; display: flex; gap: 30px; }
    .hr-tabs a { 
        text-decoration: none; color: #666; padding: 10px 5px; 
        font-weight: 500; position: relative;
    }
    .hr-tabs a.active { color: #007bff; }
    .hr-tabs a.active::after {
        content: ""; position: absolute; bottom: -2px; left: 0; 
        width: 100%; height: 2px; background: #007bff;
    }

    /* 极速模式样式 */
    .fast-mode-active .fc-daygrid-day:hover { background-color: #f0fff4 !important; cursor: pointer; }
    .copy-mode-active .fc-daygrid-day:hover { background-color: #fffaf0 !important; cursor: copy !important; }
    
    .mode-indicator {
        position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
        z-index: 2000; display: none; padding: 8px 25px;
        border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .emp-tag { padding: 8px; margin-bottom: 5px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: grab; transition: all 0.2s; }
    .emp-tag:hover { border-color: #007bff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    /* 适配双层表头导入后的日历显示 */
    .fc-event { border: none !important; padding: 2px 4px !important; font-size: 0.85em !important; }
    .shift-night { border-left: 3px solid #1a202c !important; } /* 夜班标记 */

    /* Initialize color boxes */
    .color-box {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        background-color: inherit;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.color-box').forEach(el => {
            el.style.backgroundColor = el.getAttribute('data-color');
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-2">
    <div class="hr-tabs">
        <a href="{{ url_for('scheduling.schedule_list', tab='calendar') }}" class="{% if active_tab == 'calendar' %}active{% endif %}">📅 排班视图</a>
        <a href="{{ url_for('scheduling.schedule_list', tab='posts') }}" class="{% if active_tab == 'posts' %}active{% endif %}">🛠️ 岗位设置</a>
    </div>

    {% if active_tab == 'calendar' %}
    <div id="modeIndicator" class="mode-indicator bg-warning text-dark fw-bold">
        <span id="modeText"></span>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
            <div class="form-check form-switch p-2 bg-light rounded border px-3">
                <input class="form-check-input" type="checkbox" id="fastModeToggle">
                <label class="form-check-label small fw-bold" for="fastModeToggle">🚀 极速盖章模式</label>
            </div>
            <span class="text-muted small d-none d-md-inline">提示：右键点击已有排班可“取样”，点击空白日期即“盖章”</span>
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm px-3 shadow-sm" onclick="document.getElementById('excelImportInput').click()">
                <i class="bi bi-file-earmark-excel"></i> 导入本月排班
            </button>
            <button class="btn btn-outline-danger" onclick="clearCurrentMonth()">
    <i class="bi bi-trash"></i> 清空本月排班
</button>
            <input type="file" id="excelImportInput" hidden onchange="importExcelSchedule(this)">

            <div class="btn-group shadow-sm">
                <a href="{{ url_for('scheduling.export_attendance', table_type='A') }}" class="btn btn-primary btn-sm px-3">导出 A表</a>
                <a href="{{ url_for('scheduling.export_attendance', table_type='B') }}" class="btn btn-success btn-sm px-3">导出 B表</a>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-2">
            <div class="sticky-sidebar">
                <div class="small text-muted mb-2 fw-bold">待排人员 (拖拽入日历)</div>
                <div id="external-events">
                    {% for emp in employees %}
                    <div class="emp-tag fc-event-draggable" data-user-id="{{ emp.id }}" data-user-name="{{ emp.name }}">
                        <strong>{{ emp.name }}</strong>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-10">
            <div id="calendar" class="shadow-sm border bg-white p-3"></div>
        </div>
    </div>

    {% else %}
    <div class="alert alert-info py-2 small">
        <i class="bi bi-info-circle"></i> 系统会自动根据 Excel 表头关键字（如“守台”、“夜班”、“图像”）匹配这里的岗位。
    </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0 fw-bold text-muted">岗位列表与配置</h6>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm px-3" onclick="document.getElementById('postImportInput').click()">
                <i class="bi bi-file-earmark-arrow-up"></i> 导入岗位设置
            </button>
            <a href="{{ url_for('scheduling.export_posts') }}" class="btn btn-outline-secondary btn-sm px-3">
                <i class="bi bi-file-earmark-arrow-down"></i> 导出岗位设置
            </a>
            <input type="file" id="postImportInput" hidden onchange="importPosts(this)">
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold border-0 pt-3">新增/修改岗位</div>
                <div class="card-body">
                    <form action="{{ url_for('scheduling.schedule_list') }}" method="POST">
                        <div class="mb-3">
                            <label class="small text-muted">岗位名称 (建议与Excel表头一致)</label>
                            <input type="text" name="name" class="form-control" required placeholder="如：守台-白班">
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="small text-muted">上班</label>
                                <input type="time" name="default_start" class="form-control" value="08:00" title="上班时间">
                            </div>
                            <div class="col">
                                <label class="small text-muted">下班</label>
                                <input type="time" name="default_end" class="form-control" value="20:00" title="下班时间">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="small text-muted">日历显示颜色</label>
                            <input type="color" name="color" class="form-control form-control-color w-100" value="#4299e1" title="选择岗位在日历中的显示颜色">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2">确认并保存</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr><th>颜色</th><th>岗位名称</th><th>标准工时</th><th class="text-end">操作</th></tr>
                    </thead>
                    <tbody>
                        {% for p in posts %}
                        <tr>
                            <td><div class="color-box" data-color="{{ p.color }}"></div></td>
                            <td class="fw-bold">{{ p.name }}</td>
                            <td class="text-muted">{{ p.default_start }} - {{ p.default_end }}</td>
                            <td class="text-end"><a href="{{ url_for('scheduling.post_delete', id=p.id) }}" class="btn btn-link btn-sm text-danger" onclick="return confirm('确定删除该岗位吗？')">删除</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="shiftModal">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body p-4">
                <h6 class="fw-bold mb-3 text-center" id="display_info"></h6>
                <form id="shiftForm">
                    <input type="hidden" id="post_user_id"><input type="hidden" id="post_date">
                    <div class="mb-3">
                        <label class="small text-muted">选择岗位</label>
                        <select id="post_id" class="form-select" title="选择岗位">
                            {% for p in posts %}<option value="{{p.id}}">{{p.name}}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="d-flex justify-content-center gap-4 mb-4">
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="is_night_toggle" title="标记为夜班"><label class="form-check-label" for="is_night_toggle">夜班</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="is_overtime_toggle" title="标记为加班"><label class="form-check-label" for="is_overtime_toggle">加班</label></div>
                    </div>
                    <button type="button" class="btn btn-primary w-100 py-2" onclick="submitShift()">确认排班</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/fullcalendar.global.min.js') }}"></script>
<script>
let calendar;
let copyData = null; 
let isFastMode = false;

function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    // 初始化左侧拖拽
    new FullCalendar.Draggable(document.getElementById('external-events'), {
        itemSelector: '.fc-event-draggable',
        eventData: function(eventEl) {
            return { 
                title: eventEl.getAttribute('data-user-name'), 
                extendedProps: { empId: eventEl.getAttribute('data-user-id') } 
            };
        }
    });

    calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'zh-cn',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
        initialView: 'dayGridMonth',
        editable: true,
        droppable: true,
        dayMaxEvents: 6, 
        // 拖拽释放
        drop: function(info) {
            handleDrop(info.draggedEl.getAttribute('data-user-id'), info.draggedEl.getAttribute('data-user-name'), info.dateStr);
        },
        // 点击排班：极速模式下左键点击删除
        eventClick: function(info) {
            if (isFastMode) {
                 {deleteShiftDirectly(info.event.extendedProps.shiftId);
                }
            }
        },
        // 核心：右键取样功能
        eventDidMount: function(info) {
            info.el.addEventListener('contextmenu', function(e) {
                if (!isFastMode) return;
                e.preventDefault();
                const props = info.event.extendedProps;
                copyData = {
                    user_id: props.empId,
                    user_name: info.event.title.split('-')[0],
                    post_id: props.postId,
                    shift_type: info.event.title.includes('夜') ? '夜' : '白'
                };
                enterCopyMode();
            });
        },
        // 极速盖章：在空白日期点击即排入已取样的班次
        dateClick: function(info) {
            if (isFastMode && copyData) {
                quickSave(copyData.user_id, info.dateStr, copyData.post_id, copyData.shift_type);
            }
        },
        events: "{{ url_for('scheduling.get_shifts') }}"
    });
    calendar.render();

    // 绑定极速模式开关
    const toggle = document.getElementById('fastModeToggle');
    if(toggle){
        toggle.addEventListener('change', function(e) {
            isFastMode = e.target.checked;
            const indicator = document.getElementById('modeIndicator');
            if (isFastMode) {
                document.getElementById('calendar').classList.add('fast-mode-active');
                indicator.style.display = 'block';
                document.getElementById('modeText').innerText = "🚀 极速盖章中：左键删 / 右键取样 / 点击空白日期盖章";
            } else {
                document.getElementById('calendar').classList.remove('fast-mode-active');
                indicator.style.display = 'none';
                exitCopyMode();
            }
        });
    }
}

// 盖章模式逻辑
function enterCopyMode() {
    document.getElementById('calendar').classList.add('copy-mode-active');
    document.getElementById('modeText').innerText = `盖章模式：正在为 [${copyData.user_name}] 连续排班... (点哪排哪)`;
}

function exitCopyMode() {
    copyData = null;
    document.getElementById('calendar').classList.remove('copy-mode-active');
    if (isFastMode) document.getElementById('modeText').innerText = "🚀 极速编辑模式中...";
}
function importPosts(input) {  // 岗位导入
    const formData = new FormData();
    formData.append('file', input.files[0]);
    fetch("{{ url_for('scheduling.import_post_configs') }}", { method: 'POST', body: formData })
    .then(res => res.json()).then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    });
}
// 导入 Excel 排班表 (正则解析版)
function importExcelSchedule(input) {
    if (!input.files[0]) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);
    
    const btn = event.target;
    indicatorShow("正在正则解析 Excel 并匹配岗位...");

    fetch("{{ url_for('scheduling.import_schedule_data') }}", { 
        method: 'POST', 
        body: formData 
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        location.reload();
    })
    .catch(err => alert("导入失败，请检查文件格式"));
}
// 清空本月排班数据
function clearCurrentMonth() {
    // 增加一次确认，防止误点
    if (!confirm("确定要清空 2026年1月 的所有排班数据吗？此操作不可恢复！")) {
        return;
    }

    fetch('/scheduling/clear_month', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ month: '2026-01' }) // 你可以根据当前日历显示的月份动态获取
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // 刷新日历
            if (typeof calendar !== 'undefined') {
                calendar.refetchEvents();
            } else {
                location.reload();
            }
        } else {
            alert("错误: " + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("请求失败，请检查网络或后端日志");
    });
}

function indicatorShow(text) {
    const indicator = document.getElementById('modeIndicator');
    indicator.style.display = 'block';
    document.getElementById('modeText').innerText = text;
}

// 基础 API 调用
function deleteShiftDirectly(id) {
    fetch(`/scheduling/api/delete_shift/${id}`, { method: 'POST' })
    .then(res => res.json()).then(data => { if(data.success) calendar.refetchEvents(); });
}

function handleDrop(id, name, date) {
    document.getElementById('display_info').innerText = `${name} @ ${date}`;
    document.getElementById('post_user_id').value = id;
    document.getElementById('post_date').value = date;
    new bootstrap.Modal(document.getElementById('shiftModal')).show();
}

function quickSave(userId, date, postId, type) {
    fetch("{{ url_for('scheduling.save_shift') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, date: date, post_id: postId, shift_type: type })
    }).then(res => res.json()).then(data => { if (data.success) calendar.refetchEvents(); });
}

function submitShift() {
    const payload = {
        user_id: document.getElementById('post_user_id').value,
        date: document.getElementById('post_date').value,
        post_id: document.getElementById('post_id').value,
        shift_type: document.getElementById('is_night_toggle').checked ? '夜' : '白',
        is_overtime: document.getElementById('is_overtime_toggle').checked
    };
    fetch("{{ url_for('scheduling.save_shift') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then(res => res.json()).then(data => { if (data.success) location.reload(); });
}

document.addEventListener('DOMContentLoaded', initCalendar);
</script>
{% endblock %}

==================================================
FILE: .\templates\scheduling\posts.html
==================================================

{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">新增岗位</div>
                <div class="card-body">
                    <form method="POST">
                        <div class="mb-3">
                            <label class="form-label">岗位名称</label>
                            <input type="text" name="name" class="form-control" placeholder="如：白班" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">显示颜色</label>
                            <input type="color" name="color" class="form-control form-control-color" value="#007bff">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">保存岗位</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">现有岗位列表</div>
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>颜色预览</th>
                            <th>岗位名称</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for post in posts %}
                        <tr>
                            <td><span class="badge" style="background-color: {{ post.color }};">&nbsp;&nbsp;&nbsp;</span></td>
                            <td>{{ post.name }}</td>
                            <td>
                                <a href="{{ url_for('scheduling.post_delete', id=post.id) }}" 
                                   class="btn btn-sm btn-outline-danger" 
                                   onclick="return confirm('确定删除吗？')">删除</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
