{% extends "base.html" %}
{% block title %}å‡ºå·®ç®¡ç†{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="hr-tabs">
        <a href="{{ url_for('scheduling.schedule_list') }}" class="{% if active_tab == 'calendar' %}active{% endif %}">ğŸ“… æ’ç­è§†å›¾</a>
        <a href="{{ url_for('scheduling.post_list') }}" class="{% if active_tab == 'posts' %}active{% endif %}">ğŸ› ï¸ å²—ä½è®¾ç½®</a>
        <a href="{{ url_for('trip.trip_list') }}" class="active">ğŸ’¼ å‡ºå·®è®¾ç½®</a>
        <a href="{{ url_for('leave.leave_list') }}" class="{% if active_tab == 'leave' %}active{% endif %}">ğŸ“ è¯·å‡ç®¡ç†</a>
    </div>

    <div class="card shadow">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-middle">
    <h5 class="mb-0">ğŸ’¼ {{ selected_year }}å¹´åº¦ å‡ºå·®ç®¡ç†</h5>
    <div class="d-flex gap-2 align-items-center">
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                ğŸ“… åˆ‡æ¢å¹´ä»½
            </button>
            <ul class="dropdown-menu">
                {% for y in years %}
                <li><a class="dropdown-item {% if y == selected_year %}active{% endif %}" 
                       href="{{ url_for('trip.trip_list', year=y) }}">{{ y }}å¹´</a></li>
                {% endfor %}
            </ul>
        </div>
        <a href="{{ url_for('trip.export_trip_report', year=current_year) }}" class="btn btn-sm btn-outline-success">
    <i class="bi bi-download"></i> å¯¼å‡ºæŠ¥è¡¨
</a>
        <a href="{{ url_for('trip.trip_add') }}" class="btn btn-sm btn-light">ç™»è®°å‡ºå‘</a>
    </div>
</div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>å‡ºå·®æ¬¡æ•°</th>
                            <th>å‡ºå·®äººå‘˜</th>
                            <th>ç›®çš„åœ°</th>
                            <th>æ—¥æœŸèŒƒå›´ (å¼€å§‹ - å½’é˜Ÿ)</th>
                            <th>æ—¶é•¿</th>
                            <th>çŠ¶æ€</th>
                            <th width="150">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trip in trips %}
                        <tr>
                            <td>ç¬¬{{ trips|length - loop.index0 }}æ¬¡</td>
                            
                            <td>
                                {% for p in trip.participants %}
                                    <span class="badge border text-dark bg-light">{{ p.name }}</span>
                                {% else %}
                                    <span class="text-muted">æœªæŒ‡å®š</span>
                                {% endfor %}
                            </td>

                            <td>{{ trip.destination }}</td>

                            <td>
                                <span class="text-primary fw-bold">{{ trip.start_date }}</span>
                                <i class="bi bi-arrow-right mx-1 text-muted"></i>
                                {% if trip.end_date %}
                                    {{ trip.end_date }}
                                {% else %}
                                    <span class="text-danger small">ï¼ˆå½’é˜Ÿå¾…å®šï¼‰</span>
                                {% endif %}
                            </td>

                            <td>
                                {% if trip.total_days %}
                                    <span class="badge bg-info text-dark">{{ trip.total_days }} å¤©</span>
                                {% else %}
                                    <span class="text-muted italic">--</span>
                                {% endif %}
                            </td>

                            <td>
                                {% if trip.status == 'å‡ºå·®ä¸­' %}
                                    <span class="badge rounded-pill bg-warning text-dark border border-warning">
                                        <span class="spinner-grow spinner-grow-sm text-danger" role="status"></span> æ‰§è¡Œä¸­
                                    </span>
                                {% else %}
                                    <span class="badge rounded-pill bg-light text-secondary border">å·²å½’é˜Ÿ</span>
                                {% endif %}
                            </td>

                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('trip.trip_edit', id=trip.id) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                       {% if not trip.end_date %}è¡¥å…¨{% else %}ç¼–è¾‘{% endif %}
                                    </a>
                                    {% if not trip.end_date %}
            <button type="button" class="btn btn-sm btn-outline-info" 
                    onclick="copyTripStart('{{ trip.reason }}', '{{ trip.participants|map(attribute='name')|join('ã€') }}', '{{ trip.destination }}', '{{ trip.start_date.strftime('%mæœˆ%då·') }}')">
                ğŸ“‹ å¤åˆ¶å‡ºå‘
            </button>
        {% else %}
            <button type="button" class="btn btn-sm btn-outline-success" 
                    onclick="copyTripEnd('{{ trip.reason }}', '{{ trip.participants|map(attribute='name')|join('ã€') }}')">
                ğŸ“‹ å¤åˆ¶å½’é˜Ÿ
            </button>
        {% endif %}
                                    {% if current_user.username == 'admin' %}
                                    <a href="{{ url_for('trip.trip_delete', id=trip.id) }}" 
                                       class="btn btn-sm btn-outline-danger" 
                                       onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æœ€æ–°çš„è®°å½•å—ï¼Ÿ')">åˆ é™¤</a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">æš‚æ— å‡ºå·®è®°å½•</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * æ ¸å¿ƒå¤åˆ¶å‡½æ•°
 * å¢åŠ äº†ä¼ ç»Ÿ execCommand å…¼å®¹ï¼Œé˜²æ­¢åœ¨é HTTPS ç¯å¢ƒä¸‹ navigator.clipboard å¤±æ•ˆ
 */
function copyToClipboard(text) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            alert("âœ… æŠ¥å¤‡å†…å®¹å·²å¤åˆ¶ï¼");
        }).catch(() => {
            fallbackCopy(text);
        });
    } else {
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    try {
        document.execCommand('copy');
        alert("âœ… æŠ¥å¤‡å†…å®¹å·²å¤åˆ¶ï¼");
    } catch (err) {
        alert("æ— æ³•è‡ªåŠ¨å¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡å­—å¤åˆ¶ã€‚");
    }
    document.body.removeChild(textArea);
}

// å‡ºå‘æ¨¡æ¿ï¼šè”¡è·¯æ´¾å‡ºæ‰€é©»ç‚¹ + äº‹ç”± (æ¢è¡Œ) å‡ºå·®äººå‘˜ + ç›®çš„åœ° + å½’é˜Ÿä¸è¯¦ + å‡ºå‘æ—¶é—´
function copyTripStart(reason, names, dest, startDate) {
    const baseTitle = "è”¡è·¯æ´¾å‡ºæ‰€é©»ç‚¹é…åˆæ°‘è­¦å‡ºå·®";
    const text = `${baseTitle}${reason}\nå‡ºå·®äººå‘˜ï¼š${names}\nç›®çš„åœ°: ${dest}\nå½’é˜Ÿæ—¶é—´ï¼šä¸è¯¦\nå‡ºå‘æ—¶é—´: ${startDate}`;
    copyToClipboard(text);
}

// å½’é˜Ÿæ¨¡æ¿ï¼šè”¡è·¯æ´¾å‡ºæ‰€é©»ç‚¹ + äº‹ç”±ï¼Œå§“åï¼Œå‡ºå·®ç»“æŸï¼Œå·²å½’é˜Ÿã€‚
function copyTripEnd(reason, names) {
    const baseTitle = "è”¡è·¯æ´¾å‡ºæ‰€é©»ç‚¹é…åˆæ°‘è­¦å‡ºå·®";
    const text = `${baseTitle}${reason}ï¼Œ${names}ï¼Œå‡ºå·®ç»“æŸï¼Œå·²å½’é˜Ÿã€‚`;
    copyToClipboard(text);
}
</script>
<style>
/* å¢åŠ ä¸€ä¸ªç®€å•çš„é—ªçƒæ•ˆæœï¼Œæé†’æœ‰æ­£åœ¨å‡ºå·®çš„äººå‘˜ */
.spinner-grow-sm {
    width: 0.6rem;
    height: 0.6rem;
    vertical-align: middle;
}
</style>
{% endblock %}