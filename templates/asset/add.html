<!-- templates/asset/add.html -->
{% extends "base.html" %}
{% block title %}新增资产{% endblock %}

{% block content %}
<style>
    /* 全局样式统一 */
    :root {
        --primary-color: #0d6efd;
        --success-color: #198754;
        --danger-color: #dc3545;
        --light-color: #f8f9fa;
        --border-radius: 8px;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }
    
    /* 卡片样式 */
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow: hidden;
        max-width: 900px;
        margin: 0 auto;
    }
    
    .card-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #0a58ca 100%) !important;
        padding: 1rem 1.5rem;
        border-bottom: none;
    }
    
    .card-body {
        padding: 2rem;
    }
    
    /* 表单标题样式 */
    h5.mb-3 {
        font-weight: 600;
        color: var(--primary-color);
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(13, 110, 253, 0.1);
        margin-bottom: 1.5rem !important;
        display: flex;
        align-items: center;
    }
    
    h5.mb-3 i {
        margin-right: 0.5rem;
    }
    
    /* 财务联动区域 */
    .card.bg-light {
        border-radius: var(--border-radius);
        background-color: rgba(248, 249, 250, 0.8) !important;
        border: 1px solid rgba(25, 135, 84, 0.2) !important;
        margin: 2rem 0;
        transition: all 0.3s ease;
    }
    
    .form-check-input {
        cursor: pointer;
        transform: scale(1.2);
    }
    
    .form-check-label {
        cursor: pointer;
        font-weight: 500;
        color: var(--success-color);
        margin-left: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .form-check-label:hover {
        color: #157347;
    }
    
    /* 财务表单容器 */
    #finance_container {
        border-radius: var(--border-radius);
        background-color: white;
        border: 1px solid rgba(25, 135, 84, 0.2);
        padding: 1.5rem;
        margin-top: 1rem;
        box-shadow: var(--shadow-sm);
        display: none;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* 按钮样式 */
    .btn-primary {
        border-radius: var(--border-radius);
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px rgba(13, 110, 253, 0.15);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(13, 110, 253, 0.2);
    }
    
    .btn-link {
        color: #6c757d;
        transition: all 0.2s ease;
        border-radius: var(--border-radius);
        padding: 0.75rem 1.5rem;
    }
    
    .btn-link:hover {
        color: #212529;
        background-color: var(--light-color);
        text-decoration: none;
    }
    
    /* 响应式优化 */
    @media (max-width: 768px) {
        .card-body {
            padding: 1rem;
        }
        
        #finance_container {
            padding: 1rem;
        }
        
        h5.mb-3 {
            font-size: 1.1rem;
        }
    }
    
    /* 加载状态 */
    .loading-state {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        color: #6c757d;
    }
    
    .loading-state .spinner-border {
        margin-right: 0.5rem;
    }
</style>

<div class="container mt-4 mb-5">
    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white py-3">
            <h4 class="mb-0"><i class="bi bi-box-seam"></i> 新增资产</h4>
        </div>
        <div class="card-body p-4">
            <form action="{{ url_for('asset.asset_add') }}" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                <div class="mb-4">
                    <h5 class="mb-3 text-primary border-bottom pb-2">
                        <i class="bi bi-info-circle"></i> 资产基本信息
                    </h5>
                    {% include 'asset/_partial_asset_form.html' %}
                </div>

                <div class="card bg-light border-success my-4">
                    <div class="card-body">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="sync_fund" id="sync_fund_switch" style="cursor: pointer; transform: scale(1.2);">
                            <label class="form-check-label fw-bold text-success ms-2" for="sync_fund_switch" style="cursor: pointer;">
                                这是采购入库？(同时登记资金支出记录)
                            </label>
                        </div>
                        
                        <div id="finance_container" class="mt-3 shadow-sm p-4 bg-white rounded border border-success-subtle" style="display:none;">
                            <div class="loading-state">
                                <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                                <span class="ms-2">正在加载财务表单...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg shadow">
                        <i class="bi bi-check-circle"></i> 确认新增资产
                    </button>
                    <a href="{{ url_for('asset.asset_list') }}" class="btn btn-link text-muted">取消返回</a>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
$(document).ready(function() {
    // 初始化工具提示
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    
    // 财务表单联动
    $('#sync_fund_switch').on('change', function() {
        if(this.checked) {
            // 显示加载状态
            $('#finance_container').html(`
                <div class="loading-state">
                    <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                    <span class="ms-2">正在加载财务表单...</span>
                </div>
            `).hide().load("{{ url_for('fund.get_fund_form_snippet') }}", function(response, status, xhr) {
                if (status == "error") {
                    $(this).html(`
                        <div class="alert alert-danger py-2">
                            <i class="bi bi-exclamation-circle me-1"></i>
                            财务组件加载失败: ${xhr.status} ${xhr.statusText}
                        </div>
                    `);
                }
                $(this).slideDown(300);
                
                // 重新初始化财务表单的验证和样式
                initFinanceFormValidation();
            });
        } else {
            $('#finance_container').slideUp(300, function() {
                $(this).html(`
                    <div class="loading-state">
                        <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                        <span class="ms-2">正在加载财务表单...</span>
                    </div>
                `);
            });
        }
    });
    
    // 表单提交总验证
    $('form').on('submit', function(e) {
        let isValid = true;
        
        // 1. 验证资产表单（固定资产编号、照片、数量等）
        // 这部分验证逻辑已在 partial_asset_form.html 中实现
        
        // 2. 验证财务表单（如果启用）
        if ($('#sync_fund_switch').is(':checked') && $('#finance_amount').length) {
            const amountValid = validateAmountInput($('#finance_amount')[0]);
            if (!amountValid) {
                isValid = false;
                $('#finance_amount').focus();
            }
            
            // 验证财务必填项
            $('#finance_container [required]').each(function() {
                if (!this.value.trim()) {
                    isValid = false;
                    $(this).addClass('is-invalid');
                }
            });
        }
        
        // 3. 最终确认
        if (isValid) {
            if (!confirm('确认提交新增资产信息？此操作将创建新的资产记录，财务信息也会同步保存。')) {
                e.preventDefault();
                return false;
            }
            
            // 禁用提交按钮防止重复提交
            $(this).find('button[type="submit"]').prop('disabled', true).html(
                '<i class="bi bi-hourglass-split me-2"></i> 提交中...'
            );
        } else {
            e.preventDefault();
            alert('表单填写不完整或有误，请检查！');
            // 滚动到第一个错误字段
            $(this).find('.is-invalid:first')[0]?.scrollIntoView({ behavior: 'smooth' });
        }
    });
    
    // 财务金额验证函数（与partial_fund_form.html保持一致）
    function validateAmountInput(input) {
        const value = parseFloat(input.value);
        
        if (!input.value || isNaN(value)) {
            $(input).addClass('is-invalid');
            $(input).closest('.col-md-6').find('.amount-invalid').text('请输入有效的金额数字');
            return false;
        }
        
        if (value >= 0) {
            $(input).addClass('is-invalid');
            $(input).closest('.col-md-6').find('.amount-invalid').text('采购资产属于支出，金额必须为负值！');
            return false;
        }
        
        if (Math.abs(value) < 0.01) {
            $(input).addClass('is-invalid');
            $(input).closest('.col-md-6').find('.amount-invalid').text('金额不能小于0.01元');
            return false;
        }
        
        $(input).removeClass('is-invalid').addClass('is-valid');
        return true;
    }
    
    // 初始化财务表单验证（动态加载后）
    function initFinanceFormValidation() {
        // 金额输入验证
        $('#finance_amount').on('input', function() {
            validateAmountInput(this);
            
            if (this.value && !isNaN(this.value)) {
                const value = parseFloat(this.value);
                if (!isNaN(value)) {
                    const cursorPos = this.selectionStart;
                    this.value = value.toFixed(2);
                    this.setSelectionRange(cursorPos, cursorPos);
                }
            }
        }).on('blur', function() {
            validateAmountInput(this);
            
            if (this.value && parseFloat(this.value) > 0) {
                if (confirm('检测到金额为正数，采购资产应为支出（负数），是否自动转换为负数？')) {
                    this.value = '-' + Math.abs(parseFloat(this.value)).toFixed(2);
                    validateAmountInput(this);
                }
            }
        });
        
        // 文件上传验证
        $('#finance_attachment').on('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                
                if (fileSize > 10) {
                    alert(`文件大小(${fileSize}MB)超过限制(10MB)，请选择更小的文件`);
                    this.value = '';
                    $(this).addClass('is-invalid');
                    return;
                }
                
                const fileName = file.name.toLowerCase();
                const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.pdf', '.zip', '.rar', '.doc', '.docx', '.xls', '.xlsx'];
                const fileExt = fileName.slice(fileName.lastIndexOf('.'));
                
                if (!allowedExtensions.includes(fileExt)) {
                    alert(`不支持的文件格式(${fileExt})，请上传：JPG、PNG、PDF、ZIP、RAR、Word、Excel格式文件`);
                    this.value = '';
                    $(this).addClass('is-invalid');
                    return;
                }
                
                $(this).removeClass('is-invalid').addClass('is-valid');
                alert(`文件已选择：${file.name}\n大小：${fileSize}MB`);
            }
        });
        
        // 重新初始化工具提示
        const newTooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const newTooltipList = [...newTooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        
        // 统一财务表单样式
        $('.finance-form-control').addClass('rounded-3').css({
            'padding': '0.75rem 1rem',
            'border': '1px solid #ced4da',
            'transition': 'all 0.2s ease',
            'font-size': '0.95rem'
        });
    }
    
    // Bootstrap表单验证初始化
    (() => {
        'use strict'
        const forms = document.querySelectorAll('.needs-validation')
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })();
});
</script>
{% endblock %}
{% endblock %}