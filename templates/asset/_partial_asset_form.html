<!-- templates/asset/_partial_asset_form.html -->
<div class="row g-3">
    <!-- 资产类型 -->
    <div class="col-md-4">
        <label for="asset_type_select" class="form-label fw-bold">
            资产类型 
            <span class="text-danger">*</span>
        </label>
        <select name="type" id="asset_type_select" class="form-select asset-form-control" required>
            <option value="装备">装备</option>
            <option value="服饰">服饰</option>
            <option value="固定资产">固定资产</option>
            <option value="工具">工具</option>
            <option value="消耗品">消耗品</option>
        </select>
        <div class="invalid-feedback">
            请选择资产类型
        </div>
    </div>

    <!-- 资产名称 -->
    <div class="col-md-4">
        <label class="form-label fw-bold">
            资产名称 
            <span class="text-danger">*</span>
        </label>
        <input type="text" name="name" class="form-control asset-form-control" placeholder="如：电动自行车" required>
        <div class="invalid-feedback">
            请输入资产名称
        </div>
    </div>

    <!-- 编号前缀 -->
    <div class="col-md-4">
        <label class="form-label fw-bold">
            编号前缀
            <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" data-bs-title="用于生成固定资产的唯一编号，如: SN-2026-"></i>
        </label>
        <input type="text" name="number" id="asset_prefix" class="form-control asset-form-control" placeholder="如: SN-2026-">
        <div class="form-text">
            固定资产将自动生成：前缀 + 序号（001, 002...）
        </div>
    </div>

    <!-- 入库数量 -->
    <div class="col-md-4">
        <label class="form-label fw-bold">
            入库数量 
            <span class="text-danger">*</span>
        </label>
        <input type="number" name="quantity" id="asset_qty" class="form-control asset-form-control" value="1" min="1" placeholder="请输入数量" required>
        <div class="invalid-feedback">
            请输入有效的数量（至少1）
        </div>
    </div>

    <!-- 资产归属 -->
    <div class="col-md-4">
        <label for="asset_ownership_select" class="form-label fw-bold">
            资产归属
        </label>
        <select name="ownership" id="asset_ownership_select" class="form-select asset-form-control">
            <option value="特保队">特保队</option>
            <option value="公司">公司</option>
            <option value="个人">个人</option>
            <option value="派出所">派出所</option>
        </select>
    </div>

    <!-- 存放位置 -->
    <div class="col-md-4">
        <label class="form-label fw-bold">
            存放位置
            <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" data-bs-title="精确的存放位置，便于资产管理"></i>
        </label>
        <input type="text" name="location" class="form-control asset-form-control" placeholder="如：一号仓库/二楼办公室">
        <div class="form-text">
            建议填写精确位置，方便资产查找
        </div>
    </div>

    <!-- 购置/入库日期 -->
    <div class="col-md-6">
        <label for="asset_purchase_date" class="form-label fw-bold">
            购置/入库日期
        </label>
        <input type="date" name="purchase_date" id="asset_purchase_date" class="form-control asset-form-control" value="{{ default_date }}" title="购置或入库日期">
    </div>

    <!-- 床位容量 -->
    <div class="col-md-6">
        <label class="form-label fw-bold">
            床位容量
            <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" data-bs-title="仅针对床位类资产填写"></i>
        </label>
        <select name="bed_capacity" class="form-select asset-form-control" title="床位容量">
            <option value="0">非床位类资产</option>
            <option value="1">单人床 (1坑位)</option>
            <option value="2">双层床 (2坑位)</option>
        </select>
        <div class="form-text">
            仅床位类资产需要选择此项
        </div>
    </div>

    <!-- 资产照片 -->
    <div class="col-md-12">
        <label class="form-label fw-bold">
            资产照片
            <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" data-bs-title="建议上传清晰的资产照片，便于识别"></i>
        </label>
        <input type="file" name="photo" id="asset_photo" class="form-control asset-form-control" accept="image/*" title="资产照片">
        <div class="form-text">
            支持JPG、PNG格式，建议大小不超过5MB
        </div>
    </div>

    <!-- 自定义编号区域 -->
    <div id="custom_sn_section" class="mb-4 p-4 border rounded-3 bg-white shadow-sm d-none animate__animated">
        <label class="form-label fw-bold text-primary d-flex align-items-center">
            <i class="bi bi-tags me-2"></i> 定义个体编号
            <span class="ms-2 badge bg-primary rounded-pill" id="sn_count_badge">0</span>
        </label>
        <div id="sn_container" class="row g-3 mt-2"></div>
        <div class="form-text mt-2 text-muted">
            <i class="bi bi-lightbulb me-1"></i> 可修改后缀编号，保持唯一性
        </div>
    </div>
</div>

<script>
// 样式和功能初始化
$(document).ready(function() {
    // 统一表单控件样式
    $('.asset-form-control').addClass('rounded-3').css({
        'padding': '0.75rem 1rem',
        'border': '1px solid #ced4da',
        'transition': 'all 0.2s ease'
    });
    
    // 添加表单控件焦点效果
    $('.asset-form-control').on('focus', function() {
        $(this).css({
            'border-color': '#0d6efd',
            'box-shadow': '0 0 0 4px rgba(13, 110, 253, 0.1)',
            'outline': 'none'
        });
    }).on('blur', function() {
        $(this).css({
            'border-color': '#ced4da',
            'box-shadow': 'none'
        });
    });
    
    // 定义生成子资产列表的函数
    function updateSNInputs() {
        const assetType = $('#asset_type_select').val();
        const qty = parseInt($('#asset_qty').val()) || 0;
        const prefix = $('#asset_prefix').val() || '';
        const $snSection = $('#custom_sn_section');
        const $snContainer = $('#sn_container');
        const $snCountBadge = $('#sn_count_badge');

        // 验证数量有效性
        if (qty < 1) {
            $('#asset_qty').addClass('is-invalid');
            $snSection.addClass('d-none');
            $snContainer.empty();
            $snCountBadge.text('0');
            return;
        } else {
            $('#asset_qty').removeClass('is-invalid');
        }

        // 处理固定资产编号生成
        if (assetType === '固定资产' && qty > 0) {
            // 更新数量徽章
            $snCountBadge.text(qty);
            
            // 显示并添加动画效果
            $snSection.removeClass('d-none').addClass('animate__fadeIn');
            
            // 清空容器
            $snContainer.empty();
            
            // 生成编号输入框
            for (let i = 1; i <= qty; i++) {
                const suffix = String(i).padStart(3, '0');
                const snInputHtml = `
                    <div class="col-md-3 mb-2">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light rounded-start-2" style="border-right: none;">${prefix}</span>
                            <input type="text" name="instance_numbers[]" 
                                   class="form-control sn-input rounded-end-2" 
                                   value="${suffix}" 
                                   required
                                   data-index="${i}"
                                   placeholder="001, 002...">
                            <div class="invalid-feedback">
                                请输入有效的编号后缀
                            </div>
                        </div>
                    </div>
                `;
                $snContainer.append(snInputHtml);
            }
            
            // 为编号输入框添加验证
            $('.sn-input').on('input', function() {
                // 移除非数字字符
                this.value = this.value.replace(/[^0-9]/g, '');
                // 补零到3位
                if (this.value.length > 0) {
                    this.value = String(this.value).padStart(3, '0');
                }
                
                // 验证唯一性
                validateSNUniqueness();
            }).on('blur', function() {
                // 失去焦点时补零
                if (this.value.length > 0) {
                    this.value = String(this.value).padStart(3, '0');
                }
            });
            
        } else {
            // 隐藏固定资产编号区域
            $snSection.addClass('d-none').removeClass('animate__fadeIn');
            $snContainer.empty();
            $snCountBadge.text('0');
        }
    }
    
    // 验证编号唯一性
    function validateSNUniqueness() {
        const values = [];
        let hasDuplicate = false;
        
        $('.sn-input').each(function() {
            const val = $(this).val().trim();
            if (val) {
                if (values.includes(val)) {
                    hasDuplicate = true;
                    $(this).addClass('is-invalid');
                } else {
                    values.push(val);
                    $(this).removeClass('is-invalid');
                }
            }
        });
        
        return !hasDuplicate;
    }

    // --- 事件绑定 ---

    // 1. 监听资产表单的变化（类型、数量、前缀）
    $(document).on('change input', '#asset_type_select, #asset_qty, #asset_prefix', function() {
        // 添加防抖处理，避免频繁触发
        clearTimeout(window.snUpdateTimeout);
        window.snUpdateTimeout = setTimeout(function() {
            updateSNInputs();
        }, 300);
    });

    // 2. 页面加载完成后立即运行一次
    updateSNInputs();

    // 3. 照片上传验证
    $('#asset_photo').on('change', function() {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            
            // 检查文件大小（限制5MB）
            if (fileSize > 5) {
                alert(`图片大小(${fileSize}MB)超过限制(5MB)，请选择更小的图片`);
                this.value = '';
                $(this).addClass('is-invalid');
                return;
            }
            
            // 检查文件格式
            const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert('请选择有效的图片文件（JPG、PNG、GIF格式）');
                this.value = '';
                $(this).addClass('is-invalid');
                return;
            }
            
            $(this).removeClass('is-invalid').addClass('is-valid');
        }
    });

    // 4. 固定资产编号验证（表单提交时）
    $(document).on('submit', 'form', function(e) {
        // 验证固定资产编号唯一性
        if ($('#asset_type_select').val() === '固定资产' && !validateSNUniqueness()) {
            e.preventDefault();
            alert('发现重复的资产编号，请修改后重新提交！');
            $('#custom_sn_section').addClass('border-danger');
            // 滚动到编号区域
            $('#custom_sn_section')[0].scrollIntoView({ behavior: 'smooth' });
            return false;
        }
        
        // 验证照片格式（如果有上传）
        const photoInput = $('#asset_photo')[0];
        if (photoInput.files && photoInput.files[0]) {
            const file = photoInput.files[0];
            const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                e.preventDefault();
                alert('请上传有效的图片文件（JPG、PNG、GIF格式）');
                photoInput.classList.add('is-invalid');
                return false;
            }
        }
        
        // 验证数量
        if (parseInt($('#asset_qty').val()) < 1) {
            e.preventDefault();
            alert('入库数量必须大于0！');
            $('#asset_qty').addClass('is-invalid').focus();
            return false;
        }
    });
});

// 添加动画和自定义样式
$('head').append(`
    <style>
        .animate__animated {
            animation-duration: 0.3s;
            animation-fill-mode: both;
        }
        .animate__fadeIn {
            animation-name: fadeIn;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sn-input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1);
            outline: none;
        }
        .input-group-text {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
        }
        #custom_sn_section {
            border-color: #e9ecef;
            transition: all 0.3s ease;
        }
        #custom_sn_section.border-danger {
            border-color: #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.05);
        }
        /* 验证状态样式增强 */
        .form-control.is-valid {
            border-color: #198754;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        .form-control.is-invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
    </style>
`);
</script>