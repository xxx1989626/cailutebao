<!-- templates/asset/_asset_js.html -->

<!-- 资产详情核心交互逻辑 -->
<script>
    // ============================
    // 全局状态管理
    // ============================
    const assetState = {
        qrcode: null,
        selectedSubId: null,
        selectedSubSn: null,
        assetType: '{{ asset.type }}',
        assetStatus: '{{ asset.status }}',
        assetNumber: '{{ asset.number }}',
        stockQuantity: {{ asset.stock_quantity | tojson }},
        isConsumable: '{{ asset.type }}' === '消耗品',
        // DOM元素缓存
        elements: {
            qrcodeContainer: null,
            qrSnDisplay: null,
            subSelectAlert: null,
            selectedSnText: null,
            repairBtnText: null,
            scrapBtnText: null,
            mainRepairBtn: null,
            scrapBtn: null,
            clearSubSelectBtn: null,
            suppQtyInput: null,
            suppPreview: null
        }
    };

    // ============================
    // 初始化函数
    // ============================
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化DOM元素缓存
        initElementCache();
        
        // 初始化二维码
        initQRCode(assetState.assetNumber);
        
        // 初始化补充库存预览
        initSupplementPreview();
        
        // 初始化报废按钮状态
        initScrapButtonState();
        
        // 处理空子资产列表
        handleEmptySubAssetList();
        
        // 绑定事件监听
        bindEventListeners();
        
        console.log('资产详情页面初始化完成');
    });

    /**
     * 初始化DOM元素缓存，避免重复查询DOM
     */
    function initElementCache() {
        assetState.elements = {
            qrcodeContainer: document.getElementById("qrcode"),
            qrSnDisplay: document.getElementById("qr-sn-display"),
            subSelectAlert: document.getElementById('subSelectAlert'),
            selectedSnText: document.getElementById('selectedSnText'),
            repairBtnText: document.getElementById('repairBtnText'),
            scrapBtnText: document.getElementById('scrapBtnText'),
            mainRepairBtn: document.getElementById('mainRepairBtn'),
            scrapBtn: document.getElementById('scrapBtn'),
            clearSubSelectBtn: document.querySelector('.btn-sm.btn-link[onclick="clearSubSelect()"]'),
            suppQtyInput: document.getElementById('supp_qty'),
            suppPreview: document.getElementById('supp_preview')
        };
    }

    /**
     * 初始化二维码生成
     * @param {string} text - 二维码内容
     */
    function initQRCode(text) {
        try {
            const container = assetState.elements.qrcodeContainer;
            if (!container) {
                console.warn('二维码容器未找到');
                return;
            }

            // 清空容器并生成新二维码
            container.innerHTML = "";
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);

            const qrText = text || assetState.assetNumber;

            QRCode.toCanvas(canvas, qrText, {
                width: 128,
                margin: 2,
                errorCorrectionLevel: 'H',
                color: {
                    dark: "#000000",
                    light: "#ffffff"
                    }
                }, function (error) {
                    if (error) {
                        console.error('Canvas 渲染失败:', error);
                        container.innerHTML = '<div class="text-danger">二维码生成失败</div>';
                    } else {
                        assetState.qrcode = canvas;
                    }
                });


            // 更新SN显示
            if (assetState.elements.qrSnDisplay) {
                assetState.elements.qrSnDisplay.innerText = "SN: " + qrText;
            }
        } catch (error) {
            console.error('生成二维码失败:', error);
            if (assetState.elements.qrcodeContainer) {
                assetState.elements.qrcodeContainer.innerHTML = '<div class="text-danger">二维码生成失败</div>';
            }
        }
    }

    /**
     * 初始化补充库存预览功能
     */
    function initSupplementPreview() {
        const { suppQtyInput, suppPreview } = assetState.elements;
        if (!suppQtyInput || !suppPreview) return;

        // 获取当前总数
        const currentTotal = parseInt(suppPreview.dataset.total) || 0;
        
        // 绑定输入事件
        suppQtyInput.addEventListener('input', function () {
            try {
                // 确保输入值有效且至少为1
                const val = Math.max(1, parseInt(this.value.trim()) || 1);
                this.value = val; // 修正输入值
                suppPreview.innerText = `补充后总数将变为: ${currentTotal + val}`;
            } catch (error) {
                console.error('处理补充数量失败:', error);
                suppPreview.innerText = `补充后总数将变为: ${currentTotal + 1}`;
            }
        });
    }

    /**
     * 初始化报废按钮状态
     */
    function initScrapButtonState() {
        if (assetState.isConsumable) return;
        
        const { scrapBtn } = assetState.elements;
        if (scrapBtn) {
            scrapBtn.disabled = assetState.stockQuantity <= 0;
            // 添加禁用状态样式
            if (scrapBtn.disabled) {
                scrapBtn.classList.add('opacity-75', 'cursor-not-allowed');
            }
        }
    }

    /**
     * 处理空子资产列表的显示逻辑
     */
    function handleEmptySubAssetList() {
        if (!document.getElementById('subAssetList') && assetState.elements.clearSubSelectBtn) {
            assetState.elements.clearSubSelectBtn.style.display = 'none';
        }
    }

    /**
     * 绑定全局事件监听
     */
    function bindEventListeners() {
        // 可以在这里添加需要全局监听的事件
    }

    // ============================
    // 子资产操作逻辑
    // ============================

    /**
     * 选中子资产
     * @param {string|number} id - 子资产ID
     * @param {string} sn - 子资产序列号
     * @param {HTMLElement} element - 点击的DOM元素
     */
    function selectSubAsset(id, sn, element) {
        try {
            // 更新全局状态
            assetState.selectedSubId = id;
            assetState.selectedSubSn = sn;

            // 移除所有子资产的选中状态
            document.querySelectorAll('.sub-asset-item').forEach(item => {
                item.classList.remove('active', 'bg-primary', 'text-white');
            });

            // 添加当前选中项的样式
            if (element) {
                element.classList.add('active', 'bg-primary', 'text-white');
                
                // 更新维修/报废按钮状态
                updateSubAssetActionButtons(element);
            }

            // 生成选中子资产的二维码
            initQRCode(sn);

            // 显示选中提醒
            if (assetState.elements.subSelectAlert) {
                assetState.elements.subSelectAlert.classList.remove('d-none');
                if (assetState.elements.selectedSnText) {
                    assetState.elements.selectedSnText.innerText = sn;
                }
            }

            // 过滤历史记录
            filterHistoryTable(sn);
        } catch (error) {
            console.error('选中子资产失败:', error);
            alert('选中子资产时发生错误，请刷新页面重试');
        }
    }

    /**
     * 清除子资产选中状态
     */
    function clearSubSelect() {
        try {
            // 重置全局状态
            assetState.selectedSubId = null;
            assetState.selectedSubSn = null;

            // 移除所有选中样式
            document.querySelectorAll('.sub-asset-item').forEach(item => {
                item.classList.remove('active', 'bg-primary', 'text-white');
            });

            // 恢复主资产二维码
            initQRCode(assetState.assetNumber);

            // 隐藏选中提醒
            if (assetState.elements.subSelectAlert) {
                assetState.elements.subSelectAlert.classList.add('d-none');
            }

            // 恢复按钮状态
            restoreMainAssetActionButtons();

            // 显示所有历史记录
            filterHistoryTable('all');
        } catch (error) {
            console.error('清除子资产选中状态失败:', error);
        }
    }

    /**
     * 更新子资产选中后的操作按钮状态
     * @param {HTMLElement} element - 选中的子资产元素
     */
    function updateSubAssetActionButtons(element) {
        if (assetState.isConsumable) return;

        const { repairBtnText, mainRepairBtn, scrapBtnText, scrapBtn } = assetState.elements;
        const isRepairing = element.getAttribute('data-status') === '维修';
        const badgeElement = element.querySelector('.badge');
        const isInStock = badgeElement ? badgeElement.innerText === '在库' : false;

        // 更新维修按钮
        if (repairBtnText && mainRepairBtn) {
            if (isRepairing) {
                mainRepairBtn.className = "btn btn-info text-white";
                repairBtnText.innerText = "修复选中件";
            } else {
                mainRepairBtn.className = "btn btn-warning";
                repairBtnText.innerText = "维修选中件";
            }
        }

        // 更新报废按钮
        if (scrapBtnText) {
            scrapBtnText.innerText = "报废选中件";
        }
        
        if (scrapBtn) {
            scrapBtn.disabled = !isInStock;
            if (scrapBtn.disabled) {
                scrapBtn.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                scrapBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }
    }

    /**
     * 恢复主资产的操作按钮状态
     */
    function restoreMainAssetActionButtons() {
        if (assetState.isConsumable) return;

        const { repairBtnText, scrapBtnText, mainRepairBtn, scrapBtn } = assetState.elements;

        // 恢复维修按钮
        if (repairBtnText && mainRepairBtn) {
            if (assetState.assetStatus === '维修中') {
                mainRepairBtn.className = "btn btn-info text-white";
                repairBtnText.innerText = "维修完成";
            } else {
                mainRepairBtn.className = "btn btn-warning";
                repairBtnText.innerText = "维修";
            }
        }

        // 恢复报废按钮
        if (scrapBtnText) {
            scrapBtnText.innerText = "报废";
        }
        
        if (scrapBtn) {
            scrapBtn.disabled = assetState.stockQuantity <= 0;
            if (scrapBtn.disabled) {
                scrapBtn.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                scrapBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }
    }

    // ============================
    // 维修/报废操作处理
    // ============================

    /**
     * 处理维修按钮点击事件
     */
    function handleRepairClick() {
        if (assetState.isConsumable) return;
        
        try {
            // 如果选中了子资产，处理子资产维修
            if (assetState.selectedSubId) {
                const subItem = document.querySelector(`.sub-asset-item.active`);
                if (!subItem) {
                    alert('未找到选中的子资产，请重新选择');
                    return;
                }
                
                const isSubRepairing = subItem.getAttribute('data-status') === '维修';

                if (isSubRepairing) {
                    openSubAssetModal(
                        '维修完成', 
                        "{{ url_for('asset.asset_complete_repair_sub') }}", 
                        'bg-info text-white', 
                        'btn-info'
                    );
                } else {
                    openSubAssetModal(
                        '维修', 
                        "{{ url_for('asset.asset_repair_sub') }}", 
                        'bg-warning', 
                        'btn-warning'
                    );
                }
            } else {
                // 处理主资产维修
                const completeRepairModal = document.getElementById('completeRepairModal');
                const repairModal = document.getElementById('repairModal');
                
                if (assetState.assetStatus === '维修中' && completeRepairModal) {
                    new bootstrap.Modal(completeRepairModal).show();
                } else if (repairModal) {
                    new bootstrap.Modal(repairModal).show();
                } else {
                    console.warn('维修模态框未找到');
                    alert('操作失败：未找到相关操作窗口');
                }
            }
        } catch (error) {
            console.error('处理维修操作失败:', error);
            alert('维修操作失败，请刷新页面重试');
        }
    }

    /**
     * 处理报废按钮点击事件
     */
    function handleScrapClick() {
        if (assetState.isConsumable) return;
        
        try {
            // 如果选中了子资产，处理子资产报废
            if (assetState.selectedSubId) {
                const subItem = document.querySelector(`.sub-asset-item.active`);
                if (!subItem) {
                    alert('未找到选中的子资产，请重新选择');
                    return;
                }
                
                const badgeElement = subItem.querySelector('.badge');
                const isInStock = badgeElement ? badgeElement.innerText === '在库' : false;
                
                if (!isInStock) {
                    alert('该子资产不在库存中，无法报废！请先归还后再操作。');
                    return;
                }
                
                // 二次确认
                if (!confirm(`确认要报废编号为 ${assetState.selectedSubSn} 的子资产吗？此操作不可逆！`)) {
                    return;
                }
                
                openSubAssetModal(
                    '报废', 
                    "{{ url_for('asset.asset_scrap_sub') }}", 
                    'bg-danger text-white', 
                    'btn-danger'
                );
            } else {
                // 处理主资产报废
                const scrapModal = document.getElementById('scrapModal');
                if (scrapModal) {
                    new bootstrap.Modal(scrapModal).show();
                } else {
                    console.warn('报废模态框未找到');
                    alert('操作失败：未找到相关操作窗口');
                }
            }
        } catch (error) {
            console.error('处理报废操作失败:', error);
            alert('报废操作失败，请刷新页面重试');
        }
    }

    // ============================
    // 模态框操作
    // ============================

    /**
     * 打开子资产操作模态框
     * @param {string} action - 操作类型（维修/维修完成/报废）
     * @param {string} url - 提交URL
     * @param {string} headerClass - 头部样式类
     * @param {string} btnClass - 按钮样式类
     */
    function openSubAssetModal(action, url, headerClass, btnClass) {
        try {
            // 获取模态框元素
            const hiddenSubId = document.getElementById('hiddenSubId');
            const subAssetForm = document.getElementById('subAssetForm');
            const subModalHeader = document.getElementById('subModalHeader');
            const subModalTitle = document.getElementById('subModalTitle');
            const subModalMessage = document.getElementById('subModalMessage');
            const subModalSubmitBtn = document.getElementById('subModalSubmitBtn');
            const subAssetDynamicModal = document.getElementById('subAssetDynamicModal');

            // 验证必要元素
            const requiredElements = [
                hiddenSubId, subAssetForm, subModalHeader, 
                subModalTitle, subModalMessage, subModalSubmitBtn, subAssetDynamicModal
            ];
            
            if (requiredElements.some(el => !el)) {
                console.error('子资产模态框元素不完整');
                alert('操作失败：缺少必要的操作窗口元素');
                return;
            }

            // 设置模态框内容
            hiddenSubId.value = assetState.selectedSubId;
            subAssetForm.action = url;
            subModalHeader.className = `modal-header ${headerClass}`;
            subModalTitle.innerText = `子资产${action}`;
            subModalMessage.innerHTML = `您正在对编号为 <span class="badge bg-dark">${assetState.selectedSubSn}</span> 的资产进行${action}操作。`;

            // 设置提交按钮
            subModalSubmitBtn.className = `btn ${btnClass}`;
            subModalSubmitBtn.innerText = `确认提交${action}`;

            // 显示模态框
            const subModal = new bootstrap.Modal(subAssetDynamicModal);
            subModal.show();
            
            // 模态框关闭后刷新页面
            subModal._element.addEventListener('hidden.bs.modal', function() {
                // 添加延迟，确保表单提交完成
                setTimeout(() => {
                    window.location.reload();
                }, 300);
            });
        } catch (error) {
            console.error('打开子资产模态框失败:', error);
            alert('打开操作窗口失败，请刷新页面重试');
        }
    }

    // ============================
    // 辅助功能
    // ============================

    /**
     * 根据SN过滤历史记录表格
     * @param {string} sn - 序列号，all表示显示所有
     */
    function filterHistoryTable(sn) {
        try {
            const rows = document.querySelectorAll('.history-row');
            rows.forEach(row => {
                const rowSn = row.getAttribute('data-sn') || "all";
                row.style.display = (sn === 'all' || rowSn === sn) ? '' : 'none';
                
                // 添加过渡效果
                row.style.transition = 'opacity 0.3s ease';
                row.style.opacity = (sn === 'all' || rowSn === sn) ? 1 : 0;
            });
        } catch (error) {
            console.error('过滤历史记录失败:', error);
        }
    }
</script>

<!-- 自定义样式 -->
<style>
    /* 打印样式优化 */
    @media print {
        /* 打印时隐藏所有内容 */
        body * { 
            visibility: hidden; 
        }
        
        /* 只显示二维码卡片部分 */
        .card.shadow-sm.border-primary, 
        .card.shadow-sm.border-primary * {
            visibility: visible;
        }
        
        .card.shadow-sm.border-primary {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: auto;
            box-shadow: none !important;
            border: 1px solid #ccc !important;
        }
        
        /* 隐藏按钮 */
        .btn { 
            display: none !important; 
        }
        
        /* 优化打印样式 */
        #qrcode {
            margin: 0 auto;
        }
        
        #qr-sn-display {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
    }

    /* 子资产列表样式 */
    .sub-asset-item { 
        cursor: pointer; 
        transition: all 0.2s ease;
        border-left: 5px solid transparent;
    }
    
    .sub-asset-item:hover { 
        background-color: #f8f9fa;
        transform: translateX(2px);
    }
    
    .sub-asset-item.active { 
        border-left: 5px solid #0d6efd;
        background-color: #0d6efd !important;
        color: white !important;
    }
    
    /* 禁用状态样式 */
    .cursor-not-allowed {
        cursor: not-allowed !important;
    }
    
    .opacity-75 {
        opacity: 0.75 !important;
    }
    
    /* 历史记录过滤过渡 */
    .history-row {
        transition: opacity 0.3s ease, display 0s 0.3s ease !important;
    }
    
    /* 补充数量输入框样式 */
    #supp_qty {
        transition: border-color 0.2s ease;
    }
    
    #supp_qty:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    /* 选中提醒样式优化 */
    #subSelectAlert {
        transition: all 0.3s ease;
    }
</style>