<!-- templates/asset/detail.html -->
{% extends "base.html" %}

{% block title %}资产详情 - {{ asset.name }}{% endblock %}

{% block content %}
<style>
    /* 基础样式变量 */
    :root {
        --primary-color: #0d6efd;
        --success-color: #198754;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --dark-color: #212529;
        --light-color: #f8f9fa;
        --info-color: #0dcaf0;
        --secondary-color: #6c757d;
    }
    
    /* 卡片样式 */
    .detail-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    /* 卡片头部 */
    .detail-header {
        background: linear-gradient(135deg, var(--dark-color) 0%, #343a40 100%) !important;
        padding: 1rem 1.5rem;
        border-bottom: none;
    }
    
    /* 卡片内容 */
    .detail-body {
        padding: 2rem;
    }
    
    /* 返回按钮 */
    .back-btn {
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .back-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }
    
    /* 资产图片区域 */
    .asset-photo-container {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
    }
    
    .asset-photo-container:hover {
        transform: translateY(-5px);
    }
    
    .no-photo-placeholder {
        height: 300px;
        background-color: var(--light-color);
        border-radius: 8px;
        border: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--secondary-color);
    }
    
    /* 子资产列表 */
    .sub-asset-section {
        margin-top: 2rem;
    }
    
    .sub-asset-header {
        font-weight: 600;
        color: #495057;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 1rem;
    }
    
    .clear-selection-btn {
        font-size: 0.85rem;
        color: var(--primary-color);
        transition: all 0.2s ease;
    }
    
    .clear-selection-btn:hover {
        color: #0a58ca;
        text-decoration: underline;
    }
    
    .sub-asset-list {
        border-radius: 8px;
        border: 1px solid #e9ecef;
        max-height: 400px;
        overflow-y: auto;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
    }
    
    .sub-asset-item {
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
        padding: 0.75rem 1rem;
    }
    
    .sub-asset-item:hover {
        background-color: rgba(13, 110, 253, 0.03);
        border-left-color: var(--primary-color);
    }
    
    .sub-asset-item.selected {
        background-color: rgba(13, 110, 253, 0.1);
        border-left-color: var(--primary-color);
        font-weight: 500;
    }
    
    /* 资产信息表格 */
    .asset-info-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .asset-info-table th {
        width: 120px;
        padding: 0.75rem 1rem;
        text-align: left;
        font-weight: 600;
        color: #495057;
        vertical-align: top;
        border-bottom: 1px solid #f1f3f5;
    }
    
    .asset-info-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f1f3f5;
        vertical-align: top;
    }
    
    .asset-info-table tr:last-child th,
    .asset-info-table tr:last-child td {
        border-bottom: none;
    }
    
    /* 状态徽章 */
    .status-badge {
        border-radius: 6px;
        padding: 0.4em 0.8em;
        font-weight: 500;
        font-size: 0.85rem;
    }
    
    /* 子资产选择提示 */
    .sub-select-alert {
        border-radius: 8px;
        border-left: 4px solid var(--info-color);
        background-color: rgba(13, 202, 240, 0.05);
        padding: 0.75rem 1rem;
        margin-bottom: 1.5rem;
        display: none;
    }
    
    /* 二维码卡片 */
    .qr-card {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--primary-color) !important;
    }
    
    .qr-header {
        background-color: var(--primary-color) !important;
        padding: 0.5rem 1rem;
        font-weight: 500;
    }
    
    .qr-body {
        padding: 1rem;
    }
    
    .print-btn {
        border-radius: 6px;
        transition: all 0.2s ease;
        font-weight: 500;
    }
    
    .print-btn:hover {
        background-color: var(--primary-color) !important;
        color: white !important;
    }
    
    .qr-sn-display {
        color: var(--primary-color);
        font-size: 0.85rem;
        line-height: 1.4;
    }
    
    /* 操作区域 */
    .asset-actions {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }
    
    /* 历史记录区域 */
    .asset-history {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }
    
    /* 响应式优化 */
    @media (max-width: 992px) {
        .detail-body {
            padding: 1.5rem;
        }
        
        .asset-photo-container img {
            max-height: 250px;
            object-fit: cover;
        }
        
        .no-photo-placeholder {
            height: 250px;
        }
    }
    
    @media (max-width: 768px) {
        .detail-body {
            padding: 1rem;
        }
        
        .asset-info-table th {
            width: 100px;
            padding: 0.5rem;
            font-size: 0.85rem;
        }
        
        .asset-info-table td {
            padding: 0.5rem;
            font-size: 0.85rem;
        }
        
        .sub-asset-item {
            padding: 0.5rem 0.75rem;
        }
        
        .qr-card {
            margin-top: 1.5rem;
        }
    }
    
    @media (max-width: 576px) {
        .detail-header {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 1rem;
        }
        
        .asset-photo-container img {
            max-height: 200px;
        }
        
        .no-photo-placeholder {
            height: 200px;
        }
        
        .sub-asset-list {
            max-height: 300px;
        }
    }
</style>

<div class="container mt-4 mb-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card detail-card shadow">
                <div class="card-header detail-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-box-seam me-2"></i>资产详情 - {{ asset.name }}
                    </h4>
                    <a href="{{ return_url or url_for('asset.asset_list') }}" class="btn btn-outline-light btn-sm back-btn">
                        <i class="bi bi-arrow-left me-1"></i>返回列表
                    </a>
                </div>

                <div class="card-body detail-body">
                    <div class="row">
                        <!-- 左侧：资产图片和子资产列表 -->
                        <div class="col-md-4 mb-4">
                            <!-- 资产图片 -->
                            <div class="text-center mb-3">
                                {% if asset.photo_path %}
                                <div class="asset-photo-container">
                                    <img src="/{{ asset.photo_path }}" class="img-fluid rounded" alt="{{ asset.name }}">
                                </div>
                                {% else %}
                                <div class="no-photo-placeholder rounded shadow-sm">
                                    <span class="text-muted fs-4">
                                        <i class="bi bi-image me-2"></i>无照片
                                    </span>
                                </div>
                                {% endif %}
                            </div>

                            <!-- 子资产明细 -->
                            {% if asset.instances %}
                            <div class="sub-asset-section mt-4">
                                <div class="sub-asset-header d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="bi bi-list-ul me-1"></i> 子资产明细 
                                        <span class="badge bg-light text-dark">{{ asset.instances|length }}</span>
                                    </span>
                                    <button class="btn btn-sm btn-link p-0 text-decoration-none clear-selection-btn"
                                        onclick="clearSubSelect()">
                                        <i class="bi bi-x-circle me-1"></i>清除选中
                                    </button>
                                </div>
                                <div class="list-group sub-asset-list" id="subAssetList">
                                    {% for item in asset.instances %}
                                    <button type="button"
                                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center sub-asset-item"
                                        onclick="selectSubAsset('{{ item.id }}', '{{ item.sn_number }}', this)"
                                        data-status="{{ item.status }}" data-sn="{{ item.sn_number }}">
                                        <div>
                                            <span class="fw-bold d-block">{{ item.sn_number }}</span>
                                            <small class="text-muted">状态: {{ item.status }}</small>
                                        </div>
                                        <span
                                            class="badge {% if item.status == '正常' %}bg-success{% elif item.status == '维修' %}bg-warning{% else %}bg-danger{% endif %} rounded-pill">
                                            {{ item.current_user or '在库' }}
                                        </span>
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- 右侧：资产信息和二维码 -->
                        <div class="col-md-8">
                            <!-- 子资产选择提示 -->
                            <div class="alert sub-select-alert" id="subSelectAlert">
                                <i class="bi bi-info-circle me-1"></i> 
                                当前已选中子资产：<strong id="selectedSnText"></strong>
                            </div>
                            
                            <div class="row">
                                <!-- 资产信息表格 -->
                                <div class="col-md-8 mb-4">
                                    <table class="asset-info-table">
                                        <tr>
                                            <th>资产类型</th>
                                            <td>
                                                <span class="badge bg-secondary status-badge">{{ asset.type }}</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>资产名称</th>
                                            <td>{{ asset.name }}</td>
                                        </tr>
                                        <tr>
                                            <th>资产编号</th>
                                            <td class="fw-medium">{{ asset.number }}</td>
                                        </tr>
                                        <tr>
                                            <th>购置日期</th>
                                            <td>{{ asset.purchase_date.strftime('%Y-%m-%d') if asset.purchase_date else '-' }}</td>
                                        </tr>
                                        <tr>
                                            <th>存放位置</th>
                                            <td>{{ asset.location or '-' }}</td>
                                        </tr>
                                        <tr>
                                            <th>单价</th>
                                            <td class="fw-medium">￥{{ "%.2f"|format(asset.unit_price) }}</td>
                                        </tr>
                                        <tr>
                                            <th>资产归属</th>
                                            <td>{{ asset.ownership or '-' }}</td>
                                        </tr>
                                        <tr>
                                            <th>库存/总数</th>
                                            <td>
                                                <span class="fw-bold {% if asset.stock_quantity > 0 %}text-success{% else %}text-danger{% endif %}">
                                                    {{ asset.stock_quantity }}
                                                </span> / {{ asset.total_quantity }}
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>当前领用人</th>
                                            <td>
                                                {% set active_allocs = asset.allocations | selectattr('return_date', 'none') | list %}
                                                {% if active_allocs %}
                                                <div class="d-flex flex-wrap gap-2">
                                                    {% for alloc in active_allocs %}
                                                    <span class="badge bg-primary status-badge">
                                                        {{ alloc.user.name }} <small>({{ alloc.quantity }} 个)</small>
                                                    </span>
                                                    {% endfor %}
                                                </div>
                                                {% else %}
                                                {{ asset.department or '暂无领用人' }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>状态</th>
                                            <td>
                                                <span class="badge status-badge {% if asset.status == '库存' %}bg-success{% elif asset.status == '使用中' %}bg-primary{% elif asset.status == '维修中' %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ asset.status }}
                                                </span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <!-- 二维码卡片 -->
                                <div class="col-md-4">
                                    <div class="card qr-card shadow-sm border-primary">
                                        <div class="card-header qr-header bg-primary text-white py-1">
                                            <small><i class="bi bi-qr-code me-1"></i> 资产二维码</small>
                                        </div>
                                        <div class="card-body qr-body text-center p-2">
                                            <div id="qrcode" class="d-flex justify-content-center mb-2"></div>
                                            <p class="small fw-bold mb-1 qr-sn-display" id="qr-sn-display">
                                                {{ asset.name }} <br>
                                                SN: {{ asset.number }}
                                            </p>
                                            <button class="btn btn-sm btn-outline-primary w-100 print-btn">
                                                <i class="bi bi-printer me-1"></i> 打印标签
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 资产操作区域 -->
                            <div class="asset-actions">
                                {% include "asset/_asset_actions.html" %}
                            </div>
                            
                            <!-- 资产历史记录 -->
                            <div class="asset-history">
                                {% include "asset/_asset_history.html" %}
                            </div>

                            <!-- 模态框 -->
                             <div class="asset-modales">
                                {% include "asset/_asset_modals.html" %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include "asset/_asset_js.html" %}

<script>
    let selectedSubAssets = [];
    
    // 确保 assetState 对象初始化
    if (typeof assetState === 'undefined') {
        assetState = {
            elements: {
                qrcodeContainer: document.getElementById('qrcode'),
                qrSnDisplay: document.getElementById('qr-sn-display')
            },
            // 这里确保从 Jinja2 模板拿到的值即使为空也是空字符串而非 null
            assetNumber: "{{ asset.number or '' }}",
            assetName: "{{ asset.name or '未知资产' }}"
        };
    }
    
    function selectSubAsset(id, sn, element) {
        clearSubSelect(false);
        selectedSubAssets.push({ id, sn });
        element.classList.add('selected');
        updateSelectedAlert();
        if (typeof initQRCode === 'function') initQRCode(sn); 
    }
    
    function clearSubSelect(restoreQrcode = true) {
        selectedSubAssets = [];
        document.querySelectorAll('.sub-asset-item').forEach(item => {
            item.classList.remove('selected');
        });
        const alertEl = document.getElementById('subSelectAlert');
        if (alertEl) alertEl.style.display = 'none';
        if (restoreQrcode && typeof initQRCode === 'function') {
            initQRCode(); 
        }
    }
    
    function updateSelectedAlert() {
        const alertEl = document.getElementById('subSelectAlert');
        const textEl = document.getElementById('selectedSnText');
        if (!alertEl || !textEl) return;
        if (selectedSubAssets.length > 0) {
            textEl.textContent = selectedSubAssets[0].sn;
            alertEl.style.display = 'block';
        } else {
            alertEl.style.display = 'none';
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化二维码
        if (typeof initQRCode === 'function') initQRCode();

        const printBtn = document.querySelector('.print-btn');
        if (printBtn) {
            printBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // --- 修复开始：严格校验数据 ---
                let finalName = "资产标签";
                if (assetState && assetState.assetName && assetState.assetName !== 'None') {
                    finalName = assetState.assetName;
                }

                let finalSn = (assetState && assetState.assetNumber) ? assetState.assetNumber : "";
                
                // 子资产逻辑
                if (selectedSubAssets && selectedSubAssets.length > 0) {
                    finalSn = selectedSubAssets[0].sn;
                }

                // 最终防御：防止字符串 "undefined" 出现
                if (finalSn === "undefined") finalSn = "";
                if (finalName === "undefined") finalName = "资产标签";
                // --- 修复结束 ---

                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('打印窗口被浏览器拦截，请允许弹窗后重试');
                    return;
                }

                printWindow.document.write(`
                    <html>
                        <head>
                            <title>打印 - ${finalSn}</title>
                            <style>
                                @page { size: 50mm 30mm; margin: 0; }
                                html, body { 
                                    margin: 0; padding: 0; width: 50mm; height: 30mm; 
                                    display: flex; flex-direction: column; 
                                    align-items: center; justify-content: center;
                                    overflow: hidden; background: white;
                                }
                                .asset-info { 
                                    font-family: "Microsoft YaHei", sans-serif;
                                    font-size: 8pt; font-weight: bold; 
                                    margin-bottom: 0.5mm; width: 95%;
                                    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
                                    text-align: center;
                                }
                                canvas { width: 18mm !important; height: 18mm !important; display: block; }
                                .asset-sn { font-family: Arial, sans-serif; font-size: 7pt; color: #333; margin-top: 0.5mm; }
                            </style>
                        </head>
                        <body>
                            <div class="asset-info">${finalName}</div>
                            <canvas id="print-qrcode"></canvas>
                            <div class="asset-sn">SN: ${finalSn}</div>

                            <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"><\/script>
                            <script>
                                const canvas = document.getElementById('print-qrcode');
                                QRCode.toCanvas(canvas, '${finalSn}', {
                                    width: 100, margin: 0, errorCorrectionLevel: 'H'
                                }, function (error) {
                                    if (!error) {
                                        setTimeout(() => {
                                            window.print();
                                            window.close();
                                        }, 300); 
                                    }
                                });
                            <\/script>
                        </body>
                    </html>
                `);
                printWindow.document.close();
            });
        }
    });
</script>
{% endblock %}