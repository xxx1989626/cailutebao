<!-- templates/asset/inventory.html -->
{% extends "base.html" %}
{% block title %}全局资产盘点{% endblock %}
{% block content %}
<style>
    /* 基础样式变量 */
    :root {
        --primary-color: #0d6efd;
        --success-color: #198754;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --dark-color: #212529;
        --light-color: #f8f9fa;
    }
    
    /* 卡片样式 */
    .inventory-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    /* 卡片头部 */
    .inventory-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #0a58ca 100%) !important;
        padding: 1rem 1.5rem;
        border-bottom: none;
    }
    
    /* 按钮样式 */
    .action-btn {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
        padding: 0.375rem 0.75rem;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }
    
    .scan-btn {
        background-color: var(--warning-color) !important;
        border-color: var(--warning-color) !important;
        color: var(--dark-color) !important;
    }
    
    .scan-btn:hover {
        background-color: #e0a800 !important;
        border-color: #e0a800 !important;
    }
    
    /* 筛选表单 */
    .filter-form {
        background-color: var(--light-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem !important;
    }
    
    .form-select {
        border-radius: 8px;
        padding: 0.5rem 0.75rem;
        border: 1px solid #ced4da;
        transition: all 0.2s ease;
    }
    
    .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1);
        outline: none;
    }
    
    /* 统计徽章 */
    .stat-badge {
        padding: 0.5em 1em;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    /* 表格样式 */
    .table-responsive {
        border-radius: 8px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table thead th {
        border-top: none;
        border-bottom: 2px solid #e9ecef;
        color: #495057;
        font-weight: 600;
        padding: 1rem 0.75rem;
        position: relative;
    }
    
    .table thead.sticky-top {
        top: 0;
        z-index: 10;
        background-color: var(--light-color);
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.03);
    }
    
    .table tbody tr.table-success {
        animation: highlight 3s ease;
    }
    
    @keyframes highlight {
        0% { background-color: rgba(25, 135, 84, 0.2); }
        100% { background-color: transparent; }
    }
    
    .table td {
        border-color: #e9ecef;
        vertical-align: middle;
        padding: 0.75rem 0.75rem;
    }
    
    /* 状态徽章 */
    .status-badge {
        font-size: 0.8rem !important;
        padding: 0.4em 0.8em;
        border-radius: 6px;
        font-weight: 500;
    }
    
    /* 标记按钮 */
    .mark-btn {
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .mark-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(13, 110, 253, 0.2);
    }
    
    /* 模态框样式 */
    .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        overflow: hidden;
    }
    
    .modal-header {
        background: var(--dark-color);
        color: white;
        border-bottom: none;
        padding: 1rem 1.5rem;
    }
    
    .modal-body {
        padding: 0;
    }
    
    #reader {
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* 扫描记录区域 */
    .scan-feedback-area {
        background: white;
        border-radius: 16px 16px 0 0 !important;
        margin-top: -20px !important;
        position: relative;
        z-index: 10;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .scan-history {
        max-height: 150px !important;
    }
    
    .list-group-item {
        border-left: none;
        border-right: none;
    }
    
    /* 响应式优化 */
    @media (max-width: 768px) {
        .inventory-header {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 1rem;
        }
        
        .header-actions {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .filter-form {
            padding: 0.75rem;
        }
        
        #reader {
            min-height: 300px;
        }
        
        .stat-badge {
            display: inline-block;
            margin-bottom: 0.5rem;
        }
        
        .table td, .table th {
            padding: 0.5rem 0.4rem;
            font-size: 0.85rem;
        }
        
        .status-badge {
            font-size: 0.7rem !important;
        }
    }
    
    @media (max-width: 576px) {
        .table-responsive {
            font-size: 0.8rem;
        }
        
        .mark-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    }
</style>

<div class="container mt-4 mb-5">
    <div class="card inventory-card shadow">
        <div class="card-header inventory-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="bi bi-clipboard-check me-2"></i>全局资产盘点
            </h4>
            <div class="header-actions">
                <a href="{{ url_for('asset.asset_list') }}" class="btn btn-outline-light btn-sm action-btn me-1">
                    <i class="bi bi-arrow-left me-1"></i>返回列表
                </a>
                <a href="{{ url_for('asset.export_inventory') }}" class="btn btn-outline-light btn-sm action-btn me-1">
                    <i class="bi bi-download me-1"></i>导出清单
                </a>
                <button class="btn scan-btn btn-sm fw-bold action-btn" data-bs-toggle="modal" data-bs-target="#scanModal">
                    <i class="bi bi-qr-code-scan me-1"></i>扫码盘点
                </button>
            </div>
        </div>
        
        <div class="card-body p-4">
            <!-- 筛选表单 -->
            <form method="GET" class="row g-3 filter-form mb-4">
                <div class="col-md-3">
                    <label class="form-label small text-muted mb-1">资产类型</label>
                    <select name="type" class="form-select">
                        <option value="">所有资产类型</option>
                        {% for type in asset_types %}
                        <option value="{{ type }}" {% if type_filter==type %}selected{% endif %}>{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted mb-1">资产状态</label>
                    <select name="status" class="form-select">
                        <option value="">所有资产状态</option>
                        {% for status in asset_status %}
                        <option value="{{ status }}" {% if status_filter==status %}selected{% endif %}>{{ status }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-secondary w-100 action-btn">
                        <i class="bi bi-funnel me-1"></i>筛选
                    </button>
                </div>
                <div class="col-md-4 text-end d-flex align-items-center justify-content-md-end gap-2">
                    <span class="badge bg-success stat-badge">
                        <i class="bi bi-check-circle me-1"></i>正常：{{ normal }}
                    </span>
                    <span class="badge bg-danger stat-badge">
                        <i class="bi bi-exclamation-circle me-1"></i>异常：{{ abnormal }}
                    </span>
                    <span class="badge bg-secondary stat-badge">
                        <i class="bi bi-grid-1x2-fill me-1"></i>总计：{{ total }}
                    </span>
                </div>
            </form>

            <!-- 资产盘点表格 -->
            <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                <table class="table table-hover align-middle">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>资产编号</th>
                            <th>资产名称</th>
                            <th>类型</th>
                            <th>存放位置</th>
                            <th>负责人</th>
                            <th>资产状态</th>
                            <th>上次盘点</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if assets %}
                        {% for asset in assets %}
                        <tr data-sn="{{ asset.sn_number }}">
                            <td class="fw-medium">{{ asset.sn_number }}</td>
                            <td>{{ asset.asset_info.name }}</td>
                            <td>
                                <span class="badge bg-light text-dark border">{{ asset.asset_info.type }}</span>
                            </td>
                            <td>{{ asset.current_room.number if asset.current_room else '待分配' }}</td>
                            <td>{{ asset.current_holder.name if asset.current_holder else '无' }}</td>
                            <td>
                                <span class="badge {% if asset.status == '正常' %}bg-success{% elif asset.status == '维修' %}bg-warning{% else %}bg-danger{% endif %} status-badge">
                                    {{ asset.status }}
                                </span>
                            </td>
                            <td class="last-check-cell text-muted">{{ format_date(asset.last_check_date) or '未盘点' }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary mark-btn" onclick="checkAsset('{{ asset.id }}', '{{ asset.sn_number }}')">
                                    <i class="bi bi-check-circle me-1"></i>标记
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">
                                <i class="bi bi-clipboard-check fs-3 mb-2"></i>
                                <div>暂无符合条件的资产数据</div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 扫码盘点模态框 -->
<div class="modal fade" id="scanModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-fullscreen-md-down">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">
                    <i class="bi bi-camera me-2"></i>连续扫码盘点
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="stopScanner()"></button>
            </div>
            <div class="modal-body p-0 bg-black">
                <div id="reader" style="width: 100%; background: #000;"></div>
                <div class="scan-feedback-area bg-white p-3" style="min-height: 150px;">
                    <p class="text-primary fw-bold mb-2 small">
                        <i class="bi bi-clock-history me-1"></i>最近扫描记录：
                    </p>
                    <div id="scan-feedback-msg" class="alert alert-light border small py-2 mb-2">
                        <i class="bi bi-info-circle me-1"></i> 等待扫描...
                    </div>
                    <ul id="scan-history" class="list-group list-group-flush small scan-history" style="max-height: 120px; overflow-y: auto;"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 音效文件 -->
<audio id="successSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<!-- 二维码扫描库 -->

<script>
    let html5QrCode;
    let lastScannedCode = "";
    let lastScannedTime = 0;
    let scanHistoryCount = 0;

    // 扫码成功处理函数
    function onScanSuccess(decodedText) {
        const now = Date.now();
        
        // 防抖处理：2秒内同一二维码不重复处理
        if (decodedText === lastScannedCode && (now - lastScannedTime) < 2000) return;
        
        lastScannedCode = decodedText;
        lastScannedTime = now;

        // 处理 URL 类型的二维码，提取 SN
        let sn = decodedText;
        if (decodedText.includes('/')) {
            sn = decodedText.split('/').pop();
        }
        console.log("正在盘点 SN:", sn);

        // 提交后端请求
        fetch(`/asset/inventory/quick_check`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ "sn": sn, "status": "正常" })
        })
        .then(res => {
            if(!res.ok) throw new Error(`HTTP错误: ${res.status}`);
            return res.json();
        })
        .then(data => {
            if (data.status === 'success') {
                playSuccessSound();
                showFeedback(sn, data.asset_name || "盘点成功", true);
                updateUIRow(sn); 
            } else {
                showFeedback(sn, data.message || "盘点失败", false);
            }
        })
        .catch(err => {
            console.error("盘点失败:", err);
            showFeedback(sn, "网络请求失败: " + err.message, false);
        });
    }

    // 显示扫码反馈信息
    function showFeedback(sn, msg, isSuccess) {
        const feedbackEl = document.getElementById('scan-feedback-msg');
        const historyEl = document.getElementById('scan-history');
        
        // 更新即时反馈
        feedbackEl.className = `alert py-2 small ${isSuccess ? 'alert-success' : 'alert-danger'}`;
        feedbackEl.innerHTML = `<i class="bi ${isSuccess ? 'bi-check-circle' : 'bi-x-circle'} me-1"></i> <strong>${sn}</strong>: ${msg}`;

        // 添加到历史记录（最多显示10条）
        scanHistoryCount++;
        const li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center py-1 px-0";
        li.innerHTML = `
            <span class="small">
                <span class="text-muted">#${scanHistoryCount}</span> ${sn}
            </span> 
            <small class="${isSuccess?'text-success':'text-danger'}">
                <i class="bi ${isSuccess ? 'bi-check' : 'bi-x'} me-1"></i>${isSuccess?'成功':'失败'}
            </small>
        `;
        
        historyEl.prepend(li);
        
        // 限制历史记录数量
        const items = historyEl.querySelectorAll('li');
        if (items.length > 10) {
            historyEl.removeChild(items[items.length - 1]);
        }
    }

    // 更新UI表格行状态
    function updateUIRow(sn) {
        // 使用 data-sn 选择器
        const row = document.querySelector(`tr[data-sn="${sn}"]`);
        if (row) {
            // 添加高亮动画
            row.classList.add('table-success');
            
            // 更新盘点日期
            const dateCell = row.querySelector('.last-check-cell');
            if(dateCell) {
                const now = new Date();
                const formattedDate = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                dateCell.textContent = formattedDate;
                dateCell.classList.remove('text-muted');
            }
            
            // 更新状态为正常
            const badge = row.querySelector('.status-badge');
            if(badge) {
                badge.className = "badge bg-success status-badge";
                badge.textContent = "正常";
            }
            
            // 3秒后移除高亮
            setTimeout(() => row.classList.remove('table-success'), 3000);
        }
    }

    // 启动扫码器
    document.getElementById('scanModal').addEventListener('shown.bs.modal', function () {
        // 清空历史记录
        document.getElementById('scan-history').innerHTML = '';
        document.getElementById('scan-feedback-msg').className = 'alert alert-light border small py-2';
        document.getElementById('scan-feedback-msg').innerHTML = '<i class="bi bi-info-circle me-1"></i> 等待扫描...';
        scanHistoryCount = 0;
        
        // 初始化扫码器
        if (html5QrCode) {
            html5QrCode.stop().catch(e => console.log(e));
        }
        
        html5QrCode = new Html5Qrcode("reader");
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            disableFlip: false
        };
        
        // 启动摄像头
        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess
        ).catch(err => {
            alert("相机启动失败: " + err.message + "\n请检查相机权限或使用手动标记功能");
            $('#scanModal').modal('hide');
        });
    });

    // 停止扫码器
    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                document.getElementById('reader').innerHTML = '';
            }).catch(e => console.log("停止扫码器失败:", e));
        }
    }

    // 播放成功音效
    function playSuccessSound() {
        try {
            const snd = document.getElementById('successSound');
            snd.currentTime = 0;
            snd.play().catch(e => {
                console.log("音频播放受阻，尝试用户交互后播放:", e);
                // 备用方案：震动反馈
                if (navigator.vibrate) navigator.vibrate(150);
            });
            // 震动反馈
            if (navigator.vibrate) navigator.vibrate(100);
        } catch (e) {
            console.log("播放音效失败:", e);
        }
    }

    // 手动标记资产
    function checkAsset(assetId, assetSn) {
        if (!confirm(`确认标记资产 ${assetSn} 为正常状态吗？`)) {
            return;
        }
        
        fetch(`/asset/inventory/update/${assetId}`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ "status": "正常" })
        })
        .then(res => {
            if(!res.ok) throw new Error(`HTTP错误: ${res.status}`);
            return res.json();
        })
        .then(data => {
            if (data.status === 'success') {
                updateUIRow(assetSn);
                playSuccessSound();
                
                // 显示成功提示
                const Toast = bootstrap.Toast;
                const toastEl = document.createElement('div');
                toastEl.className = 'toast position-fixed bottom-0 end-0 m-3';
                toastEl.role = 'alert';
                toastEl.innerHTML = `
                    <div class="toast-header bg-success text-white">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong class="me-auto">操作成功</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        资产 ${assetSn} 已标记为正常状态
                    </div>
                `;
                document.body.appendChild(toastEl);
                const toast = new Toast(toastEl);
                toast.show();
                setTimeout(() => toastEl.remove(), 3000);
            } else {
                alert("标记失败: " + (data.message || "未知错误"));
            }
        })
        .catch(err => {
            console.error("标记失败:", err);
            alert("标记失败: " + err.message);
        });
    }

    // 页面加载完成后的初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 筛选表单回车提交
        document.querySelectorAll('.filter-form select').forEach(select => {
            select.addEventListener('change', function() {
                this.form.submit();
            });
        });
        
        // 模态框关闭时停止扫码
        document.getElementById('scanModal').addEventListener('hidden.bs.modal', function() {
            stopScanner();
        });
    });
</script>
{% endblock %}