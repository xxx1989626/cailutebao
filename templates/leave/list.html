{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="hr-tabs mb-4">
        <a href="{{ url_for('scheduling.schedule_list') }}" class="{% if request.endpoint == 'scheduling.schedule_list' %}active{% endif %}">ğŸ“… æ’ç­è§†å›¾</a>
        <a href="{{ url_for('posts.list') }}" class="{% if request.endpoint == 'posts.list' %}active{% endif %}">ğŸ› ï¸ å²—ä½è®¾ç½®</a>
        <a href="{{ url_for('trip.trip_list') }}" class="{% if request.endpoint == 'trip.trip_list' %}active{% endif %}">ğŸ’¼ å‡ºå·®è®¾ç½®</a>
        <a href="{{ url_for('leave.leave_list') }}" class="{% if request.endpoint == 'leave.leave_list' %}active{% endif %}">ğŸ“ è¯·å‡ç®¡ç†</a>
    </div>

    <div class="card card-custom">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center py-3">
            <h4 class="mb-0"><i class="bi bi-calendar-check me-2"></i>è¯·å‡è®°å½•ç®¡ç†</h4>
            <a href="{{ url_for('leave.add_leave') }}" class="btn btn-light fw-bold shadow-sm">
                <i class="bi bi-plus-lg text-success"></i> ç™»è®°è¯·å‡è®°å½•
            </a>
        </div>
        
        <div class="card-body p-0"> <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light text-secondary small">
                        <tr>
                            <th class="ps-3">å§“å</th>
                            <th>è¯·å‡ç±»å‹</th>
                            <th>å¼€å§‹æ—¶é—´</th>
                            <th>é¢„è®¡ç»“æŸ</th>
                            <th>å®é™…é”€å‡</th>
                            <th>å¤©æ•°</th>
                            <th>çŠ¶æ€</th>
                            <th>æ˜¯å¦ä¸ŠæŠ¥</th>
                            <th>é™„ä»¶</th>
                            <th class="text-center pe-3">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for leave in leaves %}
                        <tr>
                            <td class="ps-3"><strong>{{ leave.user.name }}</strong></td>
                            <td>
    {% set leave_type_colors = {
        'äº‹å‡': 'bg-primary bg-opacity-10 text-primary border border-primary-subtle',
        'ç—…å‡': 'bg-danger bg-opacity-10 text-danger border border-danger-subtle',
        'å¹´å‡': 'bg-success bg-opacity-10 text-success border border-success-subtle',
        'è°ƒä¼‘': 'bg-warning bg-opacity-10 text-warning border border-warning-subtle',
        'å©šå‡': 'bg-pink bg-opacity-10 text-pink border border-pink-subtle',
        'äº§å‡': 'bg-purple bg-opacity-10 text-purple border border-purple-subtle',
        'å…¶ä»–': 'bg-secondary bg-opacity-10 text-secondary border border-secondary-subtle',
    } %}
    {% set default_color = 'bg-info bg-opacity-10 text-info border border-info-subtle' %}
    <span class="badge {{ leave_type_colors.get(leave.leave_type, default_color) }}">{{ leave.leave_type }}</span>
</td>
                            <td>{{ leave.start_date }}</td>
                            <td>{{ leave.end_date }}</td>
                            <td>{{ leave.actual_end_date or '-' }}</td>
                            <td class="fw-bold">{{ leave.total_days }}</td>
                            <td>
                                {% if leave.status == 'è¯·å‡ä¸­' %}
                                    <span class="badge rounded-pill bg-warning text-dark"><i class="bi bi-clock-history me-1"></i>è¯·å‡ä¸­</span>
                                {% else %}
                                    <span class="badge rounded-pill bg-light text-secondary border">å·²é”€å‡</span>
                                {% endif %}
                            </td>
                            <td>
    {% if leave.is_reported %}
        <span class="badge bg-success"><i class="bi bi-check"></i> å·²ä¸ŠæŠ¥</span>
    {% else %}
        <span class="badge bg-secondary"><i class="bi bi-x"></i> æœªä¸ŠæŠ¥</span>
    {% endif %}
</td>
                            <td>
                                {% if leave.attachments %}
                                <div class="d-flex flex-wrap gap-1">
                                    {% for path in leave.attachments %}
                                    <a href="/{{ path }}" target="_blank" class="thumb-link rounded overflow-hidden" style="width: 32px; height: 32px;">
                                        {% if path.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                                        <img src="/{{ path }}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <i class="bi bi-file-earmark-image text-muted" style="display: none; font-size: 14px; line-height: 32px; text-align: center;"></i>
                                        {% else %}
                                        <div class="bg-light d-flex align-items-center justify-content-center h-100">
                                            <i class="bi bi-file-pdf text-danger" style="font-size: 16px;"></i>
                                        </div>
                                        {% endif %}
                                    </a>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <span class="text-muted small">æ— </span>
                                {% endif %}
                            </td>
                            <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-sm btn-outline-info"
                                    onclick="copyLeaveMsg('{{ leave.user.name }}', '{{ leave.leave_type }}', '{{ leave.reason }}', '{{ leave.start_date }}', '{{ leave.end_date }}', '{{ leave.total_days }}', 'è”¡è·¯æ´¾å‡ºæ‰€')">
                                    <i class="bi bi-share"></i> å¤åˆ¶æŠ¥å¤‡
                                </button>
                                {% if leave.status == 'è¯·å‡ä¸­' %}
                                <a href="{{ url_for('leave.finish_leave', id=leave.id) }}" class="btn btn-outline-success">
                                    <i class="bi bi-check-circle"></i> é”€å‡
                                </a>
                                <a href="{{ url_for('leave.edit_leave', id=leave.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-calendar-plus"></i> å»¶æœŸ/ä¿®æ”¹
                                </a>
                                {% endif %}
                                {% if current_user.username == 'admin' %}
                                <a href="{{ url_for('leave.delete_leave', id=leave.id) }}" class="btn btn-outline-danger"
                                    onclick="return confirm('ç¡®è®¤åˆ é™¤è¯¥è®°å½•å—ï¼Ÿ')">
                                    <i class="bi bi-trash"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// ä¸¥æ ¼ä¿ç•™åŸæœ‰çš„ copyLeaveMsg é€»è¾‘
function copyLeaveMsg(name, type, reason, startDate, endDate, totalDays, post) {
    const today = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
    const text = `ä¸ŠæŠ¥æ—¥æœŸï¼š${today}\né©»ã€€ã€€ç‚¹ï¼š${post || 'è”¡è·¯æ´¾å‡ºæ‰€'}\nè¯· å‡ äººï¼š${name}\nè¯·å‡ç±»å‹ï¼š${type}\nè¯·å‡æ—¶é•¿ï¼š${totalDays}å¤©\nè¯·å‡å‘¨æœŸï¼š${startDate} è‡³ ${endDate}\näº‹ã€€ã€€ç”±ï¼š${reason}`;
    
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => alert("âœ… æ ‡å‡†æŠ¥å¤‡æ ¼å¼å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼"));
    } else {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        alert("âœ… æ ‡å‡†æŠ¥å¤‡æ ¼å¼å·²å¤åˆ¶ï¼");
        document.body.removeChild(textArea);
    }
}
</script>
<style>
/* ä¿æŒä¸ä½ çš„æ’ç­ç³»ç»Ÿä¸€è‡´çš„é£æ ¼ */
.hr-tabs { border-bottom: 2px solid #eee; display: flex; gap: 20px; }
.hr-tabs a { text-decoration: none; color: #666; padding: 10px 5px; border-bottom: 3px solid transparent; transition: all 0.3s; font-weight: 500; }
.hr-tabs a:hover { color: #0d6efd; }
.hr-tabs a.active { color: #0d6efd; border-bottom-color: #0d6efd; }
.form-control-color { padding: 0.2rem; cursor: pointer; }
.table-hover tbody tr:hover { background-color: rgba(13, 110, 253, 0.02); }
</style>
{% endblock %}