{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
    <i class="bi bi-pencil-square"></i> 
    {{ '编辑请假记录' if leave else '登记请假申请' }}
</h5>
            </div>
            <div class="card-body">
                

<form method="POST" enctype="multipart/form-data">
    <input type="hidden" name="delete_attachments" id="deleteAttachmentsInput" value="">
    <div class="mb-3">
        <label class="form-label">请假人员</label>
        <select name="user_id" class="form-select" required {% if leave %}disabled{% endif %}>
            {% for emp in employees %}
            <option value="{{ emp.id }}" {% if leave and leave.user_id == emp.id %}selected{% endif %}>
                {{ emp.name }} ({{ emp.post }})
            </option>
            {% endfor %}
        </select>
        {% if leave %}<input type="hidden" name="user_id" value="{{ leave.user_id }}">{% endif %}
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">请假类型</label>
            <select name="leave_type" class="form-select" required>
                {% for type in ['事假', '病假', '年假', '调休', '婚假', '产假', '其他'] %}
                <option value="{{ type }}" {% if leave and leave.leave_type == type %}selected{% endif %}>{{ type }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">开始日期</label>
            <input type="date" name="start_date" class="form-control" 
                   value="{{ leave.start_date if leave else form_default_date }}" required>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">预计结束日期</label>
            <input type="date" name="end_date" class="form-control" 
                   value="{{ leave.end_date if leave else '' }}" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">天数估算</label>
            <input type="number" step="0.5" name="total_days" class="form-control" 
                   value="{{ leave.total_days if leave else '' }}">
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">请假事由</label>
        <textarea name="reason" class="form-control" rows="3">{{ leave.reason if leave else '' }}</textarea>
    </div>
    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isReported" name="is_reported" 
                               {% if leave and leave.is_reported %}checked{% endif %}>
                        <label class="form-check-label" for="isReported">
                            <i class="bi bi-flag text-warning"></i> 是否上报
                        </label>
                    </div>
    <div class="mb-3">
        <label class="form-label fw-bold">证明材料</label>
        <div id="dropZone" class="border border-2 border-dashed rounded p-4 text-center bg-light" style="cursor: pointer;">
            <i class="bi bi-cloud-arrow-up fs-2 text-primary"></i>
            <p class="mb-0">将文件拖拽至此处，或点击上传</p>
            <input type="file" name="files" id="fileInput" class="form-control d-none" multiple accept="image/*,.pdf">
        </div>
        <div id="imagePreview" class="mt-2 d-flex flex-wrap gap-2">
    {% if leave and leave.attachments %}
        {% for path in leave.attachments %}
        <div class="thumb-remove-wrapper position-relative" data-path="{{ path }}" style="cursor: pointer;" title="点击删除">
            {% if path.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                <img src="/{{ path }}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
            {% else %}
                <div class="alert alert-secondary p-2 m-0"><i class="bi bi-file-pdf"></i> PDF文件</div>
            {% endif %}
            <div class="remove-overlay">
                <i class="bi bi-x-circle-fill text-danger"></i>
            </div>
        </div>
        {% endfor %}
    {% endif %}
</div>
        <small class="text-muted">文件预览。</small>
    </div>
    
    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <a href="{{ url_for('leave.leave_list') }}" class="btn btn-light">取消</a>
        <button type="submit" class="btn btn-primary px-5">保存修改</button>
    </div>
    </form>
    </div>
    </div>
    </div>
    </div>
    
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const startInput = document.querySelector('input[name="start_date"]');
    const endInput = document.querySelector('input[name="end_date"]');
    const daysInput = document.querySelector('input[name="total_days"]');

    function calculateLeaveDays() {
        const startVal = startInput.value;
        const endVal = endInput.value;

        // --- 新增：最小值联动逻辑 ---
        if (startVal) {
            endInput.min = startVal; // 设置结束日期的最小值为开始日期
        }
        // ---------------------------

        if (startVal && endVal) {
            const startDate = new Date(startVal);
            const endDate = new Date(endVal);
            
            if (endDate >= startDate) {
                // 计算差值并 +1（包含首尾）
                const diffTime = endDate.getTime() - startDate.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                daysInput.value = diffDays;
            } else {
                daysInput.value = 0;
            }
        }
    }

    // 监听两个日期控件的变化
    // 建议把 'change' 改为 'input'，这样选择日期后会立即触发，不用等失去焦点
    startInput.addEventListener('input', calculateLeaveDays);
    endInput.addEventListener('input', calculateLeaveDays);

    // 如果是编辑页面，初始化时跑一遍，确保天数能显示出来
    if (startInput.value && endInput.value) {
        calculateLeaveDays();
    }
});
</script>
<script>
// 存储待删除的现有附件路径
let deletedFiles = [];

function renderPreview() {
    const previewContainer = document.getElementById('imagePreview');
    // 渲染“现有附件”（仅在编辑模式下有效）
    const existingAttachments = document.querySelectorAll('.existing-item');
    
    // 这里我们直接给现有的图片/PDF添加点击删除功能
    document.querySelectorAll('.thumb-remove-wrapper').forEach(wrapper => {
        wrapper.onclick = function() {
            const path = this.getAttribute('data-path');
            if (path) {
                deletedFiles.push(path);
                document.getElementById('deleteAttachmentsInput').value = JSON.stringify(deletedFiles);
            }
            this.remove(); // 从界面移除
        };
    });
}
// 修改原有的文件选择预览逻辑，增加“点击移除”新选文件的功能
document.getElementById('fileInput').addEventListener('change', function(e) {
    const previewContainer = document.getElementById('imagePreview');
    // 注意：如果是追加上传，这里不一定清空，但通常 input file 改变是全量替换的
    previewContainer.querySelectorAll('.new-preview').forEach(el => el.remove()); 

    for (const file of e.target.files) {
        const reader = new FileReader();
        const isImg = file.type.startsWith('image/');
        
        reader.onload = function(event) {
            const div = document.createElement('div');
            div.className = 'new-preview position-relative';
            div.style.cursor = 'pointer';
            div.title = '点击移除';
            
            let content = isImg 
                ? `<img src="${event.target.result}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">`
                : `<div class="alert alert-secondary p-2 m-0"><i class="bi bi-file-pdf"></i> PDF</div>`;
            
            // 悬浮删除小图标样式
            div.innerHTML = `
                ${content}
                <div class="remove-overlay">
                    <i class="bi bi-x-circle-fill text-danger"></i>
                </div>
            `;
            
            div.onclick = () => {
                // 注意：由于浏览器安全限制，无法从 input.files 中删除单个文件
                // 建议提示用户重新选择，或者在后端处理。这里简单实现从界面移除预览。
                div.remove();
            };
            previewContainer.appendChild(div);
        }
        if (isImg) reader.readAsDataURL(file);
        else reader.onload({target: {result: ''}}); // PDF不需要readData
    }
});

// 在页面加载时初始化现有附件的删除事件
document.addEventListener('DOMContentLoaded', renderPreview);
// 拖拽上传逻辑
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    // 1. 点击拖拽框触发文件选择
    dropZone.addEventListener('click', () => fileInput.click());

    // 2. 阻止浏览器默认打开文件的行为
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    // 3. 拖拽高亮效果
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('border-primary', 'bg-white'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('border-primary', 'bg-white'), false);
    });

    // 4. 处理拖拽释放
    dropZone.addEventListener('drop', e => {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            // 将拖拽的文件赋值给 input 控件
            fileInput.files = files;
            // 手动触发 change 事件以运行你原有的预览逻辑
            fileInput.dispatchEvent(new Event('change'));
        }
    });
});

</script>

<style>
    #dropZone {
        transition: all 0.3s ease;
        border-style: dashed !important;
    }
    #dropZone:hover {
        border-color: #0d6efd !important;
        background-color: #f8f9fa !important;
    }
    .bi-cloud-arrow-up {
        opacity: 0.6;
    }
    .remove-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
    border-radius: 0.25rem;
}
.thumb-remove-wrapper:hover .remove-overlay, 
.new-preview:hover .remove-overlay {
    opacity: 1;
}
.remove-overlay i {
    font-size: 1.5rem;
}
</style>
{% endblock %}
