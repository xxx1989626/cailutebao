{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
    <i class="bi bi-pencil-square"></i> 
    {{ '编辑请假记录' if leave else '登记请假申请' }}
</h5>
            </div>
            <div class="card-body">
                

<form method="POST" enctype="multipart/form-data">
    <div class="mb-3">
        <label class="form-label">请假人员</label>
        <select name="user_id" class="form-select" required {% if leave %}disabled{% endif %}>
            {% for emp in employees %}
            <option value="{{ emp.id }}" {% if leave and leave.user_id == emp.id %}selected{% endif %}>
                {{ emp.name }} ({{ emp.post }})
            </option>
            {% endfor %}
        </select>
        {% if leave %}<input type="hidden" name="user_id" value="{{ leave.user_id }}">{% endif %}
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">请假类型</label>
            <select name="leave_type" class="form-select" required>
                {% for type in ['事假', '病假', '年假', '调休', '婚庆/产假'] %}
                <option value="{{ type }}" {% if leave and leave.leave_type == type %}selected{% endif %}>{{ type }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">开始日期</label>
            <input type="date" name="start_date" class="form-control" 
                   value="{{ leave.start_date if leave else form_default_date }}" required>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">预计结束日期</label>
            <input type="date" name="end_date" class="form-control" 
                   value="{{ leave.end_date if leave else '' }}" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">天数估算</label>
            <input type="number" step="0.5" name="total_days" class="form-control" 
                   value="{{ leave.total_days if leave else '' }}">
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">请假事由</label>
        <textarea name="reason" class="form-control" rows="3">{{ leave.reason if leave else '' }}</textarea>
    </div>
    <div class="mb-3">
        <label class="form-label fw-bold">证明材料</label>
        <div id="dropZone" class="border border-2 border-dashed rounded p-4 text-center bg-light" style="cursor: pointer;">
            <i class="bi bi-cloud-arrow-up fs-2 text-primary"></i>
            <p class="mb-0">将文件拖拽至此处，或点击上传</p>
            <input type="file" name="files" id="fileInput" class="form-control d-none" multiple accept="image/*,.pdf">
        </div>
        <div id="imagePreview" class="mt-2 d-flex flex-wrap gap-2"></div>
        <small class="text-muted">文件预览。</small>
    </div>
    
    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <a href="{{ url_for('leave.leave_list') }}" class="btn btn-light">取消</a>
        <button type="submit" class="btn btn-primary px-5">保存修改</button>
    </div>
    </form>
    </div>
    </div>
    </div>
    </div>
    
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const startInput = document.querySelector('input[name="start_date"]');
    const endInput = document.querySelector('input[name="end_date"]');
    const daysInput = document.querySelector('input[name="total_days"]');

    function calculateLeaveDays() {
        const startVal = startInput.value;
        const endVal = endInput.value;

        // --- 新增：最小值联动逻辑 ---
        if (startVal) {
            endInput.min = startVal; // 设置结束日期的最小值为开始日期
        }
        // ---------------------------

        if (startVal && endVal) {
            const startDate = new Date(startVal);
            const endDate = new Date(endVal);
            
            if (endDate >= startDate) {
                // 计算差值并 +1（包含首尾）
                const diffTime = endDate.getTime() - startDate.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                daysInput.value = diffDays;
            } else {
                daysInput.value = 0;
            }
        }
    }

    // 监听两个日期控件的变化
    // 建议把 'change' 改为 'input'，这样选择日期后会立即触发，不用等失去焦点
    startInput.addEventListener('input', calculateLeaveDays);
    endInput.addEventListener('input', calculateLeaveDays);

    // 如果是编辑页面，初始化时跑一遍，确保天数能显示出来
    if (startInput.value && endInput.value) {
        calculateLeaveDays();
    }
});
</script>
<script>
// 图片预览逻辑
document.getElementById('fileInput').addEventListener('change', function(e) {
    const previewContainer = document.getElementById('imagePreview');
    previewContainer.innerHTML = ''; // 清空旧预览

    for (const file of e.target.files) {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const imgWrapper = document.createElement('div');
                imgWrapper.style.position = 'relative';
                imgWrapper.innerHTML = `
                    <img src="${event.target.result}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                `;
                previewContainer.appendChild(imgWrapper);
            }
            reader.readAsDataURL(file);
        } else if (file.type === 'application/pdf') {
            const pdfIcon = document.createElement('div');
            pdfIcon.className = 'alert alert-secondary p-2';
            pdfIcon.innerHTML = `<i class="bi bi-file-pdf"></i> PDF文件`;
            previewContainer.appendChild(pdfIcon);
        }
    }
});
// 拖拽上传逻辑
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    // 1. 点击拖拽框触发文件选择
    dropZone.addEventListener('click', () => fileInput.click());

    // 2. 阻止浏览器默认打开文件的行为
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    // 3. 拖拽高亮效果
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('border-primary', 'bg-white'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('border-primary', 'bg-white'), false);
    });

    // 4. 处理拖拽释放
    dropZone.addEventListener('drop', e => {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            // 将拖拽的文件赋值给 input 控件
            fileInput.files = files;
            // 手动触发 change 事件以运行你原有的预览逻辑
            fileInput.dispatchEvent(new Event('change'));
        }
    });
});

</script>

<style>
    #dropZone {
        transition: all 0.3s ease;
        border-style: dashed !important;
    }
    #dropZone:hover {
        border-color: #0d6efd !important;
        background-color: #f8f9fa !important;
    }
    .bi-cloud-arrow-up {
        opacity: 0.6;
    }
</style>
{% endblock %}
