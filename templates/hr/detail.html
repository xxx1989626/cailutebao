{% extends "base.html" %}

{% block title %}{{ cycles[0].name }} ({{ id_card }}) - 任职档案{% endblock %}

{% block content %}
<!-- 自定义样式 -->
<style>
    /* 页面整体样式 */
    .hr-detail-card {
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: none;
        overflow: hidden;
    }
    
    .hr-detail-card .card-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
        padding: 1.25rem 1.5rem;
        border-bottom: none;
    }
    
    /* 任职周期卡片样式 */
    .cycle-card {
        border-radius: 8px;
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .cycle-card.active-cycle {
        border: 2px solid #0d6efd;
        box-shadow: 0 8px 24px rgba(13, 110, 253, 0.15);
    }
    
    .cycle-card-header {
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .cycle-card.active-cycle .cycle-card-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
        color: white;
    }
    
    /* 基本信息表格样式 */
    .info-table th {
        width: 140px;
        font-weight: 600;
        color: #495057;
        vertical-align: top;
        padding-top: 0.3rem;
        padding-bottom: 0.3rem;
    }
    
    .info-table td {
        padding-top: 0.3rem;
        padding-bottom: 0.3rem;
    }
    
    /* 装备领用区域样式 */
    .equipment-section {
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e9ecef;
    }
    
    .equipment-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .equipment-item {
        transition: all 0.2s ease;
    }
    
    .equipment-item:hover {
        background-color: #f8f9fa;
    }
    
    /* 档案记录样式 */
    .archive-record {
        transition: all 0.2s ease;
    }
    
    .archive-record:hover {
        background-color: #f8f9fa;
    }
    
    /* 滚动条美化 */
    .equipped-scroll-container {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .equipped-scroll-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .equipped-scroll-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .equipped-scroll-container::-webkit-scrollbar-thumb {
        background: #ced4da;
        border-radius: 10px;
    }
    
    .equipped-scroll-container::-webkit-scrollbar-thumb:hover {
        background: #adb5bd;
    }
    
    /* 按钮样式优化 */
    .btn-action {
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* 警告闪烁效果 */
    @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .warning-blink {
        animation: blink 2s infinite;
    }
    
    /* 模态框样式优化 */
    .modal-content {
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        border: none;
    }
    
    .modal-header {
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-footer {
        border-top: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
    }
    
    /* 响应式优化 */
    @media (max-width: 768px) {
        .cycle-card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .photo-container {
            margin-bottom: 1.5rem !important;
        }
        
        .info-table th {
            width: 100px;
            font-size: 0.875rem;
        }
        
        .equipment-section {
            font-size: 0.875rem;
        }
        
        .modal-lg {
            max-width: 95%;
        }
    }
    
    /* 空状态样式 */
    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: #6c757d;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    
    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    /* 标签样式优化 */
    .badge-custom {
        border-radius: 6px;
        padding: 0.35em 0.65em;
        font-weight: 500;
    }
</style>

<div class="container mt-4 mb-5">
    <!-- 员工档案主卡片 -->
    <div class="card hr-detail-card">
        <!-- 卡片头部 -->
        <div class="card-header bg-primary text-white d-flex flex-wrap justify-content-between align-items-center gap-3">
            <h4 class="mb-0 d-flex align-items-center">
                <i class="bi bi-person-lines-fill me-2"></i> 
                {{ cycles[0].name }} - 任职档案（共 {{ cycles|length }} 次）
            </h4>
            <div class="d-flex gap-2 align-items-center">
                <a href="{{ url_for('hr.hr_list') }}" class="btn btn-light btn-sm btn-action">
                    <i class="bi bi-arrow-left-short me-1"></i> 返回列表
                </a>
                <span class="badge bg-light text-dark fs-6 px-3 py-1">
                    {{ cycles[0].status }}
                </span>
            </div>
        </div>
        
        <!-- 卡片主体 -->
        <div class="card-body p-4">
            <div class="tab-content">
                <!-- 查看模式 -->
                <div class="tab-pane fade show active" id="view_tab">
                    {% for cycle in cycles %}
                    <!-- 任职周期卡片 -->
                    <div class="card mb-4 cycle-card {% if cycle.status == '在职' %}active-cycle{% endif %}">
                        <!-- 周期头部 -->
                        <div class="cycle-card-header {% if cycle.status == '在职' %}bg-primary text-white{% endif %}">
                            <strong class="d-flex align-items-center">
                                <span>第 {{ cycles|length - loop.index + 1 }} 次任职</span>
                                <span class="ms-2 text-muted {% if cycle.status == '在职' %}text-white-50{% endif %}">
                                    （{{ format_date(cycle.hire_date) }} ~ {{ format_date(cycle.departure_date) or '至今' }}）
                                </span>
                                <span class="ms-2 badge bg-light text-dark {% if cycle.status == '在职' %}bg-white text-primary{% endif %}">
                                    在职 {{ cycle.hire_date | calc_work_duration(cycle.departure_date) }}
                                </span>
                            </strong>
                            
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-light text-dark">{{ cycle.status }}</span>
                                
                                <!-- 重置密码按钮 -->
                                {% if current_user.role == 'admin' and associated_user %}
                                <form action="{{ url_for('auth.reset_user_password', user_id=associated_user.id) }}" 
                                      method="POST" 
                                      style="display:inline;" 
                                      onsubmit="return confirm('确定要将该用户 [{{ associated_user.name }}] 的密码重置为 123456 吗？');">
                                    <button type="submit" class="btn btn-sm btn-outline-warning btn-action">
                                        <i class="bi bi-shield-lock me-1"></i> 重置密码
                                    </button>
                                </form>
                                {% elif current_user.role == 'admin' %}
                                <span class="badge bg-light text-dark">未开通账号</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- 周期主体 -->
                        <div class="card-body p-4">
                            <!-- 基本信息区域 -->
                            <div class="row">
                                <!-- 员工照片 -->
                                <div class="col-md-3 text-center mb-3 photo-container">
                                    {% if cycle.photo_path %}
                                    <img src="/{{ cycle.photo_path }}" 
                                         class="rounded-circle shadow-sm border border-3 border-white" 
                                         width="180" height="180" 
                                         alt="{{ cycle.name }}照片"
                                         loading="lazy">
                                    {% else %}
                                    <div class="bg-light rounded-circle shadow-sm d-flex align-items-center justify-content-center text-muted border border-3 border-white"
                                         style="width:180px;height:180px;font-size:24px;">
                                        <span class="text-uppercase">{{ cycle.name[:1] }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- 基本信息表格 -->
                                <div class="col-md-9">
                                    <table class="table table-sm table-borderless info-table">
                                        <tr>
                                            <th>身份证</th>
                                            <td class="fw-medium">{{ cycle.id_card }}</td>
                                        </tr>
                                        <tr>
                                            <th>性别</th>
                                            <td>{{ cycle.gender or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>出生日期</th>
                                            <td>{{ format_date(cycle.birthday) or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>手机</th>
                                            <td>{{ cycle.phone or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>民族</th>
                                            <td>{{ cycle.ethnic or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>政治面貌</th>
                                            <td>{{ cycle.politics or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>学历</th>
                                            <td>{{ cycle.education or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>薪资模式</th>
                                            <td>{{ cycle.salary_mode }}</td>
                                        </tr>
                                        <tr>
                                            <th>职务/岗位</th>
                                            <td>{{ cycle.position or '-' }} / {{ cycle.post or '-' }}</td>
                                        </tr>
                                        <tr>
                                            <th>户籍地址</th>
                                            <td>{{ [cycle.household_province, cycle.household_city,
                                                cycle.household_district, cycle.household_town, cycle.household_village, cycle.household_detail]
                                                | reject('none') | join(' ') or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>居住地址</th>
                                            <td>{{ [cycle.residence_province, cycle.residence_city,
                                                cycle.residence_district, cycle.residence_town, cycle.residence_village, cycle.residence_detail]
                                                | reject('none') | join(' ') or '未填写' }}</td>
                                        </tr>
                                        <tr>
                                            <th>兵役情况</th>
                                            <td>{% if cycle.military_service %}入伍时间:{{
                                                format_date(cycle.enlistment_date)
                                                }}，部队番号:{{ cycle.unit_number }}，兵种:{{ cycle.branch }}，退伍时间:{{
                                                format_date(cycle.discharge_date) }}{% else %}无{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <th>驾驶证</th>
                                            <td>{% if cycle.has_license %}初领时间:{{ format_date(cycle.license_date)
                                                }}，准驾车型:{{
                                                cycle.license_type }}，有效期至:{{ format_date(cycle.license_expiry) }}{%
                                                else
                                                %}无{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <th>保安员证</th>
                                            <td>
                                                保安证编号:{{ cycle.security_license_number or '无' }}
                                                {% if cycle.security_license_date %}
                                                ,发证时间: {{ format_date(cycle.security_license_date) }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>紧急联系人</th>
                                            <td>{{ cycle.emergency_name or '' }}（{{ cycle.emergency_relation or '' }}）{{
                                                cycle.emergency_phone or '' }}</td>
                                        </tr>
                                        <tr>
                                            <th>工作服尺码</th>
                                            <td>帽围{{ cycle.hat_size or '-' }} | 短袖{{ cycle.short_sleeve or '-' }} | 长袖{{
                                                cycle.long_sleeve or '-' }} | 冬装{{ cycle.winter_uniform or '-' }} | 鞋码{{
                                                cycle.shoe_size or '-' }}</td>
                                        </tr>
                                    </table>

                                    <!-- 离职原因 -->
                                    {% if cycle.status == '离职' and cycle.archives %}
                                    {% set archives = cycle.archives | fromjson %}
                                    {% if archives.departure_reason %}
                                    <div class="alert alert-warning mt-4 p-3">
                                        <div class="d-flex align-items-start">
                                            <i class="bi bi-info-circle flex-shrink-0 me-2 mt-1 text-warning"></i>
                                            <div>
                                                <strong class="text-warning">离职原因：</strong> 
                                                {{ archives.departure_reason }}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                    
                                    <!-- 装备领用情况 -->
                                    <div class="card mt-5 equipment-section shadow-sm border-0">
                                        <div class="equipment-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0 fw-bold text-dark d-flex align-items-center">
                                                <i class="bi bi-shield-check text-primary me-2"></i> 装备领用情况
                                            </h6>
                                            <div class="d-flex align-items-center">
                                                {% if cycle.status == '在职' and perm.can('asset.issue') %}
                                                <button type="button" class="btn btn-warning btn-sm fw-bold shadow-sm btn-action" 
                                                        data-bs-toggle="modal" data-bs-target="#quickIssueModal">
                                                    <i class="bi bi-plus-lg me-1"></i> 批量发放资产
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="card-body p-0">
                                            {% set equipped_assets = get_equipped_assets(cycle.id) %}
                                            {% if equipped_assets %}
                                            {% set can_view_asset = perm.can('asset.view') %}
                                            <div class="equipped-scroll-container">
                                                <div class="list-group list-group-flush">
                                                    {% for item in equipped_assets | reverse %}
                                                    {% if can_view_asset %}
                                                    <a href="{{ url_for('asset.asset_detail', asset_id=item.asset.id) }}"
                                                       class="list-group-item list-group-item-action py-3 equipment-item">
                                                    {% else %}
                                                    <div class="list-group-item py-3 equipment-item">
                                                    {% endif %}
                                                        <div class="row align-items-center">
                                                            <div class="col-auto">
                                                                <div class="rounded-circle bg-primary bg-opacity-10 p-2">
                                                                    <i class="bi bi-box-seam text-primary"></i>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <strong class="d-block text-dark">
                                                                    {{ item.asset.name }}
                                                                    {% if can_view_asset %}
                                                                    <i class="bi bi-arrow-right-short text-muted"></i>
                                                                    {% endif %}
                                                                </strong>
                                                                <div class="d-flex flex-wrap align-items-center gap-2 mt-1">
                                                                    <span class="badge bg-light text-secondary border">编号: {{ item.asset.number }}</span>
                                                                    <span class="badge bg-primary-subtle text-primary">数量 × {{ item.quantity }}</span>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4 text-end">
                                                                <div class="small text-muted">发放于: {{ format_datetime(item.issue_date) }}</div>
                                                                <div class="small text-muted">发放人: <span class="text-dark">{{ item.issued_by or '系统' }}</span></div>
                                                                {% if item.note %}
                                                                <div class="mt-1">
                                                                    <span class="badge bg-info-subtle text-info fw-normal">
                                                                        <i class="bi bi-info-circle me-1"></i>{{ item.note }}
                                                                    </span>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    {% if can_view_asset %}
                                                    </a>
                                                    {% else %}
                                                    </div>
                                                    {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            
                                            <div class="card-footer bg-white py-3">
                                                <p class="small text-muted mb-0 text-center">
                                                    共领用 {{ equipped_assets|length }} 项资产 ·
                                                    <span class="warning-blink">
                                                        <i class="bi bi-exclamation-triangle-fill text-danger me-1"></i>
                                                        <strong class="text-danger">如有遗失或人为损坏，每项罚款 200 元</strong>
                                                    </span>
                                                    · <span class="opacity-75">向下滚动查看更多</span>
                                                </p>
                                            </div>
                                            {% else %}
                                            <div class="empty-state">
                                                <i class="bi bi-inbox"></i>
                                                <p class="mb-0">暂未领用任何装备</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <hr class="mt-5 mb-0 border-dark border-2 opacity-100">

                                    <!-- 档案记录区域 -->
                                    <div class="d-flex flex-wrap justify-content-between align-items-center mt-5 border-bottom pb-3 mb-4 gap-2">
                                        <h6 class="mb-0 fw-bold">
                                            <i class="bi bi-file-earmark-text me-1 text-primary"></i> 档案记录
                                        </h6>
                                        {% if cycle.status == '在职' and perm.can('hr.edit') %}
                                        <button type="button" class="btn btn-sm btn-success btn-action" 
                                                data-bs-toggle="modal" data-bs-target="#addArchiveModal">
                                            <i class="bi bi-plus-circle me-1"></i> 添加档案
                                        </button>
                                        {% endif %}
                                    </div>
                                    
                                    {# 1. 首先尝试解析 JSON 数据 #}
                                    {% set archives = cycle.archives | fromjson if cycle.archives else none %}
                                    
                                    {# 2. 统一判断：只有当 archives 存在且 archive_records 不为空时才显示列表 #}
                                    {% if archives and archives.archive_records %}
                                    <div class="list-group mb-4 shadow-sm">
                                        {% for record in archives.archive_records | reverse %}
                                        <div class="list-group-item list-group-item-action archive-record">
                                            <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                                                <h6 class="mb-0 d-flex align-items-center">
                                                    <span class="badge-custom me-2 {% if record.type == '奖励' %}bg-success{% elif record.type == '处罚' %}bg-danger{% else %}bg-info{% endif %} text-white">
                                                        {{ record.type }}
                                                    </span>
                                                    <strong>{{ record.title }}</strong>
                                                </h6>
                                                <small class="text-secondary fw-bold">{{ format_datetime(record.date) }}</small>
                                            </div>
                                            
                                            <div class="mb-2">
                                                <small class="text-muted">操作人：{{ record.operator or '未知' }}</small>
                                            </div>
                                    
                                            {% if record.description %}
                                            <p class="mb-3 mt-1 small text-muted border-start border-2 border-primary ps-3" style="white-space: pre-wrap;">
                                                {{ record.description }}
                                            </p>
                                            {% endif %}
                                    
                                            {% if record.file_paths %}
                                            <div class="mt-2">
                                                <label class="small fw-bold text-muted">附件：</label>
                                                <div class="d-flex flex-wrap gap-2 mt-1">
                                                    {% for file_path in record.file_paths %}
                                                    {% if file_path.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                                                    <a href="/{{ file_path }}" target="_blank" class="d-inline-block">
                                                        <img src="/{{ file_path }}" class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;"
                                                            alt="附件图片">
                                                    </a>
                                                    {% else %}
                                                    <a href="/{{ file_path }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-file-pdf"></i> 附件{{ loop.index }}
                                                    </a>
                                                    {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="empty-state mb-4">
                                        <i class="bi bi-file-text"></i>
                                        <p class="mb-0">暂无档案记录</p>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- 添加档案记录模态框 -->
                                    {% if cycle.status == 'in_service' or cycle.status == '在职' %}
                                    {% if perm.can('hr.edit') %}
                                    <div class="modal fade" id="addArchiveModal" tabindex="-1"
                                        aria-labelledby="addArchiveModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content border-0 shadow">
                                                <div class="modal-header bg-success text-white">
                                                    <h5 class="modal-title" id="addArchiveModalLabel">
                                                        <i class="bi bi-file-earmark-plus me-1"></i> 新增档案记录
                                                    </h5>
                                                    <button type="button" class="btn-close btn-close-white"
                                                        data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form method="POST"
                                                    action="{{ url_for('hr.add_archive', cycle_id=cycle.id) }}"
                                                    enctype="multipart/form-data">
                                                    <div class="modal-body p-4">
                                                        <div class="row g-3">
                                                            <div class="col-md-6">
                                                                <label class="form-label fw-bold small">记录类型</label>
                                                                <select name="record_type"
                                                                    class="form-select border-primary-subtle" required>
                                                                    <option value="奖励">奖励</option>
                                                                    <option value="处罚">处罚</option>
                                                                    <option value="其他" selected>其他</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label fw-bold small">记录日期</label>
                                                                <input type="date" name="record_date"
                                                                    class="form-control border-primary-subtle"
                                                                    value="{{ today_str() }}" required>
                                                            </div>
                                                            <div class="col-12">
                                                                <label class="form-label fw-bold small">标题/简述</label>
                                                                <input type="text" name="title"
                                                                    class="form-control border-primary-subtle"
                                                                    placeholder="请输入档案标题" required>
                                                            </div>
                                                            <div class="col-12">
                                                                <label class="form-label fw-bold small">详细说明</label>
                                                                <textarea name="description"
                                                                    class="form-control border-primary-subtle" rows="4"
                                                                    placeholder="请详细描述相关事宜..."></textarea>
                                                            </div>
                                                            <div class="col-12">
                                                                {% include '_attachment.html' with context %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer bg-light border-0">
                                                        <button type="button" class="btn btn-secondary px-4 btn-action"
                                                            data-bs-dismiss="modal">取消</button>
                                                        <button type="submit"
                                                            class="btn btn-success px-5 shadow-sm btn-action">立即提交</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}

                                    <!-- 离职操作 -->
                                    {% if cycle.status == '在职' %}
                                    {% if perm.can('hr.edit') %}
                                    <div class="mt-5 text-end">
                                        <button type="button" class="btn btn-warning btn-lg btn-action" 
                                                data-bs-toggle="modal" data-bs-target="#departureModal{{ cycle.id }}">
                                            <i class="bi bi-person-dash me-1"></i> 标记离职
                                        </button>
                                    </div>

                                    <div class="modal fade" id="departureModal{{ cycle.id }}" tabindex="-1">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <div class="modal-header bg-warning text-dark">
                                                    <h5 class="modal-title">
                                                        <i class="bi bi-person-x me-1"></i> 确认离职 - {{ cycle.name }}
                                                    </h5>
                                                    <button type="button" class="btn-close"
                                                        data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="POST"
                                                    action="{{ url_for('hr.departure', cycle_id=cycle.id) }}">
                                                    <div class="modal-body">
                                                        <!-- 未归还资产提醒 -->
                                                        {% set unreturned = get_unreturned_assets(cycle.id) %}
                                                        {% if unreturned %}
                                                        <div class="alert alert-danger mb-4 p-3">
                                                            <div class="d-flex align-items-start">
                                                                <i class="bi bi-exclamation-triangle flex-shrink-0 me-2 mt-1 text-danger"></i>
                                                                <div>
                                                                    <strong>检测到未归还资产（共 {{ unreturned|length }} 件）：</strong>
                                                                    <ul class="mb-0 mt-2">
                                                                        {% for a in unreturned %}
                                                                        <li>{{ a.name }} (编号: {{ a.number }})</li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% else %}
                                                        <div class="alert alert-success mb-4 p-3">
                                                            <div class="d-flex align-items-center">
                                                                <i class="bi bi-check-circle me-2 text-success"></i>
                                                                <div>当前无未归还资产</div>
                                                            </div>
                                                        </div>
                                                        {% endif %}

                                                        <!-- 强制勾选项目 -->
                                                        <div class="form-check mb-4 p-2 border rounded">
                                                            <input class="form-check-input" type="checkbox"
                                                                name="confirm_return" id="confirm_return{{ cycle.id }}"
                                                                required>
                                                            <label class="form-check-label fw-bold"
                                                                for="confirm_return{{ cycle.id }}">
                                                                已归还全部装备（系统将自动归还所有个人分配资产）
                                                            </label>
                                                        </div>

                                                        <div class="form-check mb-4 p-2 border rounded">
                                                            <input class="form-check-input" type="checkbox"
                                                                name="settle_utilities"
                                                                id="settle_utilities{{ cycle.id }}" required>
                                                            <label class="form-check-label fw-bold"
                                                                for="settle_utilities{{ cycle.id }}">
                                                                已结算水电费
                                                            </label>
                                                        </div>

                                                        <div class="mb-3">
                                                            <label class="form-label fw-bold">离职日期</label>
                                                            <input type="date" name="departure_date"
                                                                class="form-control" value="{{ today_str() }}"
                                                                min="0001-01-01" max="9999-12-31" required>
                                                        </div>

                                                        <div class="mb-0">
                                                            <label class="form-label fw-bold">离职原因</label>
                                                            <textarea name="departure_reason" class="form-control" rows="3"
                                                                placeholder="请输入离职原因（可选）"></textarea>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary btn-action"
                                                            data-bs-dismiss="modal">取消</button>
                                                        <button type="submit" class="btn btn-warning btn-action">确认离职</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 批量发放资产模态框 -->
<div class="modal fade" id="quickIssueModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('asset.asset_issue_from_hr') }}">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-box-seam me-1"></i> 向 {{ current_cycle.name }} 发放资产
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" value="{{ current_cycle.id }}">
                    <input type="hidden" name="id_card" value="{{ id_card }}">

                    <div class="table-responsive equipped-scroll-container">
                        <table class="table table-hover align-middle">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th width="50">选择</th>
                                    <th>资产名称 (库存)</th>
                                    <th width="150">发放数量</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asset in available_assets %}
                                <tr>
                                    <td>
                                        <input class="form-check-input asset-checkbox" type="checkbox" name="asset_ids"
                                            value="{{ asset.id }}" id="chk_{{ asset.id }}">
                                    </td>
                                    <td>
                                        <label class="form-check-label d-block" for="chk_{{ asset.id }}">
                                            <strong>{{ asset.name }}</strong> <small class="text-muted">({{ asset.type
                                                }})</small><br>
                                            <span class="text-primary small">剩余库存: {{ asset.stock_quantity }}</span>
                                        </label>
                                    </td>
                                    <td>
                                        <input type="number" name="qty_{{ asset.id }}"
                                            class="form-control form-control-sm asset-qty" value="1" min="1"
                                            max="{{ asset.stock_quantity }}" disabled>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 p-3 bg-light rounded">
                        <label class="form-label fw-bold">发放备注</label>
                        <textarea name="note" class="form-control" rows="2" placeholder="统一备注，如：入职领用"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-action" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning btn-action" id="submitIssueBtn" disabled>
                        <i class="bi bi-check-circle me-1"></i> 确认发放
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 交互增强脚本 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 控制数量框开关
        document.querySelectorAll('.asset-checkbox').forEach(chk => {
            chk.addEventListener('change', function () {
                const qtyInput = this.closest('tr').querySelector('.asset-qty');
                qtyInput.disabled = !this.checked;
                
                // 更新数量输入框样式
                if (this.checked) {
                    qtyInput.classList.add('border-warning');
                    qtyInput.focus();
                } else {
                    qtyInput.classList.remove('border-warning');
                }
                
                // 控制提交按钮
                const anyChecked = document.querySelectorAll('.asset-checkbox:checked').length > 0;
                const submitBtn = document.getElementById('submitIssueBtn');
                submitBtn.disabled = !anyChecked;
                
                // 更新提交按钮样式
                if (anyChecked) {
                    submitBtn.classList.remove('opacity-50');
                } else {
                    submitBtn.classList.add('opacity-50');
                }
            });
        });
        
        // 数量输入框验证
        document.querySelectorAll('.asset-qty').forEach(input => {
            input.addEventListener('input', function() {
                const min = parseInt(this.min) || 1;
                const max = parseInt(this.max) || 1;
                let value = parseInt(this.value) || min;
                
                if (value < min) value = min;
                if (value > max) value = max;
                
                this.value = value;
            });
        });
        
        // 模态框动画增强
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('show.bs.modal', function() {
                this.querySelector('.modal-content').style.opacity = '0';
                this.querySelector('.modal-content').style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    this.querySelector('.modal-content').style.transition = 'all 0.3s ease';
                    this.querySelector('.modal-content').style.opacity = '1';
                    this.querySelector('.modal-content').style.transform = 'translateY(0)';
                }, 10);
            });
            
            modal.addEventListener('hide.bs.modal', function() {
                this.querySelector('.modal-content').style.opacity = '0';
                this.querySelector('.modal-content').style.transform = 'translateY(20px)';
            });
        });
        
        // 离职确认表单验证增强
        const departureModals = document.querySelectorAll('[id^="departureModal"]');
        departureModals.forEach(modal => {
            const form = modal.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const checkboxes = this.querySelectorAll('input[type="checkbox"][required]');
                    let allChecked = true;
                    
                    checkboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            allChecked = false;
                            checkbox.parentElement.classList.add('border-danger');
                            
                            // 添加抖动动画
                            checkbox.parentElement.style.animation = 'shake 0.5s';
                            setTimeout(() => {
                                checkbox.parentElement.style.animation = '';
                            }, 500);
                        } else {
                            checkbox.parentElement.classList.remove('border-danger');
                        }
                    });
                    
                    if (!allChecked) {
                        e.preventDefault();
                        alert('请确认已完成所有必要的离职手续！');
                    } else if (!confirm(`确认要将${modal.dataset.name || '该员工'}标记为离职吗？此操作不可撤销！`)) {
                        e.preventDefault();
                    }
                });
            }
        });
        
        // 添加抖动动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);
        
        // 平滑滚动
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            });
        });
    });
</script>
{% endblock %}