<!-- templates/hr/edit.html -->
{% extends "base.html" %}

{% block title %}编辑员工信息 - {{ cycle.name }}{% endblock %}

{% block content %}
<style>
    /* 页面专属样式 */
    .form-page-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    .form-page-header {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%) !important;
        color: #212529 !important;
        padding: 1rem 1.5rem;
        border-bottom: none;
    }
    
    .form-page-body {
        padding: 2rem;
    }
    
    .action-btn {
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
        margin: 0 0.5rem;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    @media (max-width: 768px) {
        .form-page-body {
            padding: 1rem;
        }
        
        .action-btn {
            width: 100%;
            margin: 0.5rem 0;
        }
    }
</style>

<div class="container mt-4 mb-5">
    <div class="card form-page-card">
        <div class="card-header form-page-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="bi bi-pencil-square me-2"></i>编辑员工信息 - {{ cycle.name }}
            </h4>
            <div>
                <a href="{{ url_for('hr.hr_detail', id_card=cycle.id_card) }}" class="btn btn-dark btn-sm me-2">
                    <i class="bi bi-eye me-1"></i>查看详情
                </a>
                <a href="{{ url_for('hr.hr_list') }}" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>返回列表
                </a>
            </div>
        </div>
        <div class="card-body form-page-body">
            <form method="POST" action="{{ url_for('hr.edit_cycle', cycle_id=cycle.id) }}" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% set employee = cycle %} {# 回显数据 #}
                {% include "hr/_employee_form.html" with context %} {# 关键修复：添加 with context #}
                
                <div class="text-center mt-5 pt-4 border-top">
                    <button type="submit" class="btn btn-primary action-btn btn-lg">
                        <i class="bi bi-save me-2"></i>保存修改
                    </button>
                    <a href="{{ url_for('hr.hr_detail', id_card=cycle.id_card) }}" class="btn btn-secondary action-btn btn-lg">
                        <i class="bi bi-x-circle me-2"></i>取消
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // 表单验证
    (() => {
        'use strict'
        const forms = document.querySelectorAll('.needs-validation')
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()

    // 确认取消提示
    document.addEventListener('DOMContentLoaded', function() {
        const cancelBtn = document.querySelector('.btn-secondary.action-btn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function(e) {
                if (isFormModified()) {
                    if (!confirm('您有未保存的修改，确定要取消吗？')) {
                        e.preventDefault();
                    }
                }
            });
        }
        
        // 检测表单是否被修改
        function isFormModified() {
            const inputs = document.querySelectorAll('input, select, textarea');
            for (let input of inputs) {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    if (input.defaultChecked !== input.checked) return true;
                } else if (input.defaultValue !== input.value) {
                    return true;
                }
            }
            return false;
        }
    });
</script>
{% endblock %}