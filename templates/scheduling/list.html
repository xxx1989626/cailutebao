{% extends "base.html" %}
{% block title %}è€ƒå‹¤æ’ç­ç®¡ç†{% endblock %}

{% block head %}
<style>
    /* å…¨å±€æ»šåŠ¨æ¡ç¾åŒ– */
    .sticky-sidebar::-webkit-scrollbar { width: 6px; }
    .sticky-sidebar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }

    /* ä¾§è¾¹æ æ ·å¼å¢å¼º */
    .sticky-sidebar {
        position: sticky;
        top: 20px;
        height: calc(100vh - 120px);
        overflow-y: auto !important;
        padding: 1.2rem;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }

    /* é¡¶éƒ¨ Tabs å¯¼èˆªç¾åŒ– */
    .hr-tabs { border-bottom: 1px solid #dee2e6; margin-bottom: 25px; display: flex; gap: 30px; }
    .hr-tabs a { 
        text-decoration: none; color: #6c757d; padding: 12px 5px; 
        font-weight: 500; position: relative; transition: all 0.3s;
    }
    .hr-tabs a:hover { color: #007bff; }
    .hr-tabs a.active { color: #007bff; font-weight: 600; }
    .hr-tabs a.active::after {
        content: ""; position: absolute; bottom: -1px; left: 0; 
        width: 100%; height: 3px; background: #007bff; border-radius: 3px;
    }

    /* æé€Ÿæ¨¡å¼ & çŠ¶æ€æ ·å¼ */
    .mode-indicator {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        z-index: 2000; display: none; padding: 10px 30px;
        border-radius: 50px; background: rgba(255, 193, 7, 0.95);
        backdrop-filter: blur(5px); box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }
    
    .emp-tag { 
        padding: 10px 12px; margin-bottom: 8px; background: #fff; 
        border: 1px solid #eee; border-radius: 8px; cursor: grab; 
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        user-select: none;
    }
    .emp-tag:hover { 
        transform: translateY(-2px); border-color: #007bff; 
        box-shadow: 0 4px 8px rgba(0,123,255,0.15); 
    }

    /* çŠ¶æ€é¢œè‰²æ ‡è®° */
    .away-status { background-color: #fffef0 !important; border: 1.5px dashed #ffc107 !important; }
    .leave-status { background-color: #fff5f5 !important; border: 1.5px dotted #dc3545 !important; }

    /* æŒ‰é’®ç»„è´¨æ„Ÿ */
    .btn-export-a { background: #e7f1ff; color: #0056b3; border: 1px solid #b6d4fe; }
    .btn-export-a:hover { background: #0d6efd; color: white; }
    .btn-export-b { background: #f8f9fa; color: #333; border: 1px solid #ddd; }
    .btn-export-b:hover { background: #333; color: white; }

    /* æ—¥å†äº‹ä»¶å¾®è°ƒ */
    .fc-event { border-radius: 4px !important; margin: 1px 0 !important; cursor: pointer; }
    .fc-day-today { background: #f8f9ff !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-2">
    <div class="hr-tabs mb-4">
        <a href="{{ url_for('scheduling.schedule_list') }}" class="{% if request.endpoint == 'scheduling.schedule_list' %}active{% endif %}">ğŸ“… æ’ç­è§†å›¾</a>
        <a href="{{ url_for('posts.list') }}" class="{% if request.endpoint == 'posts.list' %}active{% endif %}">ğŸ› ï¸ å²—ä½è®¾ç½®</a>
        <a href="{{ url_for('trip.trip_list') }}" class="{% if request.endpoint == 'trip.trip_list' %}active{% endif %}">ğŸ’¼ å‡ºå·®è®¾ç½®</a>
        <a href="{{ url_for('leave.leave_list') }}" class="{% if request.endpoint == 'leave.leave_list' %}active{% endif %}">ğŸ“ è¯·å‡ç®¡ç†</a>
    </div>

    <div id="modeIndicator" class="mode-indicator text-dark fw-bold">
        <i class="bi bi-lightning-fill"></i> <span id="modeText"></span>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">
        <div class="d-flex align-items-center gap-3">
            <div class="form-check form-switch p-2 bg-white rounded border shadow-sm px-3 ps-0 d-flex align-items-center justify-content-center">
    <input class="form-check-input ms-0" type="checkbox" id="fastModeToggle" style="cursor: pointer;">
    <label class="form-check-label small fw-bold ms-2 mb-0" for="fastModeToggle" style="cursor: pointer;">ğŸš€ æé€Ÿç›–ç« æ¨¡å¼</label>
</div>
            <span class="text-muted small d-none d-lg-inline">
                <i class="bi bi-info-circle"></i> å³é”®â€œå–æ ·â€å·²æœ‰ç­æ¬¡ï¼Œç‚¹å‡»ç©ºç™½æ—¥æœŸç›´æ¥â€œç›–ç« â€
            </span>
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('excelImportInput').click()">
                <i class="bi bi-file-earmark-arrow-up"></i> å¯¼å…¥æ’ç­
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="clearCurrentMonth()">
                <i class="bi bi-trash3"></i> æ¸…ç©ºæœ¬æœˆ
            </button>
            <input type="file" id="excelImportInput" hidden onchange="importExcelSchedule(this)">

            <div class="btn-group btn-group-sm">
                <a href="{{ url_for('scheduling.export_attendance', table_type='A') }}" class="btn btn-export-a">å¯¼å‡º Aè¡¨</a>
                <a href="{{ url_for('scheduling.export_attendance', table_type='B') }}" class="btn btn-export-b">å¯¼å‡º Bè¡¨</a>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-2">
            <div class="sticky-sidebar">
                <div class="small text-secondary mb-3 fw-bold border-bottom pb-2">
                    <i class="bi bi-people"></i> å¾…æ’äººå‘˜
                </div>
                <div id="external-events">
                    {% for emp in employees %}
                        {% set is_away = emp.id in on_trip_ids %}
                        {% set is_on_leave = emp.id in on_leave_ids %}
                        <div class="emp-tag fc-event-draggable {% if is_away %}away-status{% endif %} {% if is_on_leave %}leave-status{% endif %}" 
                             data-user-id="{{ emp.id }}" 
                             data-user-name="{{ emp.name }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>{{ emp.name }}</strong>
                                <div class="d-flex gap-1 flex-wrap"> {% if is_away %}
        <span class="badge bg-warning text-dark d-inline-flex align-items-center" style="font-size: 0.65rem;" title="å‡ºå·®ä¸­">
            <i class="bi bi-airplane me-1"></i>å‡ºå·®ä¸­
        </span>
    {% endif %}
    
    {% if is_on_leave %}
        <span class="badge bg-danger d-inline-flex align-items-center" style="font-size: 0.65rem;" title="è¯·å‡ä¸­">
            <i class="bi bi-calendar-x me-1"></i>è¯·å‡ä¸­
        </span>
    {% endif %}
</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-10">
            <div id="calendar" class="shadow-sm border bg-white p-3 rounded-3"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="shiftModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-body p-4">
                <div class="text-center mb-3">
                    <div class="text-primary small fw-bold text-uppercase mb-1">æ­£åœ¨æ’ç­</div>
                    <h5 class="fw-bold" id="display_info"></h5>
                </div>
                <form id="shiftForm">
                    <input type="hidden" id="post_user_id">
                    <input type="hidden" id="post_date">
                    <div class="mb-3">
                        <label class="small text-muted mb-1">å²—ä½åˆ†é…</label>
                        <select id="post_id" class="form-select border-2">
                            {% for p in posts %}<option value="{{p.id}}">{{p.name}}</option>{% endfor %}
                        </select>
<div class="row g-2 mb-4">
    <div class="col-6">
        <div class="form-check border rounded p-2 ps-0 d-flex align-items-center justify-content-center w-100" style="cursor: pointer;">
            <input class="form-check-input" type="checkbox" id="is_night_toggle">
            <label class="form-check-label ms-2 mb-0" for="is_night_toggle" style="cursor: pointer;">å¤œç­</label>
        </div>
    </div>
    <div class="col-6">
        <div class="form-check border rounded p-2 ps-0 d-flex align-items-center justify-content-center w-100" style="cursor: pointer;">
            <input class="form-check-input" type="checkbox" id="is_overtime_toggle">
            <label class="form-check-label ms-2 mb-0" for="is_overtime_toggle" style="cursor: pointer;">åŠ ç­</label>
        </div>
    </div>
</div>
                    <button type="button" class="btn btn-primary w-100 py-2 fw-bold" onclick="submitShift()">
                        ç¡®è®¤æäº¤
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/fullcalendar.global.min.js') }}"></script>
<script>
let calendar;
let copyData = null; 
let isFastMode = false;

function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    // åˆå§‹åŒ–å·¦ä¾§æ‹–æ‹½
    new FullCalendar.Draggable(document.getElementById('external-events'), {
        itemSelector: '.fc-event-draggable',
        eventData: function(eventEl) {
            return { 
                title: eventEl.getAttribute('data-user-name'), 
                extendedProps: { empId: eventEl.getAttribute('data-user-id') } 
            };
        }
    });

    calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'zh-cn',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,dayGridWeek,dayGridDay' },
        
        buttonText: {
            today: 'ä»Šå¤©',
            month: 'æœˆè§†å›¾',
            week: 'å‘¨è§†å›¾',
            day: 'æ—¥è§†å›¾',
            prev: 'ä¸Šä¸€æœˆ',
            next: 'ä¸‹ä¸€æœˆ'
        },
        firstDay: 1,
        initialView: 'dayGridMonth',
        editable: true,
        droppable: true,
        views: {
        dayGridMonth: {dayMaxEvents: 6,},
        dayGridWeek: {dayMaxEvents: false,},
        dayGridDay: {dayMaxEvents: false,},
        },
        // æ‹–æ‹½é‡Šæ”¾
        drop: function(info) {
            handleDrop(info.draggedEl.getAttribute('data-user-id'), info.draggedEl.getAttribute('data-user-name'), info.dateStr);
        },
        // ç‚¹å‡»æ’ç­ï¼šæé€Ÿæ¨¡å¼ä¸‹å·¦é”®ç‚¹å‡»åˆ é™¤
        eventClick: function(info) {
            if (isFastMode) {
                 {deleteShiftDirectly(info.event.extendedProps.shiftId);
                }
            }
        },
        // æ ¸å¿ƒï¼šå³é”®å–æ ·åŠŸèƒ½
        eventDidMount: function(info) {
            info.el.addEventListener('contextmenu', function(e) {
                if (!isFastMode) return;
                e.preventDefault();
                const props = info.event.extendedProps;
                copyData = {
                    user_id: props.empId,
                    user_name: info.event.title.split('-')[0],
                    post_id: props.postId,
                    shift_type: info.event.title.includes('å¤œ') ? 'å¤œ' : 'ç™½'
                };
                enterCopyMode();
            });
        },
        // æé€Ÿç›–ç« ï¼šåœ¨ç©ºç™½æ—¥æœŸç‚¹å‡»å³æ’å…¥å·²å–æ ·çš„ç­æ¬¡
        dateClick: function(info) {
            if (isFastMode && copyData) {
                quickSave(copyData.user_id, info.dateStr, copyData.post_id, copyData.shift_type);
            }
        },
        events: "{{ url_for('scheduling.get_shifts') }}"
    });
    calendar.render();

    // ç»‘å®šæé€Ÿæ¨¡å¼å¼€å…³
    const toggle = document.getElementById('fastModeToggle');
    if(toggle){
        toggle.addEventListener('change', function(e) {
            isFastMode = e.target.checked;
            const indicator = document.getElementById('modeIndicator');
            if (isFastMode) {
                document.getElementById('calendar').classList.add('fast-mode-active');
                indicator.style.display = 'block';
                document.getElementById('modeText').innerText = "ğŸš€ æé€Ÿç›–ç« ä¸­ï¼šå·¦é”®åˆ  / å³é”®å–æ · / ç‚¹å‡»ç©ºç™½æ—¥æœŸç›–ç« ";
            } else {
                document.getElementById('calendar').classList.remove('fast-mode-active');
                indicator.style.display = 'none';
                exitCopyMode();
            }
        });
    }
}

// ç›–ç« æ¨¡å¼é€»è¾‘
function enterCopyMode() {
    document.getElementById('calendar').classList.add('copy-mode-active');
    document.getElementById('modeText').innerText = `ç›–ç« æ¨¡å¼ï¼šæ­£åœ¨ä¸º [${copyData.user_name}] è¿ç»­æ’ç­... (ç‚¹å“ªæ’å“ª)`;
}

function exitCopyMode() {
    copyData = null;
    document.getElementById('calendar').classList.remove('copy-mode-active');
    if (isFastMode) document.getElementById('modeText').innerText = "ğŸš€ æé€Ÿç¼–è¾‘æ¨¡å¼ä¸­...";
}
// å¯¼å…¥ Excel æ’ç­è¡¨ (æ­£åˆ™è§£æç‰ˆ)
function importExcelSchedule(input) {
    if (!input.files[0]) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);
    
    const btn = event.target;
    indicatorShow("æ­£åœ¨æ­£åˆ™è§£æ Excel å¹¶åŒ¹é…å²—ä½...");

    fetch("{{ url_for('scheduling.import_schedule_data') }}", { 
        method: 'POST', 
        body: formData 
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        location.reload();
    })
    .catch(err => alert("å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼"));
}
// æ¸…ç©ºæœ¬æœˆæ’ç­æ•°æ® - åŠ¨æ€è·å–æ—¥å†å½“å‰æœˆä»½ç‰ˆ
function clearCurrentMonth() {
    // 1. åŠ¨æ€è·å–å½“å‰æœˆä»½ (å‡è®¾ä½¿ç”¨ FullCalendar)
    let targetMonth = '2026-01'; // é»˜è®¤å€¼
    if (typeof calendar !== 'undefined') {
        const date = calendar.getDate();
        targetMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    }

    // 2. ç¡®è®¤æç¤ºæ˜¾ç¤ºåŠ¨æ€æœˆä»½
    if (!confirm(`ç¡®å®šè¦æ¸…ç©º ${targetMonth} çš„æ‰€æœ‰æ’ç­æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
    }

    fetch('/scheduling/clear_month', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ month: targetMonth }) // ä½¿ç”¨åŠ¨æ€å˜é‡
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            typeof calendar !== 'undefined' ? calendar.refetchEvents() : location.reload();
        } else {
            alert("é”™è¯¯: " + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("è¯·æ±‚å¤±è´¥");
    });
}

function indicatorShow(text) {
    const indicator = document.getElementById('modeIndicator');
    indicator.style.display = 'block';
    document.getElementById('modeText').innerText = text;
}

// åŸºç¡€ API è°ƒç”¨
function deleteShiftDirectly(id) {
    fetch(`/scheduling/api/delete_shift/${id}`, { method: 'POST' })
    .then(res => res.json()).then(data => { if(data.success) calendar.refetchEvents(); });
}

function handleDrop(id, name, date) {
    // æ£€æŸ¥è¢«æ‹–æ‹½çš„å…ƒç´ æ˜¯å¦å¸¦æœ‰å‡ºå·®æ ·å¼
    const empTag = document.querySelector(`.emp-tag[data-user-id="${id}"]`);
    const isAway = empTag && empTag.classList.contains('away-status');

    if (isAway) {
        if (!confirm(`ã€æ’ç­é¢„è­¦ã€‘\nå‘˜å·¥ ${name} ç›®å‰æ ‡è®°ä¸ºâ€œå‡ºå·®ä¸­â€ã€‚\nä½ ç¡®å®šè¦ç»™æ­£åœ¨å‡ºå·®çš„å‘˜å·¥æ’æœ¬å²—ä½å—ï¼Ÿ`)) {
            location.reload(); // ç”¨æˆ·ç‚¹å–æ¶ˆï¼Œåˆ·æ–°é¡µé¢æ’¤é”€æ“ä½œ
            return;
        }
    }
    document.getElementById('display_info').innerText = `${name} @ ${date}`;
    document.getElementById('post_user_id').value = id;
    document.getElementById('post_date').value = date;
    new bootstrap.Modal(document.getElementById('shiftModal')).show();
}

function quickSave(userId, date, postId, type) {
    fetch("{{ url_for('scheduling.save_shift') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, date: date, post_id: postId, shift_type: type })
    }).then(res => res.json()).then(data => { if (data.success) calendar.refetchEvents(); });
}

function submitShift() {
    const payload = {
        user_id: document.getElementById('post_user_id').value,
        date: document.getElementById('post_date').value,
        post_id: document.getElementById('post_id').value,
        shift_type: document.getElementById('is_night_toggle').checked ? 'å¤œ' : 'ç™½',
        is_night: document.getElementById('is_night_toggle').checked,
        is_overtime: document.getElementById('is_overtime_toggle').checked
    };
    fetch("{{ url_for('scheduling.save_shift') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then(res => res.json()).then(data => { if (data.success) location.reload(); });
}

document.addEventListener('DOMContentLoaded', initCalendar);
</script>
<style>
/* ä¿æŒä¸ä½ çš„æ’ç­ç³»ç»Ÿä¸€è‡´çš„é£æ ¼ */
.hr-tabs { border-bottom: 2px solid #eee; display: flex; gap: 20px; }
.hr-tabs a { text-decoration: none; color: #666; padding: 10px 5px; border-bottom: 3px solid transparent; transition: all 0.3s; font-weight: 500; }
.hr-tabs a:hover { color: #0d6efd; }
.hr-tabs a.active { color: #0d6efd; border-bottom-color: #0d6efd; }
.form-control-color { padding: 0.2rem; cursor: pointer; }
.table-hover tbody tr:hover { background-color: rgba(13, 110, 253, 0.02); }
</style>
{% endblock %}