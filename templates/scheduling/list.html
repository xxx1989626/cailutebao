{% extends "base.html" %}
{% block title %}è€ƒå‹¤æ’ç­ç®¡ç†{% endblock %}

{% block head %}
<style>
    /* ä¾§è¾¹æ æ»šåŠ¨ */
    .sticky-sidebar {
        position: sticky;
        top: 20px;
        height: calc(100vh - 120px);
        overflow-y: auto !important;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    /* ç®€æ´æ ‡ç­¾é¡µ */
    .hr-tabs { border-bottom: 2px solid #eee; margin-bottom: 20px; display: flex; gap: 30px; }
    .hr-tabs a { 
        text-decoration: none; color: #666; padding: 10px 5px; 
        font-weight: 500; position: relative;
    }
    .hr-tabs a.active { color: #007bff; }
    .hr-tabs a.active::after {
        content: ""; position: absolute; bottom: -2px; left: 0; 
        width: 100%; height: 2px; background: #007bff;
    }

    /* æé€Ÿæ¨¡å¼æ ·å¼ */
    .fast-mode-active .fc-daygrid-day:hover { background-color: #f0fff4 !important; cursor: pointer; }
    .copy-mode-active .fc-daygrid-day:hover { background-color: #fffaf0 !important; cursor: copy !important; }
    
    .mode-indicator {
        position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
        z-index: 2000; display: none; padding: 8px 25px;
        border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .emp-tag { padding: 8px; margin-bottom: 5px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: grab; transition: all 0.2s; }
    .emp-tag:hover { border-color: #007bff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    /* é€‚é…åŒå±‚è¡¨å¤´å¯¼å…¥åçš„æ—¥å†æ˜¾ç¤º */
    .fc-event { border: none !important; padding: 2px 4px !important; font-size: 0.85em !important; }
    .shift-night { border-left: 3px solid #1a202c !important; } /* å¤œç­æ ‡è®° */

    /* Initialize color boxes */
    .color-box {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        background-color: inherit;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.color-box').forEach(el => {
            el.style.backgroundColor = el.getAttribute('data-color');
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-2">
    <div class="hr-tabs">
        <a href="{{ url_for('scheduling.schedule_list', tab='calendar') }}" class="{% if active_tab == 'calendar' %}active{% endif %}">ğŸ“… æ’ç­è§†å›¾</a>
        <a href="{{ url_for('scheduling.schedule_list', tab='posts') }}" class="{% if active_tab == 'posts' %}active{% endif %}">ğŸ› ï¸ å²—ä½è®¾ç½®</a>
        <a href="{{ url_for('trip.trip_list') }}" class="active">ğŸ’¼ å‡ºå·®è®¾ç½®</a>
        <a href="{{ url_for('leave.leave_list') }}" class="{% if active_tab == 'leave' %}active{% endif %}">ğŸ“ è¯·å‡ç®¡ç†</a>
    </div>

    {% if active_tab == 'calendar' %}
    <div id="modeIndicator" class="mode-indicator bg-warning text-dark fw-bold">
        <span id="modeText"></span>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
            <div class="form-check form-switch p-2 bg-light rounded border px-3">
                <input class="form-check-input" type="checkbox" id="fastModeToggle">
                <label class="form-check-label small fw-bold" for="fastModeToggle">ğŸš€ æé€Ÿç›–ç« æ¨¡å¼</label>
            </div>
            <span class="text-muted small d-none d-md-inline">æç¤ºï¼šå³é”®ç‚¹å‡»å·²æœ‰æ’ç­å¯â€œå–æ ·â€ï¼Œç‚¹å‡»ç©ºç™½æ—¥æœŸå³â€œç›–ç« â€</span>
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm px-3 shadow-sm" onclick="document.getElementById('excelImportInput').click()">
                <i class="bi bi-file-earmark-excel"></i> å¯¼å…¥æœ¬æœˆæ’ç­
            </button>
            <button class="btn btn-outline-danger" onclick="clearCurrentMonth()">
    <i class="bi bi-trash"></i> æ¸…ç©ºæœ¬æœˆæ’ç­
</button>
            <input type="file" id="excelImportInput" hidden onchange="importExcelSchedule(this)">

            <div class="btn-group shadow-sm">
                <a href="{{ url_for('scheduling.export_attendance', table_type='A') }}" class="btn btn-primary btn-sm px-3">å¯¼å‡º Aè¡¨</a>
                <a href="{{ url_for('scheduling.export_attendance', table_type='B') }}" class="btn btn-success btn-sm px-3">å¯¼å‡º Bè¡¨</a>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-2">
            <div class="sticky-sidebar">
                <div class="small text-muted mb-2 fw-bold">å¾…æ’äººå‘˜ (æ‹–æ‹½å…¥æ—¥å†)</div>
                <div id="external-events">
    {% for emp in employees %}
        {% set is_away = emp.id in on_trip_ids %}
        {% set is_on_leave = emp.id in on_leave_ids %} {# åˆ¤æ–­æ˜¯å¦è¯·å‡ #}
        <div class="emp-tag fc-event-draggable {% if is_away %}away-status{% endif %}" 
             data-user-id="{{ emp.id }}" 
             data-user-name="{{ emp.name }}">
            
            <div class="d-flex justify-content-between align-items-center">
                <strong>{{ emp.name }}</strong>
                {% if is_away %}
                    <span class="badge bg-warning text-dark border border-dark-subtle" style="font-size: 0.65rem;">
                        <i class="bi bi-airplane-fill"></i> å‡ºå·®ä¸­
                    </span>
                {% endif %}
                {% if is_on_leave %}
                    <span class="badge bg-secondary" style="font-size: 0.65rem;">
                        <i class="bi bi-clock-fill"></i> è¯·å‡ä¸­
                    </span>
                {% endif %}
            </div>
        </div>
    {% endfor %}
</div>

<style>
    /* å‡ºå·®äººå‘˜ç‰¹æ®ŠèƒŒæ™¯ï¼šæ·¡æ©™è‰²è™šçº¿è¾¹æ¡† */
    .away-status {
        background-color: #fffaf0 !important;
        border: 2px dashed #ffc107 !important;
        opacity: 0.8;
    }

    /* è¯·å‡äººå‘˜ç‰¹æ®ŠèƒŒæ™¯ï¼šæ·¡ç²‰è‰²ç‚¹çŠ¶è¾¹æ¡† */
    .leave-status {
        background-color: #fff5f5 !important;
        border: 2px dotted #dc3545 !important;
        opacity: 0.7; /* è¯·å‡æƒé‡é€šå¸¸æ¯”å‡ºå·®æ›´é«˜ï¼Œé¢œè‰²æ›´æ˜¾çœ¼ä¸€ç‚¹ */
    }
    
    /* å¦‚æœä¸€ä¸ªäººæ—¢è¯·å‡åˆå‡ºå·®ï¼ˆæç«¯æƒ…å†µï¼‰ï¼Œå åŠ æ ·å¼ */
    .away-status.leave-status {
        background: linear-gradient(45deg, #fffaf0, #fff5f5) !important;
    }
</style>
            </div>
        </div>
        <div class="col-md-10">
            <div id="calendar" class="shadow-sm border bg-white p-3"></div>
        </div>
    </div>

    {% else %}
    <div class="alert alert-info py-2 small">
        <i class="bi bi-info-circle"></i> ç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ® Excel è¡¨å¤´å…³é”®å­—ï¼ˆå¦‚â€œå®ˆå°â€ã€â€œå¤œç­â€ã€â€œå›¾åƒâ€ï¼‰åŒ¹é…è¿™é‡Œçš„å²—ä½ã€‚
    </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0 fw-bold text-muted">å²—ä½åˆ—è¡¨ä¸é…ç½®</h6>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm px-3" onclick="document.getElementById('postImportInput').click()">
                <i class="bi bi-file-earmark-arrow-up"></i> å¯¼å…¥å²—ä½è®¾ç½®
            </button>
            <a href="{{ url_for('scheduling.export_posts') }}" class="btn btn-outline-secondary btn-sm px-3">
                <i class="bi bi-file-earmark-arrow-down"></i> å¯¼å‡ºå²—ä½è®¾ç½®
            </a>
            <input type="file" id="postImportInput" hidden onchange="importPosts(this)">
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold border-0 pt-3">æ–°å¢/ä¿®æ”¹å²—ä½</div>
                <div class="card-body">
                    <form action="{{ url_for('scheduling.schedule_list') }}" method="POST">
                        <div class="mb-3">
                            <label class="small text-muted">å²—ä½åç§° (å»ºè®®ä¸Excelè¡¨å¤´ä¸€è‡´)</label>
                            <input type="text" name="name" class="form-control" required placeholder="å¦‚ï¼šå®ˆå°-ç™½ç­">
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="small text-muted">ä¸Šç­</label>
                                <input type="time" name="default_start" class="form-control" value="08:00" title="ä¸Šç­æ—¶é—´">
                            </div>
                            <div class="col">
                                <label class="small text-muted">ä¸‹ç­</label>
                                <input type="time" name="default_end" class="form-control" value="20:00" title="ä¸‹ç­æ—¶é—´">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="small text-muted">æ—¥å†æ˜¾ç¤ºé¢œè‰²</label>
                            <input type="color" name="color" class="form-control form-control-color w-100" value="#4299e1" title="é€‰æ‹©å²—ä½åœ¨æ—¥å†ä¸­çš„æ˜¾ç¤ºé¢œè‰²">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2">ç¡®è®¤å¹¶ä¿å­˜</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr><th>é¢œè‰²</th><th>å²—ä½åç§°</th><th>æ ‡å‡†å·¥æ—¶</th><th class="text-end">æ“ä½œ</th></tr>
                    </thead>
                    <tbody>
                        {% for p in posts %}
                        <tr>
                            <td><div class="color-box" data-color="{{ p.color }}"></div></td>
                            <td class="fw-bold">{{ p.name }}</td>
                            <td class="text-muted">{{ p.default_start }} - {{ p.default_end }}</td>
                            <td class="text-end"><a href="{{ url_for('scheduling.post_delete', id=p.id) }}" class="btn btn-link btn-sm text-danger" onclick="return confirm('ç¡®å®šåˆ é™¤è¯¥å²—ä½å—ï¼Ÿ')">åˆ é™¤</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="shiftModal">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body p-4">
                <h6 class="fw-bold mb-3 text-center" id="display_info"></h6>
                <form id="shiftForm">
                    <input type="hidden" id="post_user_id"><input type="hidden" id="post_date">
                    <div class="mb-3">
                        <label class="small text-muted">é€‰æ‹©å²—ä½</label>
                        <select id="post_id" class="form-select" title="é€‰æ‹©å²—ä½">
                            {% for p in posts %}<option value="{{p.id}}">{{p.name}}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="d-flex justify-content-center gap-4 mb-4">
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="is_night_toggle" title="æ ‡è®°ä¸ºå¤œç­"><label class="form-check-label" for="is_night_toggle">å¤œç­</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="is_overtime_toggle" title="æ ‡è®°ä¸ºåŠ ç­"><label class="form-check-label" for="is_overtime_toggle">åŠ ç­</label></div>
                    </div>
                    <button type="button" class="btn btn-primary w-100 py-2" onclick="submitShift()">ç¡®è®¤æ’ç­</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/fullcalendar.global.min.js') }}"></script>
<script>
let calendar;
let copyData = null; 
let isFastMode = false;

function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    // åˆå§‹åŒ–å·¦ä¾§æ‹–æ‹½
    new FullCalendar.Draggable(document.getElementById('external-events'), {
        itemSelector: '.fc-event-draggable',
        eventData: function(eventEl) {
            return { 
                title: eventEl.getAttribute('data-user-name'), 
                extendedProps: { empId: eventEl.getAttribute('data-user-id') } 
            };
        }
    });

    calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'zh-cn',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
        initialView: 'dayGridMonth',
        editable: true,
        droppable: true,
        dayMaxEvents: 6, 
        // æ‹–æ‹½é‡Šæ”¾
        drop: function(info) {
            handleDrop(info.draggedEl.getAttribute('data-user-id'), info.draggedEl.getAttribute('data-user-name'), info.dateStr);
        },
        // ç‚¹å‡»æ’ç­ï¼šæé€Ÿæ¨¡å¼ä¸‹å·¦é”®ç‚¹å‡»åˆ é™¤
        eventClick: function(info) {
            if (isFastMode) {
                 {deleteShiftDirectly(info.event.extendedProps.shiftId);
                }
            }
        },
        // æ ¸å¿ƒï¼šå³é”®å–æ ·åŠŸèƒ½
        eventDidMount: function(info) {
            info.el.addEventListener('contextmenu', function(e) {
                if (!isFastMode) return;
                e.preventDefault();
                const props = info.event.extendedProps;
                copyData = {
                    user_id: props.empId,
                    user_name: info.event.title.split('-')[0],
                    post_id: props.postId,
                    shift_type: info.event.title.includes('å¤œ') ? 'å¤œ' : 'ç™½'
                };
                enterCopyMode();
            });
        },
        // æé€Ÿç›–ç« ï¼šåœ¨ç©ºç™½æ—¥æœŸç‚¹å‡»å³æ’å…¥å·²å–æ ·çš„ç­æ¬¡
        dateClick: function(info) {
            if (isFastMode && copyData) {
                quickSave(copyData.user_id, info.dateStr, copyData.post_id, copyData.shift_type);
            }
        },
        events: "{{ url_for('scheduling.get_shifts') }}"
    });
    calendar.render();

    // ç»‘å®šæé€Ÿæ¨¡å¼å¼€å…³
    const toggle = document.getElementById('fastModeToggle');
    if(toggle){
        toggle.addEventListener('change', function(e) {
            isFastMode = e.target.checked;
            const indicator = document.getElementById('modeIndicator');
            if (isFastMode) {
                document.getElementById('calendar').classList.add('fast-mode-active');
                indicator.style.display = 'block';
                document.getElementById('modeText').innerText = "ğŸš€ æé€Ÿç›–ç« ä¸­ï¼šå·¦é”®åˆ  / å³é”®å–æ · / ç‚¹å‡»ç©ºç™½æ—¥æœŸç›–ç« ";
            } else {
                document.getElementById('calendar').classList.remove('fast-mode-active');
                indicator.style.display = 'none';
                exitCopyMode();
            }
        });
    }
}

// ç›–ç« æ¨¡å¼é€»è¾‘
function enterCopyMode() {
    document.getElementById('calendar').classList.add('copy-mode-active');
    document.getElementById('modeText').innerText = `ç›–ç« æ¨¡å¼ï¼šæ­£åœ¨ä¸º [${copyData.user_name}] è¿ç»­æ’ç­... (ç‚¹å“ªæ’å“ª)`;
}

function exitCopyMode() {
    copyData = null;
    document.getElementById('calendar').classList.remove('copy-mode-active');
    if (isFastMode) document.getElementById('modeText').innerText = "ğŸš€ æé€Ÿç¼–è¾‘æ¨¡å¼ä¸­...";
}
function importPosts(input) {  // å²—ä½å¯¼å…¥
    const formData = new FormData();
    formData.append('file', input.files[0]);
    fetch("{{ url_for('scheduling.import_post_configs') }}", { method: 'POST', body: formData })
    .then(res => res.json()).then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    });
}
// å¯¼å…¥ Excel æ’ç­è¡¨ (æ­£åˆ™è§£æç‰ˆ)
function importExcelSchedule(input) {
    if (!input.files[0]) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);
    
    const btn = event.target;
    indicatorShow("æ­£åœ¨æ­£åˆ™è§£æ Excel å¹¶åŒ¹é…å²—ä½...");

    fetch("{{ url_for('scheduling.import_schedule_data') }}", { 
        method: 'POST', 
        body: formData 
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        location.reload();
    })
    .catch(err => alert("å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼"));
}
// æ¸…ç©ºæœ¬æœˆæ’ç­æ•°æ® - åŠ¨æ€è·å–æ—¥å†å½“å‰æœˆä»½ç‰ˆ
function clearCurrentMonth() {
    // 1. åŠ¨æ€è·å–å½“å‰æœˆä»½ (å‡è®¾ä½¿ç”¨ FullCalendar)
    let targetMonth = '2026-01'; // é»˜è®¤å€¼
    if (typeof calendar !== 'undefined') {
        const date = calendar.getDate();
        targetMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    }

    // 2. ç¡®è®¤æç¤ºæ˜¾ç¤ºåŠ¨æ€æœˆä»½
    if (!confirm(`ç¡®å®šè¦æ¸…ç©º ${targetMonth} çš„æ‰€æœ‰æ’ç­æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
    }

    fetch('/scheduling/clear_month', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ month: targetMonth }) // ä½¿ç”¨åŠ¨æ€å˜é‡
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            typeof calendar !== 'undefined' ? calendar.refetchEvents() : location.reload();
        } else {
            alert("é”™è¯¯: " + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("è¯·æ±‚å¤±è´¥");
    });
}

function indicatorShow(text) {
    const indicator = document.getElementById('modeIndicator');
    indicator.style.display = 'block';
    document.getElementById('modeText').innerText = text;
}

// åŸºç¡€ API è°ƒç”¨
function deleteShiftDirectly(id) {
    fetch(`/scheduling/api/delete_shift/${id}`, { method: 'POST' })
    .then(res => res.json()).then(data => { if(data.success) calendar.refetchEvents(); });
}

function handleDrop(id, name, date) {
    // æ£€æŸ¥è¢«æ‹–æ‹½çš„å…ƒç´ æ˜¯å¦å¸¦æœ‰å‡ºå·®æ ·å¼
    const empTag = document.querySelector(`.emp-tag[data-user-id="${id}"]`);
    const isAway = empTag && empTag.classList.contains('away-status');

    if (isAway) {
        if (!confirm(`ã€æ’ç­é¢„è­¦ã€‘\nå‘˜å·¥ ${name} ç›®å‰æ ‡è®°ä¸ºâ€œå‡ºå·®ä¸­â€ã€‚\nä½ ç¡®å®šè¦ç»™æ­£åœ¨å‡ºå·®çš„å‘˜å·¥æ’æœ¬å²—ä½å—ï¼Ÿ`)) {
            location.reload(); // ç”¨æˆ·ç‚¹å–æ¶ˆï¼Œåˆ·æ–°é¡µé¢æ’¤é”€æ“ä½œ
            return;
        }
    }
    document.getElementById('display_info').innerText = `${name} @ ${date}`;
    document.getElementById('post_user_id').value = id;
    document.getElementById('post_date').value = date;
    new bootstrap.Modal(document.getElementById('shiftModal')).show();
}

function quickSave(userId, date, postId, type) {
    fetch("{{ url_for('scheduling.save_shift') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, date: date, post_id: postId, shift_type: type })
    }).then(res => res.json()).then(data => { if (data.success) calendar.refetchEvents(); });
}

function submitShift() {
    const payload = {
        user_id: document.getElementById('post_user_id').value,
        date: document.getElementById('post_date').value,
        post_id: document.getElementById('post_id').value,
        shift_type: document.getElementById('is_night_toggle').checked ? 'å¤œ' : 'ç™½',
        is_night: document.getElementById('is_night_toggle').checked,
        is_overtime: document.getElementById('is_overtime_toggle').checked
    };
    fetch("{{ url_for('scheduling.save_shift') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then(res => res.json()).then(data => { if (data.success) location.reload(); });
}

document.addEventListener('DOMContentLoaded', initCalendar);
</script>
{% endblock %}