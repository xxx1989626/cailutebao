# 更新日志 (Change Log)

所有对本项目的重要变更将记录在此文件中。
Markdown格式

[7.3.0-alpha] - 2026-02-09
新增聊天系统

[7.2.2-alpha] - 2026-02-05
新增请假上传文件
个人详情页面增加 警告文字
资产列表ui适配手机
增加装备更换功能
资产详情点击返回 回到之前的位置
队员详情页点击装备可以回到资产详情
增加定期清理通知记录
给请假功能增加审计和通知

[7.2.1-alpha] - 2026-02-01
🚀 新增功能 (Added)
腾讯地图 API 深度集成：由于高德地图在直辖市及村级数据上的层级逻辑混乱，系统地址组件全面迁移至 腾讯位置服务 (Tencent LBS)。

智能五级联动架构：

前四级法定联动：基于 getchildren 接口实现省、市、区、镇的标准化行政下钻。

第五级动态补全：针对村/居委级数据，引入“接口下钻 + 关键词搜索”双驱动模式，确保 100% 的覆盖率。

直辖市逻辑重构：自动识别北京、上海、天津、重庆四个直辖市，第二级（市）自动填充为“市辖区”并跳级对接区县数据，符合国人录入习惯。

静默回显机制 (Echo Initialization)：利用 async/await 异步链条，在编辑现有记录时自动反向解析各级 adcode，实现页面加载即完成完整地址链路的还原。

🛠️ 修复 (Fixed)
地址杂质过滤：在村级搜索中加入 category 强制过滤，剔除餐饮、娱乐等商业 POI，仅保留行政地名、居委会及住宅区信息。

参数错误 (348 Error)：修复了省级列表初始化时因 id 参数为空导致的腾讯 API 报错问题。

联动断裂修复：修正了旧版代码中对 DOM 父子节点的错误引用，确保在 Bootstrap 栅格布局下 adcode-val 隐藏域能被正确赋值。

🚀 布局与交互优化 (Improved)
输入防干扰：优化了村级 input 监听逻辑，支持“空格搜索大法”，大幅提升在人口稠密城镇下寻找特定村落的精准度。

级联自动清理：当用户修改任意上级地址时，系统会自动重置所有下级字段并清空对应的 datalist，防止产生无效的地址组合。

[7.2.0-alpha] - 2026-01-14
🚀 新增功能 (Added)
年度归档筛选：在出差列表页新增“年度导航栏”，系统自动提取历史年份，支持按年度（如 2026年、2025年）一键切换显示记录。

动态次数统计：引入“年度出差次数”显示逻辑，表头序号更新为“第 X 次”，根据当前年度记录总数自动倒序计算（最新记录显示最大次数）。

智能报备模板：

新增“复制出发”与“复制归队”双模功能，按钮根据出差状态（执行中/已归队）自动切换。

模板预设“蔡路派出所驻点”前缀，自动抓取参与人姓名、目的地及起止时间。

全流程审计通知：

集成 log_action 函数，登记出差与确认归队操作将自动同步至系统审计流。

多员通知机制：系统识别出差参与人，自动向当事人及管理层（队长、领班）发送站内信动态通知。

增加通知模块页码

🛠️ 修复 (Fixed)
出差状态联动残留：修复了人员点击“已归队”并补全日期后，排班系统左侧待办人员名单仍残留“出差中”黄色标签的逻辑 Bug。

列表排序倒置：修正了出差列表默认正序排列的问题，现统一为 BusinessTrip.id.desc()，确保最新动态置顶显示。

剪贴板兼容性：针对部分非安全环境或旧版浏览器，重构了复制逻辑，通过“隐形 Textarea”方案解决了 navigator.clipboard 无法调用的报错。

404 路由冲突：修复了出差蓝图（trip_bp）在未统一配置 url_prefix 情况下导致的地址栏访问错误，明确了 /trip/list 访问规范。

🚀 布局与交互优化 (Improved)
状态颜色语义化：优化列表状态标签，出差执行中显示为“警告黄（执行中）”，已归队显示为“次要灰（已归队）”，视觉优先级更清晰。

极速盖章模式适配：优化了排班视图下的拖拽体验，出差人员在归队后会立即从侧边栏释放，恢复正常排班权限。

## [7.1.9-alpha] - 2026-01-08

### 🚀 新增功能 (Added)
- **账号自动同步**：现在“自主登记”的队员在通过管理员审批（approve_pending）后，系统会自动为其创建登录账号。

- **默认凭据生成**：自动创建的账号统一以 身份证号 为用户名，身份证后六位 为初始密码。

- **操作审计流**：在审批通过时，系统会自动记录一条 action_type='审批入职' 的审计日志到数据库中，涵盖审批人、目标对象及具体描述。

### 🛠️ 修复 (Fixed)
- **审批流程闭环**：修复了自主登记队员在审批通过后无法登录系统的逻辑漏洞。

- **状态强控：加强了审批时的状态校验，防止对非“待审核”状态的记录进行重复审批。

### 🛡️ 安全与优化 (Security & Optimization)
- **入职冲突检测**：审批前增加二次查重，防止在审批期间该身份证已通过其他渠道入职导致的重复数据。

- **异常处理：在审批提交环节增加了 try-except 捕获及 db.session.rollback() 回滚机制，确保数据库事务的一致性。

## [7.1.8-alpha] - 2026-01-08

### ✨ 新增功能 (Added)
- **床位动态统计看板**：在房间标题处新增 `已占用/总床位` 实时显示（例如：`2/6`），通过自动累加房内资产容量计算得出。
- **宿舍长置顶逻辑**：优化房间内人员列表，宿舍长（Room Leader）现在会自动排列在首位，并配有星标提醒。
- **资产-铺位联动显示**：床类资产标签右侧新增“铺位人员”面板，可直观查看上、下铺的住户姓名及空位状态。

### 🚀 布局与交互优化 (Improved)
- **全屏地图模式**：突破了 `base.html` 中 `.container` 的宽度限制，支持超大宿舍平面图的 100% 宽度显示。
- **自由缩放滚动**：为地图容器增加了 `overflow: auto`，解决了大尺寸底图在小屏幕下显示不全的问题。
- **界面层次感**：优化了资产标签的 `d-flex` 布局，使责任人信息与铺位信息在有限空间内清晰共存。

### 🐞 修复 (Fixed)
- **拖拽坐标偏移问题**：修复了在开启滚动条或父级容器偏移时，管理员移动房间位置出现的“坐标吸死”或“位置错位”现象。
- **排序冒泡干扰**：解决了 `Sortable.js` 拖拽分配功能与房间句柄 `onmousedown` 移动事件的冒泡冲突。

### 🔧 数据库与模型 (Database)
- 强化了资产模型与房间住户的关联查询，通过 `bed_number` 实现人员与具体资产个体的精确绑定。